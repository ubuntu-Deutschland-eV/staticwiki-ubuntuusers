<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Archiv/Nur-Lesen_Root-Dateisystem_mit_aufs › ubuntuusers statisches Wiki</title>
<link href="../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs.html">Nur-Lesen Root-Dateisystem mit aufs</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Archiv/Nur-Lesen_Root-Dateisystem_mit_aufs">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../wiki/index.html">Index</a></li>
<li><a href="../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../wiki.html">Übersicht</a></li>
<li><a href="../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../kategorien.html">Kategorie</a></li>
<li><a href="../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../howto.html">Howto anlegen</a></li>
<li><a href="../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../baustelle.html">Baustellen</a></li>
<li><a href="../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs/a/backlinks.html">Nur-Lesen Root-Dateisystem mit aufs</a></h1>
<div id="page"><div class="box improvable"><h3 class="box improvable">Archivierte Anleitung</h3><div class="contents"><p>
Dieser Artikel wurde archiviert, da er - oder Teile daraus -
nur noch unter einer älteren Ubuntu-Version nutzbar ist. Diese
Anleitung wird vom Wiki-Team weder auf Richtigkeit überprüft
noch anderweitig gepflegt. Zusätzlich wurde der Artikel für
weitere Änderungen gesperrt.
</p></div></div><div class="box advanced"><h3 class="box advanced">Artikel für fortgeschrittene Anwender</h3><div class="contents"><p>
Dieser Artikel erfordert mehr Erfahrung im Umgang mit
Linux und ist daher nur für fortgeschrittene Benutzer
gedacht.
</p></div></div><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="../terminal.html">Ein Terminal öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="../editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="../sudo.html">Root-Rechte</a></p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="../rechte.html">Rechte für Dateien und Ordner ändern</a></p></li></ol></div></div><p>
</p><div class="toc toc-depth-3"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Vorbereitung">Vorbereitung
</a></li><li><a class="crosslink" href="#iniramfs-erstellen">iniramfs erstellen
</a></li><li><a class="crosslink" href="#Bootloader">Bootloader
</a><ol class="arabic"><li><a class="crosslink" href="#GRUB-2">GRUB 2
</a></li><li><a class="crosslink" href="#GRUB-Legacy">GRUB Legacy
</a></li></ol></li><li><a class="crosslink" href="#Deinstallation">Deinstallation
</a></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p>In diesem Artikel wird beschrieben, wie man Schreibzugriffe auf das Root-Dateisystem mit Hilfe von <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Aufs">aufs</a> in eine RAM-Disk umleitet. Dadurch hat man nach jedem Neustart ein „sauberes“ System. Das ist zum Beispiel beim Einsatz auf einem portablen <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/USB-Stick">USB-Stick</a> als Notfall-OS nützlich. Es ist außerdem möglich, das Dateisystem beschreibbar <a class="internal" href="../mount.html">einzubinden</a>. Dadurch hat man die Möglichkeit, Aktualisierungen (Updates) zu installieren und das System an die eigenen Bedürfnisse anzupassen, ohne die Nachteile, die bei einer klassischen Lösung mit <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/SquashFS">SquashFS</a> entstehen.</p><p>Dieser Artikel ist im Grunde eine Übersetzung und Aktualisierung dieses englischen <a class="external" href="http://xercestech.com/custom-ubuntu-server-usb-stick-part2.geek" rel="nofollow">Original-Artikels</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/>.</p><p>Wenn man nur ein einfaches Live-System auf einem USB-Stick haben möchte, sollte man sich den Artikel <a class="internal" href="../live-usb.html">Live-USB</a> anschauen.</p><div class="section_1"><h2 id="Vorbereitung">Vorbereitung<a class="headerlink" href="#Vorbereitung">¶</a></h2><p>
Zunächst sollte man Ubuntu auf einen beliebigen Datenträger installieren. Diese Anleitung bezieht sich auf eine Installation mit nur einer Partition.</p></div><div class="section_1"><h2 id="iniramfs-erstellen">iniramfs erstellen<a class="headerlink" href="#iniramfs-erstellen">¶</a></h2><p>
Eigentlich spielt sich alles im initramfs des Kernels ab. Es wird eine RAM-Disk erstellt, das Root-Dateisystem nicht-beschreibbar eingebunden und mit <strong>aufs</strong> die RAM-Disk über das Root-Dateisystem gelegt. Diese Aufgabe erledigt folgendes Skript, das nach <strong>/etc/initramfs-tools/scripts/init-bottom/rootaufs</strong> kopiert werden muss <sup><a href="#source-2">[2]</a></sup><sup><a href="#source-3">[3]</a></sup>. Der Skript aus dem unten verlinkten Original-Artikel funktioniert wegen einer kleinen Änderung in <strong>modprobe</strong> ab Ubuntu 9.10 nicht mehr, deshalb bitte das angepasste aus diesem Artikel verwenden:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#! /bin/sh</span>
<span class="c1">#  Copyright 2010 Sebastian P.</span>
<span class="c1">#  Copyright 2008 Nicholas A. Schembri State College PA USA</span>
<span class="c1">#</span>
<span class="c1">#  This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#  it under the terms of the GNU General Public License as published by</span>
<span class="c1">#  the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#  (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#  This program is distributed in the hope that it will be useful,</span>
<span class="c1">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#  GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see</span>
<span class="c1">#    &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="c1"># Thank you Voyage Linux for the idea, http://voyage.hk/ Great job on release 0.5</span>
<span class="c1">#</span>
<span class="c1"># Tested with 9.10</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ****************************************************************************************</span>
<span class="c1"># </span>
<span class="c1">#                                 Change log</span>
<span class="c1">#</span>
<span class="c1"># 2008.08.01  Added debugging comments in "drop to a shell" section. grub option aufs=tmpfs-debug will stop the init script.</span>
<span class="c1">#             reviewed *********** fix fstab on tmpfs ******************</span>
<span class="c1">#             rootaufs failed when system was booted with /dev/xxx and fstab had uuid= info.</span>
<span class="c1">#             BlaYO pointed out the best and simplest solution was to use grep -v. Grep replaces a sed one liner.</span>
<span class="c1">#             Add the comment block to fstab</span>
<span class="c1">#             </span>
<span class="c1"># </span>
<span class="c1">#</span>

<span class="k">case</span> <span class="nv">$1</span> in
prereqs<span class="o">)</span>
    <span class="nb">exit</span> <span class="m">0</span>
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="nb">export</span> aufs

<span class="k">for</span> x in <span class="k">$(</span>cat /proc/cmdline<span class="k">)</span><span class="p">;</span> <span class="k">do</span> 
    <span class="k">case</span> <span class="nv">$x</span> in 
    <span class="nv">root</span><span class="o">=</span>*<span class="o">)</span>
        <span class="nv">ROOTNAME</span><span class="o">=</span><span class="si">${</span><span class="nv">x</span><span class="p">#root=</span><span class="si">}</span>
        <span class="p">;;</span>
    <span class="nv">aufs</span><span class="o">=</span>*<span class="o">)</span>
        <span class="nv">aufs</span><span class="o">=</span><span class="si">${</span><span class="nv">x</span><span class="p">#aufs=</span><span class="si">}</span>
        <span class="k">case</span> <span class="nv">$aufs</span> in
        tmpfs-debug<span class="o">)</span>
            <span class="nv">aufs</span><span class="o">=</span>tmpfs
            <span class="nv">aufsdebug</span><span class="o">=</span><span class="m">1</span>
            <span class="p">;;</span>
        <span class="k">esac</span>    
        <span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>


<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$aufs</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"tmpfs"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1">#not set in boot loader </span>
    <span class="c1">#I'm not loved. good bye</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>




<span class="c1"># This is a simple overview of the steps needed to use aufs on the root file system and see the /rw and /ro  branches.</span>
<span class="c1"># initramfs init-botton script </span>
<span class="c1"># move the root file system to aufs/unionfs readonly /ro</span>
<span class="c1"># root is mounted on ${rootmnt}</span>
<span class="c1"># create tmpfs on /rw</span>
<span class="c1"># create a aufs using /ro and /rw</span>
<span class="c1"># put some files on the tmpfs to fix mtab and fstab </span>
<span class="c1"># move aufs to rootmnt to finish the init process.</span>
<span class="c1"># No changes to the root file system are made by this script.</span>
<span class="c1">#</span>
<span class="c1">#  Why!</span>
<span class="c1">#  This will allow you to use a usb flash drive and control what is written to the drive.</span>
<span class="c1">#  no need to rebuild the squashfs file just to add a program. </span>
<span class="c1">#  boot to single user mode.  The system works the way you expect. boot aufs=tmpfs and no changes are written to the flash.</span>
<span class="c1">#  run ubuntu on an eeePC .  </span>

<span class="c1"># Install </span>
<span class="c1"># Install ubuntu 8.04 Hardy. Hardy has aufs installed by default</span>
<span class="c1"># apt-get update</span>
<span class="c1"># apt-get dist-upgrade</span>
<span class="c1"># apt-get install aufs-tools</span>
<span class="c1"># echo aufs &gt;&gt; /etc/initramfs-tools/modules</span>
<span class="c1"># put this file in /etc/initramfs-tools/scripts/init-bottom/rootaufs</span>
<span class="c1"># chmod 0755 rootaufs</span>
<span class="c1"># # clean up menu.lst </span>
<span class="c1"># update-grub</span>
<span class="c1"># update-initramfs -u</span>
<span class="c1"># vi /boot/grub/menu.lst</span>
<span class="c1"># add aufs=tmpfs to the default entry. </span>
<span class="c1"># do not add this line to single user mode.</span>
<span class="c1"># boot to single user mode in order to install software. </span>
<span class="c1"># note: if your home account is on the root file system, your files are in ram and not saved.</span>
<span class="c1"># </span>


<span class="nb">echo</span> 
<span class="nb">echo</span> <span class="s2">"       root-aufs:  Setting up aufs on </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span><span class="s2"> as root file system "</span>
<span class="nb">echo</span> 

modprobe -qb aufs
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>    root-aufs error:      Failed to load aufs.ko
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1">#make the mount points on the init root file system</span>
mkdir /aufs
mkdir /rw
mkdir /ro

<span class="c1"># mount the temp file system and move real root out of the way</span>
mount -t tmpfs aufs-tmpfs /rw
mount --move <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span> /ro 
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>    root-aufs error:    <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span>  failed to move to /ro
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>


mount -t aufs -o <span class="nv">dirs</span><span class="o">=</span>/rw:/ro<span class="o">=</span>ro aufs /aufs
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>    root-aufs error:      Failed to mount /aufs files system
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>


<span class="c1">#test for mount points on aufs file system</span>
<span class="o">[</span>  -d /aufs/ro <span class="o">]</span> <span class="o">||</span> mkdir /aufs/ro
<span class="o">[</span>  -d /aufs/rw <span class="o">]</span> <span class="o">||</span> mkdir /aufs/rw

<span class="c1"># the real root file system is hidden on /ro of the init file system.  move it to /ro </span>
mount --move /ro /aufs/ro
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>    root-aufs error:      Failed to move /ro /aufs/ro 
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># tmpfs file system is hidden on /rw</span>
mount --move /rw /aufs/rw
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>    root-aufs error:      Failed to move /rw /aufs/rw 
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>



<span class="c1"># *********** fix fstab on tmpfs ******************</span>
<span class="c1"># test for /dev/sdx </span>
<span class="c1"># this is not on the real file system.  This is created on the tmpfs each time the system boots.</span>
<span class="c1"># The init process will try to mount the root filesystem listed in fstab. / and swap must be removed.  </span>
<span class="c1"># the root file system must be mounted on /ro not on /</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$aufsdebug</span><span class="s2">"</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>  <span class="s2">"   root-aufs debug:    Remove the root file system and swap from fstab "</span>
    <span class="nb">echo</span> 
    <span class="nb">echo</span> 
    <span class="nb">echo</span>  <span class="s2">"         ROOTNAME </span><span class="nv">$ROOTNAME</span><span class="s2"> "</span>
    <span class="nb">echo</span>  <span class="s2">"         resume   </span><span class="nv">$resume</span><span class="s2">   "</span>
    <span class="nb">echo</span> 
    <span class="nb">echo</span>  <span class="s1">'     BlaYO pointed out that grep can be used to quickly remove '</span>
    <span class="nb">echo</span>  <span class="s1">'      the root file system from fstab. '</span>
    <span class="nb">echo</span> 
    <span class="nb">echo</span>  <span class="s1">'     Thank you BlaYO for the debug info.'</span>
    <span class="nb">echo</span>

<span class="k">fi</span>
<span class="c1"># old code</span>
<span class="c1"># I'm sure that sed can do this in one step but I want to correct on the rootname  not matching the root in fstab.</span>
<span class="c1">#cat /aufs/ro/etc/fstab|sed -e s/$ROOTNAME/\#$ROOTNAME/ -e s/$resume/\#$resume/ &gt;/aufs/etc/fstab  </span>

<span class="c1">#Add the comment block to fstab</span>
cat <span class="s">&lt;&lt;EOF &gt;/aufs/etc/fstab</span>
<span class="s">#</span>
<span class="s">#   RootAufs has mounted the root file system in ram</span>
<span class="s">#</span>
<span class="s">#  This fstab is in ram and the real fstab can be found /ro/etc/fstab</span>
<span class="s">#  the root file system ' / ' has been removed.</span>
<span class="s">#  All Swap files have been removed. </span>
<span class="s">#</span>

<span class="s">EOF</span>

<span class="c1">#remove root from fstab</span>
cat /aufs/ro/etc/fstab<span class="p">|</span>grep -v <span class="s1">' / '</span> &gt;&gt;/aufs/etc/fstab  
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>    root-aufs error:      Failed to create /aufs/etc/fstab 
    <span class="c1">#exit 0</span>
<span class="k">fi</span>




<span class="c1"># add the read only file system to fstab</span>
<span class="c1">#ROOTTYPE=$(/lib/udev/vol_id -t ${ROOT})</span>
<span class="nv">ROOTTYPE</span><span class="o">=</span><span class="k">$(</span>cat /proc/mounts<span class="p">|</span>grep <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span><span class="p">|</span>cut -d<span class="s1">' '</span> -f3<span class="k">)</span>
<span class="nv">ROOTOPTIONS</span><span class="o">=</span><span class="k">$(</span>cat /proc/mounts<span class="p">|</span>grep <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span><span class="p">|</span>cut -d<span class="s1">' '</span> -f4<span class="k">)</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span> /ro <span class="nv">$ROOTTYPE</span> <span class="nv">$ROOTOPTIONS</span> <span class="m">0</span> <span class="m">0</span> &gt;&gt;/aufs/etc/fstab


<span class="c1"># S22mount on debian systems is not mounting  /ro correctly after boot</span>
<span class="c1"># add to rc.local to correct what you see from df</span>
<span class="c1">#replace last case of exit with #exit</span>
cat /aufs/ro/etc/rc.local<span class="p">|</span>sed <span class="s1">'s/\(.*\)exit/\1\#exit/'</span> &gt;/aufs/etc/rc.local  
<span class="nb">echo</span> mount -f  /ro &gt;&gt;/aufs/etc/rc.local 

<span class="c1"># add back the root file system. mtab seems to be created by one of the init proceses. </span>
<span class="nb">echo</span> <span class="s2">"echo aufs / aufs rw,xino=/rw/.aufs.xino,br:/rw=rw:/ro=ro 0 0 &gt;&gt;/etc/mtab"</span> &gt;&gt;/aufs/etc/rc.local
<span class="nb">echo</span> <span class="s2">"echo aufs-tmpfs /rw tmpfs rw 0 0 &gt;&gt;/etc/mtab"</span> &gt;&gt;/aufs/etc/rc.local 
<span class="nb">echo</span> <span class="nb">exit</span> <span class="m">0</span> &gt;&gt;/aufs/etc/rc.local 

<span class="c1">#fix permissions</span>
chmod <span class="m">755</span> /aufs

<span class="c1">#build remountrw</span>
<span class="nb">echo</span> <span class="se">\#</span>!/bin/sh &gt;/aufs/bin/remountrw
<span class="nb">echo</span> mount -o remount,rw <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span> &gt;&gt;/aufs/bin/remountrw
chmod <span class="m">0700</span> /aufs/bin/remountrw

<span class="c1">#build remountro</span>
<span class="nb">echo</span> <span class="se">\#</span>!/bin/sh &gt;/aufs/bin/remountro
<span class="nb">echo</span> mount -o remount,ro <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span> &gt;&gt;/aufs/bin/remountro
chmod <span class="m">0700</span> /aufs/bin/remountro

<span class="c1"># This should drop to a shell. (rewrite)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$aufsdebug</span><span class="s2">"</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span>
    <span class="nb">echo</span> <span class="s1">'   root-aufs debug:    mount --move /aufs /root '</span>
    <span class="nb">echo</span> 
    <span class="nb">echo</span> <span class="s1">'   root-aufs debug:   init will stop here.   '</span>
    <span class="nb">echo</span>  
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

mount --move /aufs /root

<span class="nb">exit</span> <span class="m">0</span> 
</pre></div>
</td></tr></table></div><p>Als nächstes muss das Skript ausführbar gemacht werden <sup><a href="#source-1">[1]</a></sup><sup><a href="#source-3">[3]</a></sup><sup><a href="#source-4">[4]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo chmod 0755 /etc/initramfs-tools/scripts/init-bottom/rootaufs </pre></div></div><p>Das Modul <strong>aufs</strong> muss in die Datei <strong>/etc/initramfs-tools/modules</strong> eingefügt werden, damit es im initramfs verfügbar ist:</p><div class="bash"><div class="contents"><pre class="notranslate">echo aufs | sudo tee /etc/initramfs-tools/modules </pre></div></div><p>Zuletzt muss das neue initramfs erstellt werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-initramfs -u </pre></div></div></div><div class="section_1"><h2 id="Bootloader">Bootloader<a class="headerlink" href="#Bootloader">¶</a></h2><p>
Der obere Skript wird über Parameter in der Kernel-Zeile gesteuert. Sobald <code class="notranslate">aufs=tmpfs</code> gesetzt ist, wird das Dateisystem nur-lesbar eingebunden. Sobald keine zusätzlichen Parameter gesetzt wurden, startet Ubuntu normal, und Änderungen am System können vorgenommen werden.</p><div class="section_2"><h3 id="GRUB-2">GRUB 2<a class="headerlink" href="#GRUB-2">¶</a></h3><p>
Bei <a class="internal" href="../grub_2.html">GRUB 2</a> gestaltet sich die Konfiguration etwas komplizierter als bei <a class="crosslink" href="#GRUB-Legacy">GRUB (Legacy)</a>.</p><p>In der Datei <strong>/etc/grub.d/10_linux</strong> müssen folgende Zeilen
</p><pre class="notranslate">  linux_entry "${OS}, Linux ${version}" \
    "${GRUB_CMDLINE_LINUX} ${GRUB_CMDLINE_EXTRA} ${GRUB_CMDLINE_LINUX_DEFAULT}" \
    quiet
  if [ "x${GRUB_DISABLE_LINUX_RECOVERY}" != "xtrue" ]; then
    linux_entry "${OS}, Linux ${version} (recovery mode)" \
    "single ${GRUB_CMDLINE_LINUX}"
  fi</pre><p>
durch diese Zeilen
</p><pre class="notranslate">  linux_entry "${OS}, Linux ${version}" \
    "${GRUB_CMDLINE_LINUX} ${GRUB_CMDLINE_EXTRA} ${GRUB_CMDLINE_LINUX_DEFAULT} aufs=tmpfs" \
    quiet
  linux_entry "${OS}, Linux ${version} (writeable mode)" \
    "${GRUB_CMDLINE_LINUX} ${GRUB_CMDLINE_EXTRA} ${GRUB_CMDLINE_LINUX_DEFAULT}" \
    quiet
  if [ "x${GRUB_DISABLE_LINUX_RECOVERY}" != "xtrue" ]; then
    linux_entry "${OS}, Linux ${version} (recovery mode)" \
    "single ${GRUB_CMDLINE_LINUX}"
  fi</pre><p>
ersetzt werden <sup><a href="#source-2">[2]</a></sup><sup><a href="#source-3">[3]</a></sup>.</p><p>Mit
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo grub-mkconfig -o /boot/grub/grub.cfg </pre></div></div><p>
werden die Änderungen übernommen <sup><a href="#source-1">[1]</a></sup><sup><a href="#source-3">[3]</a></sup>.</p></div><div class="section_2"><h3 id="GRUB-Legacy">GRUB Legacy<a class="headerlink" href="#GRUB-Legacy">¶</a></h3><p>
Es muss die Datei <strong><a class="internal" href="../menu.lst.html">/boot/grub/menu.lst</a></strong> bearbeitet werden <sup><a href="#source-2">[2]</a></sup><sup><a href="#source-3">[3]</a></sup>.</p><p>Die Zeile
</p><pre class="notranslate"># defoptions=quiet splash</pre><p>
muss in
</p><pre class="notranslate"># defoptions=quiet splash aufs=tmpfs</pre><p>
geändert werden.</p><p>Damit automatisch ein zusätzlicher Eintrag zum normalen Starten angelegt wird, muss über der Zeile
</p><pre class="notranslate"># altoptions=(recovery mode) single</pre><p>
die Zeile</p><pre class="notranslate"># altoptions=(writeable mode) quiet splash</pre><p>
eingefügt werden.</p><p>Die Konfiguration wird mit folgendem Befehl neu erstellt <sup><a href="#source-1">[1]</a></sup><sup><a href="#source-3">[3]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-grub </pre></div></div></div></div><div class="section_1"><h2 id="Deinstallation">Deinstallation<a class="headerlink" href="#Deinstallation">¶</a></h2><p>
Die Änderungen am Bootloader müssen rückgängig gemacht, das Skript gelöscht, das zusätzliche Modul entfernt und das initramfs neu erstellt werden.</p></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Aufs">aufs</a> - Wikipedia</p></li><li><p><a class="external" href="http://xercestech.com/custom-ubuntu-server-usb-stick-part2.geek" rel="nofollow" title="http://xercestech.com/custom-ubuntu-server-usb-stick-part2.geek">http://xercestech.com/custom-ubuntu-server-usb-stick-part2.geek</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> - Original-Artikel</p></li><li><p><a class="internal" href="../chroot/persistente-installation.html">chroot/persistente-Installation</a> - Reparatur einer persistenten Installation</p></li><li><p><a class="internal" href="../nur-lesen_root-dateisystem.html">Nur-Lesen Root-Dateisystem</a> - ein OverlayFS Skript</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="../archiv/nur-lesen_root-dateisystem_mit_aufs/a/revision/833613.html">Diese Revision</a> wurde am 30. August 2015 15:58 von <a href="https://ubuntuusers.de/user/aasche/">aasche</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../startseite.html">Wiki</a></li>
<li><a href="../archiv.html">Archiv</a></li>
<li><a href="../archiv/nur-lesen_root-dateisystem_mit_aufs.html">Nur-Lesen Root-Dateisystem mit aufs</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>