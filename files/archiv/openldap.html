<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Archiv/OpenLDAP › ubuntuusers statisches Wiki</title>
<link href="../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../archiv/openldap.html">OpenLDAP</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Archiv/OpenLDAP">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../wiki/index.html">Index</a></li>
<li><a href="../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../wiki.html">Übersicht</a></li>
<li><a href="../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../kategorien.html">Kategorie</a></li>
<li><a href="../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../howto.html">Howto anlegen</a></li>
<li><a href="../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../baustelle.html">Baustellen</a></li>
<li><a href="../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../archiv/openldap/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../archiv/openldap/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../archiv/openldap/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../archiv/openldap/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../archiv/openldap/a/backlinks.html">OpenLDAP</a></h1>
<div id="page"><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Ab <a class="internal" href="../precise_pangolin.html">Ubuntu 12.04</a> bitte den Artikel <a class="internal" href="../openldap_ab_precise.html">OpenLDAP ab Precise</a> nutzen.
</p></div></div><p>
</p><div class="box improvable"><h3 class="box improvable">Archivierte Anleitung</h3><div class="contents"><p>
Dieser Artikel wurde archiviert, da er - oder Teile daraus -
nur noch unter einer älteren Ubuntu-Version nutzbar ist. Diese
Anleitung wird vom Wiki-Team weder auf Richtigkeit überprüft
noch anderweitig gepflegt. Zusätzlich wurde der Artikel für
weitere Änderungen gesperrt.
</p></div></div><p>
</p><div class="box advanced"><h3 class="box advanced">Artikel für fortgeschrittene Anwender</h3><div class="contents"><p>
Dieser Artikel erfordert mehr Erfahrung im Umgang mit
Linux und ist daher nur für fortgeschrittene Benutzer
gedacht.
</p></div></div><p>
</p><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="../pakete_installieren.html">Installation von Programmen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="../terminal.html">Ein Terminal öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="../editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="../rechte.html">Dateirechte ändern</a></p></li></ol></div></div><p>
<a class="crosslink anchor" href="#top" id="top"></a>
</p><div class="toc toc-depth-3"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Installation">Installation
</a><ol class="arabic"><li><a class="crosslink" href="#Ubuntu-Pakete-installieren">Ubuntu-Pakete installieren
</a></li><li><a class="crosslink" href="#LDAP-Schemata-einfuegen">LDAP-Schemata einfügen
</a></li><li><a class="crosslink" href="#Konfiguration-ueber-cn-config-Datenbank-etc-ldap-slapd-d">Konfiguration über cn=config-Datenbank (...</a></li><li><a class="crosslink" href="#Testen">Testen
</a></li><li><a class="crosslink" href="#Weitere-Konfiguration">Weitere Konfiguration
</a></li></ol></li><li><a class="crosslink" href="#Installation-bis-Ubuntu-9-04">Installation bis Ubuntu 9.04
</a><ol class="arabic"><li><a class="crosslink" href="#Ubuntu-Pakete-installieren-2">Ubuntu-Pakete installieren
</a></li><li><a class="crosslink" href="#Vorbereitung-und-Allgemeines">Vorbereitung und Allgemeines
</a><ol class="arabic"><li><a class="crosslink" href="#Test-mittels-lsof">Test mittels lsof
</a></li><li><a class="crosslink" href="#Test-mittels-nmap">Test mittels nmap
</a></li><li><a class="crosslink" href="#SSHA-Schluessel">SSHA-Schlüssel
</a></li></ol></li><li><a class="crosslink" href="#Konfiguration-mittels-slapd-conf">Konfiguration mittels slapd.conf
</a></li><li><a class="crosslink" href="#slapd-conf-aktivieren">slapd.conf "aktivieren"
</a></li><li><a class="crosslink" href="#LDAP-Admin-Benutzer-hinzufuegen">LDAP-Admin-Benutzer hinzufügen
</a></li><li><a class="crosslink" href="#LDAP-Client-konfigurieren">LDAP Client konfigurieren
</a></li></ol></li><li><a class="crosslink" href="#Linux-Benutzeraccounts-nach-LDAP-migrieren">Linux-Benutzeraccounts nach LDAP migrieren...</a></li><li><a class="crosslink" href="#Verwendung-von-SASL">Verwendung von SASL
</a></li><li><a class="crosslink" href="#Sichere-bertragung-mit-TLS-SSL">Sichere Übertragung mit TLS/SSL
</a><ol class="arabic"><li><a class="crosslink" href="#Erstellung-der-benoetigten-Server-Zertifikate">Erstellung der benötigten Server-Zertifi...</a><ol class="arabic"><li><a class="crosslink" href="#Selbstsigniertes-Zertifikat">Selbstsigniertes Zertifikat
</a></li><li><a class="crosslink" href="#Bereitstellung-durch-eine-eigene-Zertifizierungsstelle">Bereitstellung durch eine eigene Zerti...</a></li></ol></li><li><a class="crosslink" href="#Installation-des-LDAP-Server-Zertifikats">Installation des LDAP-Server-Zertifikats...</a></li><li><a class="crosslink" href="#Anpassung-der-Konfiguration-cn-config-Datenbank">Anpassung der Konfiguration (cn=config-D...</a></li><li><a class="crosslink" href="#Test">Test
</a></li></ol></li><li><a class="crosslink" href="#LDAP-Authentication">LDAP Authentication
</a><ol class="arabic"><li><a class="crosslink" href="#Benoetigte-Pakete-installieren-und-konfigurieren">Benötigte Pakete installieren und konfig...</a></li><li><a class="crosslink" href="#Test-2">Test
</a><ol class="arabic"><li><a class="crosslink" href="#Installation-von-LDAP-Admin-Skripts">Installation von LDAP-Admin-Skripts
</a></li><li><a class="crosslink" href="#Testbenutzer-anlegen">Testbenutzer anlegen
</a></li><li><a class="crosslink" href="#Weitere-Tests">Weitere Tests
</a></li></ol></li><li><a class="crosslink" href="#Abschliessende-Arbeiten">Abschließende Arbeiten
</a></li></ol></li><li><a class="crosslink" href="#Hinweise">Hinweise
</a></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p><a class="external" href="http://www.openldap.org/" rel="nofollow">OpenLDAP</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> stellt das Anwendungsprotokoll <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/LDAP">LDAP</a> als freie Software für Linux zur Verfügung. Mit diesem Dienst ist es beispielsweise möglich, eine zentrale Benutzerverwaltung aufzubauen. Zudem kann OpenLDAP als Adressbuch eingesetzt werden. Der LDAP-Verzeichnisdienst ist eine hierarchische Datenbank, in der strukturierte Objekte abgelegt werden. Jedes Objekt wird mit einer Menge von Attributen ausgestattet, die in einer Objektklasse festgelegt sind. Ein Objekt kann dazu mehreren Objektklassen angehören, um unterschiedliche Eigenschaften auszudrücken.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>LDAP ist ein recht komplexes Thema. Es ist empfehlenswert vor der Nutzung weitere Literatur zu gebrauchen, um ein besseres Verständnis für die Funktionsweise und die Möglichkeiten zu bekommen. 
</p></div></div><div class="section_1"><h2 id="Installation">Installation<a class="headerlink" href="#Installation">¶</a></h2><p>
Die Installation von OpenLDAP ist leider etwas kompliziert geworden. So wird nicht mehr nach einem Admin-Passwort gefragt und man muss die Datenbank selbst aufsetzen. Das geht übrigens nur mehr mit dem Root-Benutzerrechten des Rechners, auf dem OpenLDAP später seine Arbeit verrichten soll. <a class="external" href="https://lists.ubuntu.com/archives/ubuntu-server/2009-August/003182.html" rel="nofollow">Hier</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> gibt es ein offizielles Statement dazu (in Kurzform: das ist Teil einer zukünftigen Strategie, um LDAP breitgefächerter - vor allem in Unternehmen - einzusetzen, Stichwort: z.B. <a class="internal" href="../kerberos.html">Kerberos</a>).</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Die folgenden Befehle müssen immer als <a class="internal" href="../sudo.html">root</a> ausgeführt werden:
</p></div></div><div class="section_2"><h3 id="Ubuntu-Pakete-installieren">Ubuntu-Pakete installieren<a class="headerlink" href="#Ubuntu-Pakete-installieren">¶</a></h3><p>
Am Anfang steht natürlich die Installation <sup><a href="#source-1">[1]</a></sup> von OpenLDAP:</p><ul><li><p><strong>slapd</strong></p></li><li><p><strong>ldap-utils</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install slapd ldap-utils </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install slapd ldap-utils </pre></div></div><p>
</p></div></div><p>Weitere Pakete sind optional und für die Funktionalität von OpenLDAP nicht zwingend erforderlich.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>slapd kann nicht mehr mittels Dialog über <code class="notranslate">dpkg-reconfigure slapd</code> konfiguriert werden. Die Eingabe von <code class="notranslate">dpkg-reconfigure slapd</code> setzt das <em>cn=config</em>-Backend in den Ausgangszustand zurück. Alle nachfolgend beschriebenen Konfigurationsschritte an dem Backend müssen dann neu ausgeführt werden. Es ist deswegen ratsam, die für die Konfiguration verwendeten <strong>.ldif</strong>-Dateien im Verzeichnis <strong>/etc/ldap</strong> abzulegen, damit die Informationen nicht verloren gehen. <code class="notranslate">dpkg-reconfigure slapd</code> sollte nur noch zum <strong>gezielten Zurücksetzen des Backends</strong> verwendet werden. Das eigentliche LDAP-Verzeichnis bleibt dabei erhalten.
</p></div></div></div><div class="section_2"><h3 id="LDAP-Schemata-einfuegen">LDAP-Schemata einfügen<a class="headerlink" href="#LDAP-Schemata-einfuegen">¶</a></h3><p>
Anschließend fügt man einige von Ubuntu im LDIF-Format schon mitgelieferte Schemata hinzu. Bis <a class="internal" href="../maverick_meerkat.html">Ubuntu 10.10</a> ist <code class="notranslate">core.schema</code> ist das einzige Schema, bei der Installation von slapd automatisch in das <em>cn=config</em>-Backend aufgenommen wird):</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/cosine.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/inetorgperson.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/nis.ldif </pre></div></div><p>Ab <a class="internal" href="../natty_narwhal.html">Ubuntu 11.04</a> kann man auch noch folgende weitere Schemata hinzufügen:
</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/misc.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/openldap.ldif </pre></div></div><p>Weitere Schemata (wie z. B. <code class="notranslate">samba.schema</code>), die nicht im LDIF-Format vorliegen, müssen zunächst konvertiert werden. Das folgende Beispiel fügt die gängigsten Schemata hinzu:
</p><ol class="arabic"><li><p>Erstellen einer Datei <strong>schema_convert.conf</strong> im Verzeichnis <strong>/etc/ldap/schema</strong> mit folgendem Inhalt: </p><pre class="notranslate">include /etc/ldap/schema/core.schema
include /etc/ldap/schema/collective.schema
include /etc/ldap/schema/corba.schema
include /etc/ldap/schema/cosine.schema
include /etc/ldap/schema/duaconf.schema
include /etc/ldap/schema/dyngroup.schema
include /etc/ldap/schema/inetorgperson.schema
include /etc/ldap/schema/java.schema
include /etc/ldap/schema/misc.schema
include /etc/ldap/schema/nis.schema
include /etc/ldap/schema/openldap.schema
include /etc/ldap/schema/ppolicy.schema
include /etc/ldap/schema/amavis.schema
include /etc/ldap/schema/ldapns.schema
# PMI schema makes problems when checking
# database with slapcat for correctness
# in Ubuntu 9.10; see bug report
# include /etc/ldap/schema/pmi.schema
include /etc/ldap/schema/samba.schema</pre></li></ol><p>
Auch die schon in die <em>cn=config</em>-Datenbank eingefügten Schemata müssen in <strong>schema_convert.conf</strong> aufgeführt werden, da die anderen Schemata teilweise. auf sie aufbauen.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Man beachte, dass Canonical darauf hinarbeitet, die OpenLDAP-Pakete von allen LDAP-anwendungsspezifischen Konfigurationen zu befreien und diese stattdessen in die Installationsskripts der Anwendungen zu verlagern. So könnte z.B. in zukünftigen Ubuntu-Releases ein Installationsskript des Samba-Pakets das <code class="notranslate">samba.schema</code> automatisch zum <em>cn=config</em>-Verzeichnis hinzufügen. Bis <a class="internal" href="../natty_narwhal.html">Ubuntu 11.04</a> läuft das leider noch nicht so komfortabel. Canonical legt stattdessen die Schemata 'samba.schema' und 'ldapns.schema' im doc-Verzeichnis der Anwendungen ab.
</p></div></div><p>Das Schema <code class="notranslate">samba.schema</code> bekommt man über das Paket:
</p><ul><li><p><strong>samba-doc</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install samba-doc </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install samba-doc </pre></div></div><p>
</p></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">gunzip /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz
cp -v /usr/share/doc/samba-doc/examples/LDAP/samba.schema /etc/ldap/schema </pre></div></div><p>Das Schema <code class="notranslate">amavis.schema</code> ist über das gleichnamige Paket zu beziehen:
</p><ul><li><p><strong>amavis</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install amavis </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install amavis </pre></div></div><p>
</p></div></div><p>Bis <a class="internal" href="../maverick_meerkat.html">Ubuntu 10.10</a> bekommt man das Schema <code class="notranslate">ldapns.schema</code> über das Paket:</p><ul><li><p><strong>libpam-ldap</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install libpam-ldap </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install libpam-ldap </pre></div></div><p>
</p></div></div><p>Bei der Installation des Pakets öffnet sich ein Konfigurationsdialog, der im Kapitel <a class="internal missing" href="../openldap.html#ldap_auth_config">LDAP Authentication</a> beschrieben wird. Spätere Änderungen an der LDAP-Authentication-Konfiguration sind durch Aufruf von <code class="notranslate">dpkg-reconfigure ldap-auth-config</code> jederzeit möglich.</p><div class="bash"><div class="contents"><pre class="notranslate">cp -v /usr/share/doc/libpam-ldap/ldapns.schema /etc/ldap/schema </pre></div></div><p>Ab <a class="internal" href="../natty_narwhal.html">Ubuntu 11.04</a> muss man auch das Schema <code class="notranslate">amavis.schema</code> nachinstallieren. Man bekommt es über das Paket:</p><ul><li><p><strong>amavisd-new</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install amavisd-new </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install amavisd-new </pre></div></div><p>
</p></div></div><p> 
direkt in das Verzeichnis <strong>/etc/ldap/schema</strong> installiert.</p><p> 2. Erstellen eines temporären Verzeichnisses für die LDIF-Dateien</p><div class="bash"><div class="contents"><pre class="notranslate">mkdir /tmp/ldif_output </pre></div></div><p> 3. Konvertieren der Schemata ins LDIF-Format mit Hilfe von <strong>slapcat</strong> und Kopieren ins Verzeichnis <strong>/etc/ldap/schema</strong>:</p><div class="bash"><div class="contents"><pre class="notranslate">cd /etc/ldap/schema
slapcat -f schema_convert.conf -F /tmp/ldif_output -n0 
cd /tmp/ldif_output/cn\=config/cn\=schema/
cp cn={11}ppolicy.ldif cn={12}amavis.ldif cn={13}ldapns.ldif cn={14}samba.ldif cn={2}corba.ldif cn={4}duaconf.ldif cn={5}dyngroup.ldif cn={7}java.ldif /etc/ldap/schema </pre></div></div><p> 4. Öffnen der neuen LDIF-Dateien in einem Editor und Anpassen der Attribute <code class="notranslate">dn</code> (in der 1. Zeile) und <code class="notranslate">cn</code> (in der 3. Zeile), nachfolgend gezeigt am Beispiel des samba-Schemas:
</p><pre class="notranslate">dn: cn=samba,cn=schema,cn=config
...
cn: samba</pre><p>Löschen der letzten sieben Zeilen in der LDIF-Datei:
</p><pre class="notranslate">structuralObjectClass: olcSchemaConfig
entryUUID: bc124984-712d-102e-9274-5bec14760b98
creatorsName: cn=config
createTimestamp: 20091129122324Z
entryCSN: 20091129122324.626040Z#000000#000#000000
modifiersName: cn=config
modifyTimestamp: 20091129122324Z</pre><p>Das Ganze hier dann automatisiert in einem bash script:</p><div class="bash"><div class="contents"><pre class="notranslate">#!/bin/sh
WORKINGDIR=/tmp/ldapconfig
LDAPCONFIGDIR=/etc/ldap
SCHEMADIR=$LDAPCONFIGDIR/schema
SAMBAINSTALLED=''

if [ ! $UID -eq 0 ]; then
 echo Thsi script must be run as superuser 'root'!
 exit 0
fi

if [ -d $WORKINGDIR ]; then
   echo -n  It seems that a prevoius config is present. Titiying up.
   rm -rf $WORKINGDIR/*
   echo done!
fi

if [ -f /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz ]; then

  echo Samba documentaion seems to be installed, copying schema file to working directory
  zcat /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz &gt; $WORKINGDIR/samba.schema
  SAMBAINSTALLED=='n'
else

  echo "Samba seems not to be installed. Shall I do that for you temporary? [Y|n]"
  read SAMBAINSTALLED
  if [ $SAMBAINSTALLED=='Y' ]; then
    apt-get --yes  install samba-doc
  fi
  cat /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz &gt; $WORKINGDIR/samba.schema

fi

cat &lt;&lt; EOF &gt; $WORKINGDIR/slapd_temporary.conf 
include /etc/ldap/schema/core.schema
include /etc/ldap/schema/collective.schema
include /etc/ldap/schema/corba.schema
include /etc/ldap/schema/cosine.schema
include /etc/ldap/schema/duaconf.schema
include /etc/ldap/schema/dyngroup.schema
include /etc/ldap/schema/inetorgperson.schema
include /etc/ldap/schema/java.schema
include /etc/ldap/schema/misc.schema
include /etc/ldap/schema/nis.schema
include /etc/ldap/schema/openldap.schema
include /etc/ldap/schema/ppolicy.schema
include /etc/ldap/schema/ldapns.schema
include /etc/ldap/schema/pmi.schema
include /etc/ldap/schema/samba.schema
EOF

slapcat -f $WORKINGDIR/slapd_temporary.conf -F $WORKINGDIR -n0 2&gt;&amp;1 &gt; /dev/null

for FILE in $WORKINGDIR/cn\=config/cn\=schema/*.ldif; do
echo Generate ldif schema file for \'${FILE#*\}}\'

    # remove file vefore filling it with contents
    rm -f $SCHEMADIR/${FILE#*\}} 

    while read LINE; do           
       case ${LINE%%:*} in
         "dn")
           LINE="dn: "${LINE#*\}}",cn=schema,cn=config"
         ;;

         "cn")
          LINE="cn: "${LINE#*\}}
         ;;

         "structuralObjectClass")
          unset LINE
         ;;

         "entryUUID")
          unset LINE
         ;;

         "creatorsName")
          unset LINE
         ;;

         "createTimestamp")
          unset LINE
         ;;

         "entryCSN")
          unset LINE
         ;;


         "modifiersName")
          unset LINE
         ;;

         "modifyTimestamp")
          unset LINE
         ;;

       esac      

	echo ${LINE#:*} &gt;&gt; $SCHEMADIR/${FILE#*\}}

   done &lt; $FILE 

done

echo Setting password for the config database ...
slappasswd &gt; /tmp/secret.txt
PASSWORD=`cat /tmp/secret.txt`

cat &lt;&lt; EOF &gt; $WORKINGDIR/config_modify.ldif
# Modify directory database
dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcSuffix

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcSuffix
olcSuffix: dc=meinedomain,dc=local

dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcRootDN

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcRootDN
olcRootDN: cn=admin,dc=meinedomain,dc=local

dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcRootPW

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcRootPW
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1

dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcDbIndex

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: uid pres,eq

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: cn,sn,mail pres,eq,approx,sub

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: objectClass eq

###########################################################
# REMOTE CONFIGURATION DEFAULTS
###########################################################
# Some defaults need to be added in order to allow remote 
# access by DN cn=admin,cn=config to the LDAP config 
# database. Otherwise only local root will 
# administrative access.

\#dn: olcDatabase={0}config,cn=config
\#changetype: modify
\#add: olcRootDN
\#olcRootDN: cn=admin,cn=config

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
EOF

echo "olcRootPW: "$PASSWORD &gt;&gt; $WORKINGDIR/config_modify.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f $WORKINGDIR/config_modify.ldif


exit 1 </pre></div></div><p> 5. Abschließend werden die Schemata dem config-Backend hinzugefügt:
</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/ppolicy.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/amavis.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/ldapns.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/samba.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/corba.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/duaconf.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/dyngroup.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/java.ldif  </pre></div></div></div><div class="section_2"><h3 id="Konfiguration-ueber-cn-config-Datenbank-etc-ldap-slapd-d">Konfiguration über cn=config-Datenbank (/etc/ldap/slapd.d/)<a class="headerlink" href="#Konfiguration-ueber-cn-config-Datenbank-etc-ldap-slapd-d">¶</a></h3><p>
Nachdem nun alle Schemata ins Backend eingefügt worden sind, setzt man die initiale <em>cn=config</em>-Datenbank auf. Diese Datenbank hält die gesamte Konfiguration von OpenLDAP, welche bis Ubuntu 8.04 in <strong>/etc/ldap/slapd.conf</strong> geschrieben stand. Zunächst muss man dazu ein Passwort für die LDAP-Superuser festlegen. Für diesen Wiki-Artikel werden beispielhaft zwei Superuser im LDAP-Backend angelegt:
</p><ul><li><p><strong>cn=admin,cn=config</strong> (Root für die <em>cn=config</em>-Datenbank, d. h. das Konfigurationsverzeichnis des LDAP-Servers)</p></li><li><p><strong>cn=admin,dc=meinedomain,dc=local</strong> (Root für das eigentliche LDAP-Verzeichnis der Domäne <em>meinedomain.local</em>).</p></li></ul><p>
Beiden LDAP-Root-Benutzern wird beispielhaft das Passwort '1234' vergeben. Das Passwort sollte natürlich angepasst und nur verschlüsselt in <em>cn=config</em> abgelegt werden. Deshalb wird zunächst ein Hash des Passwortes erzeugt:</p><div class="bash"><div class="contents"><pre class="notranslate">slappasswd </pre></div></div><pre class="notranslate">New password:
Re-enter new password:
{SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1</pre><p>
Den Hash sollte man sich notieren, da er nachfolgend immer wieder benötigt wird.</p><p>Ab <a class="internal" href="../natty_narwhal.html">Ubuntu 11.04</a> wird die <em>cn=config</em>-Datenbank weitgehend schon bei der Installation aufgesetzt. Es sind dennoch einige Anpassungen ratsam. Dafür erstellt man eine Datei <strong>db.ldif</strong>. Dort fügt man folgendes ein:</p><pre class="notranslate">###########################################################
# DEFAULT DATABASE MODIFICATION
###########################################################

# Modify directory database
dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcSuffix

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcSuffix
olcSuffix: dc=meinedomain,dc=local

dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcRootDN

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcRootDN
olcRootDN: cn=admin,dc=meinedomain,dc=local

dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcRootPW

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcRootPW
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1

dn: olcDatabase={1}hdb,cn=config
changeType: modify
delete: olcDbIndex

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: uid pres,eq

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: cn,sn,mail pres,eq,approx,sub

dn: olcDatabase={1}hdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: objectClass eq

###########################################################
# REMOTE CONFIGURATION DEFAULTS
###########################################################
# Some defaults need to be added in order to allow remote 
# access by DN cn=admin,cn=config to the LDAP config 
# database. Otherwise only local root will 
# administrative access.

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootDN
olcRootDN: cn=admin,cn=config

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1</pre><p>Bis <a class="internal" href="../maverick_meerkat.html">Ubuntu 10.10</a> sieht die Datei <strong>db.ldif</strong> wie folgt aus:</p><pre class="notranslate">###########################################################
# DATABASE SETUP
###########################################################

# Load modules for database type
dn: cn=module{0},cn=config
objectClass: olcModuleList
cn: module{0}
olcModulePath: /usr/lib/ldap
olcModuleLoad: {0}back_hdb

# Create directory database
dn: olcDatabase={1}hdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcHdbConfig
olcDatabase: {1}hdb
olcDbDirectory: /var/lib/ldap
olcSuffix: dc=meinedomain,dc=local
olcRootDN: cn=admin,dc=meinedomain,dc=local
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1
olcAccess: {0}to attrs=userPassword,shadowLastChange by dn="cn=admin,dc=meinedomain,dc=local" write by anonymous auth by self write by * none
olcAccess: {1}to dn.base="" by * read
olcAccess: {2}to * by dn="cn=admin,dc=meinedomain,dc=local" write by * read
olcLastMod: TRUE
olcDbCheckpoint: 512 30
olcDbConfig: {0}set_cachesize 0 2097152 0
olcDbConfig: {1}set_lk_max_objects 1500
olcDbConfig: {2}set_lk_max_locks 1500
olcDbConfig: {3}set_lk_max_lockers 1500
olcDbIndex: uid pres,eq
olcDbIndex: cn,sn,mail pres,eq,approx,sub
olcDbIndex: objectClass eq

###########################################################
# REMOTE CONFIGURATION DEFAULTS
###########################################################
# Some defaults need to be added in order to allow remote 
# access by DN cn=admin,cn=config to the LDAP config 
# database. Otherwise only local root will 
# administrative access.

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootDN
olcRootDN: cn=admin,cn=config

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1
</pre><p>Der Wert für das Attribut 'olcRootPW' sollte natürlich durch den weiter oben erzeugten eigenen Passwort-Hash ersetzt werden.</p><p>Diese Konfiguration wird mit folgendem Befehl in slapd eingelesen:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f db.ldif </pre></div></div><p>Dadurch wird ein Superuser <code class="notranslate">cn=admin,dc=meinedomain,dc=local</code> mit dem Passwort <code class="notranslate">1234</code> erstellt, der von nun an <span class="underline">alle</span> Rechte am LDAP-Verzeichnis für <em>meinedomain.local</em> hat und über dessen Account nachfolgend das eigentliche LDAP-Verzeichnis initialisiert wird.
Das Passwort sollte natürlich angepasst werden.</p><p>Bis <a class="internal" href="../maverick_meerkat.html">Ubuntu 10.10</a> muss man jetzt noch die minimalen Einträge für den LDAP DIT (= "Directory Information Tree", also das eigentliche Verzeichnis des LDAP-Servers) anlegen. Dazu erstellt man eine weitere Datei namens <strong>base.ldif</strong> und fügt dort folgendes ein:</p><pre class="notranslate"># Tree root
dn: dc=meinedomain,dc=local
objectClass: dcObject
objectClass: organization
o: meinedomain.local
dc: meinedomain
description: Tree root

# LDAP admin
dn: cn=admin,dc=meinedomain,dc=local
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
userPassword: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1
description: LDAP administrator</pre><p>Hier wird nun der eigentliche LDAP-Administrator für das <em>meinedomain.local</em>-Verzeichnis definiert. Über diesen Account wird nachfolgend dann das Verzeichnis Schritt für Schritt mit Daten (wie z. B. Benutzeraccounts und deren Passwörter) gefüllt. Bitte auch hier den Passwort-Hash entsprechend anpassen.</p><p>Die Datei <strong>base.ldif</strong> wird über den Superuser-Account "cn=admin,dc=meinedomain,dc=local" eingelesen (wenn nach dem Passwort gefragt wird, das weiter oben definierte Passwort eingeben):</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -D cn=admin,dc=meinedomain,dc=local -W -f base.ldif </pre></div></div><p>Ab jetzt sollte man auf dem Stand einer frischen Installation von OpenLDAP wie unter <a class="internal" href="../jaunty_jackalope.html">Ubuntu 9.04</a> sein und kann das LDAP-Verzeichnis ganz normal <a class="internal missing" href="../openldap.html#migration">weiter aufsetzen</a>.</p></div><div class="section_2"><h3 id="Testen">Testen<a class="headerlink" href="#Testen">¶</a></h3><p>
Mit den folgenden Befehlen, die direkt auf dem Rechner mit dem OpenLDAP-Server ausgeführt werden müssen, kann die LDAP-Konfiguration testweise ausgelesen werden:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -xLLL -b cn=config -D cn=admin,cn=config -W olcDatabase={1}hdb
ldapsearch -xLLL -b cn=config -D cn=admin,cn=config -W </pre></div></div><p>Um die Konfiguration etwas komfortabler darzustellen, kann ein beliebiger LDAP-Browser verwendet werden, indem als Basis-DN 'cn=config' (nicht: <code class="notranslate">dc=meinedomain,dc=local</code>) angegeben wird.</p><p>Zum Auslesen der eigentlichen Verzeichnisdaten dient folgender Befehl (diesmal als anonymer Benutzer ohne Passworteingabe - daher wird beim Eintrag unter <code class="notranslate">cn=admin,dc=meinedomain,dc=local</code> das Passwort-Attribut nicht angezeigt):</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -xLLL -b dc=meinedomain,dc=local </pre></div></div></div><div class="section_2"><h3 id="Weitere-Konfiguration">Weitere Konfiguration<a class="headerlink" href="#Weitere-Konfiguration">¶</a></h3><p>
Im nachfolgenden Kapitel wird nun zunächst die Installation des LDAP-Servers bis <a class="internal" href="../jaunty_jackalope.html">Ubuntu 9.04</a> beschrieben. Anschließend folgen weitere Kapitel, in denen z. B. die Migration existierender Benutzer-Accounts nach LDAP und die LDAP-Authentication vorgestellt werden. Mit nachfolgendem Link gelangen Nutzer von Ubuntu 9.10 und später direkt dorthin: <a class="internal missing" href="../openldap.html#migration">{Weitere Konfiguration}</a></p></div></div><div class="section_1"><h2 id="Installation-bis-Ubuntu-9-04">Installation bis Ubuntu 9.04<a class="headerlink" href="#Installation-bis-Ubuntu-9-04">¶</a></h2><p>
</p><div class="section_2"><h3 id="Ubuntu-Pakete-installieren-2">Ubuntu-Pakete installieren<a class="headerlink" href="#Ubuntu-Pakete-installieren-2">¶</a></h3><p>
</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Die folgenden Befehle müssen immer als <a class="internal" href="../sudo.html">root</a> ausgeführt werden:
</p></div></div><p>Als erstes müssen die entsprechenden Pakete heruntergeladen und installiert werden:</p><ul><li><p><strong>slapd</strong></p></li><li><p><strong>ldap-utils</strong></p></li><li><p><strong>php5-ldap</strong></p></li><li><p><strong>db4.2-util</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install slapd ldap-utils php5-ldap db4.2-util </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install slapd ldap-utils php5-ldap db4.2-util </pre></div></div><p>
</p></div></div><p>Zum Testen wird außerdem - optional - das Paket
</p><ul><li><p><strong>nmap</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install nmap </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install nmap </pre></div></div><p>
</p></div></div><p>
benötigt.</p><p>Unter Ubuntu 8.10 und 9.04 wurde das Verfahren zum Einrichten des LDAP-Servers sehr vereinfacht. Nach der Installation gibt man am Terminal</p><pre class="notranslate">sudo dpkg-reconfigure slapd</pre><p>ein und wird dann mit ein paar Fragen durch die Grundkonfiguration geführt. Danach kann man die weitere Konfiguration bequem mit phpldapadmin durchführen. Dieses Verfahren funktioniert allerdings ab Ubuntu 9.10 nicht mehr.</p><p>Damit ist die Grundinstallation abgeschlossen. Während der Installation von <strong>slapd</strong> wird man übrigens nach einem Passwort gefragt. Dort gibt man ein neues Passwort ein.</p><p><a class="internal missing" href="../openldap.html#top">{top}</a></p></div><div class="section_2"><h3 id="Vorbereitung-und-Allgemeines">Vorbereitung und Allgemeines<a class="headerlink" href="#Vorbereitung-und-Allgemeines">¶</a></h3><p>
</p><div class="section_3"><h4 id="Test-mittels-lsof">Test mittels lsof<a class="headerlink" href="#Test-mittels-lsof">¶</a></h4><p>
Wenn man nmap noch nicht installiert hat bzw. nicht installieren möchte, kann man aber auch <a class="internal" href="../lsof.html">lsof</a> zum Überprüfen des LDAP-Servers verwenden <sup><a href="#source-3">[3]</a></sup>. Dieses ist meistens schon in der Grundinstallation von Ubuntu enthalten.</p><div class="bash"><div class="contents"><pre class="notranslate">lsof -a -i TCP:389 -c slapd  </pre></div></div><p>Die Ausgabe sollte etwa so aussehen:</p><pre class="notranslate">COMMAND  PID     USER   FD   TYPE  DEVICE SIZE NODE NAME
slapd   9395 openldap    8u  IPv6 1616216       TCP *:ldap (LISTEN)
slapd   9395 openldap    9u  IPv4 1616217       TCP *:ldap (LISTEN)</pre><p>Hier ist zu erkennen, dass <code class="notranslate">slapd</code> auf Port <code class="notranslate">389</code> lauscht. Der Server läuft also ordnungsgemäß.</p></div><div class="section_3"><h4 id="Test-mittels-nmap">Test mittels nmap<a class="headerlink" href="#Test-mittels-nmap">¶</a></h4><p>
Jetzt kann man überprüfen, ob der neue LDAP-Server auch läuft. Dazu kann man z.B. <a class="internal" href="../nmap.html">nmap</a> nutzen <sup><a href="#source-3">[3]</a></sup>.</p><div class="bash"><div class="contents"><pre class="notranslate">nmap localhost | grep ldap </pre></div></div><p>Nun sollte Folgendes erscheinen:</p><pre class="notranslate">389/tcp open ldap</pre></div><div class="section_3"><h4 id="SSHA-Schluessel">SSHA-Schlüssel<a class="headerlink" href="#SSHA-Schluessel">¶</a></h4><p>
Bis einschließlich Ubuntu Hard Heron 8.04 benötigt man einen SSHA-Schlüssel als Passwort, der durch folgenden Befehl vom System generiert wird:</p><div class="bash"><div class="contents"><pre class="notranslate">slappasswd </pre></div></div><pre class="notranslate">New password: PASSWORT
Re-enter new password: PASSWORT
{SSHA}...</pre><p>Den so generierten Schlüssel muss man sich nun merken, er wird später für die Konfiguration benötigt.</p></div></div><div class="section_2"><h3 id="Konfiguration-mittels-slapd-conf">Konfiguration mittels <em>slapd.conf</em><a class="headerlink" href="#Konfiguration-mittels-slapd-conf">¶</a></h3><p>
</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Seit Ubuntu 8.10 wird nicht mehr die <strong>slapd.conf</strong>-Konfigurationsdatei verwendet, sondern die Konfiguration ins LDAP-Verzeichnis (<code class="notranslate">cn=config</code>) selbst geschrieben. Das hat einige Vorteile, u.a. dass der OpenLDAP-Server bei Konfigurationsänderungen nicht mehr neu gestartet werden muss. Die Vorteile werden allerdings mit einer etwas umständlicheren Konfiguration erkauft.
</p></div></div><p>Wer also statt der <code class="notranslate">cn=config</code> lieber die alte Konfigurationsmethode über die Datei <strong>slapd.conf</strong> verwenden will, erstellt die Datei <strong>slapd.conf</strong> im Verzeichnis <strong>/etc/ldap</strong> und kopiert nachfolgende Konfiguration in die Datei.</p><pre class="notranslate"># This is the main slapd configuration file. See slapd.conf for more
# info on the configuration options.

#######################################################################
# Global Directives:

# Features to permit
# allow bind_v2

# Schema and objectClass definitions
include         /etc/ldap/schema/core.schema
include         /etc/ldap/schema/cosine.schema
include         /etc/ldap/schema/nis.schema
include         /etc/ldap/schema/inetorgperson.schema

# Where the pid file is put. The init.d script
# will not stop the server if you change this.
pidfile         /var/run/slapd/slapd.pid

# List of arguments that were passed to the server
argsfile        /var/run/slapd/slapd.args

# Read slapd.conf(5) for possible values
loglevel        none

# Where the dynamically loaded modules are stored
modulepath    /usr/lib/ldap
moduleload    back_hdb

# The maximum number of entries that is returned for a search operation
sizelimit 500

# The tool-threads parameter sets the actual amount of cpu's that is used
# for indexing.
tool-threads 1

#######################################################################
# Specific Backend Directives for hdb:
# Backend specific directives apply to this backend until another
# 'backend' directive occurs
backend        hdb

#######################################################################
# Specific Backend Directives for 'other':
# Backend specific directives apply to this backend until another
# 'backend' directive occurs
#backend        &lt;other&gt;
database config
#######################################################################
# Specific Directives for database #1, of type hdb:
# Database specific directives apply to this databasse until another
# 'database' directive occurs
database        hdb

# The base of your directory in database #1
suffix          "dc=yourdomain,dc=tld"

# rootdn directive for specifying a superuser on the database. This is needed
# for syncrepl.
rootdn          "cn=admin,cn=config"

# Where the database file are physically stored for database #1
directory       "/var/lib/ldap"

# The dbconfig settings are used to generate a DB_CONFIG file the first
# time slapd starts.  They do NOT override existing an existing DB_CONFIG
# file.  You should therefore change these settings in DB_CONFIG directly
# or remove DB_CONFIG and restart slapd for changes to take effect.

# For the Debian package we use 2MB as default but be sure to update this
# value if you have plenty of RAM
dbconfig set_cachesize 0 2097152 0

# Sven Hartge reported that he had to set this value incredibly high
# to get slapd running at all. See http://bugs.debian.org/303057 for more
# information.

# Number of objects that can be locked at the same time.
dbconfig set_lk_max_objects 1500
# Number of locks (both requested and granted)
dbconfig set_lk_max_locks 1500
# Number of lockers
dbconfig set_lk_max_lockers 1500

# Indexing options for database #1
index           objectClass eq

# Save the time that the entry gets modified, for database #1
lastmod         on

# Checkpoint the BerkeleyDB database periodically in case of system
# failure and to speed slapd shutdown.
checkpoint      512 30

# Where to store the replica logs for database #1
# replogfile    /var/lib/ldap/replog

# The userPassword by default can be changed
# by the entry owning it if they are authenticated.
# Others should not be able to see it, except the
# admin entry below
# These access lines apply to database #1 only
# acl specific for phamm

access to attrs=userPassword,shadowLastChange
        by dn="cn=admin,dc=webhabitat,dc=be" write
        by anonymous auth
        by self write
        by * none

access to *
        by dn="cn=admin,dc=yourdomain,dc=tld" write
        by * read

access to dn.base="" by * read

# For Netscape Roaming support, each user gets a roaming
# profile for which they have write access to
#access to dn=".*,ou=Roaming,o=morsnet"
#        by dn="cn=admin,dc=yourdomain,dc=tld" write
#        by dnattr=owner write

#######################################################################
# Specific Directives for database #2, of type 'other' (can be hdb too):
# Database specific directives apply to this databasse until another
# 'database' directive occurs
#database        &lt;other&gt;

# The base of your directory for database #2
#suffix        "dc=debian,dc=org"</pre><p>Nun sucht man folgende Zeile und ändert diese nach seinen Bedürfnissen ab:</p><pre class="notranslate">suffix "dc=meinedomain,dc=local"</pre><p>Und am Ende der Datei fügt man Folgendes ein:</p><pre class="notranslate">rootdn "cn=admin,dc=meinedomain,dc=local"
rootpw {SSHA}...</pre><p>Dort fügt man den SSHA-Schlüssel ein, den man vorhin generiert habt.</p></div><div class="section_2"><h3 id="slapd-conf-aktivieren">slapd.conf "aktivieren"<a class="headerlink" href="#slapd-conf-aktivieren">¶</a></h3><p>
Jetzt muss die neue <strong>slapd.conf</strong> erst „aktiviert“ werden.</p><p>Zunächst stoppt man den LDAP-Server:</p><div class="bash"><div class="contents"><pre class="notranslate">/etc/init.d/slapd stop </pre></div></div><p>Danach geht man in den entsprechenden Ordner <strong>/etc/ldap</strong></p><p>Die alte Konfiguration <strong>slapd.d</strong> wird zunächst gesichert, z.B. im Terminal <sup><a href="#source-2">[2]</a></sup> mit</p><div class="bash"><div class="contents"><pre class="notranslate">mv slapd.d slapd.d.bck </pre></div></div><p>Danach erstellt man ein neues <strong>slapd.d</strong>-Verzeichnis und lädt die <strong>slapd.conf</strong></p><div class="bash"><div class="contents"><pre class="notranslate">mkdir slapd.d
slaptest -f slapd.conf -F slapd.d </pre></div></div><p>Nun sollte Folgendes erscheinen:</p><pre class="notranslate">config file testing succeeded</pre><p>Jetzt werden nur noch die Benutzerrechte der neuen Konfigurationsdatei geändert <sup><a href="#source-4">[4]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">chown -R openldap:openldap slapd.d </pre></div></div><p>Nun kann der LDAP-Server wieder gestartet werden:</p><div class="bash"><div class="contents"><pre class="notranslate">/etc/init.d/slapd start </pre></div></div><p>Jetzt könnte man die <strong>slapd.conf</strong> wieder löschen, es empfiehlt sich allerdings, diese für eine spätere Änderung beizubehalten. Dazu muss man diese allerdings wieder wie oben beschrieben Schritt für Schritt „aktivieren“.</p><p>Dies ist aber erst ab Ubuntu 8.10 nötig. Bei älteren Versionen reicht das Bearbeiten der <em>slapd.conf</em> und anschließende Neustarten des LDAP-Servers aus.</p></div><div class="section_2"><h3 id="LDAP-Admin-Benutzer-hinzufuegen">LDAP-Admin-Benutzer hinzufügen<a class="headerlink" href="#LDAP-Admin-Benutzer-hinzufuegen">¶</a></h3><p>
Im nächsten Schritt muss man dem LDAP-Server einen Verzeichnisadministrator mitteilen. Dazu erstellt man eine Datei <strong>base.ldif</strong>. Dort fügt man Folgendes ein:</p><pre class="notranslate">dn:dc=meinedomain,dc=local
objectClass: dcObject
objectClass: organization
o: meinedomain
dc: meinedomain

dn:cn=admin,dc=meinedomain,dc=local
objectClass: organizationalRole
cn: admin</pre><p>Dieses muss jetzt nur noch in die LDAP-Datenbank eingefügt werden.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -h &lt;hostname&gt; (-p &lt;port&gt;) -W -D cn=admin,dc=meinedomain,dc=local -f base.ldif </pre></div></div><p>
</p><pre class="notranslate">Enter LDAP Password: PASSWORT
adding new entry "dc=meinedomain,dc=local"
adding new entry "cn=admin,dc=meinedomain,dc=local"</pre><p>Jetzt überprüft man nur noch, ob der neue Benutzer auch eingetragen wurde:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -x </pre></div></div><p>
</p><pre class="notranslate"># extended LDIF
#
# LDAPv3
# base &lt;&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#
# meinedomain.local
dn: dc=meinedomain,dc=local
objectClass: dcObject
objectClass: organization
o: meinedomain
dc: meinedomain
# admin, meinedomain.local
dn: cn=admin,dc=meinedomain,dc=local
objectClass: organizationalRole
cn: admin
# search result
search: 2
result: 0 Success
# numResponses: 3
# numEntries: 2</pre><p>Damit ist die Konfiguration abgeschlossen und der LDAP-Server läuft.</p></div><div class="section_2"><h3 id="LDAP-Client-konfigurieren">LDAP Client konfigurieren<a class="headerlink" href="#LDAP-Client-konfigurieren">¶</a></h3><p>
Damit die Clients wissen, wo sie den LDAP-Server finden, müssen ihnen ein paar grundlegende Informationen bekannt gemacht werden. Dazu öffnet man die Datei <sup><a href="#source-3">[3]</a></sup> <strong>/etc/ldap/ldap.conf</strong> und ändert den Inhalt:</p><pre class="notranslate">ldap_version 3
URI ldap://meinedomain.local
SIZELIMIT 0
TIMELIMIT 0
DEREF never
BASE dc=meinedomain,dc=local </pre><p>Danach wird die Datei gespeichert und geschlossen.</p><p><a class="internal missing" href="../openldap.html#top">{top}</a>
<a class="crosslink anchor" href="#migration" id="migration"></a></p></div></div><div class="section_1"><h2 id="Linux-Benutzeraccounts-nach-LDAP-migrieren">Linux-Benutzeraccounts nach LDAP migrieren<a class="headerlink" href="#Linux-Benutzeraccounts-nach-LDAP-migrieren">¶</a></h2><p>
Für die Migration der in den Dateien <strong>/etc/passwd</strong> und <strong>/etc/group</strong> abgelegten Linux-Benutzer- und Gruppen-Accounts stellt Ubuntu ein Skript zur Verfügung. Dieses Skript ist Teil des Pakets <strong>smbldap-tools</strong>, das eigentlich Werkzeuge für die vereinfachte Konfiguration eines Samba-Servers zur Verfügung stellt. Es kann aber auch, ohne dass ein Samba-Server verwendet wird, benutzt werden. Nachfolgend die für die Migration erforderlichen Schritte:</p><ol class="arabic"><li><p>Anlegen der für die Migration benötigten LDAP-OUs</p></li></ol><p>Erstellen der Datei <strong>init.ldif</strong> im Verzeichnis <strong>/etc/ldap</strong>. Ersetze 'dc=meinedomain,dc=local' durch den eigenen Domänenname:</p><pre class="notranslate">dn: ou=Users,dc=meinedomain,dc=local
objectClass: organizationalUnit
ou: Users

dn: ou=Groups,dc=meinedomain,dc=local
objectClass: organizationalUnit
ou: Groups

dn: ou=Computers,dc=meinedomain,dc=local
objectClass: organizationalUnit
ou: Computers

dn: ou=Idmap,dc=meinedomain,dc=local
objectClass: organizationalUnit
ou: Idmap</pre><p>Diese müssen jetzt nur noch in die LDAP-Datenbank eingefügt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ldapadd -x -h &lt;hostname&gt; (-p &lt;port&gt;) -W -D cn=admin,dc=meinedomain,dc=local -f init.ldif </pre></div></div><p> 2. Installation und Konfiguration des Pakets</p><ul><li><p><strong>smbldap-tools</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install smbldap-tools </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install smbldap-tools </pre></div></div><p>
</p></div></div><p>Die Skripte aus dem <strong>smbldap-tools</strong>-Paket werden über die Dateien <strong>smbldap.conf</strong> und <strong>smbldap_bind.conf</strong> im Verzeichnis <strong>/etc/smbldap-tools</strong> konfiguriert. Das Verzeichnis ist nach der Installation des Paketes zwar vorhanden, es fehlen aber die Konfigurationsdateien. Die Vorlagen hierfür liegen unter <strong>/usr/share/doc/smbldap-tools/examples</strong>. Die nachfolgenden Befehle müssen immer als <a class="internal" href="../sudo.html">root</a> ausgeführt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">cd /etc/smbldap-tools
zcat /usr/share/doc/smbldap-tools/examples/smbldap.conf.gz &gt; smbldap.conf
cat /usr/share/doc/smbldap-tools/examples/smbldap_bind.conf &gt; smbldap_bind.conf
chmod 0644 smbldap.conf
chmod 0600 smbldap_bind.conf </pre></div></div><p>Anschließend die Datei <strong>smbldap.conf</strong> editieren und das LDAP-Suffix korrekt einstellen, d.h. auf das bei der Konfiguration von OpenLDAP (siehe oben) verwendete Suffix <code class="notranslate">dc=meinedomain,dc=local</code>. Wenn kein Samba-Server installiert ist, sollten die Einträge für <code class="notranslate">SID</code> und <code class="notranslate">sambaDomain</code> auskommentiert werden. Wenn kein TLS für den LDAP-Server verwendet wird, sollten auch die Werte für <code class="notranslate">verify</code>, <code class="notranslate">cafile</code>, <code class="notranslate">clientcert</code> und <code class="notranslate">clientkey</code> entfernt werden. Andernfalls entsprechend der <strong>slapd.conf</strong> bzw. des <em>cn=config</em>-Backends einstellen. Die abgeänderte Datei sollte dann in etwa so aussehen:</p><pre class="notranslate">...
##############################################################################
#
# General Configuration
#
##############################################################################

# Put your own SID. To obtain this number do: "net getlocalsid".
# If not defined, parameter is taking from "net getlocalsid" return
# SID="S-1-5-21-2252255531-4061614174-2474224977"

# Domain name the Samba server is in charged.
# If not defined, parameter is taking from smb.conf configuration file
# Ex: sambaDomain="IDEALX-NT"
# sambaDomain="DOMSMB"

##############################################################################
#
# LDAP Configuration
#
##############################################################################

# Notes: to use to dual ldap servers backend for Samba, you must patch
# Samba with the dual-head patch from IDEALX. If not using this patch
# just use the same server for slaveLDAP and masterLDAP.
# Those two servers declarations can also be used when you have 
# . one master LDAP server where all writing operations must be done
# . one slave LDAP server where all reading operations must be done
#   (typically a replication directory)

# Slave LDAP server
# Ex: slaveLDAP=127.0.0.1
# If not defined, parameter is set to "127.0.0.1"
slaveLDAP="127.0.0.1"

# Slave LDAP port
# If not defined, parameter is set to "389"
slavePort="389"

# Master LDAP server: needed for write operations
# Ex: masterLDAP=127.0.0.1
# If not defined, parameter is set to "127.0.0.1"
masterLDAP="127.0.0.1"

# Master LDAP port
# If not defined, parameter is set to "389"
masterPort="389"

# Use TLS for LDAP
# If set to 1, this option will use start_tls for connection
# (you should also used the port 389)
# If not defined, parameter is set to "1"
ldapTLS="0"

# How to verify the server's certificate (none, optional or require)
# see "man Net::LDAP" in start_tls section for more details
verify=""

# CA certificate
# see "man Net::LDAP" in start_tls section for more details
cafile=""

# certificate to use to connect to the ldap server
# see "man Net::LDAP" in start_tls section for more details
clientcert=""

# key certificate to use to connect to the ldap server
# see "man Net::LDAP" in start_tls section for more details
clientkey=""

# LDAP Suffix
# Ex: suffix=dc=IDEALX,dc=ORG
suffix="dc=meinedomain,dc=local"

# Where are stored Users
# Ex: usersdn="ou=Users,dc=IDEALX,dc=ORG"
# Warning: if 'suffix' is not set here, you must set the full dn for usersdn
usersdn="ou=Users,${suffix}"

# Where are stored Computers
# Ex: computersdn="ou=Computers,dc=IDEALX,dc=ORG"
# Warning: if 'suffix' is not set here, you must set the full dn for computersdn
computersdn="ou=Computers,${suffix}"

# Where are stored Groups
# Ex: groupsdn="ou=Groups,dc=IDEALX,dc=ORG"
# Warning: if 'suffix' is not set here, you must set the full dn for groupsdn
groupsdn="ou=Groups,${suffix}"

# Where are stored Idmap entries (used if samba is a domain member server)
# Ex: groupsdn="ou=Idmap,dc=IDEALX,dc=ORG"
# Warning: if 'suffix' is not set here, you must set the full dn for idmapdn
idmapdn="ou=Idmap,${suffix}"

# Where to store next uidNumber and gidNumber available for new users and groups
# If not defined, entries are stored in sambaDomainName object.
# Ex: sambaUnixIdPooldn="sambaDomainName=${sambaDomain},${suffix}"
# Ex: sambaUnixIdPooldn="cn=NextFreeUnixId,${suffix}"
sambaUnixIdPooldn="sambaDomainName=${sambaDomain},${suffix}"

# Default scope Used
scope="sub"

# Unix password encryption (CRYPT, MD5, SMD5, SSHA, SHA, CLEARTEXT)
hash_encrypt="SSHA"

# if hash_encrypt is set to CRYPT, you may set a salt format.
# default is "%s", but many systems will generate MD5 hashed
# passwords if you use "$1$%.8s". This parameter is optional!
crypt_salt_format=""

##############################################################################
# 
# Unix Accounts Configuration
# 
##############################################################################

# Login defs
# Default Login Shell
# Ex: userLoginShell="/bin/bash"
userLoginShell="/bin/bash"

# Home directory
# Ex: userHome="/home/%U"
userHome="/home/%U"

# Default mode used for user homeDirectory
userHomeDirectoryMode="700"

# Gecos
userGecos="System User"

# Default User (POSIX and Samba) GID
defaultUserGid="513"

# Default Computer (Samba) GID
defaultComputerGid="515"

# Skel dir
skeletonDir="/etc/skel"

# Default password validation time (time in days) Comment the next line if
# you don't want password to be enable for defaultMaxPasswordAge days (be
# careful to the sambaPwdMustChange attribute's value)
defaultMaxPasswordAge="45"

##############################################################################
#
# SAMBA Configuration
#
##############################################################################

# The UNC path to home drives location (%U username substitution)
# Just set it to a null string if you want to use the smb.conf 'logon home'
# directive and/or disable roaming profiles
# Ex: userSmbHome="\\PDC-SMB3\%U"
userSmbHome="\\PDC-SRV\%U"

# The UNC path to profiles locations (%U username substitution)
# Just set it to a null string if you want to use the smb.conf 'logon path'
# directive and/or disable roaming profiles
# Ex: userProfile="\\PDC-SMB3\profiles\%U"
userProfile="\\PDC-SRV\profiles\%U"

# The default Home Drive Letter mapping
# (will be automatically mapped at logon time if home directory exist)
# Ex: userHomeDrive="H:"
userHomeDrive="H:"

# The default user netlogon script name (%U username substitution)
# if not used, will be automatically username.cmd
# make sure script file is edited under dos
# Ex: userScript="startup.cmd" # make sure script file is edited under dos
userScript="logon.bat"

# Domain appended to the users "mail"-attribute
# when smbldap-useradd -M is used
# Ex: mailDomain="idealx.com"
mailDomain="idealx.com"

##############################################################################
#
# SMBLDAP-TOOLS Configuration (default are ok for a RedHat)
#
##############################################################################

# Allows not to use smbpasswd (if with_smbpasswd == 0 in smbldap_conf.pm) but
# prefer Crypt::SmbHash library
with_smbpasswd="0"
smbpasswd="/usr/bin/smbpasswd"

# Allows not to use slappasswd (if with_slappasswd == 0 in smbldap_conf.pm)
# but prefer Crypt:: libraries
with_slappasswd="0"
slappasswd="/usr/sbin/slappasswd"

# comment out the following line to get rid of the default banner
# no_banner="1"</pre><p>Zum Schluss werden noch in der Datei <strong>smbldap_bind.conf</strong> die Einträge für den LDAP-Administrator und dessen Passwort angepasst. Dass Passwort muss als Klartext hinterlegt werden, weswegen die Zugriffsrechte weiter oben auf <a class="internal" href="../sudo.html">root</a> beschränkt worden sind:</p><pre class="notranslate">############################
# Credential Configuration #
############################
# Notes: you can specify two differents configuration if you use a
# master ldap for writing access and a slave ldap server for reading access
# By default, we will use the same DN (so it will work for standard Samba
# release)
slaveDN="cn=admin,dc=meinedomain,dc=local"
slavePw="1234"
masterDN="cn=admin,dc=meinedomain,dc=local"
masterPw="1234"</pre><p> 3. Linux-Benutzeraccounts nach LDAP migrieren</p><p>Mit Hilfe des Skripts <strong>smbldap-migrate-unix-accounts</strong> werden alle Linux-Benutzer und Passwörter nach LDAP migriert. Das Skript verwendet dabei die Konfigurationsdatei von smbldap-tools (<strong>/etc/smbldap-tools/smbldap.conf</strong>).</p><p>Normalerweise sollten nicht alle Benutzer aus der <strong>/etc/passwd</strong> nach LDAP übernommen werden. Insbesondere die Systembenutzer (<code class="notranslate">root</code>, <code class="notranslate">sys</code>, <code class="notranslate">daemon</code>, ...) belässt man besser lokal in der <strong>/etc/passwd</strong>, da diese Accounts nicht über LDAP an die anderen PCs im Netz exportiert werden sollten. Deshalb erstellt man zuerst eine Kopie der <strong>/etc/passwd</strong> und entfernt dort alle System- und Computeraccounts.</p><div class="bash"><div class="contents"><pre class="notranslate">cd /root
zcat /usr/share/doc/smbldap-tools/examples/migration_scripts/smbldap-migrate-unix-accounts.gz &gt; smbldap-migrate-unix-accounts
chmod u+x smbldap-migrate-unix-accounts
cp /etc/passwd passwd.users
vi passwd.users
... (Benutzer entfernen, die nicht importiert werden sollen) </pre></div></div><p>Jetzt können die zu migrierenden Accounts in die LDAP-Datenbank übernommen werden:</p><div class="bash"><div class="contents"><pre class="notranslate">./smbldap-migrate-unix-accounts -P passwd.users -S /etc/shadow -v </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Die Datei <strong>/etc/shadow</strong> kann direkt verwendet werden, da hieraus nur die Zeilen mit entsprechendem Eintrag in der angegebenen <strong>passwd.users</strong>-Datei übernommen werden. 
</p></div></div><p> 4. Linux-Gruppen nach LDAP migrieren</p><p>Die Migration der Linux-Gruppen funktioniert nach demselben Prinzip wie die Migration der Benutzer. Es werden nur die Gruppen in die Datenbank übertragen, die nicht Systemgruppen sind.</p><div class="bash"><div class="contents"><pre class="notranslate">zcat /usr/share/doc/smbldap-tools/examples/migration_scripts/smbldap-migrate-unix-groups.gz &gt; smbldap-migrate-unix-groups
chmod u+x smbldap-migrate-unix-groups
cp /etc/group group.import
vi group.import
... (Gruppen entfernen, die nicht importiert werden sollen)
./smbldap-migrate-unix-groups -G group.import -v </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Falls das Hinzufügen von Benutzern oder Gruppen fehlschlägt (bisher nur unter Ubuntu 11.10 aufgetreten) muss man die Dateien <strong>smbldap-migrate-unix-groups</strong> und <strong>smbldap-migrate-unix-accounts</strong> editieren:
Man sucht die Zeile mit dem Eintrag <strong>my $ldap_master=connect_ldap_master();</strong> und fügt darunter folgendes ein:
</p></div></div><p>
</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="nv">$ldap_master</span><span class="o">-&gt;</span><span class="nb">bind</span> <span class="p">(</span> <span class="s">"cn=admin,dc=meinedomain,dc=local"</span><span class="p">,</span>
                       <span class="n">password</span> <span class="o">=&gt;</span> <span class="s">"1234"</span><span class="p">,</span>
                       <span class="n">version</span> <span class="o">=&gt;</span> <span class="mi">3</span> <span class="p">);</span>
</pre></div>
</td></tr></table></div><p>Man muss eventuell die Werte für das Passwort und den Adminuser anpassen.</p><p> 5. Test, ob die Linux-Benutzer und -Gruppen im LDAP-Verzeichnis eingetragen sind</p><p>Nach Eingabe von</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -x -D cn=admin,dc=meinedomain,dc=local -W -b dc=meinedomain,dc=local </pre></div></div><p>sollten alle Benutzer und Gruppen mit den dazugehörigen Attributen angezeigt werden.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Ubuntu verwendet zumindest seit Release 9.10 standardmäßig Simple Authentication and Security Layer (SASL) als Authentifizierungs-Framework für <strong>OpenLDAP</strong>. Damit das korrekt funktioniert, müssen die Passwörter der LDAP-Benutzer im LDAP-Directory als Klartext im Attribut userPassword hinterlegt sein. Das Migrationsscript hinterlegt sie aber standardmäßig verschlüsselt. In diesem Fall funktioniert nur die einfache Authentifizierung am LDAP-Server, z. B. mittels <code class="notranslate">ldapsearch -x -D cn=carmen,dc=meinedomain,dc=local -W -b dc=meinedomain,dc=local</code> für die Benutzerin <code class="notranslate">carmen</code>. Die deutlich sichere Methode über SASL mittels: <code class="notranslate">ldapsearch -b dc=meinedomain,dc=local</code> scheitert nach der Passwortabfrage durch SASL mit Fehlermeldung <code class="notranslate">Invalid credentials (49)</code>. Abhilfe schafft, die Passwörter nochmals neu zu setzen, wie im nachfolgenden Kapitel gezeigt.
</p></div></div><p><a class="internal missing" href="../openldap.html#top">{top}</a></p></div><div class="section_1"><h2 id="Verwendung-von-SASL">Verwendung von SASL<a class="headerlink" href="#Verwendung-von-SASL">¶</a></h2><p>
Die von OpenLDAP bereitgestellten LDAP-Client-Tools wie <code class="notranslate">ldapsearch</code> und <code class="notranslate">ldapmodify</code> versuchen standardmäßig, die Benutzer am LDAP-Verzeichnis-Server über Simple Authentication and Security Layer (SASL) mit DIGEST-MD5-Mechanismus zu authentifizieren. Daneben gibt es noch eine einfache Authentifizierung (mittels Option <code class="notranslate">-x</code>), die in den vorangegangenen Installations- und Konfigurationskapiteln zur Anwendung kam. Mit ein paar zusätzlichen Schritten kann aber jedem Benutzer der Zugriff auf das LDAP-Verzeichnis mittels SASL-Authentifizierung ermöglicht werden. Dazu müssen die Linux-Benutzeraccounts wie vorangehend beschrieben in das LDAP-Verzeichnis migriert werden. Darüber hinaus müssen einige Attribute im <em>cn=config</em>-Backend bzw. der Konfigurationsdatei <strong>slapd.conf</strong> (im Verzeichnis <strong>/etc/ldap</strong>) korrekt gesetzt sein.</p><p>Für den Fall der Konfiguration mittels <em>cn=config</em>-Backend muss eine Datei <strong>sasl-digestmd5.ldif</strong> im Verzeichnis <strong>/etc/ldap</strong> mit nachfolgendem Inhalt erstellt werden.</p><pre class="notranslate">###########################################################
# DEFAULTS MODIFICATION for SASL DIGEST-MD5
###########################################################
# Some of the defaults need to be modified in order to allow
# SASL supported access to the LDAP config. 

# The LDAP administrator will need to tell the slapd server 
# how to map an authentication request DN to a user's 
# authentication DN. This is done by adding one or more 
# olcAuthzRegexp attributes to the cn=config backend. 
# This attribute takes two arguments:
#
# olcAuthzRegexp   &lt;search pattern&gt;   &lt;replacement pattern&gt;
# 
# Please note, that more than one attribute can be specified. 
# The LDAP server will serve them sequentially.

dn: cn=config
changetype: modify
add: olcAuthzRegexp
olcAuthzRegexp: uid=root,cn=[^,]*,cn=auth cn=admin,dc=meinedomain,dc=local

dn: cn=config
changetype: modify
add: olcAuthzRegexp
olcAuthzRegexp: uid=([^,]*),cn=[^,]*,cn=auth uid=$1,ou=Users,dc=meinedomain,dc=local

# set the correct authentication policy
dn: cn=config
changetype: modify
add: olcAuthzPolicy
olcAuthzPolicy: to

# User passwords have to stored as cleartext within the 
# LDAP directory
dn: olcDatabase={-1}frontend,cn=config
changetype: modify
add: olcPasswordHash
olcPasswordHash: {CLEARTEXT}</pre><p>Diese muss dann anschließend in das LDAP-Backend eingefügt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -D cn=admin,cn=config -W -f /etc/ldap/sasl-digestmd5.ldif </pre></div></div><p>Falls OpenLDAP noch über <strong>slapd.conf</strong> im Verzeichnis <strong>/etc/ldap</strong> konfiguriert wird, müssen folgende Einträge hinzugefügt bzw. angepasst werden.</p><pre class="notranslate"># SASL DIGEST-MD5 authorisation replacement directive
# This parameter is in the format of:
# uid=&lt;username&gt;,cn=&lt;realm&gt;,cn=&lt;mech&gt;,cn=auth
# The username is taken from sasl and inserted into the ldap search 
# string in the place of $1. Your realm is supposed to be your FQDN 
# (fully qualified domain name)
authz-regexp uid=admin,cn=[^,]*,cn=auth cn=admin,dc=meinedomain,dc=local
authz-regexp uid=([^,]*),cn=[^,]*,cn=auth uid=$1,ou=Users,dc=meinedomain,dc=local
authz-policy      to
# enable LDAP to help SASL to use passworts stored in LDAP database
password-hash   {CLEARTEXT}</pre><p>Neustart von <code class="notranslate">slapd</code> mittels:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo /etc/init.d/slapd restart </pre></div></div><p>Nun müssen noch die Passwörter in Klartext im LDAP-Verzeichnis hinterlegt werden. Dazu muss das Passwort neu gesetzt werden. Dies kann jeder Benutzer (z. B. <code class="notranslate">carmen</code>) selber durchführen:</p><div class="bash"><div class="contents"><pre class="notranslate">ldappasswd -x -D uid=carmen,ou=Users,dc=meinedomain,dc=local -W -s MeinPasswort uid=carmen,ou=Users,dc=meinedomain,dc=local </pre></div></div><p>oder der LDAP-Administrator (durch Neuvergabe)</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ldappasswd -x -D cn=admin,dc=meinedomain,dc=local -W -s NeuesPasswort uid=carmen,ou=Users,dc=meinedomain,dc=local </pre></div></div><p>Nach Eingabe von</p><div class="bash"><div class="contents"><pre class="notranslate">carmen@MeinComputer:~$ ldapsearch -b dc=meinedomain,dc=local </pre></div></div><p>und dem Passwort sollte jeder Benutzer die im LDAP-Verzeichnis hinterlegten Benutzer und Gruppen mit den dazugehörigen Attributen angezeigt bekommen.</p><pre class="notranslate">SASL/DIGEST-MD5 authentication started
Please enter your password: 
SASL username: carmen
SASL SSF: 128
SASL data security layer installed.
# extended LDIF
#
# LDAPv3
# base &lt;dc=meinedomain,dc=local&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# meinedomain.local
dn: dc=meinedomain,dc=local
objectClass: dcObject
objectClass: organization
o: meinedomain.local
dc: meinedomain
description: Tree root

# admin, meinedomain.local
dn: cn=admin,dc=meinedomain,dc=local
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
...</pre><p>Zum Abschluss muss auch noch dass Passwort des LDAP-Verzeichnis-Administrators (<em>cn=admin,dc=meinedomain,dc=local</em>) in Klartext in dem LDAP-Verzeichnis hinterlegt werden. Ganz zu Beginn der Installation des OpenLDAP-Servers wurde ja nur ein Passwort-Hash eingetragen. Der von den LDAP-Client-Tools standardmäßig für die Benutzerauthentifizierung verwendete SASL-DIGEST-MD5-Mechanismus erfordert aber zwingend die Ablage der Passwörter in Klartext im LDAP-Verzeichnis. LDAP-Abfragen durch den Ubuntu-Superuser <a class="internal" href="../sudo.html">root</a> wie z. B. 
</p><pre class="notranslate">sudo ldapsearch -b ou=Users,dc=meinedomain,dc=local -LLL uid=carmen
SASL/DIGEST-MD5 authentication started
Please enter your password: 
SASL username: root
SASL SSF: 128
SASL data security layer installed</pre><p>
werden aus Sicherheitsgründen mittels der oben definierten Authentication-Replace-Anweisung <code class="notranslate">authz-regexp uid=admin,cn=[^,]*,cn=auth cn=admin,dc=meinedomain,dc=local</code> über den LDAP-Admin authentifiziert. Unter <code class="notranslate">Please enter your password:</code> ist deshalb das Passwort des LDAP-Admin einzugeben (z. B. "1234"). So kann <a class="internal" href="../sudo.html">root</a>, ohne selbst im LDAP-Verzeichnis abgelegt zu sein, auf dasselbe zugreifen. Die Hinterlegung des Passwortes in Klartext erfolgt über
</p><div class="bash"><div class="contents"><pre class="notranslate">ldappasswd -x -D cn=admin,dc=meinedomain,dc=local -W -S cn=admin,dc=meinedomain,dc=local </pre></div></div><p><a class="internal missing" href="../openldap.html#top">{top}</a></p></div><div class="section_1"><h2 id="Sichere-bertragung-mit-TLS-SSL">Sichere Übertragung mit TLS/SSL<a class="headerlink" href="#Sichere-bertragung-mit-TLS-SSL">¶</a></h2><p>
Nach der sicheren Authentifizierung geht es nun an den verschlüsselten Transport der Informationen zwischen LDAP-Server und Client. Dafür wird das Verschlüsselungsprotokoll Transport Layer Security (TLS), auch bekannt unter der früheren Bezeichnung Secure Sockets Layer (SSL), herangezogen. Der in Ubuntu zur Verfügung gestellte OpenLDAP-Server (slapd) und die OpenLDAP-Clients verwenden GnuTLS als TLS-Bibliothek. Das löst zwar Lizenzprobleme, bringt aber einige Komplikationen mit sich, die das Einrichten von Transport Layer Security in OpenLDAP schnell zu einem Alptraum werden lassen können. Es ist deshalb ratsam, durch striktes Befolgen der Anleitung zunächst einen funktionierenden TLS-Layer einzurichten. Anschließend kann man diesen dann den eigenen Bedürfnissen entsprechend weiter anpassen. Wie SASL ist auch die Verschlüsselung mittels TLS zwingend erforderlich, um einen LDAP v3 kompatiblen LDAP-Verzeichnisdienst zu betreiben.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>slapd verzeiht Fehler bei der Konfiguration von TLS nicht. Gewöhnlich lässt sich der Dämon dann erst einmal nicht mehr starten und somit auch nicht mehr konfigurieren. Stattdessen beglückt der Dämon den frustrierten Nutzer auch bei höchster Debug-Stufe mit einer (!) einzigen nichtssagenden Fehlermeldung: <em><code class="notranslate">TLS init def ctx failed: -1</code></em>.</p><p>In diesem Fall bleibt nur noch der Ausweg, durch Eingabe von <code class="notranslate">dpkg-reconfigure slapd</code> das <em>cn=config</em>-Backend in den Ausgangszustand zurückzusetzen. Alle bis hier erfolgten Konfigurationsschritte an dem Backend müssen dann wieder neu ausgeführt werden. Es wird daher nochmals dringend empfohlen, die für die Konfiguration verwendeten <strong>.ldif</strong>-Dateien im Verzeichnis <strong>/etc/ldap/</strong> abzulegen. Nur so lässt sich OpenLDAP zügig reparieren. Sollten zwischenzeitlich schon Daten in das eigentliche LDAP-Verzeichnis eingetragen worden sein, ist das kein Problem. Solange man nicht in Panik gerät und ruhig und gezielt die Konfiguration des Backends wiederherstellt, bleiben alle (!) Verzeichnisdaten erhalten!
</p></div></div><div class="section_2"><h3 id="Erstellung-der-benoetigten-Server-Zertifikate">Erstellung der benötigten Server-Zertifikate<a class="headerlink" href="#Erstellung-der-benoetigten-Server-Zertifikate">¶</a></h3><p>
OpenLDAP benötigt X.509-Zertifikate zur Verschlüsselung der Daten. Es wird zwischen Server- und Client-Zertifikaten unterschieden. LDAP v3-konforme Server müssen auf gültige Zertifikate zurückgreifen können. Für LDAP-Clients ist die Verwendung von eigenen Zertifikaten optional und wird deshalb hier nicht weiter beschrieben. Um das Server-Zertifikat zu generieren, gibt es drei Möglichkeiten:</p><ol class="arabic"><li><p>Selbstsigniertes Zertifikat</p></li><li><p>Bezug von einer Zertifizierungsstelle (<em>Certification Authority</em>)</p></li><li><p>Einrichtung und Verwendung einer eigenen Zertifizierungsstelle</p></li></ol><p>
</p><div class="section_3"><h4 id="Selbstsigniertes-Zertifikat">Selbstsigniertes Zertifikat<a class="headerlink" href="#Selbstsigniertes-Zertifikat">¶</a></h4><p>
Hier macht es Sinn, die eher noch nicht so ausgereifte, dafür aber schnell und einfach zu verwendende GnuTLS-Bibliothek einzusetzen, gegen die ja auch OpenLDAP kompiliert wurde:</p><ul><li><p><strong>gnutls-bin</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install gnutls-bin </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install gnutls-bin </pre></div></div><p>
</p></div></div><p>Für TLS werden zwei Zertifikate und ein privater Schlüssel benötigt. Die Erstellung erfolgt am besten in einem eigenen Arbeitsverzeichnis, das hinterher ggf. auch wieder gelöscht werden kann:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mkdir /var/ssl
cd /var/ssl </pre></div></div><div class="section_4"><h5 id="CA-Zertifikat-cacert-pem">CA-Zertifikat (cacert.pem)<a class="headerlink" href="#CA-Zertifikat-cacert-pem">¶</a></h5><p>
Für die Erstellung des Zertifikats wird eine Konfigurationsdatei (<strong>/var/ssl/ca.cfg</strong>) benötigt:</p><pre class="notranslate">cn = meinedomain
ca
cert_signing_key</pre><p>Mit Hilfe der Konfigurationsdaten erstellt man das CA-Zertifikat wie folgt:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo sh -c "certtool --generate-privkey &gt; cakey.pem" </pre></div></div><div class="bash"><div class="contents"><pre class="notranslate">sudo certtool --generate-self-signed --load-privkey cakey.pem --template ca.cfg --outfile cacert.pem </pre></div></div></div><div class="section_4"><h5 id="Privater-Schluessel-fuer-Server-Zertifikat-ldap-slapd-key-pem">Privater Schlüssel für Server-Zertifikat (ldap_slapd_key.pem)<a class="headerlink" href="#Privater-Schluessel-fuer-Server-Zertifikat-ldap-slapd-key-pem">¶</a></h5><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo sh -c "certtool --generate-privkey &gt; ldap_slapd_key.pem </pre></div></div></div><div class="section_4"><h5 id="Server-Zertifikat-ldap-slapd-cert-pem">Server-Zertifikat (ldap_slapd_cert.pem)<a class="headerlink" href="#Server-Zertifikat-ldap-slapd-cert-pem">¶</a></h5><p>
Auch für das Server-Zertifikat wird eine Konfigurationsdatei (<strong>/var/ssl/slapd.cfg</strong>) benötigt:</p><pre class="notranslate">organization = meinedomain
cn = ldap.meinedomain.local
tls_www_server
encryption_key
signing_key</pre><p>Der <em>common name</em> im Zertifikat muss dabei auf den eindeutigen, vollständigen Namen (FQDN) des LDAP-Servers verweisen, da sonst LDAP-Clients ggf. das Zertifikat nur nach Rückfrage beim Benutzer akzeptieren. Der Befehl:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo certtool --generate-certificate --load-privkey ldap_slapd_key.pem --load-ca-certificate cacert.pem --load-ca-privkey cakey.pem --template slapd.cfg --outfile ldap_slapd_cert.pem </pre></div></div><p>erstellt das Server-Zertifikat.</p></div></div><div class="section_3"><h4 id="Bereitstellung-durch-eine-eigene-Zertifizierungsstelle">Bereitstellung durch eine eigene Zertifizierungsstelle<a class="headerlink" href="#Bereitstellung-durch-eine-eigene-Zertifizierungsstelle">¶</a></h4><p>
Wer sich schon eine eigene CA aufgebaut hat, besitzt genügend Erfahrung, um sich das für den LDAP-Server benötigte Zertifikat selbst zu erstellen und zu beglaubigen. Für diese Experten geht es im Abschnitt <a class="crosslink" href="#Installation-des-LDAP-Server-Zertifikats">Installation</a> weiter. Für alle anderen wird nachfolgend exemplarisch das Vorgehen skizziert. Dreh- und Angelpunkt ist die Erstellung einer eigenen, dauerhaften Zertifizierungsstelle. Dafür empfiehlt sich die Verwendung der ausgereifteren OpenSSL-Bibliothek, die auf den meisten Ubuntu-Installationen ohnehin schon vorhanden ist.</p><ul><li><p><strong>openssl</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install openssl </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install openssl </pre></div></div><p>
</p></div></div><div class="section_4"><h5 id="CA-cacert-pem">CA (cacert.pem)<a class="headerlink" href="#CA-cacert-pem">¶</a></h5><p>
Der Wiki-Artikel <a class="internal" href="../ca.html">CA</a> beschreibt den Aufbau der Zertifizierungsstelle und die Erstellung des zugehörigen Stammzertifikats <strong>cacert.pem</strong>. Ein steinaltes, aber sehr empfehlenswertes HowTo mit vielen weiteren Informationen dazu gibt es <a class="external" href="http://tldp.org/HOWTO/SSL-Certificates-HOWTO/" rel="nofollow">hier</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/>.</p><p>Die Erstellung und Verwaltung der eigenen <em>Certification Authority</em> erfolgt am besten in einem eigenen Arbeitsverzeichnis. In dem vorliegenden Artikel wird vom Verzeichnis <strong>/var/ssl</strong> ausgegangen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mkdir /var/ssl
cd /var/ssl </pre></div></div><p>
Will man die Zertifizierungsstelle wie in <a class="internal" href="../ca.html">CA</a> beschrieben mit Hilfe des Skripts <strong>CA.pl</strong> erstellen, muss man im Skript noch folgende Variable anpassen:</p><pre class="notranslate">$CATOP="/var/ssl"; </pre><p>
damit Zertifikate und weitere Daten nicht in einem demoCA-Unterverzeichnis abgelegt werden.</p><p>Aufgrund der Sensivität der Daten sollten alle Aktivitäten als Benutzer <em>root</em> (mit <code class="notranslate">sudo</code>) ausgeführt werden.
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo /usr/lib/ssl/misc/CA.pl -newca </pre></div></div><p>Das Stammzertifikat <strong>cacert.pem</strong> sollte sich nun im Verzeichnis <strong>/var/ssl</strong> befinden. Da es sich um ein reales, wenn auch eigenes Stammzertifikat handelt, muss es noch System-weit bekannt gemacht werden. Dazu wird es in die offizielle Stammzertifikatsliste im Verzeichnis <strong>/etc/ssl/certs</strong> eingefügt:</p><div class="bash"><div class="contents"><pre class="notranslate">openssl x509 -text -fingerprint -in /var/ssl/cacert.pem &gt; meinedomain.crt
cat /etc/ssl/certs/ca-certificates.crt meinedomain.crt &gt; ca-certificates.crt
sudo mv ca-certificates.crt /etc/ssl/certs/ca-certificates.crt </pre></div></div></div><div class="section_4"><h5 id="LDAP-Server-Zertifikat">LDAP-Server-Zertifikat<a class="headerlink" href="#LDAP-Server-Zertifikat">¶</a></h5><p>
Hat man in ersten Schritt alles richtig gemacht, befinden sich die eigene Stammzertifizierungsstelle und das zugehörige Zertifikat im Verzeichnis <strong>/var/ssl</strong>. Nun wird ausgehend vom Verzeichnis <strong>/var/ssl</strong> das eigentliche Server-Zertifikat erstellt. Dafür wird eine eigene angepasste Konfigurationsdatei verwendet:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp /usr/lib/ssl/openssl.cnf /etc/ssl </pre></div></div><p>
Die Datei <strong>/etc/ssl/openssl.cnf</strong> editieren und folgende Sektionen hinzufügen:
</p><pre class="notranslate">####################################################################
[ server_ca ]

dir		= /var/ssl		# Where everything is kept
certs		= $dir/certs		# Where the issued certs are kept
crl_dir		= $dir/crl		# Where the issued crl are kept
database	= $dir/index.txt	# database index file.
unique_subject	= no			# Set to 'no' to allow creation of
					# several ctificates with same subject.
new_certs_dir	= $dir/newcerts		# default place for new certs.

certificate	= $dir/cacert.pem 	# The CA certificate
serial		= $dir/serial 		# The current serial number
#crlnumber	= $dir/crlnumber	# the current crl number
					# must be commented out to leave a V1 CRL
crl		= $dir/crl.pem 		# The current CRL
private_key	= $dir/private/cakey.pem# The private key
RANDFILE	= $dir/private/.rand	# private random number file

x509_extensions	= v3_server		# The extentions to add to the cert

# Comment out the following two lines for the "traditional"
# (and highly broken) format.
name_opt 	= ca_default		# Subject Name options
cert_opt 	= ca_default		# Certificate field options

default_days	= 365			# how long to certify for
default_crl_days= 30			# how long before next CRL
default_md	= sha1			# which md to use.
preserve	= no			# keep passed DN ordering

# A few difference way of specifying how similar the request should look
# For type CA, the listed attributes must be the same, and the optional
# and supplied fields are just that :-)
policy		= policy_anything	# For the server policy

[ v3_server ]

# These extensions are added when 'ca' signs a request.

# This goes against PKIX guidelines but some CAs do it and some software
# requires this to avoid interpreting an end user certificate as a CA.

basicConstraints=CA:FALSE

# Here are some examples of the usage of nsCertType. If it is omitted
# the certificate can be used for anything *except* object signing.

# This is OK for an SSL server.
nsCertType			= server

# This is typical in keyUsage for a server certificate.
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, msSGC, nsSGC

# This will be displayed in Netscape's comment listbox.
nsComment = "OpenSSL Generated Server Certificate"

# PKIX recommendations harmless if included in all certificates.
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer:always

# This stuff is for subjectAltName and issuerAltname.
# Import the email address.
subjectAltName=email:copy

# Copy subject details
issuerAltName=issuer:copy</pre><p>Anschließend erstellt man eine Zertifikatsanforderung und den privaten Schlüssel <strong>ldap_slapd_key.pem</strong> für das neue Zertifikat:</p><div class="bash"><div class="contents"><pre class="notranslate">ce /var/ssl
sudo openssl req -new -config /etc/ssl/openssl.cnf -nodes -keyout ldap_slapd_key.pem -out ldap_slapd_req.pem -days 730 -passin pass:whatever -passout pass:whatever </pre></div></div><p>OpenSSL verlangt mehrere Benutzereingaben, die nachfolgend erläutert werden:</p><pre class="notranslate">Country Name (2 letter code) [AU]:                                # z.B. DE
State or Province Name (full name) [Some-State]:                  # kann ausgelassen werden
Locality Name (eg, city) []:                                      # z.B. Mönchengladbach
Organization Name (eg, company) [Internet Widgits Pty Ltd]:       # z.B. meinedomain oder Gas, Wasser Scheisse GmbH
Organizational Unit Name (eg, section) []:                        # kann man wieder auslassen
Common Name (eg, YOUR name) []:                                   # FQDN des LDAP-Servers
                                                                  # z.B. ldap.meinedomain.local
Email Address []:                                                 # z.B. postmaster@meinedomain.local
Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:                                          # Passwort eingeben wie unter passin/passout, z. B. whatever
An optional company name []:                                      # &lt;Enter&gt; drücken</pre><p>Das Passwort für die Verschlüsselung der Anforderung sollte natürlich entsprechend angepasst werden. Anschließend wird die erste Rohform des Server-Zertifikats erstellt und von der eigenen CA signiert:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo openssl ca -config /etc/ssl/openssl.cnf -name server_ca  -out newcert.pem -infiles ldap_slapd_req.pem  </pre></div></div><p>Die Datei <em>newcert.pem</em> enthält die erste Version des X.509-Zertifikats. Aus dieser wird nun das eigentliche LDAP-Server-Zertifikat <strong>ldap_slapd_cert.pem</strong> erzeugt:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo openssl pkcs12 -export -in newcert.pem -inkey ldap_slapd_key.pem -out ldap_slapd_cert.p12 -clcerts -passin pass:whatever -passout pass:whatever
sudo openssl pkcs12 -in ldap_slapd_cert.p12 -out ldap_slapd_cert.pem -passin pass:whatever -passout pass:whatever </pre></div></div><p>Natürlich ist auch hier das verwendete Passwort anzupassen.</p></div></div></div><div class="section_2"><h3 id="Installation-des-LDAP-Server-Zertifikats">Installation des LDAP-Server-Zertifikats<a class="headerlink" href="#Installation-des-LDAP-Server-Zertifikats">¶</a></h3><p>
</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Grundsätzlich sollten die für TLS benötigten Zertifikate an jedem beliebigen Ort ablegbar sein. Wenn allerdings <a class="internal" href="../apparmor.html">AppArmor</a> aktiviert ist (wie es in Ubuntu Standard ist) müssen die Zertifikate für OpenLDAP mit GnuTLS an passender Stelle abgelegt werden. Mögliche Verzeichnisse sind u.a. <strong>/etc/ssl/certs/</strong>, <strong>/usr/local/share/ca-certificates/</strong> (letzteres mit Unterverzeichnissen) und <strong>/etc/ssl/private/</strong> für den privaten Schlüssel.
</p></div></div><p>Im Verzeichnis <strong>/var/ssl/</strong> befinden sich nun alle benötigten Dateien:
</p><ul><li><p>Stammzertifikat <strong>cacert.pem</strong></p></li><li><p>Server-Zertifikat <strong>ldap_slapd_cert.pem</strong></p></li><li><p>privater Schlüssel für Server-Zertifikat <strong>ldap_slapd_key.pem</strong>.</p></li></ul><p>
Diese werden nun ins zentrale Verzeichnis <strong>/etc/ssl/certs</strong> installiert:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo install -D -o openldap -g openldap -m 600 /var/ssl/ldap_slapd_key.pem  /etc/ssl/private/ldap_slapd_key.pem
sudo install -D -o openldap -g openldap -m 600 /var/ssl/ldap_slapd_cert.pem  /etc/ssl/certs/ldap_slapd_cert.pem
sudo install -D -o openldap -g openldap -m 600 /var/ssl/cacert.pem  /etc/ssl/certs/ldap_slapd_cacert.pem </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Sollte man den privaten Schlüssel auf einer anderen Maschine erstellt haben so kann dies unter Umständen dazu führen, dass der Server sich immer mit folgender Fehlermeldung beendet:
</p><pre class="notranslate">TLS init def ctx failed: -207</pre><p>In diesem Fall hilft es den Inhalt der privaten Schlüsseldatei (<strong>/etc/ssl/certs/ldap_slapd_cacert.pem</strong>) durch die Ausgabe des Befehls "<code class="notranslate">certtool --infile /etc/ssl/certs/ldap_slapd_cacert.pem -k</code>" ab der Zeile
</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>-----BEGIN PRIVATE KEY-----
</pre></div>
</td></tr></table></div><p>
zu ersetzen.
</p></div></div></div><div class="section_2"><h3 id="Anpassung-der-Konfiguration-cn-config-Datenbank">Anpassung der Konfiguration (cn=config-Datenbank)<a class="headerlink" href="#Anpassung-der-Konfiguration-cn-config-Datenbank">¶</a></h3><p>
Jetzt muss noch dem LDAP-Serverdämon <strong>slpad</strong> mitgeteilt werden, dass er TLS verwenden soll. Dazu erstellt man die Datei <strong>/etc/ldap/tls.ldif</strong> mit folgendem Inhalt:
</p><pre class="notranslate">###########################################################
# CONFIGURATION for Support of TLS
###########################################################
# Add TLS supported access to user passwords for LDAP clients
# to the LDAP config. 

#dn: cn=config
#changetype: modify
#delete: olcTLSCACertificateFile

dn: cn=config
changetype: modify
add: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/ssl/certs/ldap_slapd_cacert.pem

#dn: cn=config
#changetype: modify
#delete: olcTLSCertificateKeyFile

dn: cn=config
changetype: modify
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap_slapd_key.pem

#dn: cn=config
#changetype: modify
#delete: olcTLSCertificateFile

dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap_slapd_cert.pem</pre><p>Diese muss dann ins LDAP-Backend eingefügt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -D cn=admin,cn=config -W -f /etc/ldap/tls.ldif </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Von einer Konfiguration des Parameters <em>TLSCipherSuite</em>, wie in manchen Anleitungen vorgeschlagen, sollte abgesehen werden. GnuTLS sucht sich ohnehin die sicherste Verschlüsselung aus. Wird hingegen ein falscher Wert für die <em>TLSCipherSuite</em> eingegeben, startet <strong>slapd</strong> nicht mehr und muss neu konfiguriert werden.
</p></div></div><p>OpenLDAP unterstützt zwei Verfahren zum Aufbau einer sicheren Kommunikation zwischen LDAP-Server und Client über TLS/SSL:
</p><ul><li><p><em>StartTLS</em> ist eine LDAP-Operation zwischen LDAP-Server und Client, die eine normale LDAP-Verbindung um TLS/SSL-Verschlüsselung erweitert. TLS/SSL wird nach erfolgreichem Abschluss dieser LDAP-Operation initialisiert. Es wird kein zusätzlicher Kommunikationsport benötigt. LDAP-Clients wie der <em>System Security Services Daemon</em> (SSSD) sind so intelligent gebaut, dass sie TLS/SSL nur vorübergehend für die Verschlüsselung der Übertragung sensitiver Daten, wie z. B. Passwörter, einrichten und danch wieder auf die normale LDAP-Verbindung zurückfallen</p></li><li><p>LDAPS oder ldaps:// verweisen auf <em>LDAP Secured</em>, d. h. LDAP über TLS/SSL. Für die Kommunikation zwischen LDAP-Server und Client wird dauerhaft eine TLS/SSL-Schicht oberhalb von TCP eingerichtet. Das LDAP-Protokoll verwendet normalerweise Port 389 für die Kommunikation. LDAPS benötigt hingegen einen eigenen Kommunikationsport (üblicherweise 636).</p></li></ul><p>
Die Extended LDAP Operation <em>StartTLS</em> ist das standardisierte Verfahren in LDAPv3 für die Einrichtung der TLS/SSL Datenverschlüsselung. Bis auf wenige Ausnahmen wird es von allen LDAP-Clients unterstützt. Deswegen wird hier auf die Einrichtung eines weiteren LDAP-Listeners (Option <em>-h</em> von <strong>slapd</strong>) verzichtet. Dies erfolgt durch Anpassen des Eintrags <em>SLAPD_SERVICES</em> in <strong>/etc/default/slapd</strong>:</p><pre class="notranslate">SLAPD_SERVICES="ldap:/// ldapi:///"</pre><p>Damit ist die Einrichtung von TLS/SSL abgeschlossen.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo /etc/init.d/slapd restart </pre></div></div><p>startet den LDAP-Server neu. Nun mit Unterstützung des StartTLS-Verfahrens für die sichere Kommunikation zwischen LDAP-Server und Client.</p></div><div class="section_2"><h3 id="Test">Test<a class="headerlink" href="#Test">¶</a></h3><p>
Zum Testen verwendet man am einfachsten die sowieso schon installierten OpenLDAP-Clients. Dazu muss man deren Konfigurationsdatei <strong>/etc/ldap/ldap.conf</strong> überprüfen und ggf. anpassen. Folgende Einträge sind zwingend erforderlich:</p><pre class="notranslate">uri ldap://ldap.meinedomain.local/
ldap_version 3
ssl start_tls
tls_cacert /etc/ssl/certs/ca_certificates.crt</pre><p>Dabei den FQDN des LDAP-Servers entsprechend anpassen. Für den Fall, dass der LDAP-Server nur ein selbstsigniertes Zertifikat verwendet, muss der Eintrag tls_cacert angepasst und noch folgender Parameter in <strong>/etc/ldap/ldap.conf</strong> eingefügt werden:</p><pre class="notranslate">tls_cacert /etc/ssl/certs/ldap_slapd_cacert.pem
TLS_REQCERT allow</pre><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>GnuTLS und damit die OpenLDAP-Clients vertrauen nur Server-Zertifikaten, die von Stammzertifizierungstellen mit entsprechendem Stammzertifikat signiert sind. Wurde das Server-Zertifikat von einer nachgeordneten CA signiert, muss die unter Option <em>tls_cacert</em> genannte Datei alle Zertifikate der Signaturkette bis zur Stammzertifizierungsstelle enthalten. Selbstsignierten Zertifikaten wird grundsätzlich nicht vertraut. Sie und alle anderen nicht vertrauenswürdigen Server-Zertifikate werden aber dennoch verwendet, wenn die TLS_REQUEST-Option den Wert <em>allow</em> oder <em>never</em> hat.  
</p></div></div><p>Nun kann man endlich die TLS/SSL-Verschlüsselung testen.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -xLLL -Z -W -D cn=admin,cn=config -b cn=config cn=config </pre></div></div><p>Die Option <em>-Z</em> fordert die StartTLS-Operation beim OpenLDAP-Client an. Wenn die Ausführung des Befehls erfolgreich ist, d. h. die TLS-Einstellungen des LDAP-Servers angezeigt werden, kann man sich die Initialisierung von TLS/SSL im Detail ansehen. Dazu gibt man folgenden Befehl ein:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -d 2 -xLLL -Z -W -D cn=admin,cn=config -b cn=config cn=config </pre></div></div><p>In der Ausgabe sollte die StartTLS-Operation, die verwendete TLS-Version und die Übertragung des Server-Zertifikats sichtbar sein. Hier ein Ausschnitt:
</p><pre class="notranslate">ldap_write: want=31, written=31
  0000:  30 1d 02 01 01 77 18 80  16 31 2e 33 2e 36 2e 31   0....w...1.3.6.1  
  0010:  2e 34 2e 31 2e 31 34 36  36 2e 32 30 30 33 37      .4.1.1466.20037  

-&gt; 1.3.6.1.4.1.1466.20037 is the StartTLS LDAP operation code
 
ldap_read: want=8, got=8
  0000:  30 0c 02 01 01 78 07 0a                            0....x..          
ldap_read: want=6, got=6
  0000:  01 00 04 00 04 00                                  ......            

-&gt; 01 00: 00 is resultCode = success

tls_write: want=93, written=93
  0000:  16 03 02 00 58 01 00 00  54 03 02 4f 48 1b 02 ca   ....X...T..OH...  
  0010:  6e 94 24 b1 bf 50 08 38  1e 12 21 6d c6 78 7f 84   n.$..P.8..!m.x..  
  0020:  ee 02 14 a7 1d 93 e5 f6  dd 23 1d 00 00 24 00 33   .........#...$.3  
  0030:  00 45 00 39 00 88 00 16  00 32 00 44 00 38 00 87   .E.9.....2.D.8..  
  0040:  00 13 00 66 00 2f 00 41  00 35 00 84 00 0a 00 05   ...f./.A.5......  
  0050:  00 04 01 00 00 07 00 09  00 03 02 00 01            .............     
tls_read: want=5, got=5
  0000:  16 03 02 00 4a                                     ....J             
tls_read: want=74, got=74
  0000:  02 00 00 46 03 02 4f 48  1b 02 a9 af 24 4c 96 32   ...F..OH....$L.2 

-&gt; 0x0302 is TLS v1.1
 
  0010:  07 f0 e3 1a 18 91 98 cc  fd 5f 1b d1 b7 9e e5 36   ........._.....6  
  0020:  d8 3a c2 16 bc 8c 20 da  87 37 f2 b3 84 e5 47 cb   .:.... ..7....G.  
  0030:  0e e0 61 6a 22 1d cc 9f  77 67 cf 9b 1a 45 7c db   ..aj"...wg...E|.  
  0040:  32 02 50 1f 30 f7 4e 00  2f 00                     2.P.0.N./.        
tls_read: want=5, got=5
  0000:  16 03 02 08 5d                                     ....]  

...
</pre><p><a class="internal missing" href="../openldap.html#top">{top}</a></p></div></div><div class="section_1"><h2 id="LDAP-Authentication">LDAP Authentication<a class="headerlink" href="#LDAP-Authentication">¶</a></h2><p>
Nachdem der LDAP-Server eingerichtet ist, die Linux-Accounts in das LDAP-Verzeichnis migriert worden sind und auch die Authentifizierung am LDAP-Server mittels Simple Authentication and Security Layer (SASL) mit DIGEST-MD5-Mechanismus funktioniert, wird in diesem Abschnitt der Ubuntu-Client in die Lage versetzt, Benutzer mit Eintrag im LDAP-Verzeichnis am LDAP-Server zu authentifizieren. Aufgrund umfangreicher und nach wie vor noch nicht abgeschlossener Umbauten der <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/PAM">PAM</a>-basierten Authentifizierung ist die Einrichtung der LDAP-Authentifizierung nicht trivial. Zum Glück gibt es aber einige Ubuntu-Pakete, die, sofern man sie einsetzt, die Arbeit doch erheblich erleichtern.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Die Konfiguration der LDAP-basierten Authentifizierung in Ubuntu ändert sich zur Zeit von Release zu Release. Sie ist schlecht dokumentiert. Selbst der <a class="external" href="https://help.ubuntu.com/11.04/serverguide/C/openldap-server.html#openldap-configuration" rel="nofollow">Ubuntu Server Guide</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> behandelt das Thema nur sehr oberflächlich. Das hier beschriebene Vorgehen ist aber bis <a class="internal" href="../natty_narwhal.html">Ubuntu 11.04</a> getestet. Ob es für frühere Releases anwendbar ist, ist zumindest zweifelhaft. 
</p></div></div><p>Es werden folgende Pakete zusätzlich benötigt:
</p><ul><li><p><strong>libnss-ldapd</strong></p></li><li><p><strong>libpam-ldapd</strong></p></li><li><p><strong>auth-client-config</strong></p></li><li><p><strong>ldap-auth-client</strong></p></li><li><p><strong>ldap-auth-config</strong></p></li><li><p><strong>nslcd</strong></p></li><li><p><strong>nscd</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install libnss-ldapd libpam-ldapd auth-client-config ldap-auth-client ldap-auth-config nslcd nscd </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install libnss-ldapd libpam-ldapd auth-client-config ldap-auth-client ldap-auth-config nslcd nscd </pre></div></div><p>
</p></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Das Paket <strong>libpam-ldapd</strong> steht erst ab <a class="internal" href="../lucid_lynx.html">Ubuntu 10.04</a> zur Verfügung. Für frühere Ubuntu-Versionen muss stattdessen die veraltete <strong>libpam-ldap</strong>-Bibliothek installiert werden. Doch auch ab <a class="internal" href="../lucid_lynx.html">Ubuntu 10.04</a> kommt man an <strong>libpam-ldap</strong> nicht ganz vorbei, da nur es das LDAP-Schema ldapns.schema bereitstellt. Sobald die zugehörige ldif-Datei aber erstellt ist, kann <strong>libpam-ldap</strong> bedenkenlos wieder per Hand oder automatisch durch die Installation von <strong>libpam-ldapd</strong> vom System entfernt werden.
Falls alternde Passwörter im LDAP Schema, d. h. Eigenschaften wie <strong>ShadowLastChange</strong> aus dem <strong>ShadowAccount</strong>-Schema, verwendet werden und das Datum der letzten Passwortänderung nicht aktualisiert wird: Unter Umständen kann das Problem gelöst werden, indem man die neueren Bibliotheken <strong>libnss-ldapd</strong> und <strong>libpam-ldapd</strong> durch die älteren <strong>libnss-ldap</strong> und <strong>libpam-ldap</strong> ersetzt.
</p></div></div><div class="section_2"><h3 id="Benoetigte-Pakete-installieren-und-konfigurieren">Benötigte Pakete installieren und konfigurieren<a class="headerlink" href="#Benoetigte-Pakete-installieren-und-konfigurieren">¶</a></h3><p>
Man startet mit <strong>libnss-ldapd</strong>, das ein Name-Service-Switch-Modul (<a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/NSS">NSS</a>) zur Verfügung stellt, mit dem der LDAP-Server seine Clients mit Benutzer-Accounts, Gruppen, Host-Namen, Aliases und weiteren Informationen, die üblicherweise in Konfigurationsdateien im Verzeichnis <em>/etc</em> abgelegt sind, versorgen kann.</p><p>Es öffnet sich ein Konfigurationsdialog, mit dem festgelegt wird, welche Services mittels LDAP-Lookup zugänglich sein sollen. Zumindest die folgenden Services werden benötigt:
</p><ul><li><p><em>"group"</em></p></li><li><p><em>"passwd"</em></p></li><li><p><em>"shadow"</em></p></li></ul><p>und sollten markiert werden.</p><p>Danach werden die Pakete <strong>nslcd</strong> und <strong>nscd</strong> installiert. Die beiden Pakete stellen Dämonen bereit, mittels derer lokale Applikationen (z.B. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/PAM">PAM</a>-Module) die über <strong>libnss-ldapd</strong> aus dem LDAP-Verzeichnis geholten Informationen entweder direkt oder aus einem Cache abfragen können.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Ohne <strong>nslcd</strong> ist  kein LDAP-authentifizierter Benutzer-Login möglich. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/PAM">PAM</a> bricht ab mit Fehlermeldung "<em>User not known to the underlying authentication module</em>" auf die Konsole und "<em>login: pam_env(login:session): No such user!?</em>" sowie "<em>login: User not known to the underlying authentication module</em>" im Logfile.
</p></div></div><p>Nach Installation von <strong>nslcd</strong></p><p>öffnet sich wiederum ein Konfigurationsdialog, mit welchem die zu verwendende LDAP-Server-URI (z. B. <code class="notranslate">ldap://127.0.0.1/</code>, wenn der LDAP-Server auf demselben Rechner läuft) und das LDAP-Suffix (also <code class="notranslate">dc=meinedomain,dc=local</code>) festgelegt werden.</p><p>Danach müssen noch die Pakete <strong>libpam-ldapd</strong> und <strong>ldap-auth-config</strong> installiert werden.</p><p>Letzteres installiert automatisch noch die Pakete <strong>auth-client-config</strong> und <strong>ldap-auth-client</strong> mit, sofern diese nicht schon auf dem System vorhanden sind. Anschließend müssen die <strong>ldap-auth</strong>-Pakete noch konfiguriert werden mittels:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo dpkg-reconfigure ldap-auth-config </pre></div></div><p><a class="crosslink anchor" href="#ldap_auth_config" id="ldap_auth_config"></a>
In dem sich öffnenden Dialog legt man die Konfigurationsoptionen fest, die dann in den Dateien <strong>/etc/ldap.conf</strong> und <strong>/etc/ldap.secret</strong> abgelegt werden:
</p><ul><li><p>LDAP server Uniform Resource Identifier: ldap://xxxx - hier die LDAP-URI des LDAP-Servers eingeben (z. B. <em>127.0.0.1</em>, wenn lokal)</p></li><li><p>Distinguished name of the search base: dc=meinedomain,dc=local - das bei der Installation festgelegte LDAP-Suffix eingeben</p></li><li><p>LDAP version to use: 3</p></li><li><p>Make local root Database admin: Yes</p></li><li><p>Does the LDAP database require login? No</p></li><li><p>LDAP account for root: cn=admin,dc=meinedomain,dc=local</p></li><li><p>LDAP root account password: 1234 - hier LDAP-Admin-Passwort eingeben; wird in ldap.secret abgelegt und ist nur <a class="internal" href="../sudo.html">root</a> zugänglich </p></li></ul><p>Spätere Änderungen an der Konfiguration sollten wenn möglich ebenfalls nur mit Hilfe von <code class="notranslate">dpkg-reconfigure ldap-auth-config</code> durchgeführt werden, um besser gewappnet zu sein für die weiter oben schon erwähnten zu erwartenden Änderungen bei einem Release-Upgrade.</p><p>Nun müssen noch die Konfigurationsdateien für die mit der Authentifizierung betrauten Systemdatenbanken (vorwiegend von PAM verwaltet) und das Name-Service-Switch-Modul (<a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/NSS">NSS</a>) angepasst werden. Dafür stehen zwei Tools zur Verfügung:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo auth-client-config -t nss -p lac_ldap </pre></div></div><p>passt die Datei <strong>/etc/nsswitch.conf</strong> auf Basis eines in der Profildatenbank im Verzeichnis <strong>/etc/auth-client-config/profile.d/</strong> enthaltenen LDAP-Schemas (<em>lac_ldap</em>) an.</p><p>Und 
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo pam-auth-update </pre></div></div><p>die PAM-Konfiguration im Verzeichnis <strong>/etc/pam.d/</strong>. Nach Eingabe des Kommandos erscheint ein Dialog, in dem die zu aktivierenden PAM-Profile ausgewählt werden müssen. Zunächst sollten die Profile 
</p><ul><li><p>Unix authentication und </p></li><li><p>LDAP Authentication</p></li></ul><p>ausgewählt werden. 
Nun sollte das System für die LDAP-Authentifizierung eingerichtet sein.</p></div><div class="section_2"><h3 id="Test-2">Test<a class="headerlink" href="#Test-2">¶</a></h3><p>
Bevor nun vollständig auf Authentifizierung mittels LDAP umgestiegen wird, sollte das System noch getestet werden. Dazu legt man zunächst einen neuen Benutzer <code class="notranslate">test</code> im LDAP-Verzeichnis an. Hierfür empfiehlt sich die Installation eines weiteren Paketes mit sehr hilfreichen Skripten.</p><div class="section_3"><h4 id="Installation-von-LDAP-Admin-Skripts">Installation von LDAP-Admin-Skripts<a class="headerlink" href="#Installation-von-LDAP-Admin-Skripts">¶</a></h4><p>
</p><ul><li><p><strong>ldapscripts</strong></p></li><li><p><strong>pwgen</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install ldapscripts pwgen </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install ldapscripts pwgen </pre></div></div><p>
</p></div></div><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>In <strong>/etc/ldapscripts/ldapscripts.conf</strong> wird suggeriert, dass die <strong>ldapscripts</strong> Parameter wie 'SERVER' automatisch aus einer anderen Konfigurationsdatei lesen können: 'DEBIAN: values from /etc/pam_ldap.conf are used.'
Aufgrund eines Bugs im Installationskript unterstützt Ubuntu dies aber nicht. Alle für die <strong>ldapscripts</strong> benötigten Parameter müssen weiterhin in <strong>/etc/ldapscripts/ldapscripts.conf</strong> definiert werden.
</p></div></div><p>Dann die Datei <strong>/etc/ldapscripts/ldapscripts.conf</strong> editieren, Kommentarzeichen löschen und anpassen wie folgt:</p><pre class="notranslate">SERVER=localhost  # falls der LDAP-Server lokal, sonst ldapi///
BINDDN='cn=admin,dc=meinedomain,dc=local'
BINDPWDFILE="/etc/ldapscripts/ldapscripts.passwd"
SUFFIX='dc=meinedomain,dc=local'
GSUFFIX='ou=Groups'
USUFFIX='ou=Users'
MSUFFIX='ou=Computers'
GIDSTART=10000
UIDSTART=10000
MIDSTART=10000
PASSWORDGEN="pwgen"</pre><p>Anschließend noch die Datei <strong>ldapscripts.passwd</strong> erstellen für den authentifizierten Admin-Zugang zum LDAP-Verzeichnis:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo sh -c "echo -n '1234' &gt; /etc/ldapscripts/ldapscripts.passwd"
sudo chmod 400 /etc/ldapscripts/ldapscripts.passwd </pre></div></div><p>Anmerkung: <code class="notranslate">'1234'</code> muss natürlich durch das tatsächliche Passwort des LDAP-Administrators ersetzt werden.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p><strong>/etc/ldapscripts/ldapscripts.passwd</strong> darf keine Zeilenumbrüche enthalten und sollte deshalb ausschließlich mit o.g. <strong>echo</strong>-Befehl erstellt und modifiziert werden.
</p></div></div></div><div class="section_3"><h4 id="Testbenutzer-anlegen">Testbenutzer anlegen<a class="headerlink" href="#Testbenutzer-anlegen">¶</a></h4><p>
Anschließend wird der neue Benutzer angelegt mit</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ldapaddgroup test
sudo ldapadduser test test
sudo ldapsetpasswd test </pre></div></div><p>Danach kann überprüft werden, ob <code class="notranslate">test</code> korrekt im LDAP-Verzeichnis angelegt wurde. Unter einem beliebigen nach obiger <a class="internal missing" href="../openldap.html#migration">Migrationsanleitung</a>
von <strong>/etc/passwd</strong> ins LDAP-Verzeichnis migrierten User-Account lässt man sich die Daten des <code class="notranslate">test</code>-Benutzers ausgeben:</p><div class="bash"><div class="contents"><pre class="notranslate">carmen@MeinComputer:~$ ldapsearch -b dc=meinedomain,dc=local uid=test </pre></div></div><p>Ausgabe:
</p><pre class="notranslate">SASL/DIGEST-MD5 authentication started
Please enter your password: 
SASL username: carmen
SASL SSF: 128
SASL data security layer installed.
# extended LDIF
#
# LDAPv3
# base dc=meinedomain,dc=local with scope subtree
# filter: uid=test
# requesting: ALL
#

# test, Users, meinedomain.local
dn: uid=test,ou=Users,dc=gas,dc=de
objectClass: account
objectClass: posixAccount
cn: test
uid: test
uidNumber: 10001
gidNumber: 10001
homeDirectory: /home/test
loginShell: /bin/sh
gecos: test
description: User account

# search result
search: 4
result: 0 Success

# numResponses: 2
# numEntries: 1</pre><p>Der Benutzer <code class="notranslate">test</code> ist nur im LDAP-Verzeichnis abgelegt, wovon man sich durch Überprüfen der Datei <strong>/etc/passwd</strong> überzeugen kann. 
Nun mittels 
<span class="key">Strg</span>  + 
<span class="key">Alt</span>  + 
<span class="key">F3</span>  auf ein Terminal wechseln und einen Login durchführen für den Benutzer <code class="notranslate">test</code> mit dem gerade eben vergebenen Passwort.</p></div><div class="section_3"><h4 id="Weitere-Tests">Weitere Tests<a class="headerlink" href="#Weitere-Tests">¶</a></h4><p>
Da OpenLDAP ein doch sehr kompliziertes und recht fehleranfälliges Thema ist, empfehlen sich weitere Tests, die hier aber nur noch kurz aufgezählt werden: 
</p><ul><li><p><code class="notranslate">getent group</code> muss alle Unix-Gruppen sowie die neue LDAP-Gruppe <code class="notranslate">test</code> ausgeben</p></li><li><p><code class="notranslate">getent passwd</code> gibt alle Unix-Accounts und den Benutzer <em>test</em> aus</p></li><li><p>unter <a class="internal" href="../sudo.html">root</a> (z. B. mit <code class="notranslate">sudo bash</code>) das System über das Skript <strong>pam-auth-update</strong> auf reine "LDAP Authentication" umstellen und Logins sowie <code class="notranslate">sudo</code>-Kommandos ausführen</p></li></ul><p>
</p><div class="box experts"><h3 class="box experts">Experten-Info:</h3><div class="contents"><p>Liegt der LDAP-Server auf einem anderen PC als der Client und sollte in der Ausgabe <code class="notranslate">getent passwd</code> der Benutzer <em>test</em>, trotz der oben aufgeführten Konfiguration nicht auffindbar sein, ist es möglich das der LDAP-Server die Verbindung ablehnt.</p><p>Um dies zu Verifizieren sollte in der ersten Konsole <code class="notranslate">tail -f /var/log/syslog</code> eingegeben werden. In der zweiten Konsole wird nochmals der Befehl <code class="notranslate">getent passwd</code> bestätigt. Erscheint nun in der ersten Konsole die Ausgabe <em>failed to bind to LDAP server ldap://yourLdapServerIP/: Can't contact LDAP server: Transport endpoint is not connected</em>, wird der Client vom Server abgewiesen.</p><p>Dieser Fehler tritt auf da LDAP nur auf der virtuellen Loopback (<code class="notranslate">localhost</code> oder <code class="notranslate">127.0.0.1</code>) Netzwerkkarte auf ein kommende Verbindungen wartet. Dies kommt unter anderem mit einem Sicherheitsgewinn einher, da kein externer Client auf den Datenbestand des Servers zugreifen kann.
</p></div></div><p>Abhilfe schafft folgendes: Es muss auf dem LDAP-Server die Datei <strong>/etc/default/slapd</strong> bearbeitet werden. Genauer es muss die Zeile</p><pre class="notranslate">SLAPD_SERVICES="ldap:/// ldaps:/// ldapi:///"</pre><p>
eingefügt werden. Alle anderen Zeilen mit dem Eintrag <em>SLAPD_SERVICES</em> müssen mit einem beginnenden # auskommentiert werden. Daraufhin sollte nochmals der Befehl <code class="notranslate">getent passwd</code> auf dem Client aufgerufen werden. Die nun folgende Ausgabe sollte den Benutzer <em>test</em> enthalten.</p></div></div><div class="section_2"><h3 id="Abschliessende-Arbeiten">Abschließende Arbeiten<a class="headerlink" href="#Abschliessende-Arbeiten">¶</a></h3><p>
Wenn man sich genügend von der korrekten Funktion der LDAP-Authentifizerung überzeugt hat, kann man mittels des Befehls <code class="notranslate">deluser</code> die Unix-Accounts der migrierten Benutzer löschen und sich voll auf das LDAP-Verzeichnis verlassen. Ein Parallelbetrieb ist aber genauso möglich. Es sollten beide Authentifizierungsprofile (LDAP-, Unix-Authentification) eingestellt bleiben, da ja nicht alle Benutzer migriert worden sind, was auch wenig sinnvoll wäre.</p><p>Wer einen Samba-Server betreibt, kann relativ einfach die migrierten LDAP-Benutzereinträge um Samba-spezifische Attribute erweitern und weitere Accounts (z. B. Computer) hinzufügen, so dass LDAP zur Authentifizierung und als Backend für Samba verwendet werden kann. Dazu existieren zahlreiche Howtos. Nach Abschluss der Arbeiten sollte der Server neu gestartet werden.</p></div></div><div class="section_1"><h2 id="Hinweise">Hinweise<a class="headerlink" href="#Hinweise">¶</a></h2><p>
Zur weiteren Konfiguration und Verwaltung kann man dann z.B. <code class="notranslate">phpLDAPadmin</code> oder <code class="notranslate">luma</code> nutzen.</p></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="internal" href="../openldap_ab_precise.html">OpenLDAP ab Precise</a></p></li><li><p><a class="external" href="http://www.openldap.org/" rel="nofollow">Projektseite</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/></p></li><li><p><a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/OpenLDAP">OpenLDAP</a></p></li><li><p><a class="external" href="http://tuxnetworks.blogspot.com/2010/06/howto-ldap-server-on-1004-lucid-lynx.html" rel="nofollow">HOWTO LDAP Server on 10.04 Lucid Lynx</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/></p></li><li><p><a class="external" href="http://www.effinger.org/blog/2008/12/14/das-kleine-openldap-1x1/" rel="nofollow">Das kleine OpenLDAP 1×1</a> <img alt="{de}" src="../_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> - Blogbeitrag 12/2008</p></li><li><p><a class="external" href="http://www.effinger.org/blog/2009/03/22/dovecot-exim-openldap-und-getmail-unter-ubuntu-1-openldap/" rel="nofollow">Dovecot, Exim, OpenLDAP und getmail unter Ubuntu</a> <img alt="{de}" src="../_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> Blogeintrag 03/2009</p></li><li><p><a class="external" href="http://wiki.ubuntu-forum.de/index.php/OpenLDAP#LDAP_im_Thunderbird_einrichten" rel="nofollow">LDAP im Thunderbird einrichten</a> <img alt="{de}" src="../_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/></p></li><li><p><a class="internal" href="../kerberos/ldap.html">Kerberos/LDAP</a> - Kombinationen beider Dienste</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="../archiv/openldap/a/revision/809438.html">Diese Revision</a> wurde am 21. April 2015 09:36 von <a href="https://ubuntuusers.de/user/frustschieber/">frustschieber</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../startseite.html">Wiki</a></li>
<li><a href="../archiv.html">Archiv</a></li>
<li><a href="../archiv/openldap.html">OpenLDAP</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>