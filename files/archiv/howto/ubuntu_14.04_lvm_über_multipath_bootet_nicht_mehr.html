<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Archiv/Howto/Ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr › ubuntuusers statisches Wiki</title>
<link href="../../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr.html">Ubuntu 14.04 lvm über multipath bootet nicht mehr</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Archiv/Howto/Ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../../wiki/index.html">Index</a></li>
<li><a href="../../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../../wiki.html">Übersicht</a></li>
<li><a href="../../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../../kategorien.html">Kategorie</a></li>
<li><a href="../../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../../howto.html">Howto anlegen</a></li>
<li><a href="../../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../../baustelle.html">Baustellen</a></li>
<li><a href="../../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr/a/backlinks.html">Ubuntu 14.04 lvm über multipath bootet nicht mehr</a></h1>
<div id="page"><div class="box improvable"><h3 class="box improvable">Archivierte Anleitung</h3><div class="contents"><p>
Dieser Artikel wurde archiviert, da er - oder Teile daraus -
nur noch unter einer älteren Ubuntu-Version nutzbar ist. Diese
Anleitung wird vom Wiki-Team weder auf Richtigkeit überprüft
noch anderweitig gepflegt. Zusätzlich wurde der Artikel für
weitere Änderungen gesperrt.
</p></div></div><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Die Verwendung dieses Howto geschieht auf eigene Gefahr. Bei Problemen mit der Anleitung melde dies bitte in der dazugehörigen Diskussion und wende dich zusätzlich an den Verfasser des Howtos.
</p></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Diese Howto-Anleitung wurde zuletzt von <a class="crosslink user" href="https://ubuntuusers.de/user/muellerj/">muellerj</a> am 08.02.2016 unter <strong>Ubuntu 14.04.3</strong> und <strong>kpartx</strong>, <strong>kpartx-boot</strong>, <strong>multipath-tools</strong>, <strong>multipath-tools-boot</strong> Version <strong>0.4.9-3ubuntu7.8</strong> erfolgreich getestet.
</p></div></div><div class="section_1"><h2 id="Problembeschreibung">Problembeschreibung<a class="headerlink" href="#Problembeschreibung">¶</a></h2><p>
Nach diversen Updates bootet das System nicht mehr. Beim Betriebssystem handelt es sich um Ubuntu 14.04.3 64-Bit mit LVM-Root-Partition, die über Multipath angebunden ist. Der Systemstart bleibt mit der Bemerkung stehen, dass die Root-Partition nicht gefunden wird (so wie hier beschrieben: <a class="external" href="http://askubuntu.com/questions/361886/cannot-find-root-device-after-latest-kernel-upgrade" rel="nofollow" title="http://askubuntu.com/questions/361886/cannot-find-root-device-after-latest-kernel-upgrade">http://askubuntu.com/questions/361886/cannot-find-root-device-after-latest-kernel-upgrade</a>). Man wird zur Eingabe von Kommandos aufgefordert. Der Systemstart kann nur nach Eingabe eigener Kommandos fortgesetzt oder beendet werden. Wie kommt man weiter?</p><p>Zunächst sollte geprüft werden, wie der Multipath-Status ist. Die kann mit dem Kommando <strong>/sbin/multipath -ll</strong> erfolgen. Erfahrungsgemäß wird nichts angezeigt. Nach Eingabe des Kommandos <strong>/sbin/multipath -v0</strong> zeigt das Kommando <strong>/sbin/multipath -ll</strong> die Multipath-Konfiguration, wie sie sein soll.</p><p>Jetzt kann mit &lt;Strg&gt;D der Eingabemodus verlassen werden. Das System findet nach dem korrekten Start jetzt die Root-Partition und startet.</p><p>Multipath wird also offensichtlich beim Systemstart nicht mehr korrekt durch das Initram-FS gestartet (siehe auch dazu: <a class="external" href="https://bugs.launchpad.net/ubuntu/+source/multipath-tools/+bug/1431650" rel="nofollow" title="https://bugs.launchpad.net/ubuntu/+source/multipath-tools/+bug/1431650">https://bugs.launchpad.net/ubuntu/+source/multipath-tools/+bug/1431650</a>).</p><p>Ein manueller Start von Multipath behebt den Fehler. Aber das System soll ja alleine starten, ohne manuellen Eingriff.</p><p>Ursache ist offensichtlich, dass das Paket <strong>multipath-tools</strong> durch diverse Updates so verändert wurde, dass durch den Systemstart Multipath nicht mehr früh genug gestartet wird. Der Start erfolgt in der Initramfs erst nach dem Start von lvm2 - und das ist zu spät. Ursache dafür könnte das Wegfallen des Files <strong>/lib/udev/rules.d/95-multipath.rules</strong> im Paket multipath-tools sein.</p><p>Es gibt 2 Möglichkeiten der Lösung:</p><ol class="arabic"><li><p>Zurücksetzen der Pakete multipath-tools, multipath-tools-boot, kpartx und kpartx-boot auf eine Version, die noch problemlos läuft</p></li><li><p>Modifizieren des Initram-FS so, dass der Start funktioniert. </p></li></ol><p>
</p></div><div class="section_1"><h2 id="Loesung-1-Alte-Pakete-einsetzen">Lösung 1 - Alte Pakete einsetzen<a class="headerlink" href="#Loesung-1-Alte-Pakete-einsetzen">¶</a></h2><p>
Die zuletzt funktionierenden Pakete <strong>kpartx</strong>, <strong>kpartx-boot</strong>, <strong>multipath-tools</strong> und <strong>multipath-tools-boot</strong> sind in Version <code class="notranslate">0.4.9-3ubuntu7.4</code> auf der Installations-CD von Ubuntu 14.04.3-Server vorhanden.</p><p>Nachdem man es geschafft hat, das System zu starten, mountet man diesen Datenträger (z.B. auf <strong>/mnt</strong>). Danach wird man feststellen, dass diese Pakete im Verzeichnis <strong>/mnt/pool/main/m/multipath-tools/</strong> liegen. Von dort können sie installiert werden mittels</p><div class="bash"><div class="contents"><pre class="notranslate">sudo dpkg -i &lt;paket&gt;... </pre></div></div><p>Danach müssen diese Pakete gesperrt werden, um bei einem weiteren Update ein Überschreiben zu verhindern. Wie dies geht, das kann dieser Beschreibung: <a class="external" href="https://wiki.debianforum.de/Pakete_auf_hold_setzen" rel="nofollow" title="https://wiki.debianforum.de/Pakete_auf_hold_setzen">https://wiki.debianforum.de/Pakete_auf_hold_setzen</a> entnommen werden.</p><p>Nach</p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-initramfs -k all -u </pre></div></div><p>wird neu gestartet.</p></div><div class="section_1"><h2 id="Loesung-2-Modifizieren-des-Boot-Vorgangs">Lösung 2 - Modifizieren des Boot-Vorgangs<a class="headerlink" href="#Loesung-2-Modifizieren-des-Boot-Vorgangs">¶</a></h2><p>
Diese Lösung ist etwas komplexer. Sie erfordert eine Eingriff in den Systemstart.</p><p>Es wurde festgestellt, dass der Multipath-Start nach dem Start von lvm2 zu spät kommt. Beim manuellen Eingreifen in den Start wird Multipath gestartet und lvm2 kann danach seine Arbeit aufnehmen. Das anschließende Mounten der Root-Partition gelingt.</p><p>Das Lösungsprinzip besteht darin, zu einem möglichst frühen Zeitpunkt Multipath zu starten, gleich nach udev. Dadurch kommt es zwar zu vielen Meldungen während des Starts, aber der Systemstart kommt erfolgreich zu Ende.</p><p>Immerhin arbeitet sie mit den aktuellen Paketen in Version <code class="notranslate">0.4.9-3ubuntu7.7</code>.</p><p>Es wird in diesem Beispiel von folgender Konfiguration für Multipath ausgegangen (<strong>/etc/multipath.conf</strong>):</p><pre class="notranslate">defaults {
        user_friendly_names yes
}
blacklist {
        devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
        devnode "^hd[a-z][[0-9]*]"
        devnode "^cciss!c[0-9]d[0-9]*[p[0-9]*]"
}
devices {
        device {
                vendor "EMC"
                product "Invista"
                product_blacklist "LUNZ"
                path_grouping_policy multibus
                path_checker tur
                no_path_retry 5
        }
}</pre><p>Zunächst wurde eine Modifikation an <strong>/etc/lvm/lvm.conf</strong> vorgenommen (Siehe auch: <a class="external" href="http://www.novell.com/support/kb/doc.php?id=7007498" rel="nofollow" title="http://www.novell.com/support/kb/doc.php?id=7007498">http://www.novell.com/support/kb/doc.php?id=7007498</a>) Die Anweisung "filter" wurde wie unten steht ersetzt:</p><pre class="notranslate">filter = [ "a|/dev/disk/by-id/dm-name-.*|", "r/.*/" ]</pre><p>Dann wurde die Liste der in die Initram zu integrierenden Module erweitert. Orientiert wurde sich dabei an der Ausgabe des Kommandos:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo lsmod </pre></div></div><p>In das Konfigurationsfile <strong>/etc/initramfs-tools/modules</strong> wurden im konkreten Beispiel eingefügt:</p><pre class="notranslate">scsi_dh_emc 
scsi_dh 
scsi_tgt 
scsi_transport_fc 
dm_multipath 
dm_round_robin</pre><p>Dann wird das File <strong>/etc/initramfs-tools/hooks/99-multipath</strong> erstellt und ausführbar gemacht:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo chmod +x /etc/initramfs-tools/hooks/99-multipath </pre></div></div><p>Es sorgt dafür, dass Multipath zu einem frühen Zeitpunkt gestartet wird.</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/sh </span>
<span class="nv">PREREQS</span><span class="o">=</span><span class="s2">"multipath"</span> 
prereqs<span class="o">()</span> <span class="o">{</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$PREREQS</span><span class="s2">"</span><span class="p">;</span> <span class="o">}</span> 
<span class="k">case</span> <span class="nv">$1</span> in 
prereqs<span class="o">)</span> 
        prereqs 
        <span class="nb">exit</span> <span class="m">0</span> 
        <span class="p">;;</span> 
<span class="k">esac</span> 
<span class="k">if</span> <span class="o">[</span> ! -x /sbin/multipath <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
        <span class="nb">exit</span> <span class="m">0</span> 
<span class="k">fi</span> 
. /usr/share/initramfs-tools/hook-functions
<span class="k">if</span> <span class="o">[</span> -x /usr/share/initramfs-tools/scripts/local-top/multipath <span class="o">]</span> 
<span class="k">then</span> 
        cp /usr/share/initramfs-tools/scripts/local-top/multipath <span class="nv">$DESTDIR</span>/scripts/init-top/ 
<span class="k">fi</span>
</pre></div>
</td></tr></table></div><p>Danach wird die Initram neu erstellt:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-initramfs -k all -u </pre></div></div><p>Die Initramfs kann ausgepackt werden. Das geschieht mit folgenden Kommandos:</p><div class="bash"><div class="contents"><pre class="notranslate">mkdir initramfs
cd initramfs
zcat /boot/initrd.img-... | cpio -imdv </pre></div></div><p>Dieses ausgepackte System kann analysiert werden, um die Wirkung zu verstehen. Es zeigt sich, dass unter <strong>scripts/</strong> zweimal <strong>multipath</strong> gestartet wird.</p><p>Ein Reboot bringt jetzt zwar viele Meldungen, läuft aber durch.</p></div><div class="section_1"><h2 id="nderungen-seit-kpartx-kpartx-boot-multipath-tools-multipath-tools-boot-Version-0-4-9-3ubuntu7-8">Änderungen seit kpartx, kpartx-boot, multipath-tools, multipath-tools-boot Version 0.4.9-3ubuntu7.8<a class="headerlink" href="#nderungen-seit-kpartx-kpartx-boot-multipath-tools-multipath-tools-boot-Version-0-4-9-3ubuntu7-8">¶</a></h2><p>
Seit dieser Version funktioniert der Neustart des Systems wieder ohne das File <strong>/etc/initramfs-tools/hooks/99-multipath</strong>.</p><p>In <strong>/etc/lvm/lvm.conf</strong> kann auch die <strong>filter</strong> Anweisung auf den in <a class="external" href="https://help.ubuntu.com/lts/serverguide/multipath-devices.html" rel="nofollow" title="https://help.ubuntu.com/lts/serverguide/multipath-devices.html">https://help.ubuntu.com/lts/serverguide/multipath-devices.html</a> vorgeschlagenen Wert zurück gesetzt werden:</p><pre class="notranslate">filter = [ "r/block/", "r/disk/", "r/sd.*/", "a/.*/" ]</pre></div><div class="section_1"><h2 id="nderungen-seit-kpartx-kpartx-boot-multipath-tools-multipath-tools-boot-Version-0-4-9-3ubuntu7-11">Änderungen seit kpartx, kpartx-boot, multipath-tools, multipath-tools-boot Version 0.4.9-3ubuntu7.11<a class="headerlink" href="#nderungen-seit-kpartx-kpartx-boot-multipath-tools-multipath-tools-boot-Version-0-4-9-3ubuntu7-11">¶</a></h2><p>
Seit dieser Version funktioniert der Start wieder richtig flott. Zwischenzeitliche Wartezeiten von maximal 4 mal jeweils 30 Sekunden sind auf maximal 10 Sekungen geschrumpft, die wohl nicht vermeidbar sind, und das bei ca. 40 Multipath-FC-Devices.</p></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="internal" href="../../howto.html">Howto</a> <img alt="{Übersicht}" src="../../_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> - Übersicht aller Howto-Artikel</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr/a/revision/937593.html">Diese Revision</a> wurde am 23. März 2017 13:02 von <a href="https://ubuntuusers.de/user/noisefloor/">noisefloor</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../../startseite.html">Wiki</a></li>
<li><a href="../../archiv.html">Archiv</a></li>
<li><a href="../../archiv/howto.html">Howto</a></li>
<li><a href="../../archiv/howto/ubuntu_14.04_lvm_über_multipath_bootet_nicht_mehr.html">Ubuntu 14.04 lvm über multipath bootet nicht mehr</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>