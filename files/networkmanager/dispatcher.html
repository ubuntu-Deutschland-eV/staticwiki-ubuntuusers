<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>NetworkManager/Dispatcher › ubuntuusers statisches Wiki</title>
<link href="../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../networkmanager/dispatcher.html">Dispatcher</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/NetworkManager/Dispatcher">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../wiki/index.html">Index</a></li>
<li><a href="../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../wiki.html">Übersicht</a></li>
<li><a href="../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../kategorien.html">Kategorie</a></li>
<li><a href="../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../howto.html">Howto anlegen</a></li>
<li><a href="../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../baustelle.html">Baustellen</a></li>
<li><a href="../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../networkmanager/dispatcher/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../networkmanager/dispatcher/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../networkmanager/dispatcher/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../networkmanager/dispatcher/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../networkmanager/dispatcher/a/backlinks.html">Dispatcher</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p>
</p><ul><li><p><a class="internal" href="../xenial_xerus.html">Ubuntu 16.04</a> Xenial Xerus</p></li><li><p><a class="internal" href="../trusty_tahr.html">Ubuntu 14.04</a> Trusty Tahr</p></li></ul></div></div><p>
</p><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="../editor.html">Einen Editor öffnen</a> </p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="../rechte.html">Rechte von Ordnern und Dateien ändern</a> </p></li></ol></div></div><p>
</p><div class="toc toc-depth-2"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Was-ist-ein-Dispatcher-Skript">Was ist ein Dispatcher-Skript
</a><ol class="arabic"><li><a class="crosslink" href="#Aktionen">Aktionen
</a></li></ol></li><li><a class="crosslink" href="#Was-kann-man-damit-machen">Was kann man damit machen?
</a><ol class="arabic"><li><a class="crosslink" href="#Beispiele">Beispiele
</a></li></ol></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p>Der NetworkManager kann mehr als nur einfach eine Verbindung auf- und wieder abbauen. Er ist in der Lage, zusätzliche Skripte beim Verbindungsauf- und -abbau ausführen. Dies erfolgt über Dispatcher-Skripte, die ausgeführt werden, wenn der NetworkManager eine Aktion durchführt, z.B. wenn er sich zu einem WLAN verbindet oder davon trennt. Diese Funktionen sind jedoch nicht von der grafischen Oberfläche aus konfigurierbar.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Das Skript <strong>/etc/NetworkManager/dispatcher.d/01ifupdown</strong> sollte man niemals löschen oder modifizieren. Es ist ein grundlegender Bestandteil der Funktionalität des NetworkManagers und wird in unveränderter Form für die Funktion des NetworkManagers benötigt.
</p></div></div><div class="section_1"><h2 id="Was-ist-ein-Dispatcher-Skript">Was ist ein Dispatcher-Skript<a class="headerlink" href="#Was-ist-ein-Dispatcher-Skript">¶</a></h2><p>
Grundsätzlich ist ein Dispatcher-Skript ein ganz normales Shellskript, das im Ordner <strong>/etc/NetworkManager/dispatcher.d/</strong> liegt. Diese Skripte werden dann vom NetworkManager bei einer Änderung an den Netzwerken mit zwei Parametern aufgerufen: Netzwerkschnittstelle und Aktion. Wichtig dabei ist, dass <code class="notranslate">root</code> der Besitzer der Skripte ist, da sie sonst nicht ausgeführt werden können.</p><p>In dem Ordner können mehrere Skripte liegen, diese werden in alphabetischer Reihenfolge abgearbeitet. Ein Skript liegt bereits in dem Ordner, <strong>01ifupdown</strong>, dieses ist das Grundskript des NetworkManagers und sorgt dafür, dass die Netzwerkschnittstellen richtig initialisiert werden.</p><div class="section_2"><h3 id="Aktionen">Aktionen<a class="headerlink" href="#Aktionen">¶</a></h3><p>
Als zweiter Parameter wird dem Script vom NetworkManager der Name der Aktion übergeben, welche die Dispatcherausführung ausgelöst hat.  
</p><table style="width: 95%"><tr><td colspan="3" style="text-align: center; background-color: #E2C890"><strong>Dispatcher Aktionen</strong></td></tr><tr style="background-color: #F9EAAF"><td><strong>Aktion</strong></td><td><strong>Bedeutung</strong></td><td><strong>Anwendungsbeispiel</strong></td></tr><tr><td> <code class="notranslate">up</code> </td><td> Eine reelle Netzwerkverbindung wurde aktiviert. </td><td> Mountet man Netzwerkfreigaben über ein Netzwerk, so kann man dieses an dieser Stelle ausführen lassen. </td></tr><tr><td> <code class="notranslate">down</code> </td><td> Eine reelle Netzwerkverbindung wurde deaktiviert. </td><td> Hat man Netzwerkfreigaben eingebunden, so sollte man diese vor dem Verbindungsabbau aushängen. Erst dann kann man sicher gehen, dass alle Daten korrekt geschrieben wurden. </td></tr><tr><td> <code class="notranslate">vpn-up</code> </td><td> Eine virtuelle(VPN) Netzwerkverbindung wurde aktiviert. </td><td> </td></tr><tr><td> <code class="notranslate">vpn-down</code> </td><td> Eine virtuelle(VPN) Netzwerkverbindung wurde deaktiviert. </td><td> </td></tr><tr><td> <code class="notranslate">hostname</code> </td><td> Der Hostname wurde geändert </td><td> </td></tr><tr><td> <code class="notranslate">dhcp4-change</code> </td><td> Der DHCP lease hat sich gändert (IPv4 Verbidungen) </td><td> </td></tr><tr><td> <code class="notranslate">dhcp6-change</code> </td><td> Der DHCP lease hat sich gändert (IPv6 Verbidungen) </td><td> </td></tr></table><p>
</p></div></div><div class="section_1"><h2 id="Was-kann-man-damit-machen">Was kann man damit machen?<a class="headerlink" href="#Was-kann-man-damit-machen">¶</a></h2><p>
Eigentlich alles was ein Skript so kann... man sollte aber nur sinnvolle Dinge wie z.B. automatischer Uhrzeitabgleich, Starten eines VPN-Clients oder Umschalten der <a class="internal" href="../iptables.html">iptables-Konfiguration</a> machen.</p><div class="section_2"><h3 id="Beispiele">Beispiele<a class="headerlink" href="#Beispiele">¶</a></h3><p>
</p><div class="section_3"><h4 id="VPNC-starten">VPNC starten<a class="headerlink" href="#VPNC-starten">¶</a></h4><p>
Man kann auch bei wechselnden WLAN-Umgebungen für einzelne Netze bestimmte Funktionen durchführen lassen. Dies wird hier gezeigt mit dem Beispiels "VPNC in der Uni".</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## INITIALISIERUNG</span>
<span class="c1">#Diese Werte werden vom NetworkManager an das Skript übergeben</span>
<span class="nv">INTERFACE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">ACTION</span><span class="o">=</span><span class="nv">$2</span>

<span class="c1">## ESSID des Universitäts-Netzwerkes</span>
<span class="nv">ESSID_VPN</span><span class="o">=</span><span class="s2">"VPN/WEB"</span>

<span class="c1">## ESSID des verbundenen Netzwerks bestimmen</span>
<span class="nv">ESSID</span><span class="o">=</span><span class="k">$(</span>iwconfig <span class="nv">$INTERFACE</span> <span class="p">|</span> grep ESSID <span class="p">|</span> cut -d<span class="s2">":"</span> -f2 <span class="p">|</span> <span class="se">\</span>
        sed <span class="s1">'s/^[^"]*"\|"[^"]*$//g'</span><span class="k">)</span>

<span class="c1">## Funktionen durchführen, je nach Aktion eine andere</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> in
        up<span class="o">)</span>
                <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ESSID</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$ESSID_VPN</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
                        vpnc /etc/vpnc/uni.conf
                <span class="k">fi</span>
                <span class="p">;;</span>

        down<span class="o">)</span>
                <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">$(</span>pidof vpnc<span class="k">)</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                        vpnc-disconnect
                        killall vpnc
                <span class="k">fi</span>
                <span class="p">;;</span>

        pre-up<span class="o">)</span>
                <span class="p">;;</span>

        post-down<span class="o">)</span>
                <span class="p">;;</span>

        *<span class="o">)</span>
                <span class="nb">echo</span> $<span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> {up|down|pre-up|post-down}"</span>
                <span class="nb">exit</span> <span class="m">1</span>
<span class="k">esac</span>
</pre></div>
</td></tr></table></div><p>Bei dieser Art, zu einem VPN-gesicherten WLAN zu verbinden, muss das Passwort im Klartext in der Datei <strong>/etc/vpnc/uni.conf</strong> gespeichert werden. Die Datei sollte daher <code class="notranslate">root</code> gehören und darf für andere nicht lesbar sein <sup><a href="#source-2">[2]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo chown root:root /etc/vpnc/uni.conf
sudo chmod 700 /etc/vpnc/uni.conf </pre></div></div><p>Das Skript <strong>/etc/NetworkManager/dispatcher.d/02uni-vpnc</strong> muss außerdem noch ausführbar gemacht werden <sup><a href="#source-2">[2]</a></sup>. Nun wird beim Verbindungsaufbau überprüft, ob man sich zu einem WLAN mit dem Namen <em>"VPN/WEB"</em> verbindet und, falls dies der Fall ist, automatisch eine VPN-Verbindung mittels <a class="internal" href="../vpnc.html">VPNC</a> ausgeführt.</p></div><div class="section_3"><h4 id="VPN-netzwerkabhaengig-starten-und-automatischer-Reconnect-mittels-NetworkManager">VPN netzwerkabhängig starten und automatischer Reconnect (mittels NetworkManager)<a class="headerlink" href="#VPN-netzwerkabhaengig-starten-und-automatischer-Reconnect-mittels-NetworkManager">¶</a></h4><p>
Möchte man, dass eine bestimmte VPN-Verbindung gestartet wird, sobald eine bestimmte WLAN-, LAN-, oder sonstige Verbindung hergestellt wurde, kann man dies mit der in Ubuntu 10.10 neu eingeführten API des NetworkManager leicht realisieren:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">REQUIRED_CONNECTION_NAME</span><span class="o">=</span><span class="s2">"&lt;LanConnection1&gt;"</span>
<span class="nv">VPN_CONNECTION_NAME</span><span class="o">=</span><span class="s2">"&lt;VpnConnection1&gt;"</span>


sleep <span class="s2">"3s"</span>

<span class="nv">active_con</span><span class="o">=</span><span class="k">$(</span>nmcli connection show --active <span class="p">|</span> grep <span class="s2">"</span><span class="si">${</span><span class="nv">REQUIRED_CONNECTION_NAME</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
<span class="nv">active_vpn</span><span class="o">=</span><span class="k">$(</span>nmcli connection show --active <span class="p">|</span> grep <span class="s2">"</span><span class="si">${</span><span class="nv">VPN_CONNECTION_NAME</span><span class="si">}</span><span class="s2">"</span><span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="si">${</span><span class="nv">active_con</span><span class="si">}</span><span class="s2">"</span> -a ! <span class="s2">"</span><span class="si">${</span><span class="nv">active_vpn</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span>
<span class="k">then</span>
    nmcli con up id <span class="s2">"</span><span class="si">${</span><span class="nv">VPN_CONNECTION_NAME</span><span class="si">}</span><span class="s2">"</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table></div><p>In diesem Skript müssen noch die Namen der erforderlichen Verbindung <code class="notranslate">&lt;LanConnection1&gt;</code> und der Name der VPN-Verbindung <code class="notranslate">&lt;VpnConnection1&gt;</code> eingetragen werden. Das Skript wird unter beliebigen Namen (z.B. <strong>02VPN1</strong>) in den Ordner des Dispacher <strong>/etc/NetworkManager/dispatcher.d/</strong> kopiert und die Rechte gesetzt.</p><pre class="notranslate">chown root:root /etc/NetworkManager/dispatcher.d/02VPN1
chmod 700 /etc/NetworkManager/dispatcher.d/02VPN1</pre><p>Natürlich lassen sich mit gleichem Aufwand auch Skripte erstellen, die bei Fehlen einer LAN- und WLAN-Verbindung eine UMTS-Verbindung automatisch aufbauen und diese bei Aktivierung einer Verbindung auch wieder abschalten.</p><div class="section_4"><h5 id="Ab-Ubuntu-11-10">Ab Ubuntu 11.10<a class="headerlink" href="#Ab-Ubuntu-11-10">¶</a></h5><p>
Seit Ubuntu 11.10 reicht das alleine allerdings nicht mehr aus, denn die Passwörter der VPN-Verbindung werden im <a class="internal" href="../gnome_schlüsselbund.html">GNOME Schlüsselbund</a> des angemeldeten Benutzers gespeichert. Die Skripte in dispatcher.d werden allerdings von root ausgeführt, welcher aber keinen Zugriff auf diese Passwörter hat. Deswegen kommt es dann zur Fehlermeldung "Keine gültigen VPN-Geheimnisse".</p><p>Um das zu ändern, öffnet man die Konfigurationsdatei der VPN-Verbindung, praktisch also eine Datei nach dem Muster <strong>/etc/NetworkManager/system-connections/VPN-VERBINDUNGSNAME</strong>. Dort ändert man bei den beiden Schlüsseln "<code class="notranslate">Xauth password-flags=</code>" und "<code class="notranslate">IPSec secret-flags=</code>" den voreinstellten Wert "<code class="notranslate">1</code>" auf "<code class="notranslate">0</code>". Damit wird der NetworkManager angewiesen, die Passwörter direkt in die Konfigurationsdatei statt in den Schlüsselbund zu speichern. Diese Passwörter müssen nun noch auf diese neue Art gespeichert werden. Um das zu erreichen, schließt man die Datei wieder und öffnet die Konfiguration der VPN-Verbindung über den NetworkManager. Dort schreibt man einmal das Gruppen- und das Benutzerpasswort hinein und schließt mit "Speichern" ab.</p><p>Um zu überprüfen, ob es funktioniert hat, öffnet man noch einmal die Datei <strong>/etc/NetworkManager/system-connections/VPN-VERBINDUNGSNAME</strong>. Dort sollten nun gegen Ende der Datei zwei neue Zeilen mit den Passwörtern ähnlich wie hier hinzugefügt worden sein:</p><pre class="notranslate">[vpn-secrets]
IPSec secret=GRUPPENKENNWORT
Xauth password=BENUTZERKENNWORT</pre><p>Ob der Verbindungsaufbau nun über root funktioniert, lässt sich mit folgendem Befehl im <a class="internal" href="../terminal.html">Terminal</a> testen:</p><pre class="notranslate">nmcli con up id VPN-VERBINDUNGSNAME</pre></div></div></div></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="internal" href="../networkmanager.html">NetworkManager</a> <img alt="{Übersicht}" src="../_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> Übersichtsartikel</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="../networkmanager/dispatcher/a/revision/940207.html">Diese Revision</a> wurde am 7. Mai 2017 14:35 von <a href="https://ubuntuusers.de/user/Heinrich_Schwietering/">Heinrich_Schwietering</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../startseite.html">Wiki</a></li>
<li><a href="../networkmanager.html">NetworkManager</a></li>
<li><a href="../networkmanager/dispatcher.html">Dispatcher</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>