<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Nur-Lesen_Root-Dateisystem › ubuntuusers statisches Wiki</title>
<link href="./_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="./_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="./_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="./_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="./_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="./_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="./startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="./nur-lesen_root-dateisystem.html">Nur-Lesen Root-Dateisystem</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Nur-Lesen_Root-Dateisystem">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="./wiki/index.html">Index</a></li>
<li><a href="./wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="./wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="./wiki.html">Übersicht</a></li>
<li><a href="./wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="./wiki/benutzung.html">Benutzung</a></li>
<li><a href="./kategorien.html">Kategorie</a></li>
<li><a href="./wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="./wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="./howto.html">Howto anlegen</a></li>
<li><a href="./wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="./wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="./baustelle.html">Baustellen</a></li>
<li><a href="./wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="./wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="./wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="./wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="./nur-lesen_root-dateisystem/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="./nur-lesen_root-dateisystem/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="./nur-lesen_root-dateisystem/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="./nur-lesen_root-dateisystem/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="./nur-lesen_root-dateisystem/a/backlinks.html">Nur-Lesen Root-Dateisystem</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p>
Dieser Artikel ist mit keiner aktuell unterstützten Ubuntu-Version getestet! Bitte diesen Artikel testen und das getestet-Tag entsprechend anpassen.
</p></div></div><p>
</p><p>
</p><div class="box advanced"><h3 class="box advanced">Artikel für fortgeschrittene Anwender</h3><div class="contents"><p>
Dieser Artikel erfordert mehr Erfahrung im Umgang mit
Linux und ist daher nur für fortgeschrittene Benutzer
gedacht.
</p></div></div><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="./terminal.html">Ein Terminal öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="./editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="./sudo.html">Root-Rechte</a></p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="./rechte.html">Rechte für Dateien und Ordner ändern</a></p></li></ol></div></div><div class="toc toc-depth-3"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#berblick">Überblick
</a></li><li><a class="crosslink" href="#Voraussetzungen">Voraussetzungen
</a></li><li><a class="crosslink" href="#Umsetzung">Umsetzung
</a><ol class="arabic"><li><a class="crosslink" href="#Funktion-des-Skripts-root-ro">Funktion des Skripts root-ro
</a></li><li><a class="crosslink" href="#nderungen-auf-dem-Nur-Lesen-Dateisystem-durchfuehren">Änderungen auf dem Nur-Lesen Dateisystem...</a></li></ol></li><li><a class="crosslink" href="#Deinstallation">Deinstallation
</a></li><li><a class="crosslink" href="#Das-Skript-root-ro">Das Skript root-ro
</a></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p>Dieser Artikel beschreibt, wie Schreibzugriffe auf das Root-<a class="internal" href="./dateisystem.html">Dateisystem</a> auf eine <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/RAM-Disk">RAM-Disk</a> umgeleitet werden können. Dadurch ergeben sich die unter anderem folgende Vorteile:
</p><ul><li><p>Nach jedem Neustart ist immer ein „sauberes“ (und stabiles) System verfügbar.</p></li><li><p>Das Root-Dateisystem kann nicht beschädigt werden, wenn der Rechner einfach ausgeschaltet wird.</p></li><li><p>Änderungen am Dateisystem werden sichtbar</p></li></ul><p>
Dabei liegt der Fokus dieses Artikels darauf, ein System für den alltäglichen Einsatz zu haben, wobei trotzdem einfache permanente Änderungen und <a class="internal" href="./update.html">Aktualisierungen</a> möglichen sind - z.B. als Media-Server, Automotive Computer etc. Denn das Nur-Lesen Dateisystem kann bei Bedarf beschreibbar <a class="internal" href="./mount.html">eingebunden</a> werden. Ist dies nicht gewünscht oder sollen noch weitere Anforderungen erfüllt werden, können evtl. die folgenden Ansätze weiterhelfen:
</p><ul><li><p>Der Wikipedia-Artikel <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Live-System">Live-System</a> beschreibt diverse Konfigurationen für verschieden Einsatzzwecke.</p></li><li><p>Das Aufsetzten eines einfachen Ubuntu Live-System auf einem USB-Stick ist im Artikel <a class="internal" href="./live-usb.html">Live-USB</a> beschrieben. </p></li><li><p>Einsatz von <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/SquashFS">SquashFS</a> für das Root-Dateisystem. Für jede permanente Änderung muss dann explizit ein neues Dateisystem-Abbild erzeugt werden. </p></li></ul><p>
</p><div class="section_1"><h2 id="berblick">Überblick<a class="headerlink" href="#berblick">¶</a></h2><p>
Prinzipiell existieren mit <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/aufs">aufs</a> und OverlayFS zwei Möglichkeiten, wie ein Nur-Lesen Root-Dateisystem erzeugt werden kann. Langfristig soll <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/aufs">aufs</a> aber durch OverlayFs ersetzt werden, da ersteres nur unter hohem Aufwand der Ubuntu-<a class="internal" href="./kernel.html">Kernel</a>-Maintainer (Betreuer) geführt werden kann. Denn die aufs-Unterstützung wird nicht in den Upstream-Kernel aufgenommen.</p></div><div class="section_1"><h2 id="Voraussetzungen">Voraussetzungen<a class="headerlink" href="#Voraussetzungen">¶</a></h2><p>
Die <a class="internal" href="./kernelmodule.html">Kernelmodule</a> <code class="notranslate">aufs</code> bzw. <code class="notranslate">overlayfs</code> müssen verfügbar sein. Dies lässt sich mit folgenden Kommandos feststellen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo modprobe aufs </pre></div></div><p>bzw.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo modprobe overlayfs </pre></div></div><p>In den regulären von Ubuntu verwendeten Kerneln ist das <code class="notranslate">aufs</code>-Modul ab <a class="internal" href="./lucid.html">Ubuntu 10.04</a> bis einschließlich <a class="internal" href="./precise.html">Ubuntu 12.04</a> verfügbar, das <code class="notranslate">overlayfs</code>-Modul ist ab Version <a class="internal" href="./oneiric.html">11.10</a> im Standardkernel enthalten. Es gibt allerdings spezielle Kernel für Portierungen, in denen diese Module fehlen, wie z.B. der <a class="external" href="https://launchpad.net/~tiomap-dev/+archive/release:" rel="nofollow">neuste Kernel von TI</a> für die ARM OMAP Platformen.</p></div><div class="section_1"><h2 id="Umsetzung">Umsetzung<a class="headerlink" href="#Umsetzung">¶</a></h2><p>
Im Artikel <a class="internal" href="./archiv/nur-lesen_root-dateisystem_mit_aufs.html">Nur-Lesen Root-Dateisystem mit aufs</a> ist eine Anleitung enthalten, die auch für OverlayFs geeignet ist. Es sind lediglich folgende Anpassungen nötig:</p><ol class="arabic"><li><p>Das Modul <code class="notranslate">overlayfs</code> muss in die Datei <strong>/etc/initramfs-tools/modules</strong> eingefügt werden, damit es im <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/initramfs">initramfs</a> verfügbar ist: </p><div class="bash"><div class="contents"><pre class="notranslate">echo overlayfs &gt;&gt;/etc/initramfs-tools/modules </pre></div></div></li><li><p>Es wird ein anderes Skript benutzt, nämlich <strong>root-ro</strong>.</p><ul><li><p>Das <a class="crosslink" href="#Das-Skript-root-ro">root-ro Skript</a> muss unter <strong>/etc/initramfs-tools/scripts/init-bottom/root-ro</strong> gespeichert werden.</p></li><li><p>Es muss ausführbar gemacht werden <sup><a href="#source-4">[4]</a></sup>.</p></li></ul></li><li><p>Zuletzt muss das neue initramfs erstellt werden: </p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-initramfs -u  </pre></div></div></li></ol><p>
Dann kann das System neu gestartet werden. Ob alles geklappt hat, lässt sich dann mit folgendem Kommando überprüfen:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mount </pre></div></div><p>Falls die originale Rootpartition <strong>/dev/sdXY</strong> war, sollte die Ausgabe jetzt u.a. diese drei Einträge enthalten:
</p><pre class="notranslate">overlayfs-root on / type overlayfs (rw)
/dev/sdXY on /mnt/root-ro type ext4 (rw,relatime,user_xattr,acl,barrier=1,data=ordered)
tmpfs-root on /mnt/root-rw type tmpfs (rw,relatime)</pre><div class="section_2"><h3 id="Funktion-des-Skripts-root-ro">Funktion des Skripts root-ro<a class="headerlink" href="#Funktion-des-Skripts-root-ro">¶</a></h3><p>
</p><ul><li><p>Die echte Rootpartition ist unter <strong>/mnt/root-ro</strong> nur lesbar eingehängt.</p></li><li><p>Die RAM-Disk, welche die Änderungen aufnimmt, ist unter <strong>/mnt/root-rw</strong> eingehängt.</p></li><li><p>Es werden die Treiber <code class="notranslate">overlayfs</code> und <code class="notranslate">aufs</code> unterstützt, dies wird über den Kernel <a class="internal" href="./booten.html#Bootoptionen">Bootparameter</a> <code class="notranslate">root-ro-driver=[overlayfs|aufs]</code> definiert. Dabei ist <code class="notranslate">overlayfs</code> der Standardwert, falls nichts angegeben ist.</p></li></ul><p>
Zum Deaktivieren gibt es zwei Möglichkeiten:
</p><ul><li><p>Es wird der Kernel Bootparameter <code class="notranslate">disable-root-ro=true</code> übergeben.</p></li><li><p>Im echten Root-Dateisystem kann eine (leere) Datei <strong>disable-root-ro</strong> in dessen Wurzelverzeichnis angelegt werden, also unter <strong>/mnt/root-ro/disable-root-ro</strong>. Nach einem Neustart sollte die Datei wieder entfernt werden.</p></li></ul><p>
</p></div><div class="section_2"><h3 id="nderungen-auf-dem-Nur-Lesen-Dateisystem-durchfuehren">Änderungen auf dem Nur-Lesen Dateisystem durchführen<a class="headerlink" href="#nderungen-auf-dem-Nur-Lesen-Dateisystem-durchfuehren">¶</a></h3><p>
Das original Root-Dateisystem ist unter <strong>/mnt/root-ro</strong> eingehängt und kann beschreibbar gemacht werden mit
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mount -o remount,rw /mnt/root-ro </pre></div></div><p>Dann können Änderungen einfach kopiert werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">cp -v DATEI /mnt/root-ro </pre></div></div><p>Damit die Änderungen auch im „virtuellen“ Root-Dateisystem  sichtbar werden, ist ggf. ein Neustart erforderlich. Denn wenn es sowohl auf der RAM-Disk (<strong>/mnt/root-rw</strong>) als auch im echten Root-Dateisystem (<strong>/mnt/root-ro</strong>) einen Eintrag gibt, hat derjenige auf der RAM-Disk Vorrang.</p></div></div><div class="section_1"><h2 id="Deinstallation">Deinstallation<a class="headerlink" href="#Deinstallation">¶</a></h2><p>
Zur Deinstallation muss das Root-Dateinsystem zuerst wieder beschreibbar gemacht werden. Dafür gibt es die oben genannten Wege:
</p><ol class="arabic"><li><p>Den Kernel mit dem Parameter <code class="notranslate">disable-root-ro=true</code> starten</p></li><li><p>Oder die „magische“ Datei <strong>disable-root-ro</strong> benutzen </p><div class="bash"><div class="contents"><pre class="notranslate">sudo mount -o remount,rw /mnt/root-ro
sudo touch /mnt/root-ro/disable-root-ro </pre></div></div><p> neu starten </p><div class="bash"><div class="contents"><pre class="notranslate">sudo reboot  </pre></div></div><p> und nach dem Neustart die Datei wieder löschen: </p><div class="bash"><div class="contents"><pre class="notranslate">sudo rm /disable-root-ro </pre></div></div></li></ol><p>
Wurde das System mit einem „normalen“ beschreibaren Root-Dateisystem gestartet, kann das Skript einfach gelöscht und ein neues initramfs erzeugt werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo rm /etc/initramfs-tools/scripts/init-bottom/root-ro
sudo update-initramfs -u  </pre></div></div></div><div class="section_1"><h2 id="Das-Skript-root-ro">Das Skript root-ro<a class="headerlink" href="#Das-Skript-root-ro">¶</a></h2><p>
</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1">#  Copyright, 2012 Axel Heider</span>
<span class="c1">#</span>
<span class="c1">#  Based on scrpts from</span>
<span class="c1">#    Sebastian P.</span>
<span class="c1">#    Nicholas A. Schembri State College PA USA</span>
<span class="c1">#</span>
<span class="c1">#  This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#  it under the terms of the GNU General Public License as published by</span>
<span class="c1">#  the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#  (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#  This program is distributed in the hope that it will be useful,</span>
<span class="c1">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#  GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see</span>
<span class="c1">#    &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Tested with Ubuntu 11.10</span>
<span class="c1">#</span>
<span class="c1"># Notes:</span>
<span class="c1">#   * no changes to the root fs are made by this script. </span>
<span class="c1">#   * if /home/[user] is on the RO root fs, files are in ram and not saved.</span>
<span class="c1">#</span>
<span class="c1"># Install:</span>
<span class="c1">#  put this file in /etc/initramfs-tools/scripts/init-bottom/root-ro</span>
<span class="c1">#  chmod 0755 root-ro</span>
<span class="c1">#  optional: clean up menu.lst, update-grub</span>
<span class="c1">#  update-initramfs -u</span>
<span class="c1">#</span>
<span class="c1"># Disable read-only root fs</span>
<span class="c1">#   * option 1: kernel boot parameter "disable-root-ro=true"</span>
<span class="c1">#   * option 2: create file "/disable-root-ro"</span>
<span class="c1">#</span>
<span class="c1"># ROOT_RO_DRIVER variable controls which driver isused for the ro/rw layering</span>
<span class="c1">#   Supported drivers are: overlayfs, aufs</span>
<span class="c1">#  the kernel parameter "root-ro-driver=[driver]" can be used to initialize</span>
<span class="c1">#  the variable ROOT_RO_DRIVER. If nothing is given, overlayfs is used.</span>
<span class="c1">#</span>

<span class="c1"># no pre requirement</span>
<span class="nv">PREREQ</span><span class="o">=</span><span class="s2">""</span>

prereqs<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="si">${</span><span class="nv">PREREQ</span><span class="si">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="k">case</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> in
    prereqs<span class="o">)</span>
    prereqs
    <span class="nb">exit</span> <span class="m">0</span>
    <span class="p">;;</span>
<span class="k">esac</span>

. /scripts/functions

<span class="nv">MYTAG</span><span class="o">=</span><span class="s2">"root-ro"</span>
<span class="nv">DISABLE_MAGIC_FILE</span><span class="o">=</span><span class="s2">"/disable-root-ro"</span>

<span class="c1"># parse kernel boot command line </span>
<span class="nv">ROOT_RO_DRIVER</span><span class="o">=</span>
<span class="nv">DISABLE_ROOT_RO</span><span class="o">=</span>
<span class="k">for</span> CMD_PARAM in <span class="k">$(</span>cat /proc/cmdline<span class="k">)</span><span class="p">;</span> <span class="k">do</span> 
    <span class="k">case</span> <span class="si">${</span><span class="nv">CMD_PARAM</span><span class="si">}</span> in 
        disable-root-ro<span class="o">=</span>*<span class="o">)</span>
            <span class="nv">DISABLE_ROOT_RO</span><span class="o">=</span><span class="si">${</span><span class="nv">CMD_PARAM</span><span class="p">#disable-root-ro=</span><span class="si">}</span>
            <span class="p">;;</span>
        root-ro-driver<span class="o">=</span>*<span class="o">)</span>
            <span class="nv">ROOT_RO_DRIVER</span><span class="o">=</span><span class="si">${</span><span class="nv">CMD_PARAM</span><span class="p">#root-ro-driver=</span><span class="si">}</span>
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done</span>

<span class="c1"># check if read-only root fs is disabled</span>
<span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">"</span><span class="si">${</span><span class="nv">DISABLE_ROOT_RO</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_warning_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2">: disabled, found boot parameter disable-root-ro=</span><span class="si">${</span><span class="nv">DISABLE_ROOT_RO</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> -e <span class="s2">"</span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">DISABLE_MAGIC_FILE</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_warning_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2">: disabled, found file </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">DISABLE_MAGIC_FILE</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># generic settings </span>
<span class="c1"># ${ROOT} and ${rootmnt} are predefined by caller of this script. Note that</span>
<span class="c1"># the root fs ${rootmnt} it mounted readonly on the initrams, which fits nicely</span>
<span class="c1"># for our purposes.</span>
<span class="nv">ROOT_RW</span><span class="o">=</span>/mnt/root-rw
<span class="nv">ROOT_RO</span><span class="o">=</span>/mnt/root-ro

<span class="c1"># check if ${ROOT_RO_DRIVER} is defined, otherwise set default </span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">"</span><span class="si">${</span><span class="nv">ROOT_RO_DRIVER</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">ROOT_RO_DRIVER</span><span class="o">=</span>overlayfs
<span class="k">fi</span>
<span class="c1"># settings based in ${ROOT_RO_DRIVER}, stop here if unsupported. </span>
<span class="k">case</span> <span class="si">${</span><span class="nv">ROOT_RO_DRIVER</span><span class="si">}</span> in
    overlayfs<span class="o">)</span>
        <span class="nv">MOUNT_PARMS</span><span class="o">=</span><span class="s2">"-t overlayfs -o lowerdir=</span><span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2">,upperdir=</span><span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span><span class="s2"> overlayfs-root </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">;;</span>
    aufs<span class="o">)</span>
        <span class="nv">MOUNT_PARMS</span><span class="o">=</span><span class="s2">"-t aufs -o dirs=</span><span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2">=ro aufs-root </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">;;</span>
    *<span class="o">)</span>
        panic <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: invalide ROOT_RO_DRIVER </span><span class="si">${</span><span class="nv">ROOT_RO_DRIVER</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">;;</span>
<span class="k">esac</span>


<span class="c1"># check if kernel module exists </span>
modprobe -qb <span class="si">${</span><span class="nv">ROOT_RO_DRIVER</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: missing kernel module </span><span class="si">${</span><span class="nv">ROOT_RO_DRIVER</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># make the mount point on the init root fs ${ROOT_RW}</span>
<span class="o">[</span> -d <span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to create </span><span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># make the mount point on the init root fs ${ROOT_RO}</span>
<span class="o">[</span> -d <span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to create </span><span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># mount a tempfs using the device name tmpfs-root at ${ROOT_RW}</span>
mount -t tmpfs tmpfs-root <span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to create tmpfs"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>


<span class="c1"># root is mounted on ${rootmnt}, move it to ${ROOT_RO}.</span>
mount --move <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span> <span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to move root away from </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span><span class="s2"> to </span><span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># there is nothing left at ${rootmnt} now. So for any error we get we should</span>
<span class="c1"># either do recovery to restore ${rootmnt} for drop to a initramfs shell using</span>
<span class="c1"># "panic". Otherwise the boot process is very likely to fail with even more </span>
<span class="c1"># errors and leave the system in a wired state. </span>

<span class="c1"># mount virtual fs ${rootmnt} with rw-fs ${ROOT_RW} on top or ro-fs ${ROOT_RO}.</span>
mount <span class="si">${</span><span class="nv">MOUNT_PARMS</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to create new ro/rw layerd </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span><span class="s2">"</span>
    <span class="c1"># do recovery and try resoring the mount for ${rootmnt}</span>
    mount --move <span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span> <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
       <span class="c1"># thats badm, drpo to s shell to let the user try fixing this</span>
       panic <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> RECOVERY ERROR: failed to move </span><span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2"> back to </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">fi</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># now the real root fs is on ${ROOT_RO} of the init file system, our layered</span>
<span class="c1"># root fs is set up at ${rootmnt}. So we can write anywhere in {rootmnt} and the</span>
<span class="c1"># changes will end up in ${ROOT_RW} while ${ROOT_RO} it not touched. However </span>
<span class="c1"># ${ROOT_RO} and ${ROOT_RW} are on the initramfs root fs, which will be removed</span>
<span class="c1"># an replaced by ${rootmnt}. Thus we must move ${ROOT_RO} and ${ROOT_RW} to the</span>
<span class="c1"># rootfs visible later, ie. ${rootmnt}${ROOT_RO} and ${rootmnt}${ROOT_RO}.</span>
<span class="c1"># Since the layered ro/rw is already up, these changes also end up on </span>
<span class="c1"># ${ROOT_RW} while ${ROOT_RO} is not touched.</span>

<span class="c1"># move mount from ${ROOT_RO} to ${rootmnt}${ROOT_RO} </span>
<span class="o">[</span> -d <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RO</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RO</span><span class="si">}</span>
mount --move <span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span> <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RO</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to move </span><span class="si">${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2"> to </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RO</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># move mount from ${ROOT_RW} to ${rootmnt}${ROOT_RW} </span>
<span class="o">[</span> -d <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RW</span><span class="si">}</span> <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RW</span><span class="si">}</span>
mount --move <span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span> <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RW</span><span class="si">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    s <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2">: ERROR: failed to move </span><span class="si">${</span><span class="nv">ROOT_RW</span><span class="si">}</span><span class="s2"> to </span><span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RW</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># technically, everything is set up nicely now. Since ${rootmnt} had beend </span>
<span class="c1"># mounted read-only on the initfamfs already, ${rootmnt}${ROOT_RO} is it, too.</span>
<span class="c1"># Now we init process could run - but unfortunately, we may have to prepare </span>
<span class="c1"># some more things here. </span>
<span class="c1"># Basically, there are two ways to deal with the read-only root fs. If the </span>
<span class="c1"># system  is made aware of this, things can be simplified a lot.</span>
<span class="c1"># If it is not, things need to be done to our best knowledge. </span>
<span class="c1">#</span>
<span class="c1"># So we assume here, the system does not really know about our read-only root fs.</span>
<span class="c1">#</span>
<span class="c1"># Let's deal with /etc/fstab first. It usually contains an entry for the root </span>
<span class="c1"># fs, which is no longer valid now. We have to remove it and add our new </span>
<span class="c1"># ${ROOT_RO} entry. </span>
<span class="c1"># Remember we are still on the initramfs root fs here, so we have to work on</span>
<span class="c1"># ${rootmnt}/etc/fstab. The original fstab is ${rootmnt}${ROOT_RO}/etc/fstab.</span>
<span class="nv">ROOT_TYPE</span><span class="o">=</span><span class="k">$(</span>cat /proc/mounts <span class="p">|</span> grep <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span> <span class="p">|</span> cut -d<span class="s1">' '</span> -f3<span class="k">)</span>
<span class="nv">ROOT_OPTIONS</span><span class="o">=</span><span class="k">$(</span>cat /proc/mounts <span class="p">|</span> grep <span class="si">${</span><span class="nv">ROOT</span><span class="si">}</span> <span class="p">|</span> cut -d<span class="s1">' '</span> -f4<span class="k">)</span>
cat <span class="s">&lt;&lt;EOF &gt;${rootmnt}/etc/fstab</span>
<span class="s">#</span>
<span class="s">#  This fstab is in RAM, the real one can be found at ${ROOT_RO}/etc/fstab</span>
<span class="s">#  The original entry for '/' and all swap files have been removed.  The new </span>
<span class="s">#  entry for the read-only the real root fs follows. Write access can be </span>
<span class="s">#  enabled using:</span>
<span class="s">#    sudo mount -o remount,rw ${ROOT_RO}</span>
<span class="s">#  re-mounting it read-only is done using:</span>
<span class="s">#    sudo mount -o remount,ro ${ROOT_RO}</span>
<span class="s">#</span>

<span class="s">${ROOT} ${ROOT_RO} ${ROOT_TYPE} ${ROOT_OPTIONS} 0 0</span>

<span class="s">#</span>
<span class="s">#  remaining entries from the original ${ROOT_RO}/etc/fstab follow.</span>
<span class="s">#</span>
<span class="s">EOF</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to modify /etc/fstab (step 1)"</span>
    <span class="c1">#exit 0</span>
<span class="k">fi</span>

<span class="c1">#remove root entry and swap from fstab</span>
cat <span class="si">${</span><span class="nv">rootmnt</span><span class="si">}${</span><span class="nv">ROOT_RO</span><span class="si">}</span>/etc/fstab <span class="p">|</span> grep -v <span class="s1">' / '</span> <span class="p">|</span> grep -v swap &gt;&gt;<span class="si">${</span><span class="nv">rootmnt</span><span class="si">}</span>/etc/fstab
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    log_failure_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> ERROR: failed to modify etc/fstab (step 2)"</span>
    <span class="c1">#exit 0</span>
<span class="k">fi</span>

<span class="c1"># now we are done. Additinal steps may be necessary depending on the actualy</span>
<span class="c1"># distribution and/or its configuration. </span>

log_success_msg <span class="s2">"</span><span class="si">${</span><span class="nv">MYTAG</span><span class="si">}</span><span class="s2"> sucessfully set up ro/tmpfs-rw layered root fs using </span><span class="si">${</span><span class="nv">ROOT_RO_DRIVER</span><span class="si">}</span><span class="s2">"</span>

<span class="nb">exit</span> <span class="m">0</span> 
</pre></div>
</td></tr></table></div></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="internal" href="./chroot/persistente-installation.html">chroot/persistente-Installation</a></p></li><li><p><a class="interwiki interwiki-ubuntu_doc" href="https://help.ubuntu.com/community/aufsRootFileSystemOnUsbFlash">aufsRootFileSystemOnUsbFlash</a> - Hier gibt es evtl eine aktuellere Version des Skripts root-ro.</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="./nur-lesen_root-dateisystem/a/revision/938618.html">Diese Revision</a> wurde am 1. Mai 2017 17:00 von <a href="https://ubuntuusers.de/user/Heinrich_Schwietering/">Heinrich_Schwietering</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="./startseite.html">Wiki</a></li>
<li><a href="./nur-lesen_root-dateisystem.html">Nur-Lesen Root-Dateisystem</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="./_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="./_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="./_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="./_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>