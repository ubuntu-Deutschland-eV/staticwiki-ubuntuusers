<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>OpenLDAP_ab_Precise › ubuntuusers statisches Wiki</title>
<link href="./_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="./_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="./_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="./_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="./_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="./_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="./startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="./openldap_ab_precise.html">OpenLDAP ab Precise</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/OpenLDAP_ab_Precise">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="./wiki/index.html">Index</a></li>
<li><a href="./wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="./wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="./wiki.html">Übersicht</a></li>
<li><a href="./wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="./wiki/benutzung.html">Benutzung</a></li>
<li><a href="./kategorien.html">Kategorie</a></li>
<li><a href="./wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="./wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="./howto.html">Howto anlegen</a></li>
<li><a href="./wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="./wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="./baustelle.html">Baustellen</a></li>
<li><a href="./wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="./wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="./wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="./wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="./openldap_ab_precise/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="./openldap_ab_precise/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="./openldap_ab_precise/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="./openldap_ab_precise/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="./openldap_ab_precise/a/backlinks.html">OpenLDAP ab Precise</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p>
Dieser Artikel ist mit keiner aktuell unterstützten Ubuntu-Version getestet! Bitte diesen Artikel testen und das getestet-Tag entsprechend anpassen.
</p></div></div><p>
</p><p>
</p><div class="box advanced"><h3 class="box advanced">Artikel für fortgeschrittene Anwender</h3><div class="contents"><p>
Dieser Artikel erfordert mehr Erfahrung im Umgang mit
Linux und ist daher nur für fortgeschrittene Benutzer
gedacht.
</p></div></div><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="./pakete_installieren.html">Installation von Programmen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="./terminal.html">Ein Terminal öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="./editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="./rechte.html">Dateirechte ändern</a></p></li><li><p><a class="crosslink anchor" href="#source-5" id="source-5"></a> <a class="internal" href="./sudo.html">Root-Rechte</a></p></li></ol></div></div><p>
</p><div class="toc toc-depth-3"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Installation">Installation
</a><ol class="arabic"><li><a class="crosslink" href="#Installation-der-benoetigten-Pakete">Installation der benötigten Pakete
</a></li><li><a class="crosslink" href="#LDAP-Schemata-einfuegen">LDAP-Schemata einfügen
</a><ol class="arabic"><li><a class="crosslink" href="#Erstellen-der-Datei-schema-convert-conf">Erstellen der Datei schema_convert.con...</a></li><li><a class="crosslink" href="#Verzeichnis-fuer-die-LDIF-Dateien">Verzeichnis für die LDIF-Dateien
</a></li><li><a class="crosslink" href="#Konvertieren-ins-LDIF-Format-und-Kopieren-der-Schemata">Konvertieren ins LDIF-Format und Kopie...</a></li><li><a class="crosslink" href="#Anpassen-der-Attribute">Anpassen der Attribute
</a></li><li><a class="crosslink" href="#Loeschen-der-letzten-sieben-Zeilen-in-der-LDIF-Datei">Löschen der letzten sieben Zeilen in d...</a></li><li><a class="crosslink" href="#Backend-hinzufuegen">Backend hinzufügen
</a></li></ol></li><li><a class="crosslink" href="#Konfiguration-ueber-cn-config-Datenbank-etc-ldap-slapd-d">Konfiguration über cn=config-Datenbank (...</a></li><li><a class="crosslink" href="#Testen">Testen
</a></li></ol></li><li><a class="crosslink" href="#Verwendung-von-SASL">Verwendung von SASL
</a></li><li><a class="crosslink" href="#Sichere-bertragung-mit-TLS-SSL">Sichere Übertragung mit TLS/SSL
</a><ol class="arabic"><li><a class="crosslink" href="#Erstellung-der-benoetigten-Server-Zertifikate">Erstellung der benötigten Server-Zertifi...</a><ol class="arabic"><li><a class="crosslink" href="#Selbstsigniertes-Zertifikat">Selbstsigniertes Zertifikat
</a></li><li><a class="crosslink" href="#Bereitstellung-durch-eine-eigene-Zertifizierungsstelle">Bereitstellung durch eine eigene Zerti...</a></li></ol></li><li><a class="crosslink" href="#Installation-des-LDAP-Server-Zertifikats">Installation des LDAP-Server-Zertifikats...</a></li><li><a class="crosslink" href="#Anpassung-der-Konfiguration-cn-config-Datenbank">Anpassung der Konfiguration (cn=config-D...</a></li><li><a class="crosslink" href="#Restart-des-slapd-Daemons">Restart des slapd-Daemons
</a></li><li><a class="crosslink" href="#Test">Test
</a></li></ol></li><li><a class="crosslink" href="#Tipps-und-Tricks">Tipps und Tricks
</a><ol class="arabic"><li><a class="crosslink" href="#Backup-der-Konfiguration-und-der-Datenbank">Backup der Konfiguration und der Datenba...</a></li></ol></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p>
<img alt="LDAPworm.gif" class="image-left" src="./_/5dbb841e1356619326f77458e11e8c1633e40324.png"/>
<a class="external" href="http://www.openldap.org/" rel="nofollow">OpenLDAP</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> stellt das Anwendungsprotokoll <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/LDAP">LDAP</a> als freie Software für Linux zur Verfügung. Mit diesem Dienst ist es beispielsweise möglich, eine zentrale Benutzerverwaltung aufzubauen. Zudem kann OpenLDAP als Adressbuch eingesetzt werden. Der LDAP-Verzeichnisdienst ist eine hierarchische Datenbank, in der strukturierte Objekte abgelegt werden. Jedes Objekt wird mit einer Menge von Attributen ausgestattet, die in einer Objektklasse festgelegt sind. Ein Objekt kann dazu mehreren Objektklassen angehören, um unterschiedliche Eigenschaften auszudrücken.</p><p>Vor einer Installationen und/oder Updates wird die Lektüre des Abschnitts <a class="crosslink" href="#tipps">Tipps und Tricks</a> empfohlen!</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>LDAP ist ein recht komplexes Thema. Es ist empfehlenswert, vor der Nutzung weitere Literatur zu Rate zu ziehen, um ein besseres Verständnis für die Funktionsweise und die Möglichkeiten zu bekommen. Bevor man OpenLDAP auf einem produktiven System installiert, wird empfohlen, zuerst auf einem Testsystem zu installieren und sich ein bisschen einzuarbeiten, da es teilweise in der Bedienung nicht besonders intuitiv ist.</p><p>Die Befehle in diesem Artikel müssen im Allgemeinen als <code class="notranslate">root</code> ausgeführt werden. Es bietet sich deshalb an, mit</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -i </pre></div></div><p>
in eine root-Shell zu wechseln.
</p></div></div><p><a class="crosslink anchor" href="#install" id="install"></a>
</p><div class="section_1"><h2 id="Installation">Installation<a class="headerlink" href="#Installation">¶</a></h2><p>
</p><div class="section_2"><h3 id="Installation-der-benoetigten-Pakete">Installation der benötigten Pakete<a class="headerlink" href="#Installation-der-benoetigten-Pakete">¶</a></h3><p>
Folgende Pakete sind für Open LDAP <sup><a href="#source-1">[1]</a></sup> zu installieren. Beide befinden sich  in den offiziellen Paketquellen.</p><ul><li><p><strong>slapd</strong></p></li><li><p><strong>ldap-utils</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install slapd ldap-utils </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install slapd ldap-utils </pre></div></div><p>
</p></div></div></div><div class="section_2"><h3 id="LDAP-Schemata-einfuegen">LDAP-Schemata einfügen<a class="headerlink" href="#LDAP-Schemata-einfuegen">¶</a></h3><p>
Als nächstes werden einige, der von Ubuntu im <strong>LDIF</strong>-Format mitgelieferte Schemata, eingefügt. Die Schemata
</p><ul><li><p><code class="notranslate">core</code></p></li><li><p><code class="notranslate">cosine</code></p></li><li><p><code class="notranslate">inetorgperson</code> und</p></li><li><p><code class="notranslate">nis</code></p></li></ul><p>sind bereits im Backend vorhanden. Es können u. a. noch folgende weitere Schemata hinzugefügt werden.</p><p>Zum besseren Verständnis hier die Schritte im einzelnen. Weiter <a class="crosslink" href="#BashScript">unten</a> ist ein bash script, welches die Erstellung der Dateien automatisiert.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/misc.ldif
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/openldap.ldif </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Es sind zwar beinahe alle Schemata schon als fertige <strong>.ldif</strong>-Dateien vorhanden, allerdings gibt es mit den Schemata <code class="notranslate">ldapns</code> und <code class="notranslate">samba</code> kleine Probleme.</p><p>Sollte OpenLDAP nicht zusammen mit <a class="internal" href="./samba.html">Samba</a> betrieben werden, ist das Schema <code class="notranslate">samba.schema</code> nicht nötig. In diesem Fall sind im folgenden alle Zeilen, welche <em>samba</em> als Wortlaut enthalten, wegzulassen.
</p></div></div><p>Weitere Schemata (wie z. B. <code class="notranslate">samba.schema</code>), die nicht im <strong>LDIF</strong>-Format vorliegen, müssen zunächst konvertiert werden.</p><div class="section_3"><h4 id="Erstellen-der-Datei-schema-convert-conf">Erstellen der Datei <strong>schema_convert.conf</strong><a class="headerlink" href="#Erstellen-der-Datei-schema-convert-conf">¶</a></h4><p>
Im Verzeichnis <strong>/etc/ldap/schema</strong> ist die Datei <strong>schema_convert.conf</strong> mit den einzufügenden Schemata zu erstellen. Das folgende Beispiel fügt die gängigsten Schemata hinzu.</p><pre class="notranslate">include /etc/ldap/schema/core.schema
include /etc/ldap/schema/collective.schema
include /etc/ldap/schema/corba.schema
include /etc/ldap/schema/cosine.schema
include /etc/ldap/schema/duaconf.schema
include /etc/ldap/schema/dyngroup.schema
include /etc/ldap/schema/inetorgperson.schema
include /etc/ldap/schema/java.schema
include /etc/ldap/schema/misc.schema
include /etc/ldap/schema/nis.schema
include /etc/ldap/schema/openldap.schema
include /etc/ldap/schema/ppolicy.schema
include /etc/ldap/schema/ldapns.schema
include /etc/ldap/schema/pmi.schema
include /etc/ldap/schema/samba.schema</pre><div class="box experts"><h3 class="box experts">Experten-Info:</h3><div class="contents"><p>Wer weiß, welche Schemata auf welchen aufbauen, kann die Liste verkürzen und sich so etwas Arbeit sparen. Es ist aber auch unbedenklich, die ganze Liste so zu installieren.
</p></div></div><p>Auch die schon in die <code class="notranslate">cn=config</code>-Datenbank eingefügten Schemata müssen in <strong>schema_convert.conf</strong> aufgeführt werden, da die anderen Schemata teilweise auf ihnen aufbauen!</p><p>Das Schema <code class="notranslate">samba.schema</code> wird wie folgt installiert<sup><a href="#source-1">[1]</a></sup>:</p><ul><li><p><strong>samba-doc</strong> (bis einschließlich <a class="internal" href="./wily.html">Ubuntu 15.10</a>)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install samba-doc </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install samba-doc </pre></div></div><p>
</p></div></div><div class="bash"><div class="contents"><pre class="notranslate">gunzip /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz
cp -v /usr/share/doc/samba-doc/examples/LDAP/samba.schema /etc/ldap/schema </pre></div></div></div><div class="section_3"><h4 id="Verzeichnis-fuer-die-LDIF-Dateien">Verzeichnis für die LDIF-Dateien<a class="headerlink" href="#Verzeichnis-fuer-die-LDIF-Dateien">¶</a></h4><p>
Als nächstes ist ein temporäres Verzeichnis für die <strong>.ldif</strong>-Dateien zu erstellen.</p><div class="bash"><div class="contents"><pre class="notranslate">mkdir /tmp/ldif_output </pre></div></div></div><div class="section_3"><h4 id="Konvertieren-ins-LDIF-Format-und-Kopieren-der-Schemata">Konvertieren ins LDIF-Format und Kopieren der Schemata<a class="headerlink" href="#Konvertieren-ins-LDIF-Format-und-Kopieren-der-Schemata">¶</a></h4><p>
Die Schemata sind ins <strong>LDIF</strong>-Format mit Hilfe von <strong>slapcat</strong> zu konvertieren und ins Verzeichnis <strong>/etc/ldap/schema</strong> zu kopieren. Die Zahlen zu den Schemata können durchaus variieren. Falls Fehlermeldungen auftreten, sind diese Schemata einzeln (mit den richtigen Nummern) zu kopieren!</p><div class="bash"><div class="contents"><pre class="notranslate">cd /etc/ldap/schema
slapcat -f schema_convert.conf -F /tmp/ldif_output -n0 
cd /tmp/ldif_output/cn\=config/cn\=schema/
cp cn={11}ppolicy.ldif cn={12}ldapns.ldif cn={13}samba.ldif cn={2}corba.ldif cn={4}duaconf.ldif cn={5}dyngroup.ldif cn={7}java.ldif /etc/ldap/schema </pre></div></div><p>
Das lästige <code class="notranslate">cn={x}</code> in den neuen <strong>.ldif</strong>-Dateien wird durch Umbenennen aus dem Dateinamen entfernt.</p></div><div class="section_3"><h4 id="Anpassen-der-Attribute">Anpassen der Attribute<a class="headerlink" href="#Anpassen-der-Attribute">¶</a></h4><p>
Nun können die neuen <strong>.ldif</strong>-Dateien in einem Editor geöffnet werden und die Attribute <code class="notranslate">dn</code> (in der 1. Zeile) und <code class="notranslate">cn</code> (in der 3. Zeile) angepasst werden. Dies wird am Beispiel des Samba-Schemas verdeutlicht.</p><pre class="notranslate">dn: cn=samba,cn=schema,cn=config
...
cn: samba</pre><p>
Vor dem Schließen der jeweiligen Datei kommt noch der nächste Punkt.</p></div><div class="section_3"><h4 id="Loeschen-der-letzten-sieben-Zeilen-in-der-LDIF-Datei">Löschen der letzten sieben Zeilen in der LDIF-Datei<a class="headerlink" href="#Loeschen-der-letzten-sieben-Zeilen-in-der-LDIF-Datei">¶</a></h4><p>
Die Zeichenfolgen hinter den <code class="notranslate">:</code> kann variieren.</p><pre class="notranslate">structuralObjectClass: olcSchemaConfig
entryUUID: bc124984-712d-102e-9274-5bec14760b98
creatorsName: cn=config
createTimestamp: 20091129122324Z
entryCSN: 20091129122324.626040Z#000000#000#000000
modifiersName: cn=config
modifyTimestamp: 20091129122324Z</pre><p><a class="crosslink anchor" href="#BashScript" id="BashScript"></a>
Dieses Script automatisiert die bis hier genannten Schritte. (Die Sicherheitsabfragen sind fehlerhaft uns müssen ggf. mit CRTL+C beeendet werden.) Da vielleicht nicht alle Schemata hinzugefügt werden sollen ist auf ein automatisches Hinzufügen aller Schemata verzichtet worden.</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nv">WORKINGDIR</span><span class="o">=</span>/tmp/ldapconfig
<span class="nv">LDAPCONFIGDIR</span><span class="o">=</span>/etc/ldap
<span class="nv">SCHEMADIR</span><span class="o">=</span><span class="nv">$LDAPCONFIGDIR</span>/schema
<span class="nv">SAMBAINSTALLED</span><span class="o">=</span><span class="s1">'Y'</span>
<span class="nv">SLAPDINSTALLED</span><span class="o">=</span><span class="s1">'Y'</span>
<span class="nv">TOPLEVEL_DOMAIN</span><span class="o">=</span><span class="s2">"de"</span>
<span class="nv">DOMAIN</span><span class="o">=</span><span class="s2">"domainname"</span>
<span class="nv">ROOTDN</span><span class="o">=</span><span class="s2">"dc=</span><span class="nv">$DOMAIN</span><span class="s2">,dc=</span><span class="nv">$TOPLEVEL_DOMAIN</span><span class="s2">"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="k">$(</span>id -u<span class="k">)</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	<span class="nb">echo</span> <span class="s2">"\033[1;31m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######     This script must be run as superuser      ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

	<span class="nb">echo</span> <span class="s2">"\033[1;33m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######      purging former slapd installations       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
	apt-get --yes purge slapd samba-doc ldap-utils <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &gt; /dev/null
	<span class="nb">echo</span>
	<span class="nb">echo</span> <span class="s2">"\033[0;32m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######                    DONE                       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
	<span class="nb">echo</span>

<span class="k">if</span> <span class="o">[</span> ! -x /usr/sbin/slappasswd <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	<span class="nb">echo</span> <span class="s2">"\033[1;33m############################################################"</span>
    <span class="nb">echo</span> <span class="s2">"#######      Openldap seems not to be installed.      ######"</span>
    <span class="nb">echo</span> <span class="s2">"#######         Shall I do that for you? [Y|n]        ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
    <span class="nb">read</span> SLAPDINSTALLED
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$SLAPDINSTALLED</span><span class="o">==</span><span class="s1">'Y'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     apt-get --yes  install slapd ldap-utils 
    <span class="k">fi</span>                                        
<span class="k">fi</span>

	<span class="nb">echo</span> <span class="s2">"\033[0;32m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######                    DONE                       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
	<span class="nb">echo</span>

<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$WORKINGDIR</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    mkdir -p <span class="nv">$WORKINGDIR</span>
<span class="k">else</span>
	<span class="nb">echo</span> <span class="s2">"\033[1;33m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######   It seems that a prevoius config is present. ######"</span>
	<span class="nb">echo</span> <span class="s2">"#######                 Titiying up.                  ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
    <span class="nb">echo</span>  
    rm -rf <span class="nv">$WORKINGDIR</span>
<span class="k">fi</span>

	<span class="nb">echo</span> <span class="s2">"\033[0;32m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######                    DONE                       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
	<span class="nb">echo</span>

<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$WORKINGDIR</span>/schema/ <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	mkdir -p <span class="nv">$WORKINGDIR</span>/schema/
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> -f /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

	<span class="nb">echo</span> <span class="s2">"\033[1;33m###########################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######   Samba documentaion seems to be installed,   ######"</span>
    <span class="nb">echo</span> <span class="s2">"#######    copying schema file to working directory   ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>

    zcat /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz &gt; <span class="nv">$WORKINGDIR</span>/schema/samba.schema
    <span class="nv">SAMBAINSTALLED</span><span class="o">==</span><span class="s1">'n'</span>
<span class="k">else</span>

	<span class="nb">echo</span> <span class="s2">"\033[1;33m############################################################"</span>
    <span class="nb">echo</span> <span class="s2">"####### Samba documentaion seems not to be installed. ######"</span>
    <span class="nb">echo</span> <span class="s2">"#######         Shall I do that for you? [Y|n]        ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
    <span class="nb">read</span> SAMBAINSTALLED
   <span class="k">if</span> <span class="o">[</span> <span class="nv">$SAMBAINSTALLED</span><span class="o">==</span><span class="s1">'Y'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     apt-get --yes  install samba-doc
   <span class="k">fi</span>
   zcat /usr/share/doc/samba-doc/examples/LDAP/samba.schema.gz &gt; <span class="nv">$WORKINGDIR</span>/schema/samba.schema
   apt-get purge samba-doc
<span class="k">fi</span>

	<span class="nb">echo</span> <span class="s2">"\033[0;32m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######                    DONE                       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
	<span class="nb">echo</span>

cat <span class="s">&lt;&lt; EOF &gt; $WORKINGDIR/slapd_temporary.conf </span>
<span class="s">include /etc/ldap/schema/core.schema</span>
<span class="s">include /etc/ldap/schema/collective.schema</span>
<span class="s">include /etc/ldap/schema/corba.schema</span>
<span class="s">include /etc/ldap/schema/cosine.schema</span>
<span class="s">include /etc/ldap/schema/duaconf.schema</span>
<span class="s">include /etc/ldap/schema/dyngroup.schema</span>
<span class="s">include /etc/ldap/schema/inetorgperson.schema</span>
<span class="s">include /etc/ldap/schema/java.schema</span>
<span class="s">include /etc/ldap/schema/misc.schema</span>
<span class="s">include /etc/ldap/schema/nis.schema</span>
<span class="s">include /etc/ldap/schema/openldap.schema</span>
<span class="s">include /etc/ldap/schema/ppolicy.schema</span>
<span class="s">include /etc/ldap/schema/ldapns.schema</span>
<span class="s">include /etc/ldap/schema/pmi.schema</span>
<span class="s">include $WORKINGDIR/schema/samba.schema</span>
<span class="s">EOF</span>

slapcat -f <span class="nv">$WORKINGDIR</span>/slapd_temporary.conf -F <span class="nv">$WORKINGDIR</span> -n0 <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> &gt; /dev/null

	<span class="nb">echo</span> <span class="s2">"\033[1;33m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######           Updating gnerated Schemas ...       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
    <span class="nb">echo</span>  

<span class="k">for</span> FILE in <span class="nv">$WORKINGDIR</span>/cn<span class="se">\=</span>config/cn<span class="se">\=</span>schema/*.ldif<span class="p">;</span> <span class="k">do</span>

	<span class="nb">echo</span> <span class="s2">"\033[1;33m Updating ldif schema file for '</span><span class="si">${</span><span class="nv">FILE</span><span class="p">#*</span><span class="se">\}</span><span class="si">}</span><span class="s2">' \033[0m"</span>

     <span class="c1"># remove file before filling it with contents</span>
     rm -f <span class="nv">$SCHEMADIR</span>/<span class="si">${</span><span class="nv">FILE</span><span class="p">#*</span><span class="se">\}</span><span class="si">}</span> 

     <span class="k">while</span> <span class="nv">IFS</span><span class="o">=</span><span class="s1">'#'</span> <span class="nb">read</span> LINE<span class="p">;</span> <span class="k">do</span> 
	 
        <span class="k">case</span> <span class="si">${</span><span class="nv">LINE</span><span class="p">%%:*</span><span class="si">}</span> in
          <span class="s2">"dn"</span><span class="o">)</span>
            <span class="nv">LINE</span><span class="o">=</span><span class="s2">"dn: cn="</span><span class="si">${</span><span class="nv">LINE</span><span class="p">#*</span><span class="se">\}</span><span class="si">}</span><span class="s2">", cn=schema, cn=config"</span>
          <span class="p">;;</span>

          <span class="s2">"cn"</span><span class="o">)</span>
           <span class="nv">LINE</span><span class="o">=</span><span class="s2">"cn: "</span><span class="si">${</span><span class="nv">LINE</span><span class="p">#*</span><span class="se">\}</span><span class="si">}</span>
          <span class="p">;;</span>

          <span class="s2">"structuralObjectClass"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>

          <span class="s2">"entryUUID"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>

          <span class="s2">"creatorsName"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>

          <span class="s2">"createTimestamp"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>

          <span class="s2">"entryCSN"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>


          <span class="s2">"modifiersName"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>

          <span class="s2">"modifyTimestamp"</span><span class="o">)</span>
           <span class="nb">unset</span> LINE
          <span class="p">;;</span>

        <span class="k">esac</span>      

	<span class="nb">echo</span> <span class="s2">"</span><span class="si">${</span><span class="nv">LINE</span><span class="p">#:*</span><span class="si">}</span><span class="s2">"</span> &gt;&gt; <span class="nv">$SCHEMADIR</span>/<span class="si">${</span><span class="nv">FILE</span><span class="p">#*</span><span class="se">\}</span><span class="si">}</span>

    <span class="k">done</span> &lt; <span class="nv">$FILE</span> 

<span class="k">done</span>

	<span class="nb">echo</span> <span class="s2">"\033[0;32m############################################################"</span>
	<span class="nb">echo</span> <span class="s2">"#######                    DONE                       ######"</span>
	<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
	<span class="nb">echo</span>
	
<span class="nb">echo</span> <span class="s2">"\033[1;33m###########################################################"</span>
<span class="nb">echo</span> <span class="s2">"#######        Enabling generated Schemas            ######"</span>
<span class="nb">echo</span> <span class="s2">"###########################################################\033[0m"</span>

<span class="k">for</span> FILE in <span class="nv">$SCHEMADIR</span>/*.ldif<span class="p">;</span> <span class="k">do</span>
	<span class="nb">echo</span> <span class="s2">"\033[1;33mAdding </span><span class="nv">$FILE</span><span class="s2">.\033[0m"</span>
	ldapadd -Y EXTERNAL -H ldapi:/// -f <span class="nv">$FILE</span>
<span class="k">done</span>

<span class="nb">echo</span> <span class="s2">"\033[1;33m############################################################"</span>
<span class="nb">echo</span> <span class="s2">"#######  Setting password for the config database ... ######"</span>
<span class="nb">echo</span> <span class="s2">"############################################################\033[0m"</span>
<span class="nb">echo</span>  

slappasswd &gt; <span class="nv">$WORKINGDIR</span>/secrethash.txt
chmod <span class="m">0400</span> <span class="nv">$WORKINGDIR</span>/secrethash.txt

cat <span class="s">&lt;&lt; EOF &gt; $WORKINGDIR/config_modify.ldif</span>
<span class="s"># Modify directory database</span>
<span class="s">dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">changeType: modify</span>
<span class="s">delete: olcSuffix</span>

<span class="s">dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">changeType: modify</span>
<span class="s">add: olcSuffix</span>
<span class="s">olcSuffix: $ROOTDN</span>

<span class="s">dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">changeType: modify</span>
<span class="s">delete: olcRootDN</span>

<span class="s">dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">changeType: modify</span>
<span class="s">add: olcRootDN</span>
<span class="s">olcRootDN: cn=admin,$ROOTDN</span>

<span class="s">dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">changeType: modify</span>
<span class="s">delete: olcRootPW</span>

<span class="s">dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">changeType: modify</span>
<span class="s">add: olcRootPW</span>
<span class="s">olcRootPW: $(cat $WORKINGDIR/secrethash.txt)</span>

<span class="s">## auskommentiert (stürzt ab... ubuntu 16.04)</span>
<span class="s">#dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">#changeType: modify</span>
<span class="s">#delete: olcDbIndex</span>

<span class="s">#dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">#changeType: modify</span>
<span class="s">#add: olcDbIndex</span>
<span class="s">#olcDbIndex: uid pres,eq</span>

<span class="s">#dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">#changeType: modify</span>
<span class="s">#add: olcDbIndex</span>
<span class="s">#olcDbIndex: cn,sn,mail pres,eq,approx,sub</span>

<span class="s">#dn: olcDatabase={1}mdb,cn=config</span>
<span class="s">#changeType: modify</span>
<span class="s">#add: olcDbIndex</span>
<span class="s">#olcDbIndex: objectClass eq</span>

<span class="s">###########################################################</span>
<span class="s"># REMOTE CONFIGURATION DEFAULTS</span>
<span class="s">###########################################################</span>
<span class="s"># Some defaults need to be added in order to allow remote </span>
<span class="s"># access by DN cn=admin,cn=config to the LDAP config </span>
<span class="s"># database. Otherwise only local root will </span>
<span class="s"># administrative access.</span>

<span class="s">dn: olcDatabase={0}config,cn=config</span>
<span class="s">changetype: modify</span>
<span class="s">add: olcRootDN</span>
<span class="s">olcRootDN: cn=admin,cn=config</span>

<span class="s">#dn: olcDatabase={0}config,cn=config</span>
<span class="s">#changeType: modify</span>
<span class="s">#delete: olcRootPW</span>

<span class="s">dn: olcDatabase={0}config,cn=config</span>
<span class="s">changetype: modify</span>
<span class="s">add: olcRootPW</span>
<span class="s">olcRootPW: $(cat $WORKINGDIR/secrethash.txt)</span>
<span class="s">EOF</span>

<span class="nb">echo</span> <span class="s2">"\033[1;33m###########################################################"</span>
<span class="nb">echo</span> <span class="s2">"#######       Modifying password settings            ######"</span>
<span class="nb">echo</span> <span class="s2">"###########################################################\033[0m"</span>

ldapadd -Y EXTERNAL -H ldapi:/// -f <span class="nv">$WORKINGDIR</span>/config_modify.ldif

cat <span class="s">&lt;&lt; EOF &gt; $WORKINGDIR/base.ldif</span>
<span class="s"># Tree root</span>
<span class="s">dn: $ROOTDN</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: dcObject</span>
<span class="s">objectClass: organization</span>
<span class="s">o: $DOMAIN.$TOPLEVEL_DOMAIN</span>
<span class="s">dc: $DOMAIN</span>
<span class="s">description: Tree root</span>

<span class="s"># LDAP admin</span>
<span class="s">dn: cn=admin,$ROOTDN</span>
<span class="s">objectClass: simpleSecurityObject</span>
<span class="s">objectClass: organizationalRole</span>
<span class="s">cn: admin</span>
<span class="s">userPassword: $(cat $WORKINGDIR/secrethash.txt)</span>
<span class="s">description: LDAP administrator for $ROOTDN</span>


<span class="s">dn: nisMapName=netgroup.byuser,$ROOTDN</span>
<span class="s">nismapname: netgroup.byuser</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: nisMap</span>

<span class="s">dn: ou=Networks,$ROOTDN</span>
<span class="s">ou: Networks</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: nisMapName=netgroup.byhost,$ROOTDN</span>
<span class="s">nismapname: netgroup.byhost</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: nisMap</span>

<span class="s">dn: ou=Users,$ROOTDN</span>
<span class="s">ou: People</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Rpc,$ROOTDN</span>
<span class="s">ou: Rpc</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Netgroup,$ROOTDN</span>
<span class="s">ou: Netgroup</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Services,$ROOTDN</span>
<span class="s">ou: Services</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Protocols,$ROOTDN</span>
<span class="s">ou: Protocols</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Mounts,$ROOTDN</span>
<span class="s">ou: Mounts</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Aliases,$ROOTDN</span>
<span class="s">ou: Aliases</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Group,$ROOTDN</span>
<span class="s">ou: Group</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>

<span class="s">dn: ou=Hosts,$ROOTDN</span>
<span class="s">ou: Hosts</span>
<span class="s">objectClass: top</span>
<span class="s">objectClass: organizationalUnit</span>
<span class="s">EOF</span>

<span class="nb">echo</span> <span class="s2">"\033[1;33m###########################################################"</span>
<span class="nb">echo</span> <span class="s2">"#######           Adding base Database               ######"</span>
<span class="nb">echo</span> <span class="s2">"###########################################################\033[0m"</span>

<span class="c1">#ldapadd -x -D cn=admin,$ROOTDN -y $WORKINGDIR/secrethash.txt -f $WORKINGDIR/base.ldif</span>
ldapadd -x -D <span class="nv">cn</span><span class="o">=</span>admin,<span class="nv">$ROOTDN</span> -W -f <span class="nv">$WORKINGDIR</span>/base.ldif

<span class="nb">echo</span> <span class="s2">"\033[1;33m###########################################################"</span>
<span class="nb">echo</span> <span class="s2">"#######      ENABLING SASL AUTHENTIFICATION          ######"</span>
<span class="nb">echo</span> <span class="s2">"###########################################################\033[0m"</span>

cat <span class="s">&lt;&lt; EOF &gt; $WORKINGDIR/sasl-digestmd5.ldif </span>

<span class="s">###########################################################</span>
<span class="s"># DEFAULTS MODIFICATION for SASL DIGEST-MD5</span>
<span class="s">###########################################################</span>
<span class="s"># Some of the defaults need to be modified in order to allow</span>
<span class="s"># SASL supported access to the LDAP config. </span>

<span class="s"># The LDAP administrator will need to tell the slapd server </span>
<span class="s"># how to map an authentication request DN to a user's </span>
<span class="s"># authentication DN. This is done by adding one or more </span>
<span class="s"># olcAuthzRegexp attributes to the cn=config backend. </span>
<span class="s"># This attribute takes two arguments:</span>
<span class="s">#</span>
<span class="s"># olcAuthzRegexp   &lt;search pattern&gt;   &lt;replacement pattern&gt;</span>
<span class="s"># </span>
<span class="s"># Please note, that more than one attribute can be specified. </span>
<span class="s"># The LDAP server will serve them sequentially.</span>

<span class="s">dn: cn=config</span>
<span class="s">changetype: modify</span>
<span class="s">add: olcAuthzRegexp</span>
<span class="s">olcAuthzRegexp: uid=root,cn=[^,]*,cn=auth cn=admin,${ROOTDN}</span>

<span class="s">dn: cn=config</span>
<span class="s">changetype: modify</span>
<span class="s">add: olcAuthzRegexp</span>
<span class="s">olcAuthzRegexp: uid=([^,]*),cn=[^,]*,cn=auth uid=\$1,ou=Users,${ROOTDN}</span>

<span class="s"># set the correct authentication policy</span>
<span class="s">dn: cn=config</span>
<span class="s">changetype: modify</span>
<span class="s">add: olcAuthzPolicy</span>
<span class="s">olcAuthzPolicy: to</span>

<span class="s"># User passwords have to stored as cleartext within the </span>
<span class="s"># LDAP directory</span>
<span class="s">dn: olcDatabase={-1}frontend,cn=config</span>
<span class="s">changetype: modify</span>
<span class="s">add: olcPasswordHash</span>
<span class="s">olcPasswordHash: {CLEARTEXT}</span>
<span class="s">EOF</span>

ldapadd -x -D <span class="nv">cn</span><span class="o">=</span>admin,cn<span class="o">=</span>config  -W  -f <span class="nv">$WORKINGDIR</span>/sasl-digestmd5.ldif 

service slapd restart 
</pre></div>
</td></tr></table></div></div><div class="section_3"><h4 id="Backend-hinzufuegen">Backend hinzufügen<a class="headerlink" href="#Backend-hinzufuegen">¶</a></h4><p>
Abschließend werden die Schemata dem config-Backend hinzugefügt (Vorsicht: Hier wurden die <code class="notranslate">cn={x}</code> schon entfernt).</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/ppolicy.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/ldapns.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/samba.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/corba.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/duaconf.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/dyngroup.ldif 
ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/java.ldif  </pre></div></div></div></div><div class="section_2"><h3 id="Konfiguration-ueber-cn-config-Datenbank-etc-ldap-slapd-d">Konfiguration über cn=config-Datenbank (/etc/ldap/slapd.d/)<a class="headerlink" href="#Konfiguration-ueber-cn-config-Datenbank-etc-ldap-slapd-d">¶</a></h3><p>
Bis vor einiger Zeit wurde das LDAP-Backend noch über die Datei <strong>/etc/ldap/slapd.conf</strong> konfiguriert. Inzwischen gibt es für die Konfiguration eine eigene, kleine Datenbank. Es ist möglich, eine Konfiguration in einer <strong>slapd.conf</strong> in die <code class="notranslate">cn=config</code>-Datenbank zu importieren. Empfohlen wird der hier gezeigte Weg.</p><p>In der nachfolgenden Konfiguration werden mehrere Platzhalter für Zeichenfolgen verwendet, die auf die eigenen Bedürfnisse anzupassen sind.</p><p>
</p><table><tr class="titel"><td colspan="2"> Platzhalter </td></tr><tr class="kopf"><td> Platzhalter </td><td> Beschreibung </td></tr><tr><td> dc=meinedomain,dc=local </td><td> Das ist der Suffix der LDAP-Datenbank. Meist wird dafür die eigene Domain gewählt. Würde dieses LDAP für ubuntuusers.de aufgesetzt, wäre es zum Beispiel <code class="notranslate">dc=ubuntuusers,dc=de</code> oder auch <code class="notranslate">dc=wiki,dc=ubuntuusers,dc=de</code>. </td></tr><tr><td> 1234 </td><td> Platzhalter für das Passwort. </td></tr><tr><td> {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1 </td><td> Platzhalter für den Hash, der noch erzeugt werden muss. </td></tr></table><p>Zunächst ist ein Passwort für die LDAP-Superuser festzulegen. Für diesen Wiki-Artikel werden beispielhaft zwei Superuser im LDAP-Backend angelegt.
</p><ul><li><p><code class="notranslate">cn=admin,cn=config</code> (Root für die <code class="notranslate">cn=config</code>-Datenbank, d. h. für das Konfigurationsverzeichnis des LDAP-Servers)</p></li><li><p><code class="notranslate">cn=admin,dc=meinedomain,dc=local</code> (Root für das eigentliche LDAP-Verzeichnis der Domäne <code class="notranslate">meinedomain.local</code>)</p></li></ul><p>
Dafür muss zuerst ein Passwort-Hash generiert werden.</p><div class="bash"><div class="contents"><pre class="notranslate">slappasswd </pre></div></div><pre class="notranslate">New password:
Re-enter new password:
{SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1</pre><p>
Dieser Hash wird später noch öfters benötigt.</p><p>Die <code class="notranslate">cn=config</code>-Datenbank wird weitgehend schon bei der Installation aufgesetzt. Es sind dennoch einige Anpassungen ratsam. Dafür wird eine Datei <strong>db.ldif</strong> erstellt und Folgendes eingefügt.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Es müssen zwei mal die Domain und zwei mal der Hash ersetzt werden!
</p></div></div><pre class="notranslate">###########################################################
# DEFAULT DATABASE MODIFICATION
###########################################################

# Modify directory database
dn: olcDatabase={1}mdb,cn=config
changeType: modify
delete: olcSuffix

dn: olcDatabase={1}mdb,cn=config
changeType: modify
add: olcSuffix
olcSuffix: dc=meinedomain,dc=local

dn: olcDatabase={1}mdb,cn=config
changeType: modify
delete: olcRootDN

dn: olcDatabase={1}mdb,cn=config
changeType: modify
add: olcRootDN
olcRootDN: cn=admin,dc=meinedomain,dc=local

dn: olcDatabase={1}mdb,cn=config
changeType: modify
delete: olcRootPW

dn: olcDatabase={1}mdb,cn=config
changeType: modify
add: olcRootPW
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1

dn: olcDatabase={1}mdb,cn=config
changeType: modify
delete: olcDbIndex

dn: olcDatabase={1}mdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: uid pres,eq

dn: olcDatabase={1}mdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: cn,sn,mail pres,eq,approx,sub

dn: olcDatabase={1}mdb,cn=config
changeType: modify
add: olcDbIndex
olcDbIndex: objectClass eq

###########################################################
# REMOTE CONFIGURATION DEFAULTS
###########################################################
# Some defaults need to be added in order to allow remote 
# access by DN cn=admin,cn=config to the LDAP config 
# database. Otherwise only local root will 
# administrative access.

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootDN
olcRootDN: cn=admin,cn=config

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1</pre><p>Diese Konfiguration wird mit folgendem Befehl in slapd eingelesen.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -Y EXTERNAL -H ldapi:/// -f db.ldif </pre></div></div><p>Dadurch wird der Administrator für das Konfigurations-Backend erstellt. Benötigt wird dieser immer dann, wenn die Konfiguration geändert werden soll.</p><p>Jetzt fehlen noch die Einträge für den LDAP DIT (= "Directory Information Tree", das eigentliche Verzeichnis des LDAP-Servers). Dazu ist eine weitere Datei namens <strong>base.ldif</strong> zu erstellen und Folgendes einzufügen.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Auch hier müssen zwei Domains und ein Hash angepasst werden. Zusätzlich sind <code class="notranslate">o: meinedomain.local</code> und <code class="notranslate">dc: meinedomain</code> anzupassen!
</p></div></div><pre class="notranslate"># Tree root
dn: dc=meinedomain,dc=local
objectClass: dcObject
objectClass: organization
o: meinedomain.local
dc: meinedomain
description: Tree root

# LDAP admin
dn: cn=admin,dc=meinedomain,dc=local
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
userPassword: {SSHA}dx0sCgNBPlx98eRYnun1QBNfrWUR6qM1
description: LDAP administrator</pre><p>Dadurch wird ein Superuser <code class="notranslate">cn=admin,dc=meinedomain,dc=local</code> mit dem Passwort <code class="notranslate">1234</code> erstellt, der von nun an <span class="underline">alle</span> Rechte am LDAP-Verzeichnis für <code class="notranslate">meinedomain.local</code> hat und über dessen Account nachfolgend das eigentliche LDAP-Verzeichnis initialisiert und befüllt wird.</p><p>Die Datei <strong>base.ldif</strong> wird über den Superuser-Account <code class="notranslate">cn=admin,dc=meinedomain,dc=local</code> eingelesen (wenn nach einem Passwort gefragt wird, das zuvor definierte Passwort <code class="notranslate">1234</code> eingeben).</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -D cn=admin,dc=meinedomain,dc=local -W -f base.ldif </pre></div></div></div><div class="section_2"><h3 id="Testen">Testen<a class="headerlink" href="#Testen">¶</a></h3><p>
Mit den folgenden Befehlen, die direkt auf dem Rechner mit dem OpenLDAP-Server ausgeführt werden müssen, kann die LDAP-Konfiguration testweise ausgelesen werden.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -xLLL -b cn=config -D cn=admin,cn=config -W olcDatabase={1}mdb
ldapsearch -xLLL -b cn=config -D cn=admin,cn=config -W </pre></div></div><p>Zum Auslesen der eigentlichen Verzeichnisdaten dient folgender Befehl (diesmal als anonymer Benutzer ohne Passworteingabe - daher wird beim Eintrag unter <code class="notranslate">cn=admin,dc=meinedomain,dc=local</code> das Passwort-Attribut nicht angezeigt):</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -xLLL -b dc=meinedomain,dc=local </pre></div></div><p><a class="crosslink anchor" href="#sasl" id="sasl"></a>
</p></div></div><div class="section_1"><h2 id="Verwendung-von-SASL">Verwendung von SASL<a class="headerlink" href="#Verwendung-von-SASL">¶</a></h2><p>
Die von OpenLDAP bereitgestellten LDAP-Client-Tools wie ldapsearch und ldapmodify versuchen standardmäßig, die Benutzer am LDAP-Verzeichnis-Server über Simple Authentication and Security Layer (<a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer">SASL</a>) mit DIGEST-MD5-Mechanismus zu authentifizieren. Daneben gibt es noch eine einfache Authentifizierung (mittels Option <code class="notranslate">-x</code>), die in den vorangegangenen Installations- und Konfigurationskapiteln zur Anwendung kam.</p><p>Mit ein paar zusätzlichen Schritten kann aber jedem Benutzer der Zugriff auf das LDAP-Verzeichnis mittels SASL-Authentifizierung ermöglicht werden. Dazu müssen die Linux-Benutzeraccounts wie <a class="internal" href="./archiv/openldap.html#migration">vorangehend beschrieben</a> in das LDAP-Verzeichnis migriert werden. Darüber hinaus müssen einige Attribute im <code class="notranslate">cn=config</code>-Backend korrekt gesetzt sein. Die Authentifizierung per SASL ist optional.</p><p>Für die Konfiguration mittels <code class="notranslate">cn=config</code>-Backend muss eine Datei <strong>sasl-digestmd5.ldif</strong> im Verzeichnis <strong>/etc/ldap</strong> mit nachfolgendem Inhalt erstellt werden. (Hier müssen wieder einige <code class="notranslate">dc</code> angepasst werden!)</p><pre class="notranslate">###########################################################
# DEFAULTS MODIFICATION for SASL DIGEST-MD5
###########################################################
# Some of the defaults need to be modified in order to allow
# SASL supported access to the LDAP config. 

# The LDAP administrator will need to tell the slapd server 
# how to map an authentication request DN to a user's 
# authentication DN. This is done by adding one or more 
# olcAuthzRegexp attributes to the cn=config backend. 
# This attribute takes two arguments:
#
# olcAuthzRegexp   &lt;search pattern&gt;   &lt;replacement pattern&gt;
# 
# Please note, that more than one attribute can be specified. 
# The LDAP server will serve them sequentially.

dn: cn=config
changetype: modify
add: olcAuthzRegexp
olcAuthzRegexp: uid=root,cn=[^,]*,cn=auth cn=admin,dc=meinedomain,dc=local

dn: cn=config
changetype: modify
add: olcAuthzRegexp
olcAuthzRegexp: uid=([^,]*),cn=[^,]*,cn=auth uid=$1,ou=Users,dc=meinedomain,dc=local

# set the correct authentication policy
dn: cn=config
changetype: modify
add: olcAuthzPolicy
olcAuthzPolicy: to

# User passwords have to stored as cleartext within the 
# LDAP directory
dn: olcDatabase={-1}frontend,cn=config
changetype: modify
add: olcPasswordHash
olcPasswordHash: {CLEARTEXT}</pre><p>Diese muss dann anschließend in das LDAP-Backend eingefügt werden.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -D cn=admin,cn=config -W -f /etc/ldap/sasl-digestmd5.ldif </pre></div></div><p>Der Neustart von slapd erfolgt mittels</p><div class="bash"><div class="contents"><pre class="notranslate">service slapd restart </pre></div></div><p>Nun müssen noch die Passwörter in Klartext im LDAP-Verzeichnis hinterlegt werden. Dazu muss das Passwort neu gesetzt werden. Dies kann jeder Benutzer (z.B. <code class="notranslate">user1</code>) selber durchführen</p><div class="bash"><div class="contents"><pre class="notranslate">ldappasswd -x -D uid=user1,ou=Users,dc=meinedomain,dc=local -W -s MeinPasswort uid=user1,ou=Users,dc=meinedomain,dc=local </pre></div></div><p>
oder der LDAP-Administrator (durch Neuvergabe):</p><div class="bash"><div class="contents"><pre class="notranslate">ldappasswd -x -D cn=admin,dc=meinedomain,dc=local -W -s NeuesPasswort uid=user1,ou=Users,dc=meinedomain,dc=local </pre></div></div><p>
Nach Eingabe von:</p><div class="bash"><div class="contents"><pre class="notranslate">user1@MeinComputer:~$ ldapsearch -b dc=meinedomain,dc=local </pre></div></div><p>
und dem Passwort sollte jeder Benutzer die im LDAP-Verzeichnis hinterlegten Benutzer und Gruppen mit den dazugehörigen Attributen angezeigt bekommen.</p><pre class="notranslate">SASL/DIGEST-MD5 authentication started
Please enter your password: 
SASL username: user1
SASL SSF: 128
SASL data security layer installed.
# extended LDIF
#
# LDAPv3
# base &lt;dc=meinedomain,dc=local&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# meinedomain.local
dn: dc=meinedomain,dc=local
objectClass: dcObject
objectClass: organization
o: meinedomain.local
dc: meinedomain
description: Tree root

# admin, meinedomain.local
dn: cn=admin,dc=meinedomain,dc=local
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
...</pre><p>Zum Abschluss muss auch noch das Passwort des LDAP-Verzeichnis-Administrators (<code class="notranslate">cn=admin,dc=meinedomain,dc=local</code>) als Klartext im LDAP-Verzeichnis hinterlegt werden. Ganz zu Beginn der Installation des OpenLDAP-Servers wurde ja nur ein Passwort-Hash eingetragen. Der von den LDAP-Client-Tools standardmäßig für die Benutzerauthentifizierung verwendete SASL-DIGEST-MD5-Mechanismus erfordert aber zwingend die Ablage der Passwörter als Klartext im LDAP-Verzeichnis. LDAP-Abfragen erfolgen mit Root-Rechten wie z.B.:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ldapsearch -b ou=Users,dc=meinedomain,dc=local -LLL uid=user1 </pre></div></div><pre class="notranslate">SASL/DIGEST-MD5 authentication started
Please enter your password: 
SASL username: root
SASL SSF: 128
SASL data security layer installed</pre><p>
werden aus Sicherheitsgründen mittels der oben definierten Authentication-Replace-Anweisung <code class="notranslate">authz-regexp uid=admin,cn=[^,]*,cn=auth cn=admin,dc=meinedomain,dc=local</code> über den LDAP-Admin authentifiziert. Unter <code class="notranslate">Please enter your password:</code> ist deshalb das Passwort <code class="notranslate">1234</code> des LDAP-Admin einzugeben. So kann <code class="notranslate">root</code>, ohne selbst im LDAP-Verzeichnis abgelegt zu sein, auf dasselbe zugreifen. Die Hinterlegung des Passwortes in Klartext erfolgt über</p><div class="bash"><div class="contents"><pre class="notranslate">ldappasswd -x -D cn=admin,dc=meinedomain,dc=local -W -S cn=admin,dc=meinedomain,dc=local </pre></div></div></div><div class="section_1"><h2 id="Sichere-bertragung-mit-TLS-SSL">Sichere Übertragung mit TLS/SSL<a class="headerlink" href="#Sichere-bertragung-mit-TLS-SSL">¶</a></h2><p>
Nach der sicheren Authentifizierung geht es nun an den verschlüsselten Transport der Informationen zwischen LDAP-Server und Client. Dafür wird das Verschlüsselungsprotokoll Transport Layer Security (TLS), auch bekannt unter der früheren Bezeichnung Secure Sockets Layer (SSL), herangezogen. Der in Ubuntu zur Verfügung gestellte OpenLDAP-Server (slapd) und die OpenLDAP-Clients verwenden GnuTLS als TLS-Bibliothek. Das löst zwar Lizenzprobleme, bringt aber einige Komplikationen mit sich, die das Einrichten von Transport Layer Security in OpenLDAP schnell zu einem Alptraum werden lassen können. Es ist deshalb ratsam, durch striktes Befolgen der Anleitung zunächst <span class="underline">einen funktionierenden</span> TLS-Layer einzurichten. Anschließend kann dieser dann den eigenen Bedürfnissen entsprechend weiter angepasst werden. Wie SASL ist auch die Verschlüsselung mittels TLS zwingend erforderlich, um einen LDAP v3 kompatiblen LDAP-Verzeichnisdienst zu betreiben.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>slapd verzeiht keine Fehler bei der Konfiguration von TLS. Gewöhnlich lässt sich der Dämon dann erst einmal nicht mehr starten und somit auch nicht mehr konfigurieren. Stattdessen beglückt der Dämon den frustrierten Nutzer auch bei höchster Debug-Stufe mit einer (!) einzigen nichtssagenden Fehlermeldung: 
</p></div></div><blockquote><p>"TLS init def ctx failed: -1"</p></blockquote><p>
Deshalb ist es ratsam, wie unter <a class="crosslink" href="#config_and_db_backup">Backup der Konfiguration und Datenbank</a> beschrieben, die letzte funktionierende Konfiguration zu sichern!</p><p>Wird dieser Rat nicht befolgt, bleibt im Falle eines Fehlers nur noch der Ausweg, durch Eingabe von <code class="notranslate">dpkg-reconfigure slapd</code> das <code class="notranslate">cn=config</code>-Backend in den Ausgangszustand zurückzusetzen. Alle bis hier erfolgten Konfigurationsschritte an dem Backend müssen dann wieder neu ausgeführt werden. Es wird daher nochmals dringend empfohlen, die für die Konfiguration verwendeten <strong>.ldif</strong>-Dateien im Verzeichnis <strong>/etc/ldap/</strong> abzulegen. Nur so lässt sich OpenLDAP zügig reparieren. Sollten zwischenzeitlich schon Daten in das eigentliche LDAP-Verzeichnis eingetragen worden sein, ist das kein Problem. Solange ruhig und gezielt die Konfiguration des Backends wiederhergestellt wird, bleiben alle (!) Verzeichnisdaten erhalten!
|}}</p><div class="section_2"><h3 id="Erstellung-der-benoetigten-Server-Zertifikate">Erstellung der benötigten Server-Zertifikate<a class="headerlink" href="#Erstellung-der-benoetigten-Server-Zertifikate">¶</a></h3><p>
OpenLDAP benötigt X.509-Zertifikate zur Verschlüsselung der Daten. Es wird zwischen Server- und Client-Zertifikaten unterschieden. LDAP v3-konforme Server müssen auf gültige Zertifikate zurückgreifen können. Für LDAP-Clients ist die Verwendung von eigenen Zertifikaten optional und wird deshalb hier nicht weiter beschrieben. Um das Server-Zertifikat zu generieren, gibt es drei Möglichkeiten:</p><ol class="arabic"><li><p>Selbstsigniertes Zertifikat</p></li><li><p>Bezug von einer Zertifizierungsstelle (<em>Certification Authority</em>)</p></li><li><p>Einrichtung und Verwendung einer eigenen Zertifizierungsstelle</p></li></ol><p>
</p><div class="section_3"><h4 id="Selbstsigniertes-Zertifikat">Selbstsigniertes Zertifikat<a class="headerlink" href="#Selbstsigniertes-Zertifikat">¶</a></h4><p>
Hier ist es sinnvoll, die eher noch nicht so ausgereifte, dafür aber schnell und einfach zu verwendende GnuTLS-Bibliothek einzusetzen, gegen die ja auch OpenLDAP kompiliert wurde.</p><ul><li><p><strong>gnutls-bin</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install gnutls-bin </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install gnutls-bin </pre></div></div><p>
</p></div></div><p>
Für TLS werden zwei Zertifikate und ein privater Schlüssel benötigt. Die Erstellung erfolgt am besten in einem eigenen Arbeitsverzeichnis, das hinterher ggf. auch wieder gelöscht werden kann.</p><div class="bash"><div class="contents"><pre class="notranslate">mkdir /var/ssl
cd /var/ssl </pre></div></div><div class="section_4"><h5 id="CA-Zertifikat-cacert-pem">CA-Zertifikat (cacert.pem)<a class="headerlink" href="#CA-Zertifikat-cacert-pem">¶</a></h5><p>
Für die Erstellung des Zertifikats wird eine Konfigurationsdatei (<strong>/var/ssl/ca.cfg</strong>) benötigt.</p><pre class="notranslate">cn = meinedomain
ca
cert_signing_key</pre><p>
Mit Hilfe der Konfigurationsdaten wird das CA-Zertifikat erstellt:</p><div class="bash"><div class="contents"><pre class="notranslate">sh -c "certtool --generate-privkey &gt; cakey.pem" </pre></div></div><div class="bash"><div class="contents"><pre class="notranslate">certtool --generate-self-signed --load-privkey cakey.pem --template ca.cfg --outfile cacert.pem </pre></div></div></div><div class="section_4"><h5 id="Privater-Schluessel-fuer-Server-Zertifikat-ldap-slapd-key-pem">Privater Schlüssel für Server-Zertifikat (ldap_slapd_key.pem)<a class="headerlink" href="#Privater-Schluessel-fuer-Server-Zertifikat-ldap-slapd-key-pem">¶</a></h5><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sh -c "certtool --generate-privkey &gt; ldap_slapd_key.pem" </pre></div></div></div><div class="section_4"><h5 id="Server-Zertifikat-ldap-slapd-cert-pem">Server-Zertifikat (ldap_slapd_cert.pem)<a class="headerlink" href="#Server-Zertifikat-ldap-slapd-cert-pem">¶</a></h5><p>
Auch für das Server-Zertifikat wird eine Konfigurationsdatei (<strong>/var/ssl/slapd.cfg</strong>) benötigt.</p><pre class="notranslate">organization = meinedomain
cn = ldap.meinedomain.local
tls_www_server
encryption_key
signing_key</pre><p>
Der "common name" im Zertifikat muss dabei auf den eindeutigen, vollständigen Namen (FQDN) des LDAP-Servers verweisen, da sonst LDAP-Clients ggf. das Zertifikat nur nach Rückfrage beim Benutzer akzeptieren. Der Befehl:</p><div class="bash"><div class="contents"><pre class="notranslate">certtool --generate-certificate --load-privkey ldap_slapd_key.pem --load-ca-certificate cacert.pem --load-ca-privkey cakey.pem --template slapd.cfg --outfile ldap_slapd_cert.pem </pre></div></div><p>
erstellt das Server-Zertifikat.</p></div></div><div class="section_3"><h4 id="Bereitstellung-durch-eine-eigene-Zertifizierungsstelle">Bereitstellung durch eine eigene Zertifizierungsstelle<a class="headerlink" href="#Bereitstellung-durch-eine-eigene-Zertifizierungsstelle">¶</a></h4><p>
Um diese Anleitung nicht zu sprengen, wird auf eine Beschreibung der Verwendung von OpenSSL verzichtet. Falls Interesse besteht, hilft der Artikel <a class="internal" href="./ca.html">CA</a> weiter.</p></div></div><div class="section_2"><h3 id="Installation-des-LDAP-Server-Zertifikats">Installation des LDAP-Server-Zertifikats<a class="headerlink" href="#Installation-des-LDAP-Server-Zertifikats">¶</a></h3><p>
</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Grundsätzlich sollten die für TLS benötigten Zertifikate an jedem beliebigen Ort ablegbar sein. Wenn allerdings <a class="internal" href="./apparmor.html">AppArmor</a> aktiviert ist (wie es in Ubuntu Standard ist) müssen die Zertifikate für OpenLDAP mit GnuTLS an passender Stelle abgelegt werden. Mögliche Verzeichnisse sind u.a. <strong>/etc/ssl/certs/</strong>, <strong>/usr/local/share/ca-certificates/</strong> (letzteres mit Unterverzeichnissen) und <strong>/etc/ssl/private/</strong> für den privaten Schlüssel.
</p></div></div><p>Im Verzeichnis <strong>/var/ssl/</strong> befinden sich nun alle benötigten Dateien:
</p><ul><li><p>Das Stammzertifikat <strong>cacert.pem</strong></p></li><li><p>Das Server-Zertifikat <strong>ldap_slapd_cert.pem</strong></p></li><li><p>Der private Schlüssel für das Server-Zertifikat <strong>ldap_slapd_key.pem</strong></p></li></ul><p>
Diese werden nun ins zentrale Verzeichnis <strong>/etc/ssl/certs</strong> installiert.</p><div class="bash"><div class="contents"><pre class="notranslate">install -D -o openldap -g openldap -m 600 /var/ssl/ldap_slapd_key.pem  /etc/ssl/private/ldap_slapd_key.pem
install -D -o openldap -g openldap -m 600 /var/ssl/ldap_slapd_cert.pem  /etc/ssl/certs/ldap_slapd_cert.pem
install -D -o openldap -g openldap -m 600 /var/ssl/cacert.pem  /etc/ssl/certs/ldap_slapd_cacert.pem </pre></div></div></div><div class="section_2"><h3 id="Anpassung-der-Konfiguration-cn-config-Datenbank">Anpassung der Konfiguration (cn=config-Datenbank)<a class="headerlink" href="#Anpassung-der-Konfiguration-cn-config-Datenbank">¶</a></h3><p>
Jetzt muss noch dem LDAP-Serverdämon <code class="notranslate">slpad</code> mitgeteilt werden, dass er TLS verwenden soll. Dazu wird die Datei <strong>/etc/ldap/tls.ldif</strong> mit folgendem Inhalt angelegt.</p><pre class="notranslate">###########################################################
# CONFIGURATION for Support of TLS
###########################################################
# Add TLS supported access to user passwords for LDAP clients
# to the LDAP config. 

dn: cn=config
changetype: modify
add: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/ssl/certs/ldap_slapd_cacert.pem

dn: cn=config
changetype: modify
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap_slapd_key.pem

#dn: cn=config
#changetype: modify
#delete: olcTLSCertificateFile

dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap_slapd_cert.pem</pre><p>
Diese muss dann ins LDAP-Backend eingefügt werden.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapadd -x -D cn=admin,cn=config -W -f /etc/ldap/tls.ldif </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Von einer Konfiguration des Parameters <code class="notranslate">TLSCipherSuite</code>, wie in manchen Anleitungen vorgeschlagen, sollte abgesehen werden. GnuTLS sucht sich ohnehin die sicherste Verschlüsselung aus. Wird hingegen ein falscher Wert für die <code class="notranslate">TLSCipherSuite</code> eingegeben, startet <code class="notranslate">slapd</code> nicht mehr und muss neu konfiguriert werden.
</p></div></div><p>OpenLDAP unterstützt zwei Verfahren zum Aufbau einer sicheren Kommunikation zwischen LDAP-Server und Client über TLS/SSL.
</p><ul><li><p><em>StartTLS</em> ist eine LDAP-Operation zwischen LDAP-Server und Client, die eine normale LDAP-Verbindung um TLS/SSL-Verschlüsselung erweitert. TLS/SSL wird nach erfolgreichem Abschluss dieser LDAP-Operation initialisiert. Es wird kein zusätzlicher Kommunikationsport benötigt. LDAP-Clients wie der System Security Services Daemon (SSSD) sind so intelligent gebaut, dass sie TLS/SSL nur vorübergehend für die Verschlüsselung der Übertragung sensitiver Daten, wie z.B. Passwörter, einrichten und danch wieder auf die normale LDAP-Verbindung zurückfallen.</p></li><li><p>LDAPS oder <code class="notranslate">ldaps://</code> verweisen auf <em>LDAP Secured</em>, d.h. LDAP über TLS/SSL. Für die Kommunikation zwischen LDAP-Server und Client wird dauerhaft eine TLS/SSL-Schicht oberhalb von TCP eingerichtet. Das LDAP-Protokoll verwendet normalerweise Port 389 für die Kommunikation. LDAPS benötigt hingegen einen eigenen Kommunikationsport (üblicherweise 636).</p></li></ul><p>
Das Ändern der Variable <code class="notranslate">SLAPD_SERVICES</code> in <strong>/etc/default/slapd</strong> ist angeblich nicht mehr notwendig.</p><p><a class="crosslink anchor" href="#certpermissions" id="certpermissions"></a>
Zunächst muss der Debconf-Wrapper für OpenSSL installiert werden, damit die richtigen Benutzer und Gruppen erstellt werden.</p><ul><li><p><strong>ssl-cert</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install ssl-cert </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install ssl-cert </pre></div></div><p>
</p></div></div><p>Mit folgenden Schritten werden dann die Zertifikate den richtigen Nutzern und Gruppen zugewiesen.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo adduser openldap ssl-cert
sudo chgrp ssl-cert /etc/ssl/private/ldap_slapd_key.pem
sudo chmod g+r /etc/ssl/certs/ldap_slapd_cert.pem
sudo chmod o-r /etc/ssl/certs/ldap_slapd_cert.pem </pre></div></div><p>Damit ist die Einrichtung von TLS/SSL abgeschlossen.</p></div><div class="section_2"><h3 id="Restart-des-slapd-Daemons">Restart des slapd-Daemons<a class="headerlink" href="#Restart-des-slapd-Daemons">¶</a></h3><p>
Nach einem Neustart des LDAP-Servers sichert das StartTLS-Verfahren die sichere Kommunikation zwischen LDAP-Server und Client.</p><div class="bash"><div class="contents"><pre class="notranslate">service slapd restart </pre></div></div><p>
Sollte der slapd-Dienst nicht starten, liegt das u.U. daran, dass die Zertifikate nicht den richtigen Nutzern und Gruppen zugeordnet wurden. In diesem Fall kann die neuerliche Durchführung des Schrittes <a class="crosslink" href="#certpermissions">Zertifikatzugriff</a> Abhilfe schaffen.</p></div><div class="section_2"><h3 id="Test">Test<a class="headerlink" href="#Test">¶</a></h3><p>
Zum Testen dienen am Einfachsten die sowieso schon installierten OpenLDAP-Clients. Dazu muss deren Konfigurationsdatei <strong>/etc/ldap/ldap.conf</strong> überprüft und ggf. anpasst werden. Folgende Einträge sind dazu zwingend erforderlich.</p><pre class="notranslate">uri ldap://ldap.meinedomain.local/
ldap_version 3
ssl start_tls
#tls_cacert /etc/ssl/certs/ca_certificates.crt # Tippfehler
tls_cacert /etc/ssl/certs/ca-certificates.crt</pre><p>
Dabei ist der FQDN des LDAP-Servers entsprechend anzupassen. Für den Fall, dass der LDAP-Server nur ein selbstsigniertes Zertifikat verwendet, muss der Eintrag <code class="notranslate">tls_cacert</code> angepasst und noch folgender Parameter in <strong>/etc/ldap/ldap.conf</strong> eingefügt werden.</p><pre class="notranslate">tls_cacert /etc/ssl/certs/ldap_slapd_cacert.pem
TLS_REQCERT allow</pre><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>GnuTLS und damit die OpenLDAP-Clients vertrauen nur Server-Zertifikaten, die von Stammzertifizierungstellen mit entsprechendem Stammzertifikat signiert sind. Wurde das Server-Zertifikat von einer nachgeordneten CA signiert, muss die unter Option <code class="notranslate">tls_cacert</code> genannte Datei alle Zertifikate der Signaturkette bis zur Stammzertifizierungsstelle enthalten. Selbstsignierten Zertifikaten wird grundsätzlich nicht vertraut. Sie und alle anderen nicht vertrauenswürdigen Server-Zertifikate werden aber dennoch verwendet, wenn die TLS_REQUEST-Option den Wert <code class="notranslate">allow</code> oder <code class="notranslate">never</code> hat.  
</p></div></div><p>
Nun kann der Test der TLS/SSL-Verschlüsselung beginnen:</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -xLLL -Z -W -D cn=admin,cn=config -b cn=config cn=config </pre></div></div><p>
Die Option <code class="notranslate">-Z</code> fordert die StartTLS-Operation beim OpenLDAP-Client an. Wenn die Ausführung des Befehls erfolgreich ist, d.h. die TLS-Einstellungen des LDAP-Servers angezeigt werden, kann die Initialisierung von TLS/SSL im Detail angesehen werden.</p><div class="bash"><div class="contents"><pre class="notranslate">ldapsearch -d 2 -xLLL -Z -W -D cn=admin,cn=config -b cn=config cn=config </pre></div></div><p>In der Ausgabe sollten die StartTLS-Operation, die verwendete TLS-Version und die Übertragung des Server-Zertifikats sichtbar sein. Es folgt ein Auszug:</p><pre class="notranslate">ldap_write: want=31, written=31
  0000:  30 1d 02 01 01 77 18 80  16 31 2e 33 2e 36 2e 31   0....w...1.3.6.1  
  0010:  2e 34 2e 31 2e 31 34 36  36 2e 32 30 30 33 37      .4.1.1466.20037  

-&gt; 1.3.6.1.4.1.1466.20037 is the StartTLS LDAP operation code
 
ldap_read: want=8, got=8
  0000:  30 0c 02 01 01 78 07 0a                            0....x..          
ldap_read: want=6, got=6
  0000:  01 00 04 00 04 00                                  ......            

-&gt; 01 00: 00 is resultCode = success

tls_write: want=93, written=93
  0000:  16 03 02 00 58 01 00 00  54 03 02 4f 48 1b 02 ca   ....X...T..OH...  
  0010:  6e 94 24 b1 bf 50 08 38  1e 12 21 6d c6 78 7f 84   n.$..P.8..!m.x..  
  0020:  ee 02 14 a7 1d 93 e5 f6  dd 23 1d 00 00 24 00 33   .........#...$.3  
  0030:  00 45 00 39 00 88 00 16  00 32 00 44 00 38 00 87   .E.9.....2.D.8..  
  0040:  00 13 00 66 00 2f 00 41  00 35 00 84 00 0a 00 05   ...f./.A.5......  
  0050:  00 04 01 00 00 07 00 09  00 03 02 00 01            .............     
tls_read: want=5, got=5
  0000:  16 03 02 00 4a                                     ....J             
tls_read: want=74, got=74
  0000:  02 00 00 46 03 02 4f 48  1b 02 a9 af 24 4c 96 32   ...F..OH....$L.2 

-&gt; 0x0302 is TLS v1.1
 
  0010:  07 f0 e3 1a 18 91 98 cc  fd 5f 1b d1 b7 9e e5 36   ........._.....6  
  0020:  d8 3a c2 16 bc 8c 20 da  87 37 f2 b3 84 e5 47 cb   .:.... ..7....G.  
  0030:  0e e0 61 6a 22 1d cc 9f  77 67 cf 9b 1a 45 7c db   ..aj"...wg...E|.  
  0040:  32 02 50 1f 30 f7 4e 00  2f 00                     2.P.0.N./.        
tls_read: want=5, got=5
  0000:  16 03 02 08 5d                                     ....]  

...
</pre><p><a class="crosslink anchor" href="#tipps" id="tipps"></a>
</p></div></div><div class="section_1"><h2 id="Tipps-und-Tricks">Tipps und Tricks<a class="headerlink" href="#Tipps-und-Tricks">¶</a></h2><p>
<a class="crosslink anchor" href="#config_and_db_backup" id="config_and_db_backup"></a>
</p><div class="section_2"><h3 id="Backup-der-Konfiguration-und-der-Datenbank">Backup der Konfiguration und der Datenbank<a class="headerlink" href="#Backup-der-Konfiguration-und-der-Datenbank">¶</a></h3><p>
Da eine gültige Konfiguration nötig ist, um den slapd-Daemon zu starten, allerdings der Dienst laufen muss, damit die Konfiguration geändert werden kann, empfiehlt es sich, nach jedem größeren Schritt die aktuelle Datenbank und Konfiguration zu sichern.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Beim Erstellen und Wiederherstellen von Backups ist beim <a class="internal" href="./cp.html">cp</a>-Befehl auf die Optipn <code class="notranslate">-p</code> zu achten! Wird diese vergessen, hat der slapd-Daemon keine Möglichkeit, auf die Verzeichnisse zuzugreifen, und wird nicht mehr starten!
</p></div></div><p>Folgende Befehle sichern den aktuellen Zustand der Datenbank und der Konfiguration:</p><div class="bash"><div class="contents"><pre class="notranslate">cp -rp /var/lib/ldap /var/lib/ldap.bak
cp -rp /etc/ldap/slapd.d /etc/ldap/slapd.d.bak </pre></div></div><p>
Wiederherstellen lässt sich beides mit:</p><div class="bash"><div class="contents"><pre class="notranslate">rm -r /var/lib/ldap /etc/ldap/slapd.d
cp -rp /var/lib/ldap.bak /var/lib/ldap
cp -rp /etc/ldap/slapd.d.bak /etc/ldap/slapd.d </pre></div></div><p>
Als weiteres (auch für tägliches Backup im laufenden Betrieb geeignetes) Mittel zur Sicherung von OpenLDAP können folgende Skripte verwendet werden.</p><ul><li><p>Zur Sicherung: </p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">BACKUP_PATH</span><span class="o">=</span>/var/backups

nice slapcat -n <span class="m">0</span> &gt; <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/config.ldif
nice slapcat -n <span class="m">1</span> &gt; <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/meinedomain.local.ldif
nice slapcat -n <span class="m">2</span> &gt; <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/access.ldif
chmod <span class="m">640</span> <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/*.ldif
</pre></div>
</td></tr></table></div></li></ul><p>
</p><ul><li><p>Zum Wiederherstellen: </p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">BACKUP_PATH</span><span class="o">=</span>/var/backups

sudo service slapd stop
sudo mkdir /var/lib/ldap/accesslog
sudo slapadd -F /etc/ldap/slapd.d -n <span class="m">0</span> -l <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/config.ldif
sudo slapadd -F /etc/ldap/slapd.d -n <span class="m">1</span> -l <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/meinedomain.local.ldif
sudo slapadd -F /etc/ldap/slapd.d -n <span class="m">2</span> -l <span class="si">${</span><span class="nv">BACKUP_PATH</span><span class="si">}</span>/access.ldif
sudo chown -R openldap:openldap /etc/ldap/slapd.d/
sudo chown -R openldap:openldap /var/lib/ldap/
sudo service slapd start
</pre></div>
</td></tr></table></div></li></ul><p>
Die erste Methode ist für die Konfigurationsphase wegen der Einfachheit besser geeignet. Sobald man allerdings ein laufendes System hat, sollte die zweite Methode verwendet werden, denn eine Sicherung, die mit dieser Methode gemacht wurde, kann auch auf ein frisch installiertes System angewandt werden.</p><p>Bei der Wiederherstellung ist darauf zu achten, dass slapadd keine bestehenden Konfigurationen oder Datenbanken überschreiben kann. Die Verzeichnisse /etc/ldap/slap.d für die Konfiguration und /var/lib/ldap für die Daten sollten leer sein. Im Falle einer Wiederherstellung auf dem Produktivsystem ist es sicherer, die Verzeichnisse jeweils nur umzubenennen und neue Verzeichnisse des vorherigen Namens zu erstellen. So können im Falle der Fälle zumindest die alten Zustände wiederhergestellt werden, sollte die Wiederherstellung aus irgendwelchen Gründen nicht klappen.</p><p>Die zur Konfiguration verwendeten <strong>.ldif</strong>-Dateien sollten in <strong>/etc/ldap</strong> bleiben, um den Dienst schnell und unkompliziert wieder aufsetzen oder verändern zu können!</p></div></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="interwiki interwiki-ubuntu_doc" href="https://help.ubuntu.com/16.04/serverguide/openldap-server.html">OpenLDAP Server</a> - Ubuntu 16.04 Server Guide</p></li><li><p><a class="interwiki interwiki-man" href="http://manpages.ubuntu.com/cgi-bin/search.py?lr=lang_en&amp;q=slapd-config">Manpage slapd-config</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/></p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="./openldap_ab_precise/a/revision/942461.html">Diese Revision</a> wurde am 9. Juli 2017 21:36 von <a href="https://ubuntuusers.de/user/toddy/">toddy</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="./startseite.html">Wiki</a></li>
<li><a href="./openldap_ab_precise.html">OpenLDAP ab Precise</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="./_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="./_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="./_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="./_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>