<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>DRBD › ubuntuusers statisches Wiki</title>
<link href="./_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="./_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="./_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="./_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="./_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="./_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="./startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="./drbd.html">DRBD</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/DRBD">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="./wiki/index.html">Index</a></li>
<li><a href="./wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="./wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="./wiki.html">Übersicht</a></li>
<li><a href="./wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="./wiki/benutzung.html">Benutzung</a></li>
<li><a href="./kategorien.html">Kategorie</a></li>
<li><a href="./wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="./wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="./howto.html">Howto anlegen</a></li>
<li><a href="./wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="./wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="./baustelle.html">Baustellen</a></li>
<li><a href="./wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="./wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="./wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="./wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="./drbd/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="./drbd/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="./drbd/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="./drbd/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="./drbd/a/backlinks.html">DRBD</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p>
Dieser Artikel ist mit keiner aktuell unterstützten Ubuntu-Version getestet! Bitte diesen Artikel testen und das getestet-Tag entsprechend anpassen.
</p></div></div><p>
</p><p>
</p><div class="box advanced"><h3 class="box advanced">Artikel für fortgeschrittene Anwender</h3><div class="contents"><p>
Dieser Artikel erfordert mehr Erfahrung im Umgang mit
Linux und ist daher nur für fortgeschrittene Benutzer
gedacht.
</p></div></div><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="./sudo.html">Als Administrator arbeiten</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="./editor.html">Umgang mit Editor</a> </p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="./dienste.html">Starten  Stoppen und Entfernen von Diensten</a> </p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="./internet_und_netzwerk.html">Netzwerkkenntnisse allgemein</a></p></li></ol></div></div><div class="toc toc-depth-3"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Funktionsweise">Funktionsweise
</a><ol class="arabic"><li><a class="crosslink" href="#Ausgangssituation">Ausgangssituation
</a></li><li><a class="crosslink" href="#Netzwerkkonfiguration">Netzwerkkonfiguration
</a></li><li><a class="crosslink" href="#Software-installieren">Software installieren
</a></li><li><a class="crosslink" href="#Konsistenz-herstellen">Konsistenz herstellen
</a></li><li><a class="crosslink" href="#Dateisystem-erstellen-und-einbinden">Dateisystem erstellen und einbinden
</a></li><li><a class="crosslink" href="#Nuetzliche-Kommandos-fuer-drbdadm">Nützliche Kommandos für drbdadm
</a></li><li><a class="crosslink" href="#Integration-in-Heartbeat">Integration in Heartbeat
</a></li><li><a class="crosslink" href="#Wechsel-der-Rollen">Wechsel der Rollen
</a></li><li><a class="crosslink" href="#Split-Brain-Situation">Split-Brain-Situation
</a></li><li><a class="crosslink" href="#Statusabfrage-fuer-Backupscripts">Statusabfrage für Backupscripts
</a></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></li></ol></div><p><a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/DRBD">DRBD</a> steht für Distributed Replicated Block Device und ist ein Open Source-Treiber, welcher Geräte im System bereitstellt, die als Blockdevice eingebunden werden können. Es ist eine Technik, die ein RAID1 (Spiegelung) übers Netzwerk mittels TCP/IP ermöglicht. Diese kostengünstige Hochverfügbarkeitslösung (HA) wird vor allem für die Ausfallsicherheit in Rechenzentren eingesetzt und ist in einem privaten Netzwerk weniger gefragt.</p><div class="section_1"><h2 id="Funktionsweise">Funktionsweise<a class="headerlink" href="#Funktionsweise">¶</a></h2><p>
Dabei arbeitet ein Server im "Cold Standby", der andere Server stellt aktiv Dienste bereit. Geht dieser Master-Server offline, fährt Heartbeat auf dem anderen, dem Slave, sämtliche Ressourcen hoch inkl. dem/den DRBD-Device(s). Auch zur Wartung ist solch ein Takeover praktisch, da der Master hinterher z.B. repariert, geupdatet o.ä. werden kann. Im Anschluss an derartige Arbeiten synchronisiert DRBD selbstständig das/die Laufwerk(e) und Heartbeat übergibt die Ressourcen zurück an den Master. Generell sorgt der DRBD-Treiber selbstständig dafür, dass auf allen beteiligten Systemen die Daten synchron vorliegen und verweigert z.B. die Übergabe der Dienste, solange der zukünftige Masterserver nicht komplett aktualisiert wurde.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Wichtig zu wissen ist dabei, dass man niemals versuchen sollte, an per DRBD gespeicherten Daten zu kommen, ohne DRBD dazu zu benutzen, jedenfalls nicht, wenn man vorhat das Device weiterhin zu benutzen.
</p></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Auch befreit DRBD nicht von der Pflicht zur Datensicherung, da Fehler oder Aktionen im Dateisystem in Echtzeit auf alle anderen DRBD-Partner übertragen werden. Ist das Dateisystem defekt oder die Datei gelöscht, ist das auf allen Partnern so!
</p></div></div><div class="section_2"><h3 id="Ausgangssituation">Ausgangssituation<a class="headerlink" href="#Ausgangssituation">¶</a></h3><p>
Ausgegangen wird von zwei fertig konfigurierten Maschinen mit Ubuntu Server 8.04 LTS, die weitestgehend die gleiche Konfiguration haben. Dazu gehört neben aktuellen Patches eine funktionstüchtige Installation der später zu hostenden Dienste (in diesem Fall MySQL), IDS (Intrusion Detection System), Monitoring (mon), Backup, Cronjobs für Zeitsync etc. Der HA-Verbund soll im folgenden Beispiel mehreren Web- und Applikationsserver eines Rechenzentrums Datenbanken zur Verfügung stellen. Die beiden eingesetzten Maschinen heißen sqlrz-master und sqlrz-slave. Der Masterserver ist der aktive, der Slave der Standbyserver.</p><p>Beide Maschinen haben je eine Netzwerkkarte für das lokale Netz, über welches die Systeme einzeln ansprechbar sind und worüber z.B. Updates aus dem Internet geholt werden. Zudem gibt es ein weiteres Netzwerk, das HA-Netz, welches nur zwischen diesen beiden Servern besteht. Dieses muss in einem eigenen Subnetz liegen, in welchem keine anderen Hosts auftauchen und ist idealerweise über einen separaten Switch geschaltet, der mit dem lokalen Netzwerk nicht verbunden ist.</p><p>Die Festplatten sollten in beiden Maschinen etwa gleich schnell sein, da eine ungleiche Performanceverteilung erfahrungsgemäß auch das schnellere System erheblich ausbremsen kann.</p><p>Diese beiden Server sollen nun eine MySQL-Instanz hochverfügbar machen, ohne die MySQL-eigene Clustertechnologie zu nutzen. Die hier gezeigte HA-Lösung ist übrigens die von MySQLAB/SUN empfohlene Alternative zum "echten" Cluster.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Dieses Anleitung ist auf die Hochverfügbar-Machung der meisten anderen Dienste übertragbar, z.B. auf Apache oder Samba. Wichtig ist allerdings, dass z.B. Logs, Sessions etc. ebenfalls auf dem Share-Laufwerk liegen, damit bei einer Übernahme der Dienste des anderen Servers der Betrieb nahtlos weitergehen und später auch nachverfolgt werden kann. Bei Backups z.B. ist darauf zu achten, dass das Datenlaufwerk später über DRBD immer nur einem Rechner, nämlich dem gerade aktuellen Master zugänglich ist.
</p></div></div><p>Einige Angaben hier machen in der eigenen Umgebung so keinen Sinn, müssen also entsprechend angepasst werden (IPs, Dienste, Namen, Auswahl des Dateisystems etc.)! Alle hier beschriebenen Aktionen müssen außerdem als root durchgeführt werden.</p><p>Ein Datenlaufwerk soll später unter <strong>/home/data</strong> eingebunden werden, wobei dieses per DRBD übers Netzwerk als RAID1 betrieben wird. Es wurde bei der Installation der Server auf beiden bereits angelegt. Beide Server haben lokal je zwei Platten im Softraid1, welches (bis auf <strong>/boot</strong>) mit LVM2 partitioniert wurde. Die Volumegruppe heißt <strong>vg00</strong>, die Datenpartition <strong>sqldata</strong>. Letztere ist erreichbar unter <strong>/dev/mapper/vg00-sqldata</strong>.</p><p>Die Aktivierung der Dienste und das Switchen der DRBD-Rollen übernimmt später Heartbeat.</p></div><div class="section_2"><h3 id="Netzwerkkonfiguration">Netzwerkkonfiguration<a class="headerlink" href="#Netzwerkkonfiguration">¶</a></h3><p>
Die IP-Konfiguration wird als erstes vorgenommen. Beide Server bekommen je eine IP aus dem Netz 10.110.214.0/24 auf ihre 2. Netzwerkkarte. Danach wird die Datei <strong>/etc/hosts</strong> auf beiden Rechnern wie folgt konfiguriert:</p><p>sqlrz-master
</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="m">127</span>.0.0.1       localhost
<span class="m">127</span>.0.1.1       sqlrz-master
<span class="m">192</span>.168.9.3     sqlrz-master.fkc.firma  sqlrz-master
<span class="c1"># HA-Netz</span>
<span class="m">10</span>.110.214.1    sqlrz-master.fkc.firma  sqlrz-master
<span class="m">10</span>.110.214.2    sqlrz-slave.fkc.firma   sqlrz-slave
</pre></div>
</td></tr></table></div><p>sqlrz-slave
</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="m">127</span>.0.0.1       localhost
<span class="m">127</span>.0.1.1       sqlrz-slave
<span class="m">192</span>.168.9.4     sqlrz-slave.fkc.firma  sqlrz-slave
<span class="c1"># HA-Netz</span>
<span class="m">10</span>.110.214.1    sqlrz-master.fkc.firma  sqlrz-master
<span class="m">10</span>.110.214.2    sqlrz-slave.fkc.firma   sqlrz-slave
</pre></div>
</td></tr></table></div><p>Damit greifen beide Server auf den jeweils anderen über die HA-Adresse zu. Diese wird dann auch verwendet, um die DRBD- und Heartbeat-Zugriffe zu transportieren. Der Name des Partners kann nun außerdem ohne DNS und IMMER auf die HA-Adresse aufgelöst werden.</p><p>Zum Überprüfen wird auf beiden Rechnern der jeweils andere über seinen Namen angepingt. Die Antwort sollte über die HA-Adresse kommen.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# ping sqlrz-slave </pre></div></div><pre class="notranslate">PING sqlrz-slave.fkc.firma (10.110.214.2) 56(84) bytes of data.
64 bytes from sqlrz-slave.fkc.firma (10.110.214.2): icmp_seq=1 ttl=64 time=3.64 ms</pre><p>Die nächsten Schritte sind auf beiden Maschinen parallel durchzuführen!</p></div><div class="section_2"><h3 id="Software-installieren">Software installieren<a class="headerlink" href="#Software-installieren">¶</a></h3><p>
Folgende Pakete müssen installiert werden:</p><ul><li><p><strong>heartbeat</strong></p></li><li><p><strong>drbd8-utils</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install heartbeat drbd8-utils </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install heartbeat drbd8-utils </pre></div></div><p>
</p></div></div><p>Hier soll es die Version 8 (bzw. 0.8) sein. Da in Hardy DRBD8 bereits in <strong>linux-ubuntu-modules</strong> enthalten ist, muss nur <strong>drbd8-utils</strong> für die Verwaltungstools installiert werden.</p><p>Als nächstes muss die DRBD-Konfiguration angepasst werden. Dazu wird die Datei <strong>/etc/drbd.conf</strong> in einem Editor geöffnet. Sie enthält bereits mehrere vorkonfigurierte Abschnitte, die gelöscht oder zumindest deaktiviert werden müssen (auskommentieren). Sie können natürlich auch als Quelle für eigene Konfigurationen dienen. Was die Optionen genau bedeuten, ist in der Original-Konfig ausführlich beschrieben, hier nur ein paar Worte zur Protokollversion.</p><p>Es gibt drei Arten, wie DRBD mit den Daten umgeht, um sicherzustellen, dass sie geschrieben wurden:</p><ul><li><p>Protokoll A: asynchronr Replikationsmodus - die Daten gelten als sicher, sobald sie von der lokalen HDD als geschrieben gemeldet und in den TCP-Sendepuffer geschrieben wurden.</p></li><li><p>Protokoll B : semi-synchroner Replikationsmodus - die Daten gelten als sicher, sobald sie von der lokalen HDD als geschrieben gemeldet wurden und der DRBD-Partner-Node den Datenempfang bestätigt hat.</p></li><li><p>Protokoll C: synchroner Replikationsmodus - die Daten gelten als sicher, sobald sie auf ALLEN beteiligten Platten (lokal und anderer Node) geschrieben wurden.</p></li></ul><p>
Nur die Protokollversion C bietet vollständige Redundanz. Die Versionen A und B bergen die Gefahr, dass bei einem Ausfall des Primary Node Daten verloren gehen, da sie auf dem Secondary Node noch nicht vollständig geschrieben wurden. Deshalb ist C auch die am häufigsten eingesetzte Protokollversion.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Die Datei <strong>/etc/drbd.conf</strong> muss auf beiden Maschinen identisch sein!
</p></div></div><p>In diesem Beispiel sieht die Datei so aus:</p><pre class="notranslate">### globale Angaben ###
global {
    # an Statistikauswertung auf usage.drbd.org teilnehmen?
    usage-count yes;
}
### Optionen, die an alle Ressourcen vererbt werden ###
common {
  syncer { 
    rate 100M; 
  }
}
### Ressourcenspezifische Optionen
resource home-data {
  # Protokoll-Version
  protocol C;
  
  startup {
    # Timeout (in Sekunden) für Verbindungsherstellung beim Start
    wfc-timeout         0;
    # Timeout (in Sekunden) für Verbindungsherstellung beim Start 
    # nach vorheriger Feststellung von Dateninkonsistenz
    # ("degraded mode")
    degr-wfc-timeout  120;
  }
  disk {
    # Aktion bei EA-Fehlern: Laufwerk aushängen
    on-io-error detach;
  }
  net {
    ### Verschiedene Netzwerkoptionen, die normalerweise nicht gebraucht werden, ###
    ### die HA-Verbindung sollte generell möglichst performant sein...           ###
    # timeout           60;
    # connect-int       10;
    # ping-int          10;
    # max-buffers     2048;
    # max-epoch-size  2048;
  }
  syncer {
    # Geschwindigkeit der HA-Verbindung
    rate 100M;
  }
  on sqlrz-master {
    ### Optionen für Master-Server ###
    # Name des bereitgestellten Blockdevices
    device     /dev/drbd0;
    # dem DRBD zugrunde liegendes Laufwerk
    disk       /dev/mapper/vg00-sqldata;
    # Adresse und Port, über welche die Synchr. läuft
    address    10.110.214.1:7788;
    # Speicherort der Metadaten, hier im Laufwerk selbst
    meta-disk  internal;                 
  }
  on sqlrz-slave {
    ## Optionen für Slave-Server
    # Name des bereitgestellten Blockdevices
    device     /dev/drbd0;
    # dem DRBD zugrunde liegendes Laufwerk
    disk       /dev/mapper/vg00-sqldata;
    # Adresse und Port, über welche die Synchr. läuft
    address    10.110.214.2:7788;
    # Speicherort der Metadaten, hier im Laufwerk selbst
    meta-disk  internal;
  }
}</pre><p>Nun sollte geprüft werden, dass die angegebene Partition nicht in der <strong>/etc/fstab</strong> eingetragen ist (ohne Dateisystem steht sie normalerweise sowieso nicht drin, aber falls man sie doch schon vorher formatiert haben sollte...). Sollte man tatsächlich vorher formatiert haben, kann man das Dateisystem mit folgendem Befehl wieder zerstören, die Optionen <code class="notranslate">count</code> und <code class="notranslate">bs</code> sollten multipliziert in etwa der Größe der Partition entsprechen:</p><div class="bash"><div class="contents"><pre class="notranslate">dd if=/dev/zero bs=10M count=100 of=/dev/mapper/vg00-sqldata; sync </pre></div></div><p>Jetzt wird das Modul geladen und der Autostart aktiviert.</p><div class="bash"><div class="contents"><pre class="notranslate">modprobe drbd
echo 'drbd' &gt;&gt; /etc/modules
update-rc.d drbd defaults                     </pre></div></div><p>Der letzte Befehl bringt u.U. eine Meldung, dass der Link bereits existiert - das ist ok.</p><p>Ein Test, ob das Modul geladen wurde:</p><div class="bash"><div class="contents"><pre class="notranslate">lsmod | grep drbd </pre></div></div><p>
</p><pre class="notranslate">drbd                  225200  0
cn                     18248  1 drbd</pre><p>Nun kann DRBD gestartet werden.</p><div class="bash"><div class="contents"><pre class="notranslate">/etc/init.d/drbd restart
drbdadm create-md home-data
drbdadm up home-data </pre></div></div><p>Nun kann erstmals der Status abgefragt werden. An dieser Stelle zeigt sich dann, ob alles richtig gemacht wurde. Wenn es funktioniert, sieht die Ausgabe so aus:</p><div class="bash"><div class="contents"><pre class="notranslate">cat /proc/drbd </pre></div></div><p>
</p><pre class="notranslate">version: 8.0.11 (api:86/proto:86)
GIT-hash: b3fe2bdfd3b9f7c2f923186883eb9e2a0d3a5b1b build by phil@mescal, 2008-02-12 11:56:43
 0: cs:Connected st:Secondary/Secondary ds:Inconsistent/Inconsistent C r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0
        resync: used:0/31 hits:0 misses:0 starving:0 dirty:0 changed:0
        act_log: used:0/127 hits:0 misses:0 starving:0 dirty:0 changed:0</pre><p>Wenn nicht, ist das an dem <code class="notranslate">WFConnection</code> (Waiting for Connection) bzw. <code class="notranslate">Unknown</code> erkennbar:</p><div class="bash"><div class="contents"><pre class="notranslate">cat /proc/drbd </pre></div></div><p>
</p><pre class="notranslate">version: 8.0.11 (api:86/proto:86)
GIT-hash: b3fe2bdfd3b9f7c2f923186883eb9e2a0d3a5b1b build by phil@mescal, 2008-02-12 11:56:43
 0: cs:WFConnection st:Secondary/Unknown ds:Inconsistent/DUnknown C r---
    ns:0 nr:0 dw:0 dr:0 al:0 bm:0 lo:0 pe:0 ua:0 ap:0
        resync: used:0/31 hits:0 misses:0 starving:0 dirty:0 changed:0
        act_log: used:0/127 hits:0 misses:0 starving:0 dirty:0 changed:0</pre><p>Dann hilft auf beiden Rechnern evtl. folgendes:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm disconnect home-data
drbdadm detach home-data </pre></div></div><p>Danach sind die Schritte weiter oben zu wiederholen, also ab drbd restart.</p><p>Ab jetzt sind die weiteren Schritte nur noch auf dem jeweils angegebenen Rechner durchzuführen.</p></div><div class="section_2"><h3 id="Konsistenz-herstellen">Konsistenz herstellen<a class="headerlink" href="#Konsistenz-herstellen">¶</a></h3><p>
Dass <strong>/proc/drbd</strong> die Konsistenz der Devices leugnet, hat einen Grund: es ist noch kein primäres Device angegeben worden. Erst wenn das erledigt ist, weiß DRBD, welches der Laufwerke den tatsächlichen Laufwerkszustand angibt und synchronisiert diesen auf das sekundäre Device.</p><p>Genau das wird jetzt getan:</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# drbdadm -- -o primary home-data
root@sqlrz-master:~# cat /proc/drbd </pre></div></div><p>
</p><pre class="notranslate">version: 8.0.11 (api:86/proto:86)
GIT-hash: b3fe2bdfd3b9f7c2f923186883eb9e2a0d3a5b1b build by phil@mescal, 2008-02-12 11:56:43
 0: cs:SyncSource st:Primary/Secondary ds:UpToDate/Inconsistent C r---
    ns:73236 nr:0 dw:0 dr:81312 al:0 bm:4 lo:1 pe:5 ua:253 ap:0
        [&gt;....................] sync'ed:  0.8% (10168/10239)M
        finish: 0:14:13 speed: 12,180 (12,180) K/sec
        resync: used:1/31 hits:4820 misses:5 starving:0 dirty:0 changed:5
        act_log: used:0/127 hits:0 misses:0 starving:0 dirty:0 changed:0</pre><p>Hier ist nun zu sehen, dass der Sync-Prozess begonnen hat und wie weit er fortgeschritten ist. Der jeweilige Server gibt seine eigenes Rolle und seinen Zustand übrigens immer als erstes an, d.h. <code class="notranslate">st:Primary/Secondary ds:UpToDate/Inconsistent</code> zeigt, dieser Server ist der Primäre und sein Laufwerkszustand ist aktuell. Beim Slave sieht das also so aus: <code class="notranslate">st:Secondary/Primary ds:Inconsistent/UpToDate</code>.</p><p>In der Logdatei <strong>/var/log/syslog</strong> sollte der Syncvorgang folgende Spuren hinterlassen:</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# tail -20 /var/log/syslog </pre></div></div><p>
</p><pre class="notranslate">Jun  9 11:48:02 sqlrz-master kernel: [1890704.201139] drbd0: conn( StandAlone -&gt; Unconnected )
Jun  9 11:48:02 sqlrz-master kernel: [1890704.201214] drbd0: Starting receiver thread (from drbd0_worker [26327])
Jun  9 11:48:02 sqlrz-master kernel: [1890704.201236] drbd0: receiver (re)started
Jun  9 11:48:02 sqlrz-master kernel: [1890704.201239] drbd0: conn( Unconnected -&gt; WFConnection )
Jun  9 11:48:30 sqlrz-master kernel: [1890732.551619] drbd0: Handshake successful: DRBD Network Protocol version 86
Jun  9 11:48:30 sqlrz-master kernel: [1890732.551631] drbd0: conn( WFConnection -&gt; WFReportParams )
Jun  9 11:48:30 sqlrz-master kernel: [1890732.551636] drbd0: Starting asender thread (from drbd0_receiver [23389])
Jun  9 11:48:30 sqlrz-master kernel: [1890732.552213] drbd0: Becoming sync source due to disk states.
Jun  9 11:48:30 sqlrz-master kernel: [1890732.552216] drbd0: Writing meta data super block now.
Jun  9 11:48:30 sqlrz-master kernel: [1890732.568799] drbd0: writing of bitmap took 1 jiffies
Jun  9 11:48:30 sqlrz-master kernel: [1890732.568805] drbd0: 25 GB (6553391 bits) marked out-of-sync by on disk bit-map.
Jun  9 11:48:30 sqlrz-master kernel: [1890732.568808] drbd0: Writing meta data super block now.
Jun  9 11:48:30 sqlrz-master kernel: [1890732.569987] drbd0: peer( Unknown -&gt; Secondary ) conn( WFReportParams -&gt; WFBitMapS ) pdsk( DUnknown -&gt; Inconsistent )
Jun  9 11:48:30 sqlrz-master kernel: [1890732.569995] drbd0: Writing meta data super block now.
Jun  9 11:48:31 sqlrz-master kernel: [1890732.611974] drbd0: conn( WFBitMapS -&gt; SyncSource )
Jun  9 11:48:31 sqlrz-master kernel: [1890732.611984] drbd0: Began resync as SyncSource (will sync 26213564 KB [6553391 bits set]).
Jun  9 11:48:31 sqlrz-master kernel: [1890732.611987] drbd0: Writing meta data super block now.
Jun  9 11:55:39 sqlrz-master kernel: [1891160.009582] drbd0: Resync done (total 428 sec; paused 0 sec; 61244 K/sec)
Jun  9 11:55:39 sqlrz-master kernel: [1891160.010205] drbd0: conn( SyncSource -&gt; Connected ) pdsk( Inconsistent -&gt; UpToDate )
Jun  9 11:55:39 sqlrz-master kernel: [1891160.010210] drbd0: Writing meta data super block now.</pre><p>Sollte einer der Nodes später ausgetauscht oder neu aufgesetzt werden, muss er erneut in den DRBD-Verbund aufgenommen werden, wobei die Vorgehensweise dieselbe bleibt.</p></div><div class="section_2"><h3 id="Dateisystem-erstellen-und-einbinden">Dateisystem erstellen und einbinden<a class="headerlink" href="#Dateisystem-erstellen-und-einbinden">¶</a></h3><p>
Nach dem Synchronisieren kann dann das eigentliche Laufwerk <strong>/dev/drbd0</strong> gemounted und formatiert werden. Das geschieht erstmal per Hand, später übernimmt das Heartbeat.</p><p>Eine DRBD-Statusabfrage sollte nun folgendes Bild liefern:</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# cat /proc/drbd </pre></div></div><p>
</p><pre class="notranslate">version: 8.0.11 (api:86/proto:86)
GIT-hash: b3fe2bdfd3b9f7c2f923186883eb9e2a0d3a5b1b build by phil@mescal, 2008-02-12 11:56:43
 0: cs:Connected st:Primary/Secondary ds:'UpToDate/UpToDate' C r---
    ns:0 nr:10485404 dw:10485404 dr:0 al:0 bm:640 lo:0 pe:0 ua:0 ap:0
        resync: used:0/31 hits:654698 misses:640 starving:0 dirty:0 changed:640
        act_log: used:0/127 hits:0 misses:0 starving:0 dirty:0 changed:0</pre><p>Jetzt wird das Dateisystem erstellt.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# mkfs.xfs /dev/drbd0 </pre></div></div><p>Einbinden:</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# mount /dev/drbd0 /home/data </pre></div></div><p>Zum Testen kann auch mal eine Datei erstellt werden.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# touch /home/data/test </pre></div></div><p>Wenn man das Device auf dem anderen Rechner einbinden will, muss man vorher die DRBD-Rolle runterstufen, da nur ein DRBD-Partner exklusiv auf die Platten zugreifen darf. Vorher muss das Device noch umountet werden, sonst gibts eine Fehlermeldung.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# umount /home/data
root@sqlrz-master:~# drbdadm secondary home-data </pre></div></div><p>Auf dem anderen Rechner kann man nun das DRBD-Device auf primär schalten und seinerseits mounten. Dann sollte die Datei <strong>test</strong> sichtbar werden.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-slave:~# drbdadm primary home-data
root@sqlrz-slave:~# mount /dev/drbd0 /homedata
root@sqlrz-slave:~# ls /home/data </pre></div></div><pre class="notranslate">test</pre><p>Die Daten werden nun auf beiden Platten gleichzeitig geschrieben.</p></div><div class="section_2"><h3 id="Nuetzliche-Kommandos-fuer-drbdadm">Nützliche Kommandos für drbdadm<a class="headerlink" href="#Nuetzliche-Kommandos-fuer-drbdadm">¶</a></h3><p>
Der Befehl <code class="notranslate">drbdadm</code> ist vergleichbar mit <code class="notranslate">mdadm</code> bei Softraids. Er kann mit verschiedenen Parametern dazu benutzt werden, DRBD-Devices wie oben bereits gezeigt zu erstellen, aber auch zu ändern, zu (de-)aktivieren oder zu löschen.</p><p>Volle Neusynchronisation von <strong>/dev/drbd0</strong> mittels der DRBD-Ressource 'home-data' (Status in <strong>/proc/drbd</strong>):</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm attach home-data </pre></div></div><p>Trennen der Verbindung von Laufwerk und DRBD-Ressource:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm detach home-data </pre></div></div><p>Verbinden des DRBD-Treibers mit dem anderen Node:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm connect home-data </pre></div></div><p>Bestehende DRBD-Verbindung zum anderen Node trennen:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm disconnect home-data </pre></div></div><p>Masterrolle agbgeben:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm secondary home-data </pre></div></div><p>Masterrolle übernehmen:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm primary home-data </pre></div></div><p>Übernahme von Änderungen an <strong>/etc/drbd.conf</strong>:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm adjust home-data </pre></div></div><p>Statusabfrage der Verbindung:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm role home-data </pre></div></div><pre class="notranslate">Primary/Secondary</pre><p>Statusabfrage der Datensynchronisation:</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm dstate home-data </pre></div></div><pre class="notranslate">UpToDate/UpToDate</pre><p>Eigene Daten als ungültig markieren um Resync auszulösen (nur als Secondary!):</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm invalidate home-data </pre></div></div><p>Daten des Partnernodes als ungültig markieren um Resync auszulösen (nur als Primary!):</p><div class="bash"><div class="contents"><pre class="notranslate">drbdadm invalidate-remote home-data </pre></div></div><p>Für gewöhnlich ist ein manuelles Auslösen der Resynchronisation nicht nötig - Heartbeat erkennt selbstständig, ob ein Secondary-Node outdated ist oder nicht und startet sie ggf. automatisch.</p><p>Um die DRBD-Ressource an den Partnernode zu übergeben, kann man statt</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# drbdadm disconnect home-data
root@sqlrz-master:~# drbdadm detach home-data </pre></div></div><p>bzw.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-slave:~# drbdadm attach home-data
root@sqlrz-slave:~# drbdadm syncer home-data
root@sqlrz-slave:~# drbdadm connect home-data </pre></div></div><p>auch die Kurzformen verwenden:</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# drbdadm down home-data </pre></div></div><p>und</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-slave:~# drbdadm up home-data </pre></div></div><p>Setzt man die Befehle einzeln manuell ab, muss man vorher mittels</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# drbdadm secondary home-data </pre></div></div><p>den Master von Primary auf Secondary herunterstufen. Der Parameter up übernimmt das jedoch selbstständig.</p></div><div class="section_2"><h3 id="Integration-in-Heartbeat">Integration in Heartbeat<a class="headerlink" href="#Integration-in-Heartbeat">¶</a></h3><p>
Heartbeat übernimmt in Zukunft das Mounten, weshalb das Device auf beiden Rechnern nicht in der <strong>/etc/fstab</strong> stehen darf!</p><p>In der Heartbeat-Ressourcenkonfiguration wird folgendes notiert:</p><div class="bash"><div class="contents"><pre class="notranslate">vim /etc/ha.d/haresources </pre></div></div><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>sqlrz-master <span class="m">192</span>.168.10.2 drbddisk::home-data Filesystem::/dev/drbd0::/home/data::xfs mysql mon
</pre></div>
</td></tr></table></div><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Wichtig ist für alle Ressourcen, dass sie nicht beim Booten aktiviert werden dürfen, sondern dass das nun eben Heartbeat übernimmt. Das gilt für ALLE Angaben! Diese Konfiguration muss ebenfalls auf beiden Rechnern gleich sein.
</p></div></div><ul><li><p><code class="notranslate">sqlrz-master</code> ist der HA-Master, der standardmäßig die Ressourcen bereitstellt und der (je nach Konfig) auch nach einem Ausfall ggf. wieder automatisch übernimmt</p></li><li><p><code class="notranslate">192.168.10.2</code> ist eine IP-Adresse auf einem virtuellen Interface, die durch Heartbeat konfiguriert wird; sie darf nicht in /etc/network/interfaces stehen!</p></li><li><p><code class="notranslate">drbddisk::home-data Filesystem::/dev/drbd0::/home/data::xfs</code> gibt das DRBD-Device, seinen Mountpunkt und das Dateisystem an</p></li><li><p><code class="notranslate">mysql</code> und <code class="notranslate">mon</code> sind Dienste, die mit gestartet werden, da deren Ressourcen wiederum auf dem DRBD-Laufwerk liegen</p></li></ul><p>
Beim Booten werden die Ressourcen in dieser Reihenfolge eingebunden, etwaige darüber notierte Dienste oder IPs werden zuvor gestartet. Daher sollten die eigentlichen Dienste erst zum Schluss gestartet werden, wenn alles andere bereits verfügbar ist.</p><p>Heartbeat selbst wird über die Dateien <strong>/etc/ha.d/ha.cf</strong> und <strong>/etc/ha.d/authkeys</strong> konfiguriert. Sie sehen wie folgt aus:</p><p><strong>/etc/ha.d/ha.cf</strong> auf sqlrz-master</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>auto_failback   off
ucast   eth2 <span class="m">10</span>.110.214.2
node    sqlrz-slave
node    sqlrz-master
keepalive       <span class="m">2</span>
deadtime        <span class="m">30</span>
</pre></div>
</td></tr></table></div><p><strong>/etc/ha.d/ha.cf</strong> auf sqlrz-slave</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>auto_failback   off
ucast   eth2 <span class="m">10</span>.110.214.1
node    sqlrz-slave
node    sqlrz-master
keepalive       <span class="m">2</span>
deadtime        <span class="m">30</span>
</pre></div>
</td></tr></table></div><p><strong>/etc/ha.d/authkeys</strong> auf beiden Maschinen</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>auth <span class="m">1</span>
<span class="m">1</span> crc
<span class="c1">#2 sha1 HI!</span>
<span class="c1">#3 md5 Hello!</span>
</pre></div>
</td></tr></table></div><p>Die Option ucast gibt in <strong>/etc/ha.d/ha.cf</strong> die Methode und das Interface sowie die Zieladresse für die Heartbeatverbindung an. Hier wird der Heartbeat per Unicast an die Adresse des jeweiligen HA-Partners gesendet. Es gibt auch eine Möglichkeit, Broadcasts zu verwenden, allerdings sollte bei zwei Nodes Unicast verwendet werden. Weiterhin werden die Nodes namentlich aufgelistet sowie Timeouts definiert.</p><p>Mittels <code class="notranslate">auto_failback</code> wird angegeben, ob der Masterserver automatisch die Masterrolle übernehmen soll, sobald er wieder verfügbar ist (z.B. nach einem Reboot). Diese Option sollte allerdings mit Bedacht gesetzt werden, da bei einem Fehler beim Binden der Ressourcen ein Ping-Pong-Effekt entstehen kann, bei dem die Server die Rollen immer wieder hin und her switchen. Es kann durchaus sinnvoller sein, die Rückgabe der Masterrolle manuell vorzunehmen</p><p>In der Datei <strong>/etc/ha.d/authkeys</strong> wird eine eventuelle Verschlüsselung der Heartbeatverbindung konfiguriert. Zur Verfügung stehen die Modi SHA, MD5 und CRC. SHA gilt als sicherste Methode, MD5 als zweitsicherste und bei CRC wird gar nicht verschlüsselt. Bei einer direkten Verbindung über ein einzelnes Netzwerkkabel oder einen separaten Switch ist keine Verschlüsselung nötig. Verwendet man das HA-Interface aber an einem auch anderweitig genutzten Switch/Hub oder über ein öffentlichen Netzwerk, sollte SHA zum Einsatz kommen. Beim Einsatz einer Verschlüsselung wird hinter dem Namen der Methode (in einer nummerierten Liste) das entsprechende Kennwort notiert. Der Parameter auth gibt die zu verwendende Methode anhand ihrer Listenposition an.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Wenn man eine Verschlüsselung einsetzt, sollte die Datei <strong>/etc/ha.d/authkeys</strong> mittels chmod auf den Rechtemodus 600 gesetzt werden!
</p></div></div></div><div class="section_2"><h3 id="Wechsel-der-Rollen">Wechsel der Rollen<a class="headerlink" href="#Wechsel-der-Rollen">¶</a></h3><p>
Sollte der Masterserver zu Wartungszwecken außer Betrieb genommen werden, kann man die Masterrolle an den Slaveserver übergeben.</p><div class="bash"><div class="contents"><pre class="notranslate">root@sqlrz-master:~# /etc/init.d/heartbeat standby </pre></div></div><p>Auch die Rückgabe der Dienste an den Master kann so vom Slave angewiesen werden. Der Fortschritt lässt sich in <strong>/var/log/syslog</strong> beobachten. Dort werden auch eventuelle Fehler bei der Übergabe vermerkt, in diesem Fall kann die Übergabe nicht erfolgreich abgeschlossen werden.</p><p>Wenn am Slave Wartungsarbeiten vorgenommen werden müssen, kann dieser einfach vom Netz genommen werden. Sobald die HA-Verbindung wieder steht, wird automatisch ein Resync angestoßen.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Beim Wechsel der Rollen sollte man immer darauf achten, dass beide DRBD-Nodes UpToDate sind. Der jeweils aktive HA-Master ist auch der maßgebende Host für das DRBD-Device - seine Daten gelten als aktuell! 
</p></div></div><p>Man sollte sich nicht allein auf die Automatik von Heartbeat, die Rollenübergabe bei Fehlern abzubrechen, verlassen. Im laufenden Betrieb ist das zwar in der Regel kein Problem, vor allem beim späteren Hinzufügen eines neuen Nodes sollte man äußerste Vorsicht walten lassen und alle Meldungen genau lesen. Ein vorheriges Backup ist natürlich sowieso Pflicht.</p></div><div class="section_2"><h3 id="Split-Brain-Situation">Split-Brain-Situation<a class="headerlink" href="#Split-Brain-Situation">¶</a></h3><p>
In Einzelfällen kann es vorkommen, dass die Server einwandfrei funktionieren, ihre Heartbeat-Verbindung aber gestört ist, z.B. beim Ausfall eines HA-Interfaces oder des verbindenden Switches. In diesem Fall "denken" beide Server, sie wären der zuletzt übrig gebliebene und beanspruchen die Ressourcen für sich. Das kann z.b. bei von Heartbeat verwalteten IPs schwere Netzfehler verursachen, da diese dann doppelt vorhanden wären. Die DRBD-Datenträger würde sich mit unterschiedlichen Daten füllen, die nicht mehr synchronisiert werden könnten. Oder beide Server gehen wegen Fehlern vollständig vom Netz.</p><p>Um diese Situation zu vermeiden, gibt es eine Technik namens STONITH. Diese Abkürzung steht für <strong>S</strong>hoot <strong>T</strong>he <strong>O</strong>ther <strong>N</strong>ode <strong>I</strong>n <strong>T</strong>he <strong>H</strong>ead. Gemeint ist eine gezielte Abschaltung des jeweils anderen Nodes, indem über per Netzwerk konfigurierbare Stromverteiler (meist Net-PDU o.ä. genannt) dem jeweils anderen Node der Strom angeschaltet wird. Die Hardware dafür ist allerdings recht teuer und meist nicht ohne erheblichen Scripting-/Programmieraufwand einzubinden.</p></div><div class="section_2"><h3 id="Statusabfrage-fuer-Backupscripts">Statusabfrage für Backupscripts<a class="headerlink" href="#Statusabfrage-fuer-Backupscripts">¶</a></h3><p>
Wenn man per Cron ein Backupskript laufen lässt, welches auch die Daten der HA-Dienste sichert, sollte man eine Abfrage zum aktuellen Status des DRBD-Laufwerks machen. So kann man sicherstellen, dass das System auch Zugriff auf die Ressourcen nehmen kann, außerdem kann man so das Skript auf alle beteiligten Partnersystemen laufen lassen, wobei es nur auf dem aktiven Master seine Arbeit komplett durchführt. Eine Abfrage könnte so eingebaut werden:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="c1"># Pruefung, ob Master oder Slave</span>
check_primary <span class="o">()</span> <span class="o">{</span>
  <span class="nb">local</span> <span class="nv">PRIMARY</span><span class="o">=</span><span class="m">1</span>
  <span class="nb">local</span> <span class="nv">RESSTRING</span><span class="o">=</span>
  <span class="nb">local</span> <span class="nv">DRBDCMD</span><span class="o">=</span>/sbin/drbdadm

        <span class="c1"># Variable enthält 'Primary' oder 'Secondary'</span>
        <span class="nv">RESSTRING</span><span class="o">=</span><span class="sb">`</span><span class="nv">$DRBDCMD</span> state all <span class="p">|</span> sed -e <span class="s1">'s/\/.*$//'</span><span class="sb">`</span>
        <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$RESSTRING</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"Primary"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nv">PRIMARY</span><span class="o">=</span><span class="m">0</span>
        <span class="k">fi</span>
        <span class="k">return</span> <span class="nv">$PRIMARY</span>
<span class="o">}</span>
<span class="c1"># Falls nicht DRBD-Primary, dann Ende</span>
check_primary
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">"Error: I'm not primary! Cancelling Script..."</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table></div></div><div class="section_2"><h3 id="Links">Links<a class="headerlink" href="#Links">¶</a></h3><p>
</p><ul><li><p><a class="external" href="http://www.linux-ha.org" rel="nofollow">Linux-HA Projekt</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> </p></li><li><p><a class="external" href="http://www.linux-magazin.de/heft_abo/ausgaben/2004/07/reservespieler" rel="nofollow">Artikel zu älteren Versionen von Heartbeat &amp; DRBD bei Linux-Magazin.de</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> </p></li><li><p><a class="external" href="http://www.linbit.com/" rel="nofollow">Linbit: Hersteller von DRBD</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/></p></li><li><p><a class="external" href="http://www.drbd.org/" rel="nofollow">Linbit: Technische Details und Dokumentation zu DRBD</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> </p></li><li><p><a class="external" href="http://usage.drbd.org/" rel="nofollow">Linbit: DRBD Nutzerstatistiken</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> </p></li></ul><p>
</p></div></div></div>
<p class="meta">
<a href="./drbd/a/revision/938821.html">Diese Revision</a> wurde am 2. Mai 2017 16:36 von <a href="https://ubuntuusers.de/user/frustschieber/">frustschieber</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="./startseite.html">Wiki</a></li>
<li><a href="./drbd.html">DRBD</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="./_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="./_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="./_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="./_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>