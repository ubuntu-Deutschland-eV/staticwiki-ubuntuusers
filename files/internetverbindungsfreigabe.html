<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Internetverbindungsfreigabe › ubuntuusers statisches Wiki</title>
<link href="./_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="./_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="./_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="./_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="./_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="./_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="./startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="./internetverbindungsfreigabe.html">Internetverbindungsfreigabe</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Internetverbindungsfreigabe">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="./wiki/index.html">Index</a></li>
<li><a href="./wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="./wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="./wiki.html">Übersicht</a></li>
<li><a href="./wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="./wiki/benutzung.html">Benutzung</a></li>
<li><a href="./kategorien.html">Kategorie</a></li>
<li><a href="./wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="./wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="./howto.html">Howto anlegen</a></li>
<li><a href="./wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="./wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="./baustelle.html">Baustellen</a></li>
<li><a href="./wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="./wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="./wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="./wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="./internetverbindungsfreigabe/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="./internetverbindungsfreigabe/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="./internetverbindungsfreigabe/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="./internetverbindungsfreigabe/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="./internetverbindungsfreigabe/a/backlinks.html">Internetverbindungsfreigabe</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p> 
Dieser Artikel ist größtenteils für alle Ubuntu-Versionen gültig.
</p></div></div><p>
</p><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="./editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="./terminal.html">Ein Terminal öffnen</a> </p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="./sudo.html">root-Rechte</a> </p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="./pakete_installieren.html">Installation von Programmen</a></p></li></ol></div></div><div class="toc toc-depth-2"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#ICS-mit-dem-Network-Manager">ICS mit dem Network-Manager
</a><ol class="arabic"><li><a class="crosslink" href="#LAN-auf-WLAN">LAN auf WLAN
</a></li><li><a class="crosslink" href="#WLAN-auf-LAN">WLAN auf LAN
</a></li><li><a class="crosslink" href="#LAN-auf-LAN">LAN auf LAN
</a></li></ol></li><li><a class="crosslink" href="#ICS-mit-Wicd">ICS mit Wicd
</a><ol class="arabic"><li><a class="crosslink" href="#WLAN-auf-LAN-2">WLAN auf LAN
</a></li></ol></li><li><a class="crosslink" href="#ICS-ueber-die-Datei-interfaces">ICS über die Datei interfaces
</a><ol class="arabic"><li><a class="crosslink" href="#Grundkonfiguration">Grundkonfiguration
</a></li><li><a class="crosslink" href="#Automatische-Konfiguration-DHCP">Automatische Konfiguration DHCP
</a></li><li><a class="crosslink" href="#Statische-Konfiguration">Statische Konfiguration
</a></li><li><a class="crosslink" href="#Netzwerkbruecke">Netzwerkbrücke
</a></li><li><a class="crosslink" href="#Instant-Ad-Hoc">Instant Ad-Hoc
</a></li><li><a class="crosslink" href="#Proxyserver">Proxyserver
</a></li></ol></li><li><a class="crosslink" href="#Zusatzinformationen">Zusatzinformationen
</a><ol class="arabic"><li><a class="crosslink" href="#freie-DNS">freie DNS
</a></li></ol></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p><img alt="Wiki/Icons/networksettings.png" class="image-left" src="./_/4f3bc63a7bdfd5b2858d32f3205316fffbdff8d1.png"/>
Dieser Artikel beschreibt <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Internet_Connection_Sharing">Internet Connection Sharing</a> (ICS) mit Ubuntu-Linux. Ab Ubuntu 8.10 <a class="internal" href="./intrepid_ibex.html">Intrepid Ibex</a> ist die Freigabe der bestehenden Internetverbindung mit dem <a class="internal" href="./network-manager.html">Network-Manager</a> möglich.</p><p>Nachfolgend wird die Konfiguration an verschiedenen Beispielen erklärt, aufbauend auf dem Artikel <a class="internal" href="./router.html">Router</a>. Ebenso wie die rein manuelle Konfigurationen über die Datei <a class="internal" href="./interfaces.html">/etc/network/interfaces</a> für verschiedene Szenarien.</p><p>Das Basissystem bringt bereits alle erforderlichen Programme mit, um eine Verbindung herzustellen und die Internetverbindung zu teilen. Zugriff auf freigegebene Verzeichnisse aller Rechner im Verbund erlangt man einfach mittels <a class="internal" href="./heimnetzwerk.html#net-usershare-Samba-fuer-jedermann">Samba User-Shares</a>.</p><p>Ebenso ist es möglich, eine bestehende UMTS/GPRS- oder Bluetooth-Verbindung auf die LAN-Schnittstelle oder ein WLAN Ad-Hoc Netz weiterzuleiten und anderen zur Verfügung zu stellen. Die Vorgehensweise entspricht der Anleitung in den ersten beiden Abschnitten zur Konfiguration mit dem Network-Manager.</p><p>ICS ist keine Spezialität von Linux, sondern auch über Windows möglich (siehe <a class="internal" href="./internetverbindungsfreigabe_über_windows.html">Internetverbindungsfreigabe über Windows</a>).</p><div class="section_1"><h2 id="ICS-mit-dem-Network-Manager">ICS mit dem Network-Manager<a class="headerlink" href="#ICS-mit-dem-Network-Manager">¶</a></h2><p>
Der Network-Manager verwendet standardmäßig <a class="internal" href="./dnsmasq.html">dnsmasq</a>, genauer dnsmasq_base, als DNS-Cache. Soll eine der nachfolgend genannten Konfigurationen über den Manager eingerichtet werden, so kann dies zu einem Konflikt führen, da der Manager dnsmasq dann als DHCP-Server einrichten muss. In diesem Fall sollte man zuvor dnsmasq als Cache deaktivieren. Die Konfiguration erfolgt über die  <strong>/etc/NetworkManager/NetworkManager.conf</strong></p><div class="bash"><div class="contents"><pre class="notranslate">sudo sed -i "s/dns=dnsmasq/#dns=dnsmasq/g" /etc/NetworkManager/NetworkManager.conf
sudo killall dnsmasq
sudo service network-manager restart </pre></div></div><div class="section_2"><h3 id="LAN-auf-WLAN">LAN auf WLAN<a class="headerlink" href="#LAN-auf-WLAN">¶</a></h3><p>
(gilt auch für UMTS/GPRS- oder Bluetooth-Verbindungen auf WLAN)</p><p>Zunächst ein Beispiel, wie eine bestehende LAN-Verbindung, die über eine automatische Konfiguration (<a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a>) und einen Router die Verbindung zum Internet herstellt, über einen WLAN <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Ad-hoc-Netz">Ad-Hoc</a> Zugriffspunkt anderen Rechnern (Clients) zur Verfügung gestellt wird.</p><p><img alt="./Funknetzwerk_erstellen.png" class="image-right" src="./_/e26fdb8803a88dd19dd7eb3e7455fb49d7640af2.png"/>
<img alt="./NM01b.png" class="image-right" src="./_/64319ca0f35f8ad6c2b5f71445ad2002e54b3878.png"/></p><p>Der Network-Manager nutzt <a class="internal" href="./dnsmasq.html">dnsmasq</a>-base  zur Konfiguration und verwendet je nach Ubuntu-Version etwas unterschiedliche Einstellungen für die Verbindung und die IP-Adressen:
</p><ul><li><p><strong>10.xx.xx.1</strong> - feste IP-Adresse der WLAN-Karte im Ad-Hoc-Modus oder der LAN-Karte / das Gateway</p></li><li><p><strong>255.255.255.0</strong> - Netzmaske</p></li><li><p><strong>10.xx.xx.255</strong> - Broadcast</p></li><li><p><strong>10.xx.xx.10</strong> bis <strong>10.xx.xx.100</strong> - verwendeter IP-Adresspool von dnsmasq_base</p></li></ul><p>
</p><ul><li><p>statische Adressen für angeschlossene Clients  sind möglich</p><ul><li><p>also z.B im Bereich von <strong>10.xx.xx.2 - 10.xx.xx.9</strong> und wieder ab <strong>10.xx.xx.101</strong></p></li></ul></li></ul><p>Voraussetzungen, die erfüllt sein müssen:
</p><ul><li><p>LAN- und Internetverbindung und Konfiguration der Schnittstelle besteht bereits</p></li><li><p>die WLAN-Karte ist betriebsbereit und wird vom Network-Manager erkannt </p></li></ul><p>
Über einen Linksklick <img alt="linke Maustaste" class="image-default" src="./_/9c03a73e06581c6d6932d30e0750812ed76e6022.png"/> öffnet man nun das Netzwerk-Manager Applet im Panel und wählt <em>"Neues Funknetzwerk erstellen..."</em>, gibt den gewünschten Namen des Netzwerks ein (hier im Beispiel <code class="notranslate">Test</code>) und wählt die Art der Verschlüsselung.</p><div class="section_3"><h4 id="Verschluesselung">Verschlüsselung<a class="headerlink" href="#Verschluesselung">¶</a></h4><p>
Erlaubt ist nur eine 64/128bit WEP-Verschlüsselung, auch wenn der Network-Manager die Eingabe eines WPA-Kennworts ermöglicht, funktioniert das in der Regel nicht.</p><p>Ab Ubuntu 14.04 <a class="internal" href="./trusty_tahr.html">Trusty Tahr</a> kann auch ein AdHoc-Netzwerk mit WPA(2)-Verschlüsselung über den Network-Manager aufgebaut werden. Allerdings funktioniert dies nicht unbedingt mit jeder WLAN-Hardware. Ebenso kann es sein, dass Clients wie andere Rechner, Tablets oder Smartphones die Verbindung nicht herstellen können, obwohl das so erzeugte Funknetzwerk angezeigt wird und der eingegebene Zugangsschlüssel korrekt ist.</p><p>Im Zweifelsfall probiert man diese Funktion über einen <a class="internal" href="./live-usb.html">Live-USB</a> Stick mit Ubuntu 14.04 oder höher aus. Falls man diese Funktion nur gelegentlich benötigt, bietet sich diese Variante ebenfalls an um auf dem fest installierten System weiterhin eine andere Ubuntu <a class="internal" href="./lts.html">LTS</a>-Version verwenden zu können.</p><p>Der WPA(2)-Zugangsschlüssel darf zwischen 8 und 63 Zeichen umfassen. Schlüssel ab etwa 16 Zeichen, die nicht durch eine einfache Wörterbuchattacke herausgefunden werden können, gelten als sicher. Der Schlüssel sollte sich aus Klein- und Großbuchstaben, Zahlen und den erlaubten <a class="internal" href="./wlan/sonderzeichen.html">Sonderzeichen</a> zusammensetzen.</p><p>Weitere Hintergrundinformationen dazu im <a class="crosslink post" href="https://forum.ubuntuusers.de/post/2744424/">Forum</a>. Zur Unsicherheit von WEP siehe <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Wired_Equivalent_Privacy">Wired_Equivalent_Privacy</a>.</p><p>Eine Plausibilitätsüberprüfung des verwendeten WEP-Schlüssels findet ansonsten nur bei der Auswahl <em>"WEP 128-bit Schlüssel"</em> statt, weshalb sich diese Option grundsätzlich anbietet, um Fehler weitestgehend zu vermeiden. Die Schlüssellänge in hexadezimalem Code (0-9, a-f, A-F) beträgt zehn Zeichen (64 bit) oder sechsundzwanzig Zeichen (128 bit) die zwingend eingehalten werden muss.</p><p>Die Eingabe eines Schlüssels in Klartext (0-9, a-z, A-Z) ist hier ebenfalls möglich. Die einzuhaltende Schlüssellänge beträgt in diesem Fall fünf Zeichen (64 bit) oder dreizehn Zeichen (128 bit). Fehler oder unzulässige Zeichen bei der Eingabe werden nicht angezeigt!</p><p>Je nach verwendetem Treiber kann die angebotene Verschlüsselungsmethode auch als WEP40 oder WEP104 angezeigt werden. Das entspricht einer 64bit bzw. 128bit Verschlüsselung, da das Datenpaket mit einem 24-Bit großem Initialisierungsvektor beginnt.</p><p><a class="internal" href="./wlan/sonderzeichen.html">Sonderzeichen</a> wie beispielsweise deutsche Umlaute sind nicht erlaubt, um die Kompatibilität zwischen verschiedenen Betriebssystemen zu gewährleisten.</p><p><img alt="./WLAN_Konfiguration01.png" class="image-right" src="./_/489dbe2864db27daa5b8fa8ad0b13070146f4c09.png"/></p><p>Abschließend klickt man auf <em>"Erzeugen"</em>. Die erforderlichen Freigaben der LAN-Verbindung werden nun automatisch angelegt.</p><p>Über einen Rechtsklick <img alt="rechte Maustaste" class="image-default" src="./_/aa516ca8be74ff7de9b706b8ffc7a88e87e17fb5.png"/> auf das Network-Manager Symbol und <em>"Verbindungen bearbeiten"</em> kann die Konfiguration überprüft und bei Bedarf auch angepasst oder gelöscht werden. Das Fenster <em>"Netzwerkverbindungen"</em> wird geöffnet. In diesem Beispiel steht das erzeugte Ad-Hoc Netz natürlich unter <em>"Funknetzwerk"</em>. Bearbeitet man diese Konfiguration, muss unter <em>"IPv4 Einstellungen"</em> <em>"Gemeinsam mit anderen Rechnern"</em> eingestellt sein.</p><p>Ab Ubuntu 10.10 <a class="internal" href="./maverick_meerkat.html">Maverick Meerkat</a> sind erweiterte Einstellung für das Ad-Hoc Netz, wie z.B. eine manuelle Einstellung des Funkkanals möglich. Es können allerdings auch Parameter eingestellt werden, die die verwendete WLAN-Karte oder auch der Treiber nicht unterstützt.</p><p><img alt="./Test_bearbeiten.png" class="image-right" src="./_/09de7d73e0e16c83626d96c90d295de8799aeb92.png"/></p><p><span class="underline">IPv4-Einstellungen:</span>
</p><ul><li><p>Auf dem Host:</p><ul><li><p>LAN - "<em>Automatisch DHCP</em>"  (Verbindung zum Internet über Router/Modem. Kann auch statisch konfiguriert werden.)</p></li><li><p>WLAN - "<em>Gemeinsam mit anderen Rechnern</em>" (wird automatisch eingestellt)</p></li></ul></li></ul><p>
</p><ul><li><p>Auf den Clients:</p><ul><li><p>WLAN - "<em>Automatisch DHCP</em>"</p></li></ul></li></ul><p>
Die Einstellungen der Schnittstellen und die sich daraus ergebende Routing-Tabelle können zur Kontrolle über Terminal <sup><a href="#source-1">[1]</a></sup> abgefragt werden, nachdem das Netzwerk eingerichtet wurde.</p><p>Abfragen für das hier aufgeführte Beispiel:</p><div class="bash"><div class="contents"><pre class="notranslate">iwconfig             # Konfiguration der WLAN-Schnittstelle abfragen </pre></div></div><pre class="notranslate">wlan0     IEEE 802.11g  <strong class="highlighted">ESSID:"Test"</strong> 
          <strong class="highlighted">Mode:Ad-Hoc</strong>  Frequency:2.412 GHz  Cell: 00:39:80:39:0A:03   
          Bit Rate=54 Mb/s   Tx-Power:10 dBm   Sensitivity=0/3  
...</pre><div class="bash"><div class="contents"><pre class="notranslate">ifconfig             # Konfiguration der LAN- oder WLAN-Schnittstelle abfragen </pre></div></div><pre class="notranslate">wlan0     Link encap:Ethernet  Hardware Adresse 00:04:0e:c2:61:ca  
          <strong class="highlighted">inet Adresse:10.42.43.1  Bcast:10.42.43.255  Maske:255.255.255.0</strong>
          inet6-Adresse: fe80::204:eff:fec2:61ca/64 Gültigkeitsbereich:Verbindung
...</pre><div class="bash"><div class="contents"><pre class="notranslate">route -n             # Routingtabelle anzeigen </pre></div></div><pre class="notranslate">Kernel-IP-Routentabelle
Ziel            Router          Genmask         Flags Metric Ref    Use Iface
192.168.178.0   0.0.0.0         255.255.255.0   U     1      0        0 eth0
<strong class="highlighted">10.42.43.0</strong>      0.0.0.0         255.255.255.0   U     2      0        0 <strong class="highlighted">wlan0</strong>
169.254.0.0     0.0.0.0         255.255.0.0     U     1000   0        0 eth0
0.0.0.0         192.168.178.1   0.0.0.0         UG    0      0        0 eth0</pre><p>Andere Rechner mit WLAN können sich nun direkt mit dem neuen Netzwerk <code class="notranslate">Test</code> und korrekter Eingabe des Zugangsschlüssels verbinden. Die Zuweisung einer IP-Adresse erfolgt automatisch über DHCP.</p></div></div><div class="section_2"><h3 id="WLAN-auf-LAN">WLAN auf LAN<a class="headerlink" href="#WLAN-auf-LAN">¶</a></h3><p>
(gilt auch für UMTS/GPRS- oder Bluetooth-Verbindungen auf LAN)</p><p>Eine bestehende WLAN-Verbindung, welche über einen Router die Verbindung zum Internet herstellt, wird über die freie LAN-Schnittstelle anderen Rechnern (Clients) zur Verfügung gestellt. Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><p>Über einen Rechtsklick <img alt="rechte Maustaste" class="image-default" src="./_/aa516ca8be74ff7de9b706b8ffc7a88e87e17fb5.png"/> auf das Network-Manager-Icon und <em>"Verbindungen bearbeiten"</em> oder direkt über das Menü <em>"System -&gt; Einstellungen -&gt; Netzwerkverbindungen"</em> wird hier die gewünschte Schnittstelle konfiguriert. Im Beispiel wird über <code class="notranslate">wlan0</code> die Internetverbindung hergestellt und über <code class="notranslate">eth0</code> an nachfolgende Rechner durchgereicht.</p><p>Der vielleicht schon bestehende Eintrag für <code class="notranslate">Auto eth0</code> kann bearbeitet werden. Ansonsten einen neuen Eintrag mit Namen <em>"ICS WLAN (wlan0) auf LAN (eth0)"</em> als eindeutige Beschreibung hinzufügen. Unter <em>"IPv4 Einstellungen"</em> muss wieder <em>"Gemeinsam mit anderen Rechnern"</em> ausgewählt und die Änderungen übernommen werden.</p><p>Das Kontrollkästchen <em>"Automatisch verbinden"</em> muss bei allen vorhandenen Profilen unter <em>"Kabelgebunden"</em> entfernt werden, ansonsten wird u.U. automatisch das falsche Profil gewählt. Das gewünschte Profil kann nun manuell über das Network-Manager-Applet im Panel aktiviert werden.</p><p>Ein oder auch mehrere Rechner können jetzt direkt oder auch über einen Netzwerk-Switch an die Schnittstelle angeschlossen werden. Die Zuweisung einer IP-Adresse erfolgt automatisch über DHCP.</p><p><span class="underline">IPv4-Einstellungen:</span>
</p><ul><li><p>Auf dem Host:</p><ul><li><p>WLAN - <em>"Automatisch DHCP"</em> (Verbindung zum Internet über WLAN-Router/UMTS-Modem/Bluetooth)</p></li><li><p>LAN - <em>"Gemeinsam mit anderen Rechnern"</em> (muss manuell eingestellt werden)</p></li></ul></li></ul><p>
</p><ul><li><p>Auf den Clients:</p><ul><li><p>LAN - <em>"Automatisch DHCP"</em></p></li></ul></li></ul><p>
</p></div><div class="section_2"><h3 id="LAN-auf-LAN">LAN auf LAN<a class="headerlink" href="#LAN-auf-LAN">¶</a></h3><p>
Eine bestehende LAN-Verbindung, welche über eine automatische Konfiguration (<a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a>) und einen Router die Verbindung zum Internet herstellt, kann über eine weitere LAN-Schnittstelle anderen Rechnern (Clients) zur Verfügung gestellt werden. Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><p>Über einen Rechtsklick <img alt="rechte Maustaste" class="image-default" src="./_/aa516ca8be74ff7de9b706b8ffc7a88e87e17fb5.png"/> auf das Network-Manager Symbol und <em>"Verbindungen bearbeiten"</em> oder direkt über das Menü <em>"System -&gt; Einstellungen -&gt; Netzwerkverbindungen"</em> wird hier die gewünschte Schnittstelle konfiguriert. Im Beispiel wird über <code class="notranslate">eth0</code> die Internetverbindung hergestellt und über <code class="notranslate">eth1</code> an nachfolgende Rechner durchgereicht.</p><p>Es muss ein neuer Eintrag (Profil) für <code class="notranslate">eth1</code> angelegt werden. Dazu den Namen <em>"ICS LAN1 (eth0) auf LAN2 (eth1)"</em> als eindeutige Beschreibung eintragen. Damit der Network-Manager erkennt, dass dieses Profil nur für die zweite Netzwerkschnittstelle verwendet wird, ist die Hardware-Adresse (MAC) der Karte anzugeben.</p><p>Abfrage der MAC-Adresse hier für das Beispiel:</p><div class="bash"><div class="contents"><pre class="notranslate">ifconfig eth1 | grep Hard | awk {'print $1,$4,$5,$6'} </pre></div></div><p>Die Ausgabe sieht dann etwa so aus:</p><pre class="notranslate">eth1 Hardware Adresse 00:24:21:0e:8f:4a</pre><p>Benötigt wird nur die letzte, durch durch Doppelpunkte getrennte, hexadezimale Zeichenfolge.</p><p>Das Kontrollkästchen <em>"Automatisch verbinden"</em> darf für dieses Profil nicht gesetzt werden. Unter <em>"IPv4 Einstellungen"</em> muss wieder <em>"Gemeinsam mit anderen Rechnern"</em> eingestellt werden. Änderungen übernehmen. Die Zuweisung einer IP-Adresse erfolgt automatisch über DHCP. Das gewünschte Profil kann nun manuell über das Network-Manager-Applet im Panel aktiviert werden.</p><p><img alt="./Bildschirmfoto-ICS_LAN1_auf_LAN2.png" class="image-right" src="./_/b9051c22567e2b622719dbd0ae548913127c581b.png"/></p><p><span class="underline">IPv4-Einstellungen:</span>
</p><ul><li><p>Auf dem Host:</p><ul><li><p>LAN 1 - <em>"Automatisch DHCP"</em> (Verbindung zum Internet über Router/Modem. Kann auch statisch konfiguriert werden.)</p></li><li><p>LAN 2 - <em>"Gemeinsam mit anderen Rechnern"</em> (muss manuell eingestellt werden)</p></li></ul></li></ul><p>
</p><ul><li><p>Auf den Clients:</p><ul><li><p>LAN - <em>"Automatisch DHCP"</em></p></li></ul></li></ul><p>
</p></div></div><div class="section_1"><h2 id="ICS-mit-Wicd">ICS mit Wicd<a class="headerlink" href="#ICS-mit-Wicd">¶</a></h2><p>
</p><div class="section_2"><h3 id="WLAN-auf-LAN-2">WLAN auf LAN<a class="headerlink" href="#WLAN-auf-LAN-2">¶</a></h3><p>
Über die in <a class="internal" href="./wicd.html">Wicd</a> integrierte Skriptfunktion kann eine bestehende LAN- oder WLAN-Verbindung ebenfalls weitergeleitet werden. Hier im Beispiel wird die WLAN-Verbindung mit Wicd aufgebaut und anschließend auf die LAN-Schnittstelle durchgereicht. Umgekehrt ist das natürlich ebenfalls möglich. Die hier im Artikel gezeigten Konfigurationsbeispiele über die Datei <a class="internal" href="./interfaces.html">interfaces</a> können zur dazu verwendet und für die Skripte entsprechend angepasst werden.</p><p>Zunächst müssen die benötigten Dateien (Skripte) angelegt und ausführbar gemacht werden:</p><div class="bash"><div class="contents"><pre class="notranslate">touch ics_up.sh
touch ics_down.sh
chmod +x ics_up.sh
chmod +x ics_down.sh </pre></div></div><p>Anschließend mit mit einem <a class="internal" href="./editor.html">Editor</a> bearbeiten und folgende Inhalte einfügen.</p><p>Startskript <strong>ics_up.sh</strong>:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## LAN-Schnittstelle konfigurieren</span>
/sbin/ifconfig  eth0 down
 /bin/sleep <span class="m">2</span>
  /sbin/ifconfig eth0 <span class="m">192</span>.168.3.1 broadcast <span class="m">192</span>.168.3.255 netmask <span class="m">255</span>.255.255.0
    /bin/sleep <span class="m">2</span>
     /sbin/ifconfig  eth0 up

<span class="c1">## Maskieren der WLAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren</span>
/sbin/iptables -A FORWARD -o wlan0 -i eth0 -s <span class="m">192</span>.168.3.0/24 -m conntrack --ctstate NEW -j ACCEPT
 /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  /sbin/iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE 
   /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span> 

<span class="c1">## dnsmasq-base starten</span>
/bin/sleep <span class="m">2</span>
 /usr/bin/killall dnsmasq
  /bin/sleep <span class="m">2</span>
   /usr/sbin/dnsmasq -i eth0 -I wlan0 -F <span class="m">192</span>.168.3.10,192.168.3.20,infinite
<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</td></tr></table></div><p>Stopskript <strong>ics_down.sh</strong>:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## LAN-Schnittstelle stoppen</span>
/sbin/ifconfig eth0 down

<span class="c1">## iptables/Masquerading - vorhandene Regeln und Ketten löschen, dnsmasq stoppen</span>
/sbin/iptables -F
 /sbin/iptables -X
  /sbin/iptables -t nat -F
   /usr/bin/killall dnsmasq
    /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>

<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</td></tr></table></div><p>
Die Bezeichnungen der tatsächlich verwendeten Schnittstellen ist natürlich entsprechend anzupassen.</p><p><img alt="./Wicd_ConfigureScripts.png" class="image-right" src="./_/c503252faf7ad8f6bdf3580f41deef7b04179ba0.png"/></p><p>Das Startskript muss nun nach <strong>/etc/wicd/scripts/postconnect</strong> und das Stopskript nach <strong>/etc/wicd/scripts/predisconnect</strong> kopiert und der Aufruf in das entsprechenden Verbindungsprofil in Wicd unter <em>Eigenschaften - Skripte</em> eingetragen werden. Die Skripte werden nun entsprechend nach Aufbau der WLAN-Verbindung, bzw. vor Abbau selbiger abgearbeitet.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp ics_up.sh /etc/wicd/scripts/postconnect
sudo cp ics_down.sh /etc/wicd/scripts/predisconnect </pre></div></div><p>Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p></div></div><div class="section_1"><h2 id="ICS-ueber-die-Datei-interfaces">ICS über die Datei interfaces<a class="headerlink" href="#ICS-ueber-die-Datei-interfaces">¶</a></h2><p>
</p><div class="section_2"><h3 id="Grundkonfiguration">Grundkonfiguration<a class="headerlink" href="#Grundkonfiguration">¶</a></h3><p>
Die Konfiguration über den <a class="internal" href="./network-manager.html">Network-Manager</a> muss dazu deaktiviert werden. Über einen Rechtsklick <img alt="rechte Maustaste" class="image-default" src="./_/aa516ca8be74ff7de9b706b8ffc7a88e87e17fb5.png"/> auf das Symbol in der Leiste (Panel) sind die LAN- und WLAN-Verbindungen zu deaktivieren, um die Konfiguration über die Datei <a class="internal" href="./interfaces.html">/etc/network/interfaces</a> zu ermöglichen. Der Manager sollte ansonsten vollständig deinstalliert werden, um Konflikte zu vermeiden.</p><p>Für eine Beispiele stehen Skripte zur Steuerung der jeweiligen Konfiguration zur Verfügung welche den Manager automatisch deaktivieren und auch wieder aktivieren, so dass dieser nicht manuell abgeschaltet oder deinstalliert werden muss.</p><p>Alle Konfigurationsdateien können mit einem <a class="internal" href="./editor.html">Editor</a> <sup><a href="#source-1">[1]</a></sup> und Root-Rechten <sup><a href="#source-3">[3]</a></sup> bearbeitet werden.</p><div class="section_3"><h4 id="Netzwerk-neu-starten">Netzwerk neu starten<a class="headerlink" href="#Netzwerk-neu-starten">¶</a></h4><p>
Nachdem eine der nachfolgend beschriebenen Konfigurationen erstellt wurde, muss das Netzwerk neu gestartet werden. Beobachte die Terminalausgabe <sup><a href="#source-2">[2]</a></sup>, achte auch auf Fehlermeldungen und überprüfe anschließend die Konfiguration:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo /etc/init.d/networking restart
ifconfig -a
iwconfig </pre></div></div></div><div class="section_3"><h4 id="Dnsmasq">Dnsmasq<a class="headerlink" href="#Dnsmasq">¶</a></h4><p>
So wie beim Network-Manager auch wird hier <a class="internal" href="./dnsmasq.html">dnsmasq-base</a> für die gezeigten Beispiele verwendet, was bereits zur Standardinstallation seit Ubuntu 8.10 <a class="internal" href="./intrepid_ibex.html">Intrepid Ibex</a> gehört, aber auch schon unter Ubuntu 8.04 <a class="internal" href="./hardy_heron.html">Hardy Heron</a> nachinstalliert werden kann. Dnsmasq wird dann über eine einzige Befehlszeile konfiguriert.</p><ul><li><p><strong>dnsmasq-base </strong> (<em>universe</em> <sup><a href="#source-5">[5]</a></sup> - ein DHCP-Server und DNS-Cache (Basispaket))</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install dnsmasq-base  </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install dnsmasq-base  </pre></div></div><p>
</p></div></div><p>Soll <a class="internal" href="./dnsmasq.html">Dnsmasq</a> als Vollinstallation verwendet werden, um die Konfigurationsdatei mit erweiterten Optionen nutzen zu können, muss folgendes Programmpaket nachinstalliert werden:</p><ul><li><p><strong>dnsmasq </strong> (<em>universe</em> <sup><a href="#source-5">[5]</a></sup> - ein DHCP- und DNS-Cache, siehe auch <a class="internal" href="./dnsmasq.html">Dnsmasq</a> und <a class="internal" href="./router.html">Router</a>)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install dnsmasq  </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install dnsmasq  </pre></div></div><p>
</p></div></div><p>Danach sollte die Konfigurationsdatei gesichert werden, da diese div. Beispiele enthält.
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.bak     # Originaldatei vorab sichern </pre></div></div></div></div><div class="section_2"><h3 id="Automatische-Konfiguration-DHCP">Automatische Konfiguration DHCP<a class="headerlink" href="#Automatische-Konfiguration-DHCP">¶</a></h3><p>
</p><div class="section_3"><h4 id="LAN-auf-WLAN-2">LAN auf WLAN<a class="headerlink" href="#LAN-auf-WLAN-2">¶</a></h4><p>
Eine manuelle Konfiguration bietet erweiterte Einstellmöglichkeiten, wie z.B. Auswahl der <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Private_IP-Adresse">IP-Adressen</a> oder freie Kanalwahl der WLAN-Verbindung, was mit dem Network-Manager erst ab Ubuntu 10.10 <a class="internal" href="./maverick_meerkat.html">Maverick Meerkat</a> möglich ist (zulässige <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Wireless_Local_Area_Network#Frequenzen_und_Kan.C3.A4le">Frequenzeinstellungen</a>).</p><p>Nachfolgend eine vollständige Beispielkonfiguration für eine Verbindungsfreigabe mittels WLAN Ad-Hoc mit 128-bit WEP-Verschlüsselung auf Funkkanal 1. Die Konfiguration für <code class="notranslate">eth0</code> muss entsprechend der Gegebenheiten angepasst werden. Start des DHCP-Servers, IP-Forwarding und Maskieren der LAN-Schnittstelle sind temporär und werden bei Systemstart automatisch erneut aktiviert. Die IP-Adresse der lokalen Schnittstelle muss sich zudem in einem separaten Adressraum/Subnetz befinden.</p><p>Konfiguration der <strong>/etc/network/interfaces</strong>:</p><pre class="notranslate">auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp

auto wlan0
iface wlan0 inet static
address 192.168.3.1
netmask 255.255.255.0
broadcast 192.168.3.255

# Ad-Hoc Netz erstellen. ESSID, Schlüssel und Funkkanal anpassen
up iwconfig wlan0 mode Ad-Hoc essid <strong class="highlighted">Deine_ESSID</strong> key <strong class="highlighted">12345678901234567890123456</strong> freq <strong class="highlighted">2412000000</strong>

## Alternative Syntax Kanaleinstellung
# up iwconfig wlan0 mode Ad-Hoc essid Deine_ESSID key 12345678901234567890123456 channel 1

## Alternative Syntax 128bit Schlüssel in Klartext
# up iwconfig wlan0 mode Ad-Hoc essid Deine_ESSID key s:abcdefghjklmn channel 1

## vorhandene Regeln und Ketten zuerst löschen
up /sbin/iptables -F
 up /sbin/iptables -X
  up /sbin/iptables -t nat -F

## Maskieren der LAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren
up /sbin/iptables -A FORWARD -o eth0 -i wlan0 -s 192.168.0.0/24 -m conntrack --ctstate NEW -j ACCEPT
 up /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  up /sbin/iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 
   up /sbin/sysctl -w net.ipv4.ip_forward=1 

## dnsmasq-base verwenden
## verwendeter Adressbereich 192.168.3.10 - 192.168.3.20
up /usr/bin/killall dnsmasq
 up /bin/sleep 2
  post-up /usr/sbin/dnsmasq -i wlan0 -I eth0 -F 192.168.3.10,192.168.3.20,infinite

## Nur bei Verwendung der dnsmasq.conf aktivieren!
## Abschnitt für dnsmasq-base dann deaktivieren!
## dnsmasq neu starten
# post-up /etc/init.d/dnsmasq restart</pre><p>Optionale Basiskonfiguration der <strong>/etc/dnsmasq.conf</strong> für das hier gezeigte Beispiel:</p><pre class="notranslate"># DHCP-Server aktiv für Interface
interface=wlan0

# DHCP-Server nicht aktiv für Interface
no-dhcp-interface=eth0

# IP-Adressbereich / Lease-Time
dhcp-range=interface:wlan0,192.168.3.10,192.168.3.20,infinite</pre><p>
Feste IP für die angeschlossenen Clients vergeben. Konfiguration über die <strong>/etc/dnsmasq.conf</strong></p><pre class="notranslate">dhcp-host=&lt;MAC-Adresse&gt;,&lt;Name&gt;,&lt;IP-Adresse&gt;,infinite
dhcp-host=&lt;MAC-Adresse&gt;,&lt;IP-Adresse&gt;,infinite
dhcp-host=&lt;Rechnername&gt;,&lt;IP-Adresse&gt;,infinite</pre></div><div class="section_3"><h4 id="WLAN-auf-LAN-3">WLAN auf LAN<a class="headerlink" href="#WLAN-auf-LAN-3">¶</a></h4><p>
Die WLAN-Schnittstelle wurde hier für eine Verbindung mit sicherer WPA2-Verschlüsselung vorkonfiguriert. Ebenso ist die WLAN-Konfiguration über <a class="internal" href="./wlan/wpa_supplicant.html">WLAN/wpa supplicant</a> möglich.</p><p>Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><p>Konfiguration der <strong>/etc/network/interfaces</strong>:
</p><pre class="notranslate">auto lo
iface lo inet loopback

auto wlan0 
iface wlan0 inet dhcp
     wpa-driver wext
     wpa-ssid DeineSSID
     wpa-ap-scan 1
     wpa-proto RSN
     wpa-pairwise CCMP
     wpa-group CCMP
     wpa-key-mgmt WPA-PSK
     wpa-psk "Dein_WPA-Kennwort_in Klartext"

auto eth0
iface eth0 inet static
address 192.168.3.1
netmask 255.255.255.0
broadcast 192.168.3.255

## vorhandene Regeln und Ketten zuerst löschen
up /sbin/iptables -F
 up /sbin/iptables -X
  up /sbin/iptables -t nat -F

## Maskieren der LAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren
up /sbin/iptables -A FORWARD -o wlan0 -i eth0 -s 192.168.0.0/24 -m conntrack --ctstate NEW -j ACCEPT
 up /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  up /sbin/iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE 
   up /sbin/sysctl -w net.ipv4.ip_forward=1 

## dnsmasq-base verwenden
## verwendeter Adressbereich 192.168.3.10 - 192.168.3.20
up /usr/bin/killall dnsmasq
 up /bin/sleep 2
  post-up /usr/sbin/dnsmasq -i eth0 -I wlan0 -F 192.168.3.10,192.168.3.20,infinite

## Nur bei Verwendung der dnsmasq.conf aktivieren!
## Abschnitt für dnsmasq-base dann deaktivieren!
## dnsmasq neu starten
# post-up /etc/init.d/dnsmasq restart</pre><p>Optionale Basiskonfiguration der <strong>/etc/dnsmasq.conf</strong> für das hier gezeigte Beispiel:</p><pre class="notranslate"># DHCP-Server aktiv für Interface
interface=eth0

# DHCP-Server nicht aktiv für Interface
no-dhcp-interface=wlan0

# IP-Adressbereich / Lease-Time
dhcp-range=interface:eth0,192.168.3.10,192.168.3.20,infinite</pre><p>Steuerung der Konfiguration über ein Skript.</p><div class="section_4"><h5 id="Instant-ICS">Instant ICS<a class="headerlink" href="#Instant-ICS">¶</a></h5><p>
Die Einrichtung ist ebenfalls über ein Skript möglich. Das Skript basiert auf <a class="internal" href="./internetverbindungsfreigabe.html#Instant-Ad-Hoc">Internetverbindungsfreigabe - Instant-Ad-Hoc</a>, ist aber für ein Verbindung zwischen WLAN und LAN umgeschrieben. Der Network-Manager wird durch das Skript gesteuert und muss nicht manuell deaktiviert werden.</p><p>Skript anlegen und ausführbar machen <sup><a href="#source-2">[2]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">touch instant_ICS_WLAN_to_LAN.sh
chmod +x instant_ICS_WLAN_to_LAN.sh </pre></div></div><p>Inhalt einfügen:
</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant ICS - Modus WLAN auf LAN</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2011</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 1.0.2 vom 23.Dezember 2011</span>
<span class="c1">##</span>
<span class="c1">## Skript</span>
<span class="c1">##</span>
<span class="c1">## freie Variablen</span>
<span class="c1">##</span>

<span class="c1">## Schnittstellenkonfiguration WLAN-Interface</span>
<span class="nv">wlaniface</span><span class="o">=</span><span class="s2">"wlan0"</span>

<span class="c1">## Konfiguration des Accesspoints</span>
<span class="c1">## SSID (Name) des WLAN Accesspoints eintragen zu dem eine Verbindung hergestellt werden soll</span>
<span class="nv">ssid</span><span class="o">=</span><span class="s2">"Deine_WLAN_SSID"</span>

<span class="c1">## MAC-Adresse des WLAN Accesspoints eintragen</span>
<span class="nv">mac</span><span class="o">=</span><span class="s2">"XX:XX:XX:XX:XX:XX"</span>

<span class="c1">## Einstellungen zur Verschlüsselung</span>
<span class="c1">## Konfiguration wpa-supplicant</span>
<span class="nv">proto</span><span class="o">=</span><span class="s2">"WPA RSN"</span>
<span class="nv">key_mgmt</span><span class="o">=</span><span class="s2">"WPA-PSK"</span>
<span class="nv">pairwise</span><span class="o">=</span><span class="s2">"TKIP CCMP"</span>
<span class="nv">group</span><span class="o">=</span><span class="s2">"TKIP CCMP"</span>

<span class="c1">## Zugangskennwort in Klartext (PSK)</span>
<span class="nv">psk</span><span class="o">=</span><span class="s2">"Dein_Zugangsschluessel_in_Klartext_PSK"</span>

<span class="c1">## Treiber für wpa_supplicant (Vorgabe)</span>
<span class="nv">wpadriver</span><span class="o">=</span><span class="s2">"wext"</span>

<span class="c1">## temporäre Konfigurationsdatei für wpa_supplicant</span>
<span class="nv">home</span><span class="o">=</span><span class="s2">"`pwd`"</span>
<span class="nv">configfile</span><span class="o">=</span><span class="nv">$home</span>/wpa_supplicant.tmp

<span class="c1">## Schnittsetllenkonfiguration LAN-Interface</span>
<span class="c1">## LAN statisch (Vorgabe) </span>
<span class="nv">laniface</span><span class="o">=</span><span class="s2">"eth0"</span>
<span class="nv">laddress</span><span class="o">=</span><span class="s2">"192.168.3.1"</span>
<span class="nv">lbroadcast</span><span class="o">=</span><span class="s2">"192.186.3.255"</span>
<span class="nv">lnetmask</span><span class="o">=</span><span class="s2">"255.255.255.0"</span>
<span class="nv">iptablemask</span><span class="o">=</span><span class="s2">"192.168.0.0/24"</span>

<span class="c1">## DHCP-Client</span>
<span class="nv">dhcpclient</span><span class="o">=</span><span class="s2">"dhclient"</span>

<span class="c1">## manuelle DNS (drei DNS Einträge, 1xDomain und 1xSearch sind möglich) - Startoption -D</span>
<span class="c1">## Beispiel:</span>
<span class="c1">## dns="nameserver 192.168.178.1 nameserver 192.168.178.1 nameserver 192.168.178.1 domain fritz.box search fritz.box"</span>
<span class="nv">dns</span><span class="o">=</span><span class="s2">"nameserver 8.8.4.4 nameserver 8.8.8.8 nameserver 213.73.91.35"</span> 

<span class="c1">## dnsmasq-base Konfiguration</span>
<span class="c1">## DHCP-Adresspool umfasst x-Adressen</span>
<span class="nv">ipaddresses</span><span class="o">=</span><span class="m">10</span>

<span class="c1">## Basisadresse DHCP-Adresspool (LAN-IP + Startadresse)</span>
<span class="nv">lanbaseip</span><span class="o">=</span><span class="m">10</span>

<span class="c1">## Lease-Time</span>
<span class="nv">leasetime</span><span class="o">=</span><span class="s2">"infinite"</span>

<span class="c1">## Proxy Server auf Port x</span>
<span class="nv">proxyport</span><span class="o">=</span><span class="m">3128</span>

<span class="c1">## Pause bevor eine IP-Adresse angefordert wird</span>
<span class="c1">## diese Zeit in Sek. bleibt wpa_supplicant für den Verbindungsaufbau</span>
<span class="nv">connectsleep</span><span class="o">=</span><span class="m">15</span>

<span class="c1">## Pause in Sekunden für Konfigurationsparameter</span>
<span class="c1">## Vorgabewert 2</span>
<span class="nv">configdelay</span><span class="o">=</span><span class="m">2</span>

<span class="c1">## Ende freie Variablen</span>

<span class="c1">## aut. Adressberechnung DHCP-Range für dnsmasq</span>
<span class="c1">## gemäß Vorgabe WLAN-Schnittstelle</span>

<span class="nv">ipaddresses</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$ipaddresses</span>+<span class="nv">$lanbaseip</span><span class="o">]</span>
 <span class="nv">baseendaddr</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$laddress</span><span class="s2"> | tr -s . "</span> <span class="s2">" | awk {'print </span><span class="nv">$4</span><span class="s2">'}`"</span>
  <span class="nv">basestartaddr</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$laddress</span><span class="s2"> | tr -s . "</span> <span class="s2">" | awk {'print </span><span class="nv">$1</span><span class="s2">,</span><span class="nv">$2</span><span class="s2">,</span><span class="nv">$3</span><span class="s2">'} | tr -s "</span> <span class="s2">" .`"</span>
   <span class="nv">endaddr</span><span class="o">=</span><span class="s2">"</span><span class="nv">$basestartaddr</span><span class="s2">""."</span>$<span class="o">[</span><span class="nv">$startaddr</span>+<span class="nv">$ipaddresses</span><span class="o">]</span>
    <span class="nv">startaddr</span><span class="o">=</span><span class="s2">"</span><span class="nv">$basestartaddr</span><span class="s2">""."</span>$<span class="o">[</span><span class="nv">$baseendaddr</span>+<span class="nv">$lanbaseip</span><span class="o">]</span>

<span class="c1">## Optionen</span>
<span class="nv">D</span><span class="o">=</span><span class="m">0</span>
<span class="nv">H</span><span class="o">=</span><span class="m">0</span>
<span class="nv">P</span><span class="o">=</span><span class="m">0</span>

<span class="k">while</span> <span class="nb">getopts</span> <span class="s2">":hDP"</span> OPTION <span class="p">;</span> <span class="k">do</span>
 <span class="k">case</span> <span class="nv">$OPTION</span> in
  D<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"manueller DNS"</span><span class="p">;</span> <span class="nv">D</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  P<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Portumleitung für Proxy aktiviert"</span><span class="p">;</span> <span class="nv">P</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  h<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Hilfe angefordert"</span><span class="p">;</span> <span class="nv">H</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
 <span class="k">esac</span>
  <span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$H</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_ICS_WLAN_to_LAN.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-restart<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-P<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-D<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_ICS.sh  startet mit Standardparametern, wie [-start]"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_ICS.sh -restart -D startet automatische WLAN-Konfiguration über DHCP, verwendet manuelle DNS"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_ICS.sh -restart"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_ICS.sh -P Portumleitung für Proxyserver (Squid)"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_ICS.sh -stop beendet das ICS Netzwerk"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> starte Konfiguration ...

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> stoppe alle Dienste, und Verbindungen ...

<span class="c1"># iptables Filter löschen</span>
/sbin/iptables -F
 /sbin/iptables -X
  /sbin/iptables -t nat -F

<span class="nv">defgw</span><span class="o">=</span><span class="s2">"`route -n | grep UG | awk {'print </span><span class="nv">$2</span><span class="s2">'}`"</span>
 /sbin/route del default gw <span class="nv">$defgw</span> <span class="nv">$wlaniface</span>
  <span class="nb">echo</span> <span class="s1">''</span> <span class="p">|</span> tee /etc/resolv.conf
 
 /sbin/ifconfig <span class="nv">$wlaniface</span> down
   /usr/bin/killall dnsmasq
     /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>
      service squid stop

<span class="c1"># lösche Konfigurationsdatei</span>
rm <span class="nv">$home</span>/wpa_supplicant.tmp

<span class="c1">## Restart Network-Manager - beende ICS Netzwerk</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-stop"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"reaktiviere Network-Manager."</span>
   service network-manager start
    sleep <span class="nv">$configdelay</span>
     service network-manager restart
<span class="nb">echo</span> <span class="s2">"ICS Konfiguration beendet."</span>
 <span class="nb">exit</span>
  <span class="k">fi</span>
 <span class="k">fi</span>

<span class="c1"># Konfiguration</span>
service network-manager stop
 sleep <span class="m">1</span>
  killall wpa_supplicant
   killall <span class="nv">$dhcpclient</span>
    sleep <span class="nv">$configdelay</span>
     /sbin/ifconfig <span class="nv">$wlaniface</span> down
      sleep <span class="nv">$configdelay</span>
       /sbin/ifconfig <span class="nv">$wlaniface</span> up
        sleep <span class="nv">$configdelay</span>

<span class="c1"># Konfiguration wpa_supplicant</span>
<span class="nv">ctrliface</span><span class="o">=</span><span class="s2">"ctrl_interface=/var/run/wpa_supplicant"</span>
<span class="nv">eapolv</span><span class="o">=</span><span class="s2">"eapol_version=1"</span>
<span class="nv">apscan</span><span class="o">=</span><span class="s2">"ap_scan=1"</span>

<span class="c1">## WLAN-Verbindung vorbereiten</span>
 <span class="nb">echo</span> <span class="nv">$ctrliface</span> <span class="p">|</span> tee <span class="nv">$configfile</span>
  <span class="nb">echo</span> <span class="nv">$eapolv</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
   <span class="nb">echo</span> <span class="nv">$apscan</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
    <span class="nb">echo</span> <span class="s1">'network={'</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
     <span class="nb">echo</span> <span class="nv">ssid</span><span class="o">=</span><span class="s1">'"'</span><span class="nv">$ssid</span><span class="s1">'"'</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
      <span class="nb">echo</span> <span class="nv">bssid</span><span class="o">=</span><span class="nv">$mac</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
       <span class="nb">echo</span> <span class="nv">proto</span><span class="o">=</span><span class="nv">$proto</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
        <span class="nb">echo</span> <span class="nv">key_mgmt</span><span class="o">=</span><span class="nv">$key_mgmt</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
         <span class="nb">echo</span> <span class="nv">pairwise</span><span class="o">=</span><span class="nv">$pairwise</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
          <span class="nb">echo</span> <span class="nv">group</span><span class="o">=</span><span class="nv">$group</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
           <span class="nb">echo</span> <span class="nv">psk</span><span class="o">=</span><span class="s1">'"'</span><span class="nv">$psk</span><span class="s1">'"'</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>
            <span class="nb">echo</span> <span class="s1">'}'</span> <span class="p">|</span> tee -a <span class="nv">$configfile</span>

<span class="nb">echo</span> <span class="s2">"Starte automatische WLAN-Verbindung über DHCP ..."</span>
 /sbin/wpa_supplicant -i <span class="nv">$wlaniface</span> -D <span class="nv">$wpadriver</span> -c <span class="nv">$configfile</span> -B
  sleep <span class="nv">$connectsleep</span>
    <span class="nb">echo</span> <span class="s2">"Fordere IP-Adresse an ..."</span>
     /sbin/dhclient <span class="nv">$wlaniface</span>
      sleep <span class="nv">$configdelay</span>

<span class="c1"># manuelle DNS - Startoption -D</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"setze manuelle DNS"</span>
 <span class="nb">echo</span> <span class="s1">'# instant_ICS_WLAN_to_LAN.sh'</span> <span class="p">|</span> tee /etc/resolv.conf
  <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $1,$2'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
   <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $3,$4'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
    <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $5,$6'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf 
     <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $7,$8'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
      <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $9,$10'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
 sleep <span class="nv">$configdelay</span>
<span class="k">fi</span>

<span class="c1"># statische Konfiguration der Ethernet-Schnittstelle</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"Starte statische LAN-Konfiguration ..."</span>
   /sbin/ifconfig <span class="nv">$laniface</span> down
    /sbin/ifconfig <span class="nv">$laniface</span> <span class="nv">$laddress</span> broadcast <span class="nv">$lbroadcast</span> netmask <span class="nv">$lnetmask</span>
     /sbin/ifconfig <span class="nv">$laniface</span> up
      sleep <span class="nv">$configdelay</span>

<span class="nb">echo</span> <span class="s2">"Vorgabewerte:"</span>
 <span class="nb">echo</span> <span class="s2">"Schnittstelle: "</span><span class="nv">$laniface</span><span class="s2">" IP: "</span><span class="nv">$laddress</span><span class="s2">" Broadcast: "</span><span class="nv">$lbroadcast</span><span class="s2">" Netzmaske: "</span><span class="nv">$lnetmask</span>

<span class="c1"># aktiviere IP-Forward und NAT</span>
<span class="nb">echo</span> <span class="s2">"starte IP-Forward, Masquerading und NAT"</span>
/sbin/iptables -A FORWARD -o <span class="nv">$wlaniface</span> -i <span class="nv">$laniface</span> -s <span class="nv">$iptablemask</span> -m conntrack --ctstate NEW -j ACCEPT
 /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  /sbin/iptables -t nat -A POSTROUTING -o <span class="nv">$wlaniface</span> -j MASQUERADE 
   /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span> 
    sleep <span class="nv">$configdelay</span>

<span class="c1"># dnsmasq starten</span>
<span class="nb">echo</span> <span class="s2">"starte dnsmasq"</span>
 <span class="nb">echo</span> <span class="s2">"DHCP-Range dnsmasq - Startadresse: "</span><span class="nv">$startaddr</span><span class="s2">" Endadresse: "</span><span class="nv">$endaddr</span>
  /usr/sbin/dnsmasq -i <span class="nv">$laniface</span> -I <span class="nv">$wlaniface</span> -F <span class="nv">$startaddr</span>,<span class="nv">$endaddr</span>,<span class="nv">$leasetime</span>

<span class="c1"># Portumleitung für Squid Proxyserver - Startoption -P</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$P</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/iptables -t nat -A PREROUTING -i <span class="nv">$wlaniface</span> -p tcp --dport <span class="m">80</span> -j REDIRECT --to-port <span class="m">3128</span>
  <span class="nb">echo</span> <span class="s2">"Port 80 </span><span class="nv">$wlaniface</span><span class="s2"> auf Port </span><span class="nv">$proxyport</span><span class="s2"> umgeleitet (Squid Proxyserver)"</span>
   <span class="nb">echo</span> <span class="s2">"starte Squid Proxyserver ..."</span>
    sleep <span class="nv">$configdelay</span>
      service squid start -n
<span class="k">fi</span>

<span class="c1"># Ausgabe der Konfiguration. Einstellungen der Schnittstellen,</span>
<span class="c1"># Routingtabelle und DNS prüfen</span>

<span class="nb">echo</span> <span class="s2">"prüfe Konfiguration ..."</span>
 <span class="nb">echo</span>
<span class="nb">echo</span> <span class="s2">"Systemkonfiguration: /etc/resolv.conf"</span>
  /bin/cat /etc/resolv.conf
   /sbin/route -n
    <span class="nb">echo</span> 
   <span class="nb">echo</span> Konfiguration LAN:
    /sbin/ifconfig <span class="nv">$laniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
<span class="nb">echo</span>
   <span class="nb">echo</span> Konfiguration WLAN:
    /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"Konfiguration beendet"</span>

<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</td></tr></table></div><p>
Parameter der Schnittstellen, IP-Adressbereiche usw. können im Deklarationsblock des Skripts angepasst werden.</p><p>Im Terminal <sup><a href="#source-2">[2]</a></sup> als <code class="notranslate">root</code><sup><a href="#source-3">[3]</a></sup> kann das Skript nun mit verschiedenen Parametern aufgerufen werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ./instant_ICS_WLAN_to_LAN.sh [-start|-restart|-stop]
sudo ./instant_ICS_WLAN_to_LAN.sh                  # startet mit automatischer Konfiguration (wie mit [-start])
sudo ./instant_ICS_WLAN_to_LAN.sh -start           # startet alle Verbindungen und Dienste mit automatischer Konfiguration
sudo ./instant_ICS_WLAN_to_LAN.sh -restart         # erneuert alle Verbindungen und Dienste mit automatischer Konfiguration
sudo ./instant_ICS_WLAN_to_LAN.sh -stop            # beendet alle Verbindungen und Dienste </pre></div></div><p>
Weitere Startoptionen sind im Skript beschrieben.</p></div></div><div class="section_3"><h4 id="LAN-auf-LAN-2">LAN auf LAN<a class="headerlink" href="#LAN-auf-LAN-2">¶</a></h4><p>
Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><p>Konfiguration der <strong>/etc/network/interfaces</strong>:</p><pre class="notranslate">auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
address 192.168.3.1
netmask 255.255.255.0
broadcast 192.168.3.255

## vorhandene Regeln und Ketten zuerst löschen
up /sbin/iptables -F
 up /sbin/iptables -X
  up /sbin/iptables -t nat -F

## Maskieren der LAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren
up /sbin/iptables -A FORWARD -o eth0 -i eth1 -s 192.168.0.0/24 -m conntrack --ctstate NEW -j ACCEPT
 up /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  up /sbin/iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE 
   up /sbin/sysctl -w net.ipv4.ip_forward=1 

## dnsmasq-base verwenden
## verwendeter Adressbereich 192.168.3.10 - 192.168.3.20
up /usr/bin/killall dnsmasq
 up /bin/sleep 2
  post-up /usr/sbin/dnsmasq -i eth1 -I eth0 -F 192.168.3.10,192.168.3.20,infinite

## Nur bei Verwendung der dnsmasq.conf aktivieren!
## Abschnitt für dnsmasq-base dann deaktivieren!
## dnsmasq neu starten
# post-up /etc/init.d/dnsmasq restart</pre><p>Optionale Basiskonfiguration der <strong>/etc/dnsmasq.conf</strong> für das hier gezeigte Beispiel:</p><pre class="notranslate"># DHCP-Server aktiv für Interface
interface=eth1

# DHCP-Server nicht aktiv für Interface
no-dhcp-interface=eth0

# IP-Adressbereich / Lease-Time
dhcp-range=interface:eth1,192.168.3.10,192.168.3.20,infinite</pre><p>Steuerung der Konfiguration über ein Skript.</p><div class="section_4"><h5 id="Instant-ICS-2">Instant ICS<a class="headerlink" href="#Instant-ICS-2">¶</a></h5><p>
Die Einrichtung ist ebenfalls über ein Skript möglich. Das Skript basiert auf <a class="internal" href="./internetverbindungsfreigabe.html#Instant-Ad-Hoc">Internetverbindungsfreigabe - Instant-Ad-Hoc</a>, ist aber für ein Verbindung zwischen zwei Ethernetschnittstellen (LAN auf LAN) umgeschrieben. Der Network-Manager wird durch das Skript gesteuert und muss nicht manuell deaktiviert werden.</p><p>Skript anlegen und ausführbar machen <sup><a href="#source-2">[2]</a></sup>:
</p><div class="bash"><div class="contents"><pre class="notranslate">touch instant_ICS.sh
chmod +x instant_ICS.sh </pre></div></div><p>Inhalt einfügen:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant ICS - Modus LAN auf LAN</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2011</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 1.0.1 vom 27.November 2011</span>
<span class="c1">##</span>
<span class="c1">## Skript</span>
<span class="c1">##</span>
<span class="c1">## freie Variablen</span>
<span class="c1">##</span>
<span class="c1">## LAN statisch (Beispiel) (Startoption [-f])</span>
<span class="c1">## Internetverbindung</span>
<span class="c1">#</span>
<span class="nv">laniface</span><span class="o">=</span>eth0
<span class="nv">laddress</span><span class="o">=</span><span class="m">192</span>.168.178.10
<span class="nv">lbroadcast</span><span class="o">=</span><span class="m">192</span>.168.178.255
<span class="nv">lnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">lgateway</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">### DNS (drei DNS Einträge, 1x Domain und 1x Search sind möglich) - nur mit Startoption [-f]</span>
<span class="c1"># Beispiel:</span>
<span class="c1"># dns="nameserver 192.168.178.1 nameserver 213.73.91.35 nameserver 87.118.100.175 domain fritz.box search fritz.box"</span>
<span class="nv">dns</span><span class="o">=</span><span class="s2">"nameserver 8.8.4.4 nameserver 8.8.8.8 nameserver 213.73.91.35"</span> 

<span class="c1">## dnsmasq DNS (manuell) (Startoption [-D])</span>
<span class="c1">## dnsmasq ignoriert dann /etc/resolv.conf</span>
<span class="nv">mandns</span><span class="o">=</span><span class="m">8</span>.8.4.4

<span class="c1">## MAC-Adresse (optional) (Startoption [-m])</span>
<span class="nv">lmacaddress</span><span class="o">=</span><span class="m">00</span>:12:79:c0:49:ae

<span class="c1">## LAN2 statisch (Beispiel) </span>
<span class="c1">## hier werden weitere Clients angeschlossen</span>
<span class="c1">#</span>
<span class="nv">laniface2</span><span class="o">=</span>eth1
<span class="nv">address2</span><span class="o">=</span><span class="m">192</span>.168.3.1
<span class="nv">broadcast2</span><span class="o">=</span><span class="m">192</span>.186.3.255
<span class="nv">netmask2</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">iptablemask</span><span class="o">=</span><span class="m">192</span>.168.0.0/24

<span class="c1">## DNSMASQ Konfiguration</span>
<span class="c1"># DHCP-Adresspool umfasst x-Adressen</span>
<span class="nv">ipaddresses</span><span class="o">=</span><span class="m">10</span>

<span class="c1"># Basisadresse DHCP-Adresspool (WLAN-IP + X)</span>
<span class="nv">lanbaseip</span><span class="o">=</span><span class="m">10</span>

<span class="c1"># Lease-Time</span>
<span class="nv">leasetime</span><span class="o">=</span>infinite

<span class="c1">## Proxy Server auf Port x</span>
<span class="nv">proxyport</span><span class="o">=</span><span class="m">3128</span>

<span class="c1">## Ende freie Variablen</span>

<span class="c1">## aut. Adressberechnung DHCP-Range für dnsmasq</span>
<span class="c1">## gemäß Vorgabe WLAN-Schnittstelle</span>
<span class="nv">ipaddresses</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$ipaddresses</span>+<span class="nv">$lanbaseip</span><span class="o">]</span>
 <span class="nv">baseendaddr</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$address2</span><span class="s2"> | tr -s . "</span> <span class="s2">" | awk {'print </span><span class="nv">$4</span><span class="s2">'}`"</span>
  <span class="nv">basestartaddr</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$address2</span><span class="s2"> | tr -s . "</span> <span class="s2">" | awk {'print </span><span class="nv">$1</span><span class="s2">,</span><span class="nv">$2</span><span class="s2">,</span><span class="nv">$3</span><span class="s2">'} | tr -s "</span> <span class="s2">" .`"</span>
   <span class="nv">endaddr</span><span class="o">=</span><span class="s2">"</span><span class="nv">$basestartaddr</span><span class="s2">""."</span>$<span class="o">[</span><span class="nv">$startaddr</span>+<span class="nv">$ipaddresses</span><span class="o">]</span>
    <span class="nv">startaddr</span><span class="o">=</span><span class="s2">"</span><span class="nv">$basestartaddr</span><span class="s2">""."</span>$<span class="o">[</span><span class="nv">$baseendaddr</span>+<span class="nv">$lanbaseip</span><span class="o">]</span>

<span class="c1">## Pause vor LAN-Verbindungstest</span>
<span class="nv">pause</span><span class="o">=</span><span class="m">4</span>
<span class="nv">pingout</span><span class="o">=</span><span class="s2">""</span>

<span class="c1">## Pause in Sekunden für Konfigurationsparameter</span>
<span class="c1">## Vorgabewert 3</span>
<span class="nv">configdelay</span><span class="o">=</span><span class="m">2</span>

<span class="c1">## Optionen</span>
<span class="nv">A</span><span class="o">=</span><span class="m">1</span>
<span class="nv">B</span><span class="o">=</span><span class="m">0</span>
<span class="nv">D</span><span class="o">=</span><span class="m">0</span>
<span class="nv">H</span><span class="o">=</span><span class="m">0</span>
<span class="nv">P</span><span class="o">=</span><span class="m">0</span>

<span class="k">while</span> <span class="nb">getopts</span> <span class="s2">":dfmhDP"</span> OPTION <span class="p">;</span> <span class="k">do</span>
 <span class="k">case</span> <span class="nv">$OPTION</span> in
  d<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"konfiguriere LAN1 über DHCP"</span><span class="p">;</span> <span class="nv">A</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  f<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"konfiguriere LAN1 statisch"</span><span class="p">;</span> <span class="nv">A</span><span class="o">=</span><span class="m">2</span><span class="p">;;</span>
  m<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"MAC-Change LAN1 ein"</span><span class="p">;</span> <span class="nv">B</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  D<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"manueller DNS"</span><span class="p">;</span> <span class="nv">D</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  P<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Portumleitung für Proxy aktiviert"</span><span class="p">;</span> <span class="nv">P</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  h<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Hilfe angefordert"</span><span class="p">;</span> <span class="nv">H</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
 <span class="k">esac</span>
  <span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$H</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_AdHoc.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-restart<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-f<span class="o">]</span> <span class="o">[</span>-m<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-D<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh  startet mit Standardparametern, wie [-start][-d]"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -d startet mit Standardparametern, wie [-start]"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -f statische LAN-Konfiguration"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -f -m  statische LAN-Konfiguration, MAC-Änderung"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -f -m -c statischer LAN-Konfiguration, MAC-Änderung, MAC-Filter"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -start -f statische LAN-Konfiguration"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -restart -f statische LAN-Konfiguration"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -restart -d -D automatische LAN-Konfiguration über DHCP, dnsmasq ignoriert System-DNS"</span>
<span class="nb">echo</span> <span class="s2">"bei Option [-D] ignoriert dnsmasq die Einträge der /etc/resolv.conf"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -restart -f -m -c statische LAN-Konfiguration, MAC-Änderung, MAC-Filter"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -P Portumleitung für Proxyserver (Squid)"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -stop beendet das ICS Netzwerk"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> starte Konfiguration ...
 sleep <span class="m">2</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> stoppe alle Dienste, und Verbindungen ...

<span class="c1"># iptables Filter löschen</span>
/sbin/iptables -F
 /sbin/iptables -X
  /sbin/iptables -t nat -F

<span class="nv">defgw</span><span class="o">=</span><span class="s2">"`route -n | grep UG | awk {'print </span><span class="nv">$2</span><span class="s2">'}`"</span>
 /sbin/route del default gw <span class="nv">$defgw</span> <span class="nv">$laniface</span>
  <span class="nb">echo</span> <span class="s1">''</span> <span class="p">|</span> tee /etc/resolv.conf
 
 /sbin/ifconfig <span class="nv">$laniface2</span> down
  /sbin/ifconfig <span class="nv">$laniface</span> down
   /usr/bin/killall dnsmasq
    /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>
     service squid stop

<span class="c1">## Restart Network-Manager - beende ICS Netzwerk</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-stop"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"reaktiviere Network-Manager."</span>
   service network-manager start
    sleep <span class="nv">$configdelay</span>
     service network-manager restart
<span class="nb">echo</span> <span class="s2">"ICS Konfiguration beendet."</span>
 <span class="nb">exit</span>
  <span class="k">fi</span>
 <span class="k">fi</span>


<span class="c1">## MAC-Adresse LAN1 abgleichen</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$B</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">currentmac</span><span class="o">=</span><span class="s2">"`ifconfig </span><span class="nv">$laniface</span><span class="s2"> | grep Adresse | awk {'print </span><span class="nv">$6</span><span class="s2">'}`"</span>
  <span class="nb">echo</span> Schnittstelle <span class="nv">$laniface</span>, MAC-Adresse: <span class="nv">$currentmac</span> 
   <span class="nb">echo</span> Vorgabe: <span class="nv">$lmacaddress</span>

 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$currentmac</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lmacaddress</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   <span class="nb">echo</span> Übereinstimmende MAC-Adresse 
<span class="k">else</span>
   /sbin/ifconfig <span class="nv">$laniface</span> down
 /sbin/ip link <span class="nb">set</span> dev <span class="nv">$laniface</span> addr <span class="nv">$lmacaddress</span>

<span class="nv">currentmac</span><span class="o">=</span><span class="s2">"`ifconfig </span><span class="nv">$laniface</span><span class="s2"> | grep Adresse | awk {'print </span><span class="nv">$6</span><span class="s2">'}`"</span>
 <span class="nb">echo</span> versuche MAC-Adresse zu ändern ...
  <span class="nb">echo</span> Schnittstelle <span class="nv">$laniface</span>, MAC-Adresse: <span class="nv">$currentmac</span> 

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$currentmac</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lmacaddress</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> Änderung der MAC-Adresse erfolgreich! 
  <span class="k">else</span>
 <span class="nb">echo</span> Änderung der MAC-Adresse nicht erfolgreich!
<span class="nb">echo</span> fahre fort ...
<span class="k">fi</span>

 <span class="k">fi</span>
<span class="k">fi</span>

<span class="c1"># Konfiguration LAN</span>
<span class="nb">echo</span> <span class="s2">"Beende Network-Manager"</span>
 service network-manager stop
  <span class="nb">echo</span> <span class="s2">"Starte benötigte Dienste, und Verbindungen ..."</span>
   sleep <span class="nv">$configdelay</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$A</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
sleep <span class="nv">$configdelay</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"Starte automatische LAN-Verbindung über DHCP ..."</span>
   /sbin/dhclient <span class="nv">$laniface</span>

<span class="k">else</span>
sleep <span class="nv">$configdelay</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"Starte statische LAN-Konfiguration ..."</span>
   /sbin/ifconfig <span class="nv">$laniface</span> down
    /sbin/ifconfig <span class="nv">$laniface</span> <span class="nv">$laddress</span> broadcast <span class="nv">$lbroadcast</span> netmask <span class="nv">$lnetmask</span>
     sleep <span class="nv">$configdelay</span>

<span class="c1">## vorhandene Route ggf. löschen</span>
 <span class="nb">echo</span> <span class="s2">"Lösche Default-Gateway ..."</span>
  <span class="nv">defgw</span><span class="o">=</span><span class="s2">"`route -n | grep UG | awk {'print </span><span class="nv">$2</span><span class="s2">'}`"</span>
   /sbin/route del default gw <span class="nv">$defgw</span> <span class="nv">$laniface</span>

<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"Setze Gateway und Route ..."</span>
  /sbin/route add default gw <span class="nv">$lgateway</span> <span class="nv">$laniface</span>
   sleep <span class="nv">$configdelay</span>

<span class="c1">## DNS eintragen (nur bei statischer Konfiguration - Option [-f])</span>
<span class="nb">echo</span> setze DNS
<span class="nb">echo</span> <span class="s1">'# erzeugt durch instant_AdHoc.sh'</span> <span class="p">|</span> tee /etc/resolv.conf
 <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $1,$2'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
  <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $3,$4'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
   <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $5,$6'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf 
    <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $7,$8'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
     <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $9,$10'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
 sleep <span class="nv">$pause</span>
<span class="k">fi</span>

<span class="c1">## Verbindungstest LAN</span>
<span class="nb">echo</span> LAN Verbindungstest ...
 <span class="nv">pingout</span><span class="o">=</span><span class="s2">"`(ping -c1 </span><span class="nv">$lgateway</span><span class="s2"> | egrep -wo '100% packet loss')`"</span>

 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$pingout</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"100% packet loss"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> kann Gateway nicht pingen <span class="nv">$pingout</span> - Verbindung fehlgeschlagen!
   <span class="nb">echo</span> breche Vorgang ab!
    <span class="nb">echo</span> Kabelverbindung oder Konfiguration überprüfen!

     /sbin/ifconfig <span class="nv">$laniface</span> down

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$A</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"2"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> lösche Default-Gateway ...
  <span class="nv">defgw</span><span class="o">=</span><span class="s2">"`route -n | grep UG | awk {'print </span><span class="nv">$2</span><span class="s2">'}`"</span>
   /sbin/route del default gw <span class="nv">$defgw</span> <span class="nv">$laniface</span>
 <span class="k">fi</span>

<span class="nb">echo</span> Vorgabewerte:
 <span class="nb">echo</span> Schnittstelle: <span class="nv">$laniface</span> IP: <span class="nv">$laddress</span> Broadcast: <span class="nv">$lbroadcast</span> Netzmaske: <span class="nv">$lnetmask</span>
  <span class="nb">echo</span> IP-Adresse Gateway: <span class="nv">$lgateway</span>
 <span class="nb">exit</span>
<span class="k">fi</span>
 <span class="nb">echo</span> Verbindungstest erfolgreich!

<span class="c1"># LAN2-Schnittstelle statisch konfigurieren</span>
<span class="nb">echo</span> Konfiguriere WLAN, starte WLAN Ad-Hoc Modus ...
 /sbin/ifconfig <span class="nv">$laniface2</span> down
  sleep <span class="m">1</span>
    /sbin/ifconfig <span class="nv">$laniface2</span> <span class="nv">$address2</span> broadcast <span class="nv">$broadcast2</span> netmask <span class="nv">$netmask2</span>
     /sbin/ifconfig <span class="nv">$laniface2</span> up

<span class="nb">echo</span> starte IP-Forward, Masquerading und NAT

/sbin/iptables -A FORWARD -o <span class="nv">$laniface</span> -i <span class="nv">$laniface2</span> -s <span class="nv">$iptablemask</span> -m conntrack --ctstate NEW -j ACCEPT
 /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  /sbin/iptables -t nat -A POSTROUTING -o <span class="nv">$laniface</span> -j MASQUERADE 
   /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span> 

<span class="c1">## dnsmasq starten</span>
<span class="nb">echo</span> starte dnsmasq
 <span class="nb">echo</span> DHCP-Range dnsmasq - Startadresse: <span class="nv">$startaddr</span> Endadresse: <span class="nv">$endaddr</span>

/usr/bin/killall dnsmasq

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$S</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /usr/sbin/dnsmasq -i <span class="nv">$laniface2</span> -I <span class="nv">$laniface</span> -F <span class="nv">$startaddr</span>,<span class="nv">$endaddr</span>,<span class="nv">$leasetime</span>
  <span class="k">else</span>
   /usr/sbin/dnsmasq -i <span class="nv">$wlaniface</span> -I <span class="nv">$laniface</span> -F <span class="nv">$startaddr</span>,<span class="nv">$endaddr</span>,<span class="nv">$leasetime</span> -R -S <span class="nv">$mandns</span>
     <span class="nb">echo</span> DNS Systemeinstellung wird ignoriert, dnsmasq verwendet DNS: <span class="nv">$mandns</span>
  <span class="k">fi</span>

<span class="c1">## Portumleitung für Squid Proxyserver</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$P</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/iptables -t nat -A PREROUTING -i <span class="nv">$laniface2</span> -p tcp --dport <span class="m">80</span> -j REDIRECT --to-port <span class="m">3128</span>
     <span class="nb">echo</span> <span class="s2">"Port 80 </span><span class="nv">$laniface2</span><span class="s2"> auf Port </span><span class="nv">$proxyport</span><span class="s2"> umgeleitet (Squid Proxyserver)"</span>
   <span class="nb">echo</span> starte Squid Proxyserver ...
 sleep <span class="m">4</span>
  service squid start -n
<span class="k">fi</span>

<span class="c1">## Ausgabe der Konfiguration. Einstellungen der Schnittstellen,</span>
<span class="c1">## Routingtabelle und DNS prüfen</span>

<span class="nb">echo</span> <span class="s2">"prüfe Konfiguration ..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$A</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"2"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> vorgegebene DNS: <span class="nv">$dns</span>
  <span class="k">fi</span> 
 
<span class="nb">echo</span> <span class="s2">"Systemkonfiguration: /etc/resolv.conf"</span>
  /bin/cat /etc/resolv.conf
   /sbin/route -n
    <span class="nb">echo</span> 
   <span class="nb">echo</span> Konfiguration LAN:
    /sbin/ifconfig <span class="nv">$laniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span> Konfiguration WLAN:
    /sbin/ifconfig <span class="nv">$laniface2</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>

<span class="nb">echo</span> <span class="s2">"Konfiguration beendet"</span>

<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</td></tr></table></div><p>
Parameter der Schnittstellen, IP-Adressbereiche usw. können im Deklarationsblock des Skripts angepasst werden.</p><p>Im Terminal <sup><a href="#source-2">[2]</a></sup> als <code class="notranslate">root</code><sup><a href="#source-3">[3]</a></sup> kann das Skript nun mit verschiedenen Parametern aufgerufen werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ./instant_ICS.sh [-start|-restart|-stop]
sudo ./instant_ICS.sh                  # startet mit automatischer Konfiguration (wie mit [-start])
sudo ./instant_ICS.sh -start           # startet alle Verbindungen und Dienste mit automatischer Konfiguration
sudo ./instant_ICS.sh -restart         # erneuert alle Verbindungen und Dienste mit automatischer Konfiguration
sudo ./instant_ICS.sh -stop            # beendet alle Verbindungen und Dienste </pre></div></div><p>
Weitere Startoptionen sind im Skript beschrieben.</p><p><img alt="./Netzwerk_Minirouter.png" class="image-right" src="./_/436e56fc67674d16e4d627c08fa0348250287004.png"/></p></div></div><div class="section_3"><h4 id="DSL-Modem-teilen">DSL-Modem teilen<a class="headerlink" href="#DSL-Modem-teilen">¶</a></h4><p>
Folgende Konfiguration stellt bereits die Funktionalität eines einfachen Routers bereit. Die Internetverbindung wird über <code class="notranslate">eth0</code> und einem angeschlossenen Modem mittels pppoeconf aufgebaut, die Verbindung über eine zweite Ethernet-Schnitstelle, hier (<code class="notranslate">eth1</code>) und WLAN-Netzwerk Ad-Hoc (<code class="notranslate">wlan0</code>), geteilt.</p><p>Sofern die eingesetzte WLAN-Hardware die Einrichtung eines vollwertigen Acess-Points mit sicherer WPA oder sogar WPA2-Verschlüsselung erlaubt, sollte diese Methode bevorzugt werden. Informationen dazu in <a class="internal" href="./wlan_router.html">WLAN Router</a>.</p><p>Hier wird <a class="internal" href="./dnsmasq.html">Dnsmasq</a> als Vollinstallation benötigt (s.o.).</p><p>Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt an die zweite Ethernet-Schnittstelle angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><p>Konfiguration der <strong>/etc/network/interfaces</strong>:</p><pre class="notranslate">auto lo
iface lo inet loopback

# an eth0 ist der Modem angeschlossen
auto eth0
iface eth0 inet manual

# pppoe Verbindung
auto dsl-provider
iface dsl-provider inet ppp
pre-up /sbin/ifconfig eth0 up   # line maintained by pppoeconf
provider dsl-provider

# lokales Netzwerk LAN-Anschluß 2
auto eth1
iface eth1 inet static
address 192.168.3.1
netmask 255.255.255.0
broadcast 192.168.3.255

# lokales WLAN-Netzwerk 
auto wlan0
iface wlan0 inet static
address 192.168.3.2
# Bei Verbindungsproblemen alternativ ein anderes Subnetz und Broadcast wählen
# address 192.168.4.1
netmask 255.255.255.0
broadcast 192.168.3.255
# broadcast 192.168.4.255

# Ad-Hoc Netz erstellen. ESSID, Schlüssel und Funkkanal anpassen
up /sbin/iwconfig wlan0 mode Ad-Hoc essid Deine_ESSID key 12345678901234567890123456 freq 2412000000

## vorhandene Regeln und Ketten zuerst löschen
up /sbin/iptables -F
 up /sbin/iptables -X
  up /sbin/iptables -t nat -F

## Maskieren der LAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren
## Die Eingangs-Schnittstelle kann hier entfallen, da mehre Teilnetze auf das Internet zugreifen dürfen.
## In diesem Fall muss hier 192.168.0.0/16 verwendet werden.

up iptables -A FORWARD -o ppp0 -s 192.168.0.0/16 -m conntrack --ctstate NEW -j ACCEPT
 up /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  up /sbin/iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE 
   up /sbin/sysctl -w net.ipv4.ip_forward=1 

## dnsmasq neu starten
up /etc/init.d/dnsmasq restart</pre><p>Basiskonfiguration der <strong>/etc/dnsmasq.conf</strong>:
</p><pre class="notranslate"># DHCP-Server aktiv für Interface
interface=eth1
interface=wlan0

# DHCP-Server nicht aktiv für Interface
no-dhcp-interface=eth0

# IP-Adressbereich / Lease-Time
dhcp-range=interface:eth1,192.168.3.10,192.168.3.40,infinite    # Verteile an eth1 Adressen 192.168.3.10..192.168.3.40
dhcp-range=interface:wlan0,192.168.3.10,192.168.3.40,infinite   # Verteile an wlan0 Adressen 192.168.3.10..192.168.3.40

# Bei Verbindungsproblemen (IP-Adresse wird nicht zugewiesen) alternativ ein anderes Subnetz für WLAN wählen
# dhcp-range=interface:wlan0,192.168.4.10,192.168.4.40,infinite   # Verteile an wlan0 Adressen 192.168.4.10..192.168.4.40</pre></div><div class="section_3"><h4 id="MAC-Adressfilter-einrichten">MAC-Adressfilter einrichten<a class="headerlink" href="#MAC-Adressfilter-einrichten">¶</a></h4><p>
Eine WEP-Verschlüsselung ist unsicher und mit den entsprechenden Werkzeugen schnell entschlüsselt. Um etwas zusätzliche Sicherheit zu erlangen, kann der IP-Adressbereich des DHCP-Servers (dnsmasq) in der Konfigurationsdatei auf die tatsächliche Anzahl der angeschlossenen Rechner begrenzt werden. Zusätzlich können über <a class="internal" href="./iptables2.html">iptables</a> entsprechende Filterregeln erstellt werden, so dass nur bekannten Rechnern eine Datenübertragung bzw. der Internet-Zugriff gestattet wird.</p><p>Allerdings kann diese Maßnahme mit dem entsprechenden Hintergrundwissen ebenfalls relativ einfach überwunden werden, da MAC-Adressen unverschlüsselt im Netzwerk übertragen werden. Sensible persönliche Daten sollten in einem WEP-Verschlüsselten Netzwerk deshalb nicht ohne Dateiverschlüsselung oder Kennwortschutz freigegeben werden und zugänglich sein.</p><p>An die bestehende Konfiguration in der Datei <a class="internal" href="./interfaces.html">/etc/network/interfaces</a> ist folgendes anzuhängen. Die gezeigten MAC-Geräteadressen sind natürlich nur Beispiele. Für jeden Rechner im Netzwerk ist eine Filterregel mit der MAC-Adresse der verbauten LAN- bzw. WLAN-Karte einzufügen. Hier wurden Filterregeln für LAN und WLAN berücksichtigt. Die Bezeichnung der tatsächlich verwendeten Schnittstellen ist zu beachten.</p><pre class="notranslate"># MAC-Adressfilter aktivieren / Datenübertragung für eingetragene WLAN-Geräte zulassen
 up /sbin/iptables -A INPUT -i wlan0 -m mac --mac-source 00:14:f6:2d:0a:b1 -j ACCEPT
  up /sbin/iptables -A INPUT -i wlan0 -m mac --mac-source 1c:2a:b4:30:4a:23 -j ACCEPT

# MAC-Adressfilter aktivieren / Datenübertragung für eingetragene LAN-Geräte zulassen
 up /sbin/iptables -A INPUT -i eth1 -m mac --mac-source 00:24:12:0e:9f:4a -j ACCEPT
  up /sbin/iptables -A INPUT -i eth1 -m mac --mac-source 00:26:35:10:2a:1b -j ACCEPT

# alle anderen Datenpakete die über die freigegebene WLAN-Schnittstelle kommen verwerfen
 up /sbin/iptables -A INPUT -i wlan0 -j DROP

# alle anderen Datenpakete die über die freigegebene LAN-Schnittstelle kommen verwerfen
 up /sbin/iptables -A INPUT -i eth1 -j DROP</pre><p>Das Netzwerk abschließend wie beschrieben neu starten und die Filterregeln überprüfen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo iptables -t filter -n -L -v </pre></div></div><p>Die Ausgabe für die Kette "<em>INPUT</em>" sollte passend zum Beispiel folgendermaßen aussehen (die Anzahl der übertragenen Datenpakete und Bytes ändert sich natürlich):</p><pre class="notranslate">Chain INPUT (policy ACCEPT 617 packets, 229K bytes)
 pkts bytes target     prot opt in     out     source               destination         
   65  8826 ACCEPT     all  --  wlan0  *       0.0.0.0/0            0.0.0.0/0           MAC 00:14:f6:2d:0a:b1 
   13  1564 ACCEPT     all  --  wlan0  *       0.0.0.0/0            0.0.0.0/0           MAC 1c:2a:b4:30:4a:23 
    0     0 ACCEPT     all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           MAC 00:24:12:0E:9F:4A 
    0     0 ACCEPT     all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           MAC 00:26:35:10:2A:1B 
    6  1158 DROP       all  --  wlan0  *       0.0.0.0/0            0.0.0.0/0           
    0     0 DROP       all  --  eth1   *       0.0.0.0/0            0.0.0.0/0 
...</pre><p>Für eine erweiterte Konfiguration und die Einrichtung spezieller Filtertabellen bietet sich <a class="internal" href="./skripte/nathelper.html">nathelper</a>, <a class="internal" href="./ufw.html">ufw</a> oder auch <a class="internal" href="./skripte/anfd.html">anfd</a> an. Entsprechende Befehle können ebenfalls in die Datei interfaces integriert werden. Ebenso lassen sich diverse <a class="internal" href="./serverdienste.html">Serverdienste</a> einrichten.</p><p><img alt="./Netzwerk01.png" class="image-right" src="./_/0a21d8ccd0672aa58e804e80b8cba07cec587e39.png"/></p></div></div><div class="section_2"><h3 id="Statische-Konfiguration">Statische Konfiguration<a class="headerlink" href="#Statische-Konfiguration">¶</a></h3><p>
Die WLAN-Verbindung des Host-Rechners die z.B. über eine manuelle Konfiguration (<a class="internal" href="./interfaces.html">interfaces</a>) oder über <a class="internal" href="./wicd.html">Wicd</a> aufgebaut wird, soll <span class="underline">ohne</span> zusätzlichen DHCP-Server/DNS-Cache (<a class="internal" href="./dnsmasq.html">Dnsmasq</a>) über LAN <code class="notranslate">eth0</code> einem oder auch mehreren anderen Rechnern die Internetverbindug zur Verfügung stellen und auch einen lokalen Server oder ein <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Network_Attached_Storage">NAS</a> anbinden.</p><p>Über einen <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> können so auch mehrere Clients angeschlossen und untereinander vernetzt werden. Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><div class="section_3"><h4 id="WLAN-auf-LAN-4">WLAN auf LAN<a class="headerlink" href="#WLAN-auf-LAN-4">¶</a></h4><p>
Beispiel mit manueller Konfiguration des WLAN und LAN
Konfiguration der <strong>/etc/network/interfaces</strong> des Host-Rechners:</p><pre class="notranslate">auto lo
iface lo inet loopback

auto wlan0 
iface wlan0 inet dhcp
     wpa-driver wext
     wpa-ssid DeineSSID
     wpa-ap-scan 1
     wpa-proto RSN
     wpa-pairwise CCMP
     wpa-group CCMP
     wpa-key-mgmt WPA-PSK
     wpa-psk "Dein_WPA-Kennwort_in Klartext"

auto eth0
iface eth0 inet static
address 192.168.3.1
netmask 255.255.255.0
broadcast 192.168.3.255

## vorhandene Regeln und Ketten zuerst löschen
up /sbin/iptables -F
 up /sbin/iptables -X
  up /sbin/iptables -t nat -F

## Maskieren der LAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren
up /sbin/iptables -A FORWARD -o wlan0 -i eth0 -s 192.168.0.0/24 -m conntrack --ctstate NEW -j ACCEPT
 up /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  up /sbin/iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE 
   up /sbin/sysctl -w net.ipv4.ip_forward=1 </pre><p><img alt="./Netzwerk_statisch_Modem.png" class="image-right" src="./_/8da7a18079e0af716ea33a88256172129af389ba.png"/></p></div><div class="section_3"><h4 id="DSL-Modem-teilen-2">DSL-Modem teilen<a class="headerlink" href="#DSL-Modem-teilen-2">¶</a></h4><p>
Ein Router ist nicht vorhanden, alle Rechner verfügen nur über eine einzige Ethernet-Schnittstelle und sind über einen <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> miteinander verbunden. Der DSL-Modem ist ebenfalls am Switch angeschlossen.</p><p>Einer der Rechner (Host) übernimmt die Einwahl (über pppoeconf) und leitet die Verbindung über ein virtuelles Interface (<code class="notranslate">eth0:1</code>) in das lokale Subnetz weiter. Die Konfiguration erfolgt ausschließlich über die <strong>/etc/network/interfaces</strong>.</p><p>Zusätzlich empfiehlt es sich hier über einen transparenten Proxyserver wie z.B. <a class="internal" href="./squid.html">Squid</a> auf dem Host-Rechner einen Daten-Cache einzurichten. Anleitung dazu weiter unten in diesem Artikel.</p><p>Der vom Provider zugewiesenen DNS-Server des Host-Rechners kann nach Verbindungsaufbau abgefragt und ebenfalls für die Konfiguration der Clients verwendet werden:</p><div class="bash"><div class="contents"><pre class="notranslate">cat /etc/resolv.conf </pre></div></div><p>Konfiguration der <strong>/etc/network/interfaces</strong>:</p><pre class="notranslate">auto lo
iface lo inet loopback

# an eth0 ist der Modem angeschlossen / LAN-Anschluß 1-0
auto eth0
iface eth0 inet manual

# pppoe Verbindung
auto dsl-provider
iface dsl-provider inet ppp
pre-up /sbin/ifconfig eth0 up   # line maintained by pppoeconf
provider dsl-provider

# lokales Netzwerk LAN-Anschluß 1-1
auto eth0:1
iface eth0:1 inet static
address 192.168.3.1
netmask 255.255.255.0
broadcast 192.168.3.255

## vorhandene Regeln und Ketten zuerst löschen
up /sbin/iptables -F
 up /sbin/iptables -X
  up /sbin/iptables -t nat -F

## Maskieren der LAN-Schnittstelle, Port-Forwarding &amp; Nat aktivieren
up /sbin/iptables -A FORWARD -o ppp0 -s 192.168.0.0/16 -m conntrack --ctstate NEW -j ACCEPT
 up /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  up /sbin/iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE 
   up /sbin/sysctl -w net.ipv4.ip_forward=1 

# Vorbereitung für transparenten Proxyserver Squid
# up service squid stop
#  post-up /sbin/iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3128
#   post-up service squid start -n</pre><p><img alt="./NM_statisch.png" class="image-right" src="./_/fdb8823781c8f444b9c56c041fc70301dad273eb.png"/>
<img alt="./WICD_statisch.png" class="image-right" src="./_/35ca72c915367b90bae84503ed83911e17dee204.png"/></p></div><div class="section_3"><h4 id="Konfiguration-der-Clients">Konfiguration der Clients<a class="headerlink" href="#Konfiguration-der-Clients">¶</a></h4><p>
Die Konfiguration muss ebenfalls statisch erfolgen. Das kann manuell über die Datei <a class="internal" href="./interfaces.html">/etc/network/interfaces</a>, mit dem <a class="internal" href="./network-manager.html">Network-Manager</a> oder auch <a class="internal" href="./wicd.html">Wicd</a> durchgeführt werden. Statische IP-Adressen im lokalen Netz dürfen nicht doppelt vergeben werden und müssen sich im selben Adressbereich befinden wie die des Host-Rechners!</p><div class="section_4"><h5 id="Mit-Netzwerkmanager">Mit Netzwerkmanager<a class="headerlink" href="#Mit-Netzwerkmanager">¶</a></h5><p>
Über einen Rechtsklick <img alt="rechte Maustaste" class="image-default" src="./_/aa516ca8be74ff7de9b706b8ffc7a88e87e17fb5.png"/> auf das Network-Manager Symbol und <em>"Verbindungen bearbeiten"</em> kann ein neuer Eintrag für die statische Konfiguration angelegt werden. Im Hauptfenster von Wicd über <em>"Hinzufügen"</em>. Der verwendete DNS, hier im Beispiel die IP-Adresse des vorgeschalteten Routers, ist zusätzlich einzutragen.</p></div><div class="section_4"><h5 id="ber-die-interfaces">Über die interfaces<a class="headerlink" href="#ber-die-interfaces">¶</a></h5><p>
Konfiguration der <strong>/etc/network/interfaces</strong> (Beispiel):</p><pre class="notranslate">auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 192.168.3.10
netmask 255.255.255.0
broadcast 192.168.3.255
gateway 192.168.3.1            # IP-Adresse LAN-Schnittstelle des Host

## optional benötigte DNS eintragen
## drei Einträge sind möglich
# post-up /bin/echo 'nameserver 192.168.178.1' | tee /etc/resolv.conf
#  post-up /bin/echo 'nameserver 213.73.91.35' | tee -a /etc/resolv.conf
#   post-up /bin/echo 'nameserver 87.118.100.175' | tee -a /etc/resolv.conf

## optional Domain und Sucheintrag 
# post-up /bin/echo 'domain fritz.box' | tee -a /etc/resolv.conf
#  post-up /bin/echo 'search fritz.box' | tee -a /etc/resolv.conf</pre><p><img alt="./Netzwerk-Bruecke.png" class="image-right" src="./_/4c1793a116a1932148481df6ba76734155c7f0cc.png"/></p></div></div></div><div class="section_2"><h3 id="Netzwerkbruecke">Netzwerkbrücke<a class="headerlink" href="#Netzwerkbruecke">¶</a></h3><p>
Ein Rechner (Host) stellt über einen DSL-Router und Schnittstelle (<code class="notranslate">eth0</code>) die Internetverbindung her. Über eine zweite Schnittstelle (<code class="notranslate">eth1</code>) wird die Verbindung durchgereicht. Beide Anschlüsse werden über eine "Netzwerkbrücke" miteinander verbunden. Die Verbindung ist <em>"transparent"</em>, dass heißt alle Rechner im Netzwerk verhalten sich so, als wären sie direkt am Router angeschlossen. Dieser verteilt IP-Adressen über DHCP. Eine statische Konfiguration ist ebenfalls möglich. Siehe dazu auch <a class="internal" href="./netzwerkbrücke.html">Netzwerkbrücke</a>.</p><p>Über einen <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> können so auch mehrere Clients angeschlossen und untereinander vernetzt werden. Soll nur ein einziger Rechner ohne <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Switch_(Computertechnik)">Netzwerk-Switch</a> direkt angeschlossen werden, muss möglicherweise ein sog. <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Crosskabel">Crosskabel</a> für die Verbindung verwendet werden. Weitere Hinweise dazu in <a class="internal" href="./pc-direktverbindung_per_netzwerk-kabel.html">PC-Direktverbindung per Netzwerk-Kabel</a>.</p><p>Auf dem Host-Rechner wird dazu folgende Software benötigt:</p><ul><li><p><strong>bridge-utils </strong> (Software um eine Netzwerkbrücke herzustellen)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install bridge-utils  </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install bridge-utils  </pre></div></div><p>
</p></div></div><div class="section_3"><h4 id="LAN-auf-LAN-3">LAN auf LAN<a class="headerlink" href="#LAN-auf-LAN-3">¶</a></h4><p>
Eine permanente Konfiguration des Host-Rechners erfolgt manuell über die <a class="internal" href="./interfaces.html">/etc/network/interfaces</a>. 
</p><pre class="notranslate">auto lo
iface lo inet loopback

auto br0
iface br0 inet dhcp
bridge_ports eth0 eth1
bridge_fd 5
bridge_stp no </pre><p>Die Clients können wie gewohnt über einen Netzwerkmanager oder auch manuell konfiguriert werden.</p><div class="section_4"><h5 id="Steuerung-ueber-Skript">Steuerung über Skript<a class="headerlink" href="#Steuerung-ueber-Skript">¶</a></h5><p>
Über ein kleines Skript kann eine bei Bedarf benötigte Netzwerkbrücke erstellt und auch wieder entfernt werden. Die Datei <strong>/etc/network/interfaces</strong> muss dazu nicht verändert werden. Ebenso kann der Network-Manager parallel verwendet werden und wird durch das Skript automatisch gestoppt und auch wieder gestartet.</p><p>Mit einem Editor <sup><a href="#source-1">[1]</a></sup> oder über Terminal <sup><a href="#source-2">[2]</a></sup> wird das Skript <strong>lan_bridge.sh</strong> angelegt und ausführbar gemacht.</p><div class="bash"><div class="contents"><pre class="notranslate">touch lan_bridge.sh
chmod +x lan_bridge.sh </pre></div></div><p>Folgenden Inhalt einfügen und abspeichern:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant LAN-Bridge</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2011</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Skript</span>
<span class="c1">##</span>

<span class="c1">## Konfiguration</span>
<span class="nv">bridge</span><span class="o">=</span>br0
<span class="nv">forward_delay</span><span class="o">=</span><span class="m">5</span>
<span class="nv">stp</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## Schnittstellen</span>
<span class="nv">iface0</span><span class="o">=</span>eth0
<span class="nv">iface1</span><span class="o">=</span>eth1

<span class="c1">## Verbindungen beenden</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"off"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/ifconfig <span class="nv">$bridge</span> down
  /sbin/ifconfig <span class="nv">$iface1</span> down

<span class="c1">## Brücke löschen</span>
<span class="nb">echo</span> <span class="s2">"lösche Brücke und Konfiguration, starte den Network-Manager ..."</span>

/usr/sbin/brctl delif <span class="nv">$bridge</span> <span class="nv">$iface0</span>
 /usr/sbin/brctl delif <span class="nv">$bridge</span> <span class="nv">$iface1</span>
  /usr/sbin/brctl delbr <span class="nv">$bridge</span>
   service network-manager start

<span class="nb">echo</span> <span class="s2">"LAN-Brücke beendet"</span>
 <span class="k">fi</span>

<span class="c1">## Bridge starten</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"on"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"stoppe  Network-Manager, starte LAN-Brücke"</span> <span class="nv">$iface0</span> <span class="s2">"&lt;=&gt;"</span> <span class="nv">$iface1</span>
sleep <span class="m">2</span>
 service network-manager stop
  sleep <span class="m">2</span>

<span class="c1">## Brücke erzeugen</span>
 /usr/sbin/brctl addbr <span class="nv">$bridge</span>
  /usr/sbin/brctl addif <span class="nv">$bridge</span> <span class="nv">$iface0</span>
   /usr/sbin/brctl addif <span class="nv">$bridge</span> <span class="nv">$iface1</span>
    /usr/sbin/brctl stp <span class="nv">$bridge</span> <span class="nv">$stp</span>
     /usr/sbin/brctl setfd <span class="nv">$bridge</span> <span class="nv">$forward_delay</span>

<span class="c1">## Verbindungen starten</span>
/sbin/ifconfig <span class="nv">$bridge</span> up
 /sbin/ifconfig <span class="nv">$iface1</span> up
  /sbin/dhclient <span class="nv">$bridge</span>
<span class="k">fi</span> 
 <span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</td></tr></table></div><p>Skript starten und beenden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo lan_bridge.sh on         # startet die LAN-Brücke
sudo lan_bridge.sh off        # beendet die LAN-Brücke </pre></div></div></div></div><div class="section_3"><h4 id="WLAN-auf-LAN-5">WLAN auf LAN<a class="headerlink" href="#WLAN-auf-LAN-5">¶</a></h4><p>
Eine transparente Brücke zwischen WLAN und LAN ist nicht so einfach herzustellen, außerdem muss die WLAN-Hard- und Firmware dies auch unterstützen (MAC-Forwarding). Diese Möglichkeit wurde im Kernel abgeschaltet. Eine Brücke zwischen LAN und WLAN ist nur möglich, wenn sich die WLAN-Karte im Master-Modus befindet, also über <strong>hostapd</strong> so wie in <a class="internal" href="./wlan_router.html">WLAN Router</a> beschrieben.</p><p><img alt="./Netzwerk02_Instant.png" class="image-right" src="./_/b0790a22c4879858d60baf710bc02cf1bb92cc37.png"/></p></div></div><div class="section_2"><h3 id="Instant-Ad-Hoc">Instant Ad-Hoc<a class="headerlink" href="#Instant-Ad-Hoc">¶</a></h3><p>
Über ein Skript kann ein Ad-Hoc-Netz erzeugt und die vorhandene Internetverbindung über LAN durchgereicht werden. Die Datei <strong>/etc/network/interfaces</strong> muss dazu <span class="underline">nicht</span> verändert werden. So kann "zwischendurch" schnell mal ein Ad-Hoc-Netzwerk erstellt werden, sollte dies mit dem Network-Manager, wie am Anfang des Artikels beschrieben, nicht zuverlässig funktionieren oder wenn ein anderer Manager wie z.B. <a class="internal" href="./wicd.html">Wicd</a> verwendet wird. Das Skript kann aber auch problemlos mit dem Network-Manager verwendet werden. Der Manager wird dazu automatisch deaktiviert und auch wieder neu gestartet.</p><p>Das Skript verwendet <a class="internal" href="./dnsmasq.html">dnsmasq-base</a> zur Konfiguration. Manuelle Änderungen im Skript wie die verwendeten Schnittstellen und IP-Adressen werden für dnsmasq automatisch übernommen bzw. gemäß der getroffenen Einstellungen generiert.</p><p>Mit einem Editor <sup><a href="#source-1">[1]</a></sup> oder über Terminal <sup><a href="#source-2">[2]</a></sup> wird das Skript <strong>instant_AdHoc.sh</strong> angelegt und ausführbar gemacht.</p><div class="bash"><div class="contents"><pre class="notranslate">touch instant_AdHoc.sh
chmod +x instant_AdHoc.sh </pre></div></div><p>Anschließend folgenden Inhalt mit einem Editor <sup><a href="#source-2">[2]</a></sup> einfügen:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant Ad-Hoc Modus</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2011</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 2.5.7 vom 6.November 2011</span>
<span class="c1"># Prüfung der Konfiguration verbessert</span>
<span class="c1"># voreingestellte freie DNS geändert</span>
<span class="c1"># Startoptionen Fehler beseitigt</span>
<span class="c1"># Restart des Network-Managers erst bei -stop</span>
<span class="c1">#</span>
<span class="c1">## Version 2.5.6 vom 4.November 2011</span>
<span class="c1"># -x Ad-Hoc Netzwerk ohne Verschlüsselung</span>
<span class="c1"># -c aktiviert MAC-Filter und legt eine Konfigurationsdatei an / vereinfachte Zugangskontrolle bekannter Clients</span>
<span class="c1"># -C verwendet die über -c angelegte Konfigurationsdatei für MAC-Filterkonfiguration</span>
<span class="c1"># Delay für einzelne Konfigurationsabschitte einstellbar</span>
<span class="c1">##</span>
<span class="c1">## Version 2.5.4 vom 1.November 2011</span>
<span class="c1"># div. Bugfixes/Syntax</span>
<span class="c1"># Verbindungstest LAN über Startoption -v abschaltbar</span>
<span class="c1">##</span>
<span class="c1">## freie Variablen</span>
<span class="c1">##</span>

<span class="c1">## LAN statisch (Beispiel) (Startoption [-f])</span>
<span class="nv">laniface</span><span class="o">=</span>eth0
<span class="nv">laddress</span><span class="o">=</span><span class="m">192</span>.168.178.5
<span class="nv">lbroadcast</span><span class="o">=</span><span class="m">192</span>.168.178.255
<span class="nv">lnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">lgateway</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">### DNS (drei DNS Einträge, 1x Domain und 1x Search sind möglich) - nur mit Startoption [-f]</span>
<span class="c1"># Beispiel:</span>
<span class="c1"># dns="nameserver 192.168.178.1 nameserver 213.73.91.35 nameserver 87.118.100.175 domain fritz.box search fritz.box"</span>
<span class="nv">dns</span><span class="o">=</span><span class="s2">"nameserver 8.8.4.4 nameserver 8.8.8.8 nameserver 213.73.91.35"</span> 

<span class="c1">## dnsmasq DNS (manuell) (Startoption [-D])</span>
<span class="c1">## dnsmasq ignoriert dann /etc/resolv.conf</span>
<span class="nv">mandns</span><span class="o">=</span><span class="m">8</span>.8.4.4

<span class="c1">## MAC-Adresse (optional) (Startoption [-m])</span>
<span class="nv">lmacaddress</span><span class="o">=</span><span class="m">00</span>:12:79:c0:49:ae

<span class="c1">## WLAN statisch (Beispiel)</span>
<span class="c1">## Einstellungen der WLAN-Schnittstelle </span>
<span class="nv">wlaniface</span><span class="o">=</span>wlan0
<span class="nv">waddress</span><span class="o">=</span><span class="m">192</span>.168.3.1
<span class="nv">wbroadcast</span><span class="o">=</span><span class="m">192</span>.186.3.255
<span class="nv">wnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">iptablemask</span><span class="o">=</span><span class="m">192</span>.168.0.0/24

<span class="c1">## WLAN Konfiguration</span>
<span class="c1">## Einstellungen des Ad-Hoc Netzes</span>
<span class="c1">##</span>
<span class="c1"># Verschlüsselung (hex) (128bit/26 Zeichen - 64bit/10 Zeichen)</span>
<span class="nv">wkey</span><span class="o">=</span>12345678901234567890ABCdef
<span class="c1">## SSID</span>
<span class="nv">wname</span><span class="o">=</span><span class="s2">"Instant_Ad-Hoc"</span>
<span class="c1">## Funkkanal</span>
<span class="nv">wchannel</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## dnsmasq-base Konfiguration</span>
<span class="c1"># DHCP-Adresspool umfasst x-Adressen</span>
<span class="nv">ipaddresses</span><span class="o">=</span><span class="m">10</span>

<span class="c1"># Basisadresse DHCP-Adresspool (WLAN-IP + X)</span>
<span class="nv">wlanbaseip</span><span class="o">=</span><span class="m">10</span>

<span class="c1"># Lease-Time</span>
<span class="nv">leasetime</span><span class="o">=</span>infinite

<span class="c1">## Proxy Server auf Port x</span>
<span class="nv">proxyport</span><span class="o">=</span><span class="m">3128</span>

<span class="c1">## Pause in Sekunden für Konfigurationsparameter</span>
<span class="c1">## Vorgabewert 3</span>
<span class="nv">configdelay</span><span class="o">=</span><span class="m">2</span>

<span class="c1">## Pause in Sekunden vor LAN-Verbindungstest</span>
<span class="c1">## Vorgabewert 4</span>
<span class="nv">pause</span><span class="o">=</span><span class="m">4</span>

<span class="c1">## Konfigurationsdatei bekannte Geräte für MAC-Filter</span>
<span class="nv">configfile</span><span class="o">=</span><span class="s2">"instant_AdHoc_MAC.conf"</span>

<span class="c1">#### Ende freie Variablen</span>
<span class="c1">##</span>
<span class="nv">pingout</span><span class="o">=</span><span class="s2">""</span>

<span class="c1">## Prüfung der Konfiguration</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-stop"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

<span class="c1">##  prüfe Basiskonfiguration Schnittstellen </span>
<span class="nv">check_wlaniface</span><span class="o">=</span><span class="s2">"`ifconfig </span><span class="nv">$wlaniface</span><span class="s2"> | grep Link | awk {'print </span><span class="nv">$1</span><span class="s2">'}`"</span>
 <span class="nv">check_laniface</span><span class="o">=</span><span class="s2">"`ifconfig </span><span class="nv">$laniface</span><span class="s2"> | grep Link | awk {'print </span><span class="nv">$1</span><span class="s2">'}`"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check_wlaniface</span><span class="s2">"</span> <span class="o">=</span> <span class="nv">$wlaniface</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"WLAN-Interface"</span> <span class="nv">$wlaniface</span> <span class="s2">"gefunden. Setze Konfiguration fort."</span>

<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"WLAN-Interface"</span> <span class="nv">$wlaniface</span> <span class="s2">"nicht gefunden! Breche Konfiguration ab."</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check_laniface</span><span class="s2">"</span> <span class="o">=</span> <span class="nv">$laniface</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"LAN-Interface"</span> <span class="nv">$laniface</span> <span class="s2">"gefunden. Setze Konfiguration fort."</span>

<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"LAN-Interface"</span> <span class="nv">$laniface</span> <span class="s2">"nicht gefunden! Breche Konfiguration ab."</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1">## Plausibilitätsprüfung WEP-Schlüssel</span>
<span class="nv">keycheck</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$wkey</span><span class="s2"> | egrep -o [A-Fa-f0-9]`"</span>
 <span class="nv">keycheck</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$keycheck</span><span class="s2"> | tr -d "</span> <span class="s2">"`"</span>
  <span class="nv">keylenght</span><span class="o">=</span><span class="s2">"`expr length </span><span class="nv">$keycheck</span><span class="s2"> | egrep -wo '10|26'`"</span>
   <span class="nv">keylenght</span><span class="o">=</span>$<span class="o">[</span>keylenght +1<span class="o">]</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$keycheck</span> !<span class="o">=</span> <span class="nv">$wkey</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"Unzulässige Zeichen im WEP-Schlüssel. [a-f] [A-F] [0-9] (hex-Code) sind erlaubt"</span>
  <span class="nb">exit</span>
 <span class="k">elif</span> <span class="o">[</span> <span class="nv">$keylenght</span> <span class="o">=</span> <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">"Länge des gewählten WEP-Schlüssels fehlerhaft, 10 Zeichen (64bit) oder 26 Zeichen (128bit) sind erlaubt"</span>
   <span class="nb">exit</span>
<span class="k">fi</span>
 
 <span class="nb">echo</span> <span class="s2">"Plausibilitätsprüfung des WEP-Schlüssels abgeschlossen. Setze Konfiguration fort."</span>
<span class="k">fi</span>

<span class="c1">## Konfiguration der Startoptionen</span>
<span class="c1">## benötigte Optionen können an dieser Stelle auch fest vorgegeben werden</span>

<span class="nv">A</span><span class="o">=</span><span class="m">1</span>
<span class="nv">B</span><span class="o">=</span><span class="m">0</span>
<span class="nv">C</span><span class="o">=</span><span class="m">0</span>
<span class="nv">D</span><span class="o">=</span><span class="m">0</span>
<span class="nv">E</span><span class="o">=</span><span class="m">0</span>
<span class="nv">F</span><span class="o">=</span><span class="m">0</span>
<span class="nv">H</span><span class="o">=</span><span class="m">0</span>
<span class="nv">P</span><span class="o">=</span><span class="m">0</span>
<span class="nv">V</span><span class="o">=</span><span class="m">0</span>
<span class="nv">X</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## hier keine Änderungen vornehmen!</span>

<span class="k">while</span> <span class="nb">getopts</span> <span class="s2">":dfmcCDPhvx"</span> OPTION <span class="p">;</span> <span class="k">do</span>
 <span class="k">case</span> <span class="nv">$OPTION</span> in
  d<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"konfiguriere LAN über DHCP"</span><span class="p">;</span> <span class="nv">A</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  f<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"konfiguriere LAN statisch"</span><span class="p">;</span> <span class="nv">A</span><span class="o">=</span><span class="m">2</span><span class="p">;;</span>
  m<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"MAC-Adressänderung LAN ein"</span><span class="p">;</span> <span class="nv">B</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  c<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"MAC-Filter WLAN ein"</span><span class="p">;</span> <span class="nv">C</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  C<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"MAC-Filter WLAN ein, verwende Konfigurationsdatei"</span><span class="p">;</span> <span class="nv">C</span><span class="o">=</span><span class="m">2</span><span class="p">;;</span>
  D<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"manueller DNS"</span><span class="p">;</span> <span class="nv">D</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  P<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Portumleitung für Proxy aktiviert"</span><span class="p">;</span> <span class="nv">P</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  h<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Hilfe angefordert"</span><span class="p">;</span> <span class="nv">H</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  v<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Verbindungstest über Ping abgeschaltet"</span><span class="p">;</span> <span class="nv">V</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
  x<span class="o">)</span> <span class="nb">echo</span> <span class="s2">"Verschlüsselung abgeschaltet"</span><span class="p">;</span> <span class="nv">X</span><span class="o">=</span><span class="m">1</span><span class="p">;;</span>
 <span class="k">esac</span>
  <span class="k">done</span>

<span class="c1">## Ausgabe Hilfetext</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$H</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_AdHoc.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-restart<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-d<span class="o">]</span> <span class="o">[</span>-f<span class="o">]</span> <span class="o">[</span>-m<span class="o">]</span> <span class="o">[</span>-e<span class="o">]</span> <span class="o">[</span>-c<span class="o">]</span> <span class="o">[</span>-C<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-D<span class="o">]</span> <span class="o">[</span>-x<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh  startet mit Standardparametern, wie [-start][-d]"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -d startet mit Standardparametern, wie [-start]"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -f statische LAN-Konfiguration"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -x ohne WEP Verschlüsselung"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -c aktiviert MAC-Adressfilter"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -C aktiviert MAC-Adressfilter. Verwendet angelegte konfigurationsdatei."</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -v deaktiviert den aut. Verbindungstest (LAN) mittels Ping"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -f -m  statische LAN-Konfiguration, MAC-Änderung"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -f -m -c statischer LAN-Konfiguration, MAC-Änderung, MAC-Filter"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -start -f statische LAN-Konfiguration"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -restart -f statische LAN-Konfiguration"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -restart -d -D automatische LAN-Konfiguration über DHCP, dnsmasq ignoriert System-DNS"</span>
<span class="nb">echo</span> <span class="s2">"bei Option [-D] ignoriert dnsmasq die Einträge der /etc/resolv.conf"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -restart -f -m -c statische LAN-Konfiguration, MAC-Änderung, MAC-Filter"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -P Portumleitung für Proxyserver (Squid)"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AdHoc.sh -stop beendet das Ad-Hoc Netzwerk"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"Instant Ad-Hoc Netzwerkkonfiguration"</span>
 <span class="nb">echo</span> <span class="s2">"Starte gewählte Konfiguration ..."</span>
  sleep <span class="m">2</span>

<span class="c1">## Abfrage der Konfigurationsdatei für berechtigten Clients bei Option -C</span>
<span class="nv">cconfig</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">path</span><span class="o">=</span><span class="s2">"`pwd`""/"</span>
 <span class="nv">cconfig</span><span class="o">=</span><span class="s2">"`grep "</span>Client<span class="o">(</span>s<span class="o">)</span> erfasst<span class="s2">" </span><span class="nv">$path$configfile</span><span class="s2"> | awk {'print </span><span class="nv">$1</span><span class="s2">'}`"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$cconfig</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">""</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$C</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"2"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nv">ipaddresses</span><span class="o">=</span><span class="nv">$cconfig</span>
 <span class="k">fi</span>

<span class="c1">## aut. Adressberechnung DHCP-Range für dnsmasq</span>
<span class="c1">## gemäß Vorgabe WLAN-Schnittstelle</span>

<span class="nv">ipaddresses</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$ipaddresses</span>+<span class="nv">$wlanbaseip</span><span class="o">]</span>
 <span class="nv">baseendaddr</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$waddress</span><span class="s2"> | tr -s . "</span> <span class="s2">" | awk {'print </span><span class="nv">$4</span><span class="s2">'}`"</span>
  <span class="nv">basestartaddr</span><span class="o">=</span><span class="s2">"`echo </span><span class="nv">$waddress</span><span class="s2"> | tr -s . "</span> <span class="s2">" | awk {'print </span><span class="nv">$1</span><span class="s2">,</span><span class="nv">$2</span><span class="s2">,</span><span class="nv">$3</span><span class="s2">'} | tr -s "</span> <span class="s2">" .`"</span>
   <span class="nv">endaddr</span><span class="o">=</span><span class="s2">"</span><span class="nv">$basestartaddr</span><span class="s2">""."</span>$<span class="o">[</span><span class="nv">$startaddr</span>+<span class="nv">$ipaddresses</span><span class="o">]</span>
    <span class="nv">startaddr</span><span class="o">=</span><span class="s2">"</span><span class="nv">$basestartaddr</span><span class="s2">""."</span>$<span class="o">[</span><span class="nv">$baseendaddr</span>+<span class="nv">$wlanbaseip</span><span class="o">]</span>
     <span class="nv">ipaddresses</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$ipaddresses</span>-1<span class="o">]</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"Stoppe alle Dienste, Port-Forwarding, entferne Paketfilter und beende Verbindungen ..."</span>

<span class="c1"># iptables Filter löschen</span>
/sbin/iptables -F
 /sbin/iptables -X
  /sbin/iptables -t nat -F

<span class="nv">defgw</span><span class="o">=</span><span class="s2">"`route -n | grep UG | awk {'print </span><span class="nv">$2</span><span class="s2">'}`"</span>
 /sbin/route del default gw <span class="nv">$defgw</span> <span class="nv">$laniface</span>
  <span class="nb">echo</span> <span class="s1">''</span> <span class="p">|</span> tee /etc/resolv.conf
 
 /sbin/ifconfig <span class="nv">$wlaniface</span> down
  sleep <span class="nv">$configdelay</span>
   /sbin/iwconfig <span class="nv">$wlaniface</span> mode managed
    /sbin/ifconfig <span class="nv">$laniface</span> down
     /usr/bin/killall dnsmasq
      /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>
       service squid stop
        sleep <span class="nv">$configdelay</span>

<span class="c1">## Systemprotokollierung auf Standardwerte         </span>
sed -i <span class="s1">'s/:msg, contains, "DHCPREQUEST" syslog/# :msg, contains, "DHCPREQUEST" syslog/g'</span> /etc/rsyslog.conf
 service rsyslog restart
  /sbin/modprobe -rfv iptable_nat ipt_MASQUERADE xt_conntrack iptable_filter   

<span class="c1">## Restart Network-Manager - beende Ad-Hoc Netzwerk</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-stop"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"reaktiviere Network-Manager."</span>
   service network-manager start
    sleep <span class="nv">$configdelay</span>
     service network-manager restart
<span class="nb">echo</span> <span class="s2">"Ad-Hoc Konfiguration beendet."</span>
 <span class="nb">exit</span>
  <span class="k">fi</span>
 <span class="k">fi</span>

<span class="c1">## MAC-Adresse abgleichen</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$B</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">currentmac</span><span class="o">=</span><span class="s2">"`ifconfig </span><span class="nv">$laniface</span><span class="s2"> | grep Adresse | awk {'print </span><span class="nv">$6</span><span class="s2">'}`"</span>
  <span class="nb">echo</span> <span class="s2">"Schnittstelle "</span><span class="nv">$laniface</span><span class="s2">", MAC-Adresse: "</span><span class="nv">$currentmac</span> 
   <span class="nb">echo</span> <span class="s2">"Vorgabe: "</span><span class="nv">$lmacaddress</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$currentmac</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lmacaddress</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"Übereinstimmende MAC-Adresse. Änderungsversuch obsolet."</span>
  sleep <span class="nv">$configdelay</span>

<span class="k">else</span>
 /sbin/ifconfig <span class="nv">$laniface</span> down
  sleep <span class="nv">$configdelay</span>  
   /sbin/ip link <span class="nb">set</span> dev <span class="nv">$laniface</span> addr <span class="nv">$lmacaddress</span>
    sleep <span class="nv">$configdelay</span>

<span class="nv">currentmac</span><span class="o">=</span><span class="s2">"`ifconfig </span><span class="nv">$laniface</span><span class="s2"> | grep Adresse | awk {'print </span><span class="nv">$6</span><span class="s2">'}`"</span>
 <span class="nb">echo</span> <span class="s2">"Versuche MAC-Adresse zu ändern ..."</span>
  <span class="nb">echo</span> <span class="s2">"Schnittstelle "</span><span class="nv">$laniface</span><span class="s2">", MAC-Adresse: "</span><span class="nv">$currentmac</span> 

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$currentmac</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lmacaddress</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> Änderung der MAC-Adresse erfolgreich! 
  <span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"Änderung der MAC-Adresse nicht erfolgreich!"</span>
<span class="nb">echo</span> <span class="s2">"fahre ohne Änderung fort ..."</span>
<span class="k">fi</span>

 <span class="k">fi</span>
<span class="k">fi</span>

<span class="c1"># Konfiguration LAN</span>
<span class="nb">echo</span> <span class="s2">"Beende Network-Manager"</span>
 service network-manager stop
  <span class="nb">echo</span> <span class="s2">"Starte benötigte Dienste, und Verbindungen ..."</span>
   sleep <span class="nv">$configdelay</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$A</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
sleep <span class="nv">$configdelay</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"Starte automatische LAN-Verbindung über DHCP ..."</span>
   /sbin/dhclient <span class="nv">$laniface</span>

<span class="k">else</span>
sleep <span class="nv">$configdelay</span>
 <span class="nb">echo</span>
  <span class="nb">echo</span> <span class="s2">"Starte statische LAN-Konfiguration ..."</span>
   /sbin/ifconfig <span class="nv">$laniface</span> down
    /sbin/ifconfig <span class="nv">$laniface</span> <span class="nv">$laddress</span> broadcast <span class="nv">$lbroadcast</span> netmask <span class="nv">$lnetmask</span>
     sleep <span class="nv">$configdelay</span>

<span class="c1">## vorhandene Route ggf. löschen</span>
 <span class="nb">echo</span> <span class="s2">"Lösche Default-Gateway ..."</span>
  <span class="nv">defgw</span><span class="o">=</span><span class="s2">"`route -n | grep UG | awk {'print </span><span class="nv">$2</span><span class="s2">'}`"</span>
   /sbin/route del default gw <span class="nv">$defgw</span> <span class="nv">$laniface</span>

<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"Setze Gateway und Route ..."</span>
  /sbin/route add default gw <span class="nv">$lgateway</span> <span class="nv">$laniface</span>
   sleep <span class="nv">$configdelay</span>

<span class="c1">## DNS eintragen (nur bei statischer Konfiguration - Option [-f])</span>
<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"Setze manuell vorgegebene DNS"</span>
  <span class="nb">echo</span> <span class="s1">'# erzeugt durch instant_AdHoc.sh'</span> <span class="p">|</span> tee /etc/resolv.conf
   <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $1,$2'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
    <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $3,$4'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
     <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $5,$6'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf 
      <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $7,$8'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
       <span class="nb">echo</span> <span class="nv">$dns</span> <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $9,$10'</span><span class="o">}</span> <span class="p">|</span> tee -a /etc/resolv.conf
 <span class="k">fi</span>
  sleep <span class="nv">$pause</span>

<span class="c1">## Verbindungstest LAN</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$V</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"Starte LAN Verbindungstest ..."</span>
 <span class="nv">pingout</span><span class="o">=</span><span class="s2">"`(ping -c1 </span><span class="nv">$lgateway</span><span class="s2"> | egrep -wo '100% packet loss')`"</span>

 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$pingout</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"100% packet loss"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">"Kann Gateway nicht pingen </span><span class="nv">$pingout</span><span class="s2"> - Verbindung fehlgeschlagen!"</span>
   <span class="nb">echo</span> <span class="s2">"breche Vorgang ab!"</span>
    <span class="nb">echo</span> <span class="s2">"Kabelverbindung oder Konfiguration überprüfen!"</span>
     /sbin/ifconfig <span class="nv">$laniface</span> down

<span class="nb">echo</span> <span class="s2">"Erfasste Vorgabewerte:"</span>
 <span class="nb">echo</span> <span class="s2">"Schnittstelle: "</span><span class="nv">$laniface</span><span class="s2">" IP: "</span><span class="nv">$laddress</span><span class="s2">" Broadcast: "</span><span class="nv">$lbroadcast</span><span class="s2">" Netzmaske: "</span><span class="nv">$lnetmask</span>
  <span class="nb">echo</span> <span class="s2">"IP-Adresse Gateway: "</span><span class="nv">$lgateway</span>
 <span class="nb">exit</span>
<span class="k">fi</span>
  <span class="nb">echo</span> <span class="s2">"Verbindungstest erfolgreich!"</span>

<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"Verbindungstest abgeschaltet"</span>
 <span class="k">fi</span>

<span class="c1">## WLAN-Schnittstelle statisch konfigurieren</span>
<span class="nb">echo</span> <span class="s2">"Konfiguriere WLAN, starte WLAN Ad-Hoc Modus ..."</span>
 /sbin/ifconfig <span class="nv">$wlaniface</span> down
  sleep <span class="nv">$configdelay</span>

<span class="c1">## mit/ohne Verschlüsselung</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$X</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/iwconfig <span class="nv">$wlaniface</span> mode Ad-Hoc essid <span class="nv">$wname</span> channel <span class="nv">$wchannel</span>

<span class="k">else</span>
 /sbin/iwconfig <span class="nv">$wlaniface</span> mode Ad-Hoc essid <span class="nv">$wname</span> key <span class="nv">$wkey</span> channel <span class="nv">$wchannel</span>
  sleep <span class="nv">$configdelay</span>
<span class="k">fi</span>

/sbin/ifconfig <span class="nv">$wlaniface</span> <span class="nv">$waddress</span> broadcast <span class="nv">$wbroadcast</span> netmask <span class="nv">$wnetmask</span>
 sleep <span class="nv">$configdelay</span>
  /sbin/ifconfig <span class="nv">$wlaniface</span> up
   sleep <span class="nv">$configdelay</span>

<span class="c1">## force Mode and SSID</span>
<span class="c1">## Optional/testing</span>
<span class="c1">#  /sbin/iwconfig $wlaniface mode Ad-Hoc essid $wname</span>
<span class="c1">#   sleep $configdelay</span>

<span class="c1">## Systemkonfiguration iptables und IP-Forwarding</span>
<span class="nb">echo</span> <span class="s2">"Starte IP-Forward, Masquerading und NAT"</span>

/sbin/iptables -A FORWARD -o <span class="nv">$laniface</span> -i <span class="nv">$wlaniface</span> -s <span class="nv">$iptablemask</span> -m conntrack --ctstate NEW -j ACCEPT
 /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  /sbin/iptables -t nat -A POSTROUTING -o <span class="nv">$laniface</span> -j MASQUERADE 
   /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span> 

<span class="c1">## dnsmasq starten</span>
<span class="nb">echo</span> <span class="s2">"Starte dnsmasq"</span>
 <span class="nb">echo</span> <span class="s2">"DHCP-Range dnsmasq-base - Startadresse: "</span><span class="nv">$startaddr</span><span class="s2">" Endadresse: "</span><span class="nv">$endaddr</span>
  <span class="nb">echo</span>

/usr/bin/killall dnsmasq

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$D</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /usr/sbin/dnsmasq -i <span class="nv">$wlaniface</span> -I <span class="nv">$laniface</span> -F <span class="nv">$startaddr</span>,<span class="nv">$endaddr</span>,<span class="nv">$leasetime</span>
  <span class="k">else</span>
   /usr/sbin/dnsmasq -i <span class="nv">$wlaniface</span> -I <span class="nv">$laniface</span> -F <span class="nv">$startaddr</span>,<span class="nv">$endaddr</span>,<span class="nv">$leasetime</span> -R -S <span class="nv">$mandns</span>
     <span class="nb">echo</span> <span class="s2">"DNS Systemeinstellung wird ignoriert, dnsmasq verwendet DNS: "</span><span class="nv">$mandns</span>
  <span class="k">fi</span>

<span class="c1">## Portumleitung für Squid Proxyserver</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$P</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/iptables -t nat -A PREROUTING -i <span class="nv">$wlaniface</span> -p tcp --dport <span class="m">80</span> -j REDIRECT --to-port <span class="nv">$proxyport</span>
     <span class="nb">echo</span> <span class="s2">"Port 80 </span><span class="nv">$wlaniface</span><span class="s2"> auf Port </span><span class="nv">$proxyport</span><span class="s2"> umgeleitet (Squid Proxyserver)"</span>
   <span class="nb">echo</span> <span class="s2">"Starte Squid Proxyserver ..."</span>
 sleep <span class="nv">$configdelay</span>
  service squid start -n
<span class="k">fi</span>

<span class="c1">## Ausgabe der Konfiguration. Einstellungen der Schnittstellen,</span>
<span class="c1">## Routingtabelle und DNS prüfen</span>

<span class="nb">echo</span> <span class="s2">"Aktuelle Konfiguration ..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$A</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"2"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"vorgegebene DNS: "</span><span class="nv">$dns</span>
  <span class="k">fi</span> 

<span class="nb">echo</span> 
 <span class="nb">echo</span> <span class="s2">"Systemkonfiguration: /etc/resolv.conf"</span>
  /bin/cat /etc/resolv.conf

<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"Systemkonfiguration: Routingtabelle"</span>
  /sbin/route -n

<span class="nb">echo</span> 
 <span class="nb">echo</span> <span class="s2">"Konfiguration LAN:"</span>
  /sbin/ifconfig <span class="nv">$laniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>

<span class="nb">echo</span>   
 <span class="nb">echo</span> <span class="s2">"Konfiguration WLAN (IP-Einstellungen und Modus):"</span>
  /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    <span class="nb">echo</span> <span class="s2">"warte 10 Sekunden ..."</span>
     sleep <span class="m">10</span>
      /sbin/iwconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Mode'</span>

<span class="nb">echo</span> <span class="s2">"Basiskonfiguration abgeschlossen."</span>

<span class="c1">## Ende Standardkonfiguration</span>
<span class="c1">## MAC-Adressfilter / Anmeldung der Clients</span>

<span class="nv">maccount</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## Konfigurationsdatei auslesen</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$C</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"2"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"MAC-Adressfilter aktiviert"</span>
  <span class="nb">echo</span> <span class="s2">"Verarbeite Konfigurationsdatei ""`pwd`"</span>/<span class="nv">$configfile</span>

<span class="k">for</span> i in <span class="o">{</span><span class="m">1</span>..50<span class="o">}</span>
 <span class="k">do</span>
<span class="nv">mac</span><span class="o">=</span><span class="s2">"`grep "</span>MAC <span class="nv">$i</span><span class="s2">" instant_AdHoc_MAC.conf | awk {'print </span><span class="nv">$4</span><span class="s2">'}`"</span>
 
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$mac</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"Konfiguration beendet."</span>
  /sbin/iptables -A INPUT -i <span class="nv">$wlaniface</span> -j DROP
   <span class="nb">exit</span> <span class="m">0</span>

 <span class="k">else</span> 
  /sbin/iptables -A INPUT -i <span class="nv">$wlaniface</span> -m mac --mac-source <span class="nv">$mac</span> -j ACCEPT
   <span class="nb">echo</span> <span class="s2">"Erlaube Verbindung für Client "</span><span class="nv">$mac</span>
<span class="k">fi</span>
 <span class="k">done</span>
<span class="k">fi</span>

<span class="c1">## erforderliche Protokollierung des Systems aktivieren</span>
<span class="c1">## erstellen der Konfigurationsdatei</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$C</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"MAC-Adressfilter aktiviert. Starte Erfassung der Clients"</span>
  <span class="nb">echo</span> <span class="s2">"Aktiviere erforderliche Systemprotokollierung"</span>
   <span class="nv">logfilter</span><span class="o">=</span><span class="s2">"`(grep ':msg, contains, "</span>DHCPREQUEST<span class="s2">" syslog' /etc/rsyslog.conf)`"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$logfilter</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s1">':msg, contains, "DHCPREQUEST" syslog'</span> <span class="p">|</span> tee -a /etc/rsyslog.conf

<span class="k">else</span>
 sed -i <span class="s1">'s/# :msg, contains, "DHCPREQUEST" syslog/:msg, contains, "DHCPREQUEST" syslog/g'</span> /etc/rsyslog.conf
  service rsyslog restart
   sleep <span class="nv">$configdelay</span>
 <span class="k">fi</span>

<span class="c1">## MAC-Filter / Geräteadressen erfassen</span>
 /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>

<span class="nb">echo</span>
 <span class="nb">echo</span> <span class="s2">"Basiskonfiguration beendet. MAC-Adressfilter aktiviert. Warte auf Clients ..."</span>
  <span class="nb">echo</span> <span class="s2">"## Erfasste Adressen"</span> &gt; <span class="s2">"`pwd`"</span>/<span class="nv">$configfile</span>
  <span class="k">else</span>
 <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="k">while</span> <span class="nb">true</span>
 <span class="k">do</span>

<span class="nv">input</span><span class="o">=</span><span class="s2">"none"</span>
  <span class="nv">iprequest</span><span class="o">=</span><span class="s2">"`(tail -n3 /var/log/syslog | grep DHCPREQUEST | awk {'print </span><span class="nv">$8</span><span class="s2">'})`"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$iprequest</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"Berechtigungsanfrage!"</span>
  <span class="nb">echo</span> -n <span class="s2">"Soll dem Gerät mit der MAC-Adresse "</span><span class="nv">$iprequest</span><span class="s2">" der Zugang gestattet werden? [y/n] "</span>
     <span class="nb">read</span> input

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$input</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"y"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nv">timestamp</span><span class="o">=</span><span class="s2">"`date`"</span>
  <span class="nb">echo</span> <span class="nv">$timestamp</span><span class="s2">" ICS Instant Ad-Hoc. Zugangsanfrage erkannt"</span> <span class="p">|</span> tee -a /var/log/syslog
   <span class="nb">echo</span> <span class="nv">$timestamp</span><span class="s2">" ICS Instant Ad-Hoc. Gestatte WLAN-Zugang für Client "</span><span class="nv">$iprequest</span> <span class="p">|</span> tee -a /var/log/syslog

<span class="nv">maccount</span><span class="o">=</span>$<span class="o">[</span><span class="nv">$maccount</span>+1<span class="o">]</span>
 <span class="nb">echo</span> <span class="s2">"MAC "</span><span class="nv">$maccount</span><span class="s2">" - "</span><span class="nv">$iprequest</span> &gt;&gt; <span class="s2">"`pwd`"</span>/<span class="nv">$configfile</span>
  /sbin/iptables -A INPUT -i <span class="nv">$wlaniface</span> -m mac --mac-source <span class="nv">$iprequest</span> -j ACCEPT

<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$input</span><span class="s2">"</span> <span class="o">=</span> n <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"verweigere Zugang für "</span><span class="nv">$iprequest</span>
  <span class="nb">echo</span> <span class="s2">"warte auf Clients ..."</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$maccount</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> -n <span class="s2">"Soll weiteren Clients eine Verbindung gestattet werden ? [y/n] "</span>
  <span class="nb">read</span> input
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$input</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"n"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="nv">$maccount</span> <span class="s2">" Client(s) erfasst, beende Konfiguration!"</span>
  <span class="nb">echo</span> <span class="s2">"aktiviere IP-Forwarding"</span>
   /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
    /sbin/iptables -A INPUT -i <span class="nv">$wlaniface</span> -j DROP

 <span class="nb">echo</span> <span class="s2">"## Anzahl erfasster Clients"</span> &gt;&gt; <span class="s2">"`pwd`"</span>/<span class="nv">$configfile</span>
  <span class="nb">echo</span> <span class="nv">$maccount</span><span class="s2">" Client(s) erfasst"</span> &gt;&gt; <span class="s2">"`pwd`"</span>/<span class="nv">$configfile</span>
<span class="nb">exit</span>

<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"warte auf Clients ..."</span>
  <span class="k">fi</span>
<span class="k">fi</span>
  sleep <span class="m">6</span>
 <span class="k">done</span>
<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
</td></tr></table></div><p>Die verwendeten Schnittstellen für LAN und WLAN, sowie die gewünschten IP-Adressen sind ggf. noch anzupassen. Alle erforderlichen Parameter können im Deklarationsblock des Skripts im Abschnitt <code class="notranslate">## freie Variablen</code> geändert werden.</p><p>Im Terminal <sup><a href="#source-2">[2]</a></sup> als <code class="notranslate">root</code><sup><a href="#source-3">[3]</a></sup> kann das Skript nun mit verschiedenen Parametern aufgerufen werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ./instant_AdHoc.sh [-start|-restart|-stop]
sudo ./instant_AdHoc.sh                  # startet mit automatischer Konfiguration (wie mit [-start])
sudo ./instant_AdHoc.sh -start           # startet alle Verbindungen und Dienste mit automatischer Konfiguration
sudo ./instant_AdHoc.sh -restart         # erneuert alle Verbindungen und Dienste mit automatischer Konfiguration
sudo ./instant_AdHoc.sh -stop            # beendet alle Verbindungen und Dienste </pre></div></div><p>Zusätzliche Optionen für eine statische Konfiguration der LAN-Schnittstelle, manuelle DNS-Einstellungen, ein MAC-Adressfilter und eine Änderung der MAC-Adresse der LAN-Schnittstelle sind möglich, sollte dies für eine Verbindung erforderlich sein. Das Skript gibt entsprechende Rückmeldungen. Am Ende wird die Konfiguration der LAN- und WLAN-Schnittstelle, sowie die Routingtabelle zur Funktionsprüfung ausgegeben.</p><p>Beispiele zur Anwendung der Startoptionen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ./instant_AdHoc.sh [-start|-restart|-stop] [-d] [-f] [-m] [-c] [-C] [-h] [-v] [-D] [-P] [-x]
sudo ./instant_AdHoc.sh -h               # gibt eine Hilfe zur Syntax aus
sudo ./instant_AdHoc.sh -f -c            # startet LAN mit statischer Konfiguration und und MAC-Adressfilter
sudo ./instant_AdHoc.sh -D               # dnsmasq verwendet den angebenen DNS und ignoriert die /etc/resolv.conf
sudo ./instant_AdHoc.sh -P               # startet Proxyserver Squid
sudo ./instant_AdHoc.sh -x               # Ad-Hoc unverschlüsselt
sudo ./instant_AdHoc.sh -start -d -m     # startet LAN mit automatischer Konfiguration und ändert die MAC-Adresse
sudo ./instant_AdHoc.sh -start -f -m     # startet LAN mit statischer Konfiguration und ändert die MAC-Adresse
sudo ./instant_AdHoc.sh -restart -f -c   # erneuert alle Verbindungen mit statischer Konfiguration und MAC-Adressfilter
sudo ./instant_AdHoc.sh -start -C        # startet mit MAC-Adressfilter, verwendet aber die zuvor angelegte Konfigurationsdatei
sudo ./instant_AdHoc.sh -start -v        # LAN Verbindungstest über Ping deaktiviert
sudo ./instant_AdHoc.sh -restart -fmcD   # Restart, LAN statisch &amp; MAC-Änderung &amp; MAC-Adressfilter &amp; manueller DNS </pre></div></div><p>Die Optionen können beliebig kombiniert werden. Bei Option <code class="notranslate">-df</code> wird eine statische Konfiguration, und bei <code class="notranslate">-fd</code> eine dynamische Konfiguration der LAN-Schnitstelle ausgeführt, also immer die zuletzt angegebene Option verwendet. Parameter <code class="notranslate">-stop</code> erfortert keine Option, bzw. ignoriert diese.</p><p>Mit <code class="notranslate">-c</code> wird ein MAC-Adressfilter aktiviert. Alle Clients müssen sich nacheinander anmelden bevor die Konfiguration bei der abschließenden Eingabeaufforderung mit einem 
<span class="key">N</span>  beendet ist und der Internetzugang freigegeben wird.</p><p>Beispielausgabe:</p><pre class="notranslate">Basiskonfiguration beendet. MAC-Adressfilter aktiviert. Warte auf Clients ...
Berechtigungsanfrage!
Soll dem Gerät mit der MAC-Adresse 1c:4b:d6:50:5f:63 der Zugang gestattet werden? [y/n]y
ICS Instant Ad-Hoc. Gestatte WLAN-Zugang für 1c:4b:d6:50:5f:63
Soll weiteren Clients eine Verbindung gestattet werden ? [y/n]y
warte auf Clients ...
Berechtigungsanfrage!
Soll dem Gerät mit der MAC-Adresse 00:04:0e:c2:61:ca der Zugang gestattet werden? [y/n]y
ICS Instant Ad-Hoc. Gestatte WLAN-Zugang für 00:04:0e:c2:61:ca
Soll weiteren Clients eine Verbindung gestattet werden ? [y/n]n
2 Client(s) erfasst, beende Konfiguration.</pre><p>Nun wird die Internetverbindung auf alle angemeldeten Clients weitergeleitet. Die Konfiguration wird im Benutzerverzeichnis in der Textdatei <strong>instant_AdHoc_MAC.conf</strong> abgelegt. Bei einem Start des Skripts mit Option <code class="notranslate">-C</code> werden die Einstellungen aus dieser Datei übernommen, und die Clients müssen sich nicht erneut manuell anmelden. Der IP-Adresspool des DHCP-Server wird zusätzlich auf die Anzahl der bekannten Clients begrenzt.</p><p>Sollen weitere Clients erfasst werden, muss das Skript erneut mit Option <code class="notranslate">-c</code> gestartet werden um die Konfigurationsdatei neu anzulegen.</p><p>Die Konfigurationsdatei kann auch manuell mit einem Editor <sup><a href="#source-1">[1]</a></sup> angelegt oder bearbeitet werden. Der Inhalt ist natürlich entsprechend anzupassen. Maximal 50 Adressen werden vom Skript ausgewertet.</p><p>Beispiel für zwei zugelassene Clients:</p><pre class="notranslate">## Erfasste Adressen
MAC 1 - 1c:4b:d6:50:5f:63
MAC 2 - 00:04:0e:c2:61:ca
## Anzahl erfasster Clients
2 Client(s) erfasst</pre><p>Nachdem das Skript und alle Dienste beendet, sowie die Einstellungen zurückgesetzt wurden, wird der Network-Manager wieder gestartet und kann wie gewohnt verwendet werden.</p></div><div class="section_2"><h3 id="Proxyserver">Proxyserver<a class="headerlink" href="#Proxyserver">¶</a></h3><p>
</p><ul><li><p><strong>squid</strong> (ein Open-Source Proxyserver und Daten-Cache, siehe <a class="internal" href="./squid.html">Squid</a>)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install squid </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install squid </pre></div></div><p>
</p></div></div><div class="section_3"><h4 id="Squid-als-Daten-Cache">Squid als Daten-Cache<a class="headerlink" href="#Squid-als-Daten-Cache">¶</a></h4><p>
Zusätzliche Sicherheit erreicht man durch einen Proxyserver wie <a class="internal" href="./squid.html">Squid</a>, mit dem ein Daten-Cache und Web-Filter eingerichtet werden kann. <a class="internal" href="./squid.html">Squid</a> arbeitet hier als "<em>transparenter</em>" Proxy und reiner Datencache. Über SquidGuard kann ein zusätzlicher Web-Filter eingerichtet werden, die gezeigte Konfigurationsdatei ist entsprechend vorbereitet. Auf den angeschlossenen Clients muss dazu nichts weiter konfiguriert werden, alle Anfragen werden direkt auf den Proxyserver umgeleitet.</p><p>Nach der Installation wird die squid-Konfigurationsdatei <strong>/etc/squid/squid.conf</strong> gesichert und durch folgende Basiskonfiguration ersetzt.
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp /etc/squid/squid.conf /etc/squid/squid.conf.bak </pre></div></div><p>Die Konfigurationsdatei kann nun mit einem <a class="internal" href="./editor.html">Editor</a> <sup><a href="#source-1">[1]</a></sup> und Root-Rechten <sup><a href="#source-3">[3]</a></sup> bearbeitet werden. Folgender Inalt ist einzufügen:</p><pre class="notranslate"># SQUID erforderliche Minimalkonfiguration
acl all src all
acl manager proto cache_object
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32

# Example rule allowing access from your local networks.
acl localnet src 192.168.0.0/24	# RFC1918 possible internal network

# lokale Rechner freigegeben
acl lokale_rechner src 192.168.3.0/255.255.255.0
http_access allow lokale_rechner

acl SSL_ports port 443		# https
acl SSL_ports port 563		# snews
acl SSL_ports port 873		# rsync
acl Safe_ports port 80 		# http
acl Safe_ports port 21 		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl Safe_ports port 631		# cups
acl Safe_ports port 873		# rsync
acl Safe_ports port 901		# SWAT
acl purge method PURGE
acl CONNECT method CONNECT

http_access allow manager localhost
http_access deny manager

# Only allow purge requests from localhost
http_access allow purge localhost
http_access deny purge

# Deny requests to unknown ports
http_access deny !Safe_ports

# Deny CONNECT to other than SSL ports
http_access deny CONNECT !SSL_ports

http_access deny all

#Allow ICP queries from local networks only
icp_access allow localnet
icp_access deny all

# verwendeter Port 3128
http_port 192.168.3.1:3128 transparent

# deutsche Fehlermeldungen geblockte Seiten usw.
error_directory /usr/share/squid/errors/de

# Tag: Programmumleitung zu Squid-Guard / hier deaktiviert
# redirect_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf

access_log /var/log/squid/access.log squid

# Speicherverwaltung
cache_dir ufs /var/spool/squid 2000 16 256
cache_replacement_policy heap LFUDA
memory_replacement_policy heap LFUDA
maximum_object_size 5000 KB
maximum_object_size_in_memory 32 KB
cache_mem 32 MB</pre><p>Diese Konfiguration kann ebenfalls direkt mit dem hier gezeigten Skript <strong>instant_AdHoc.sh</strong> mit der Startoption <code class="notranslate">-P</code> verwendet werden. Bei einer manuellen Konfiguration über die Datei <a class="internal" href="./interfaces.html">/etc/network/interfaces</a> muss eine entsprechende Portweiterleitung und der Startbefehl für Squid nachgetragen werden.</p><pre class="notranslate">...
up service squid stop
 post-up /sbin/iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3128
  post-up service squid start -n</pre><p>Die Konfiguration auf ist damit abgeschlossen.</p></div><div class="section_3"><h4 id="Squid-mit-NCSA-Authentifikation">Squid mit NCSA Authentifikation<a class="headerlink" href="#Squid-mit-NCSA-Authentifikation">¶</a></h4><p>
Hier soll zunächst gezeigt werden wie damit eine zusätzliche Authentifikation über den Benutzernamen und ein Kennwort eingerichtet wird. Ein transparenter Proxy-Server kann in diesem Fall nicht verwendet werden.</p><p>Es werden zusätzlich folgende Programmpakete benötigt:</p><ul><li><p><strong>apache2-utils </strong> (Hilfsprogramme um u.a. Kennwortdateien anlegen und verwalten zu können)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install apache2-utils  </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install apache2-utils  </pre></div></div><p>
</p></div></div><p>Nach der Installation wird die squid-Konfigurationsdatei <strong>/etc/squid/squid.conf</strong> gesichert und durch folgende Basiskonfiguration ersetzt.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp /etc/squid/squid.conf /etc/squid/squid.conf.bak </pre></div></div><p>Die Konfigurationsdatei kann nun mit einem <a class="internal" href="./editor.html">Editor</a> <sup><a href="#source-1">[1]</a></sup> und Root-Rechten <sup><a href="#source-3">[3]</a></sup> bearbeitet werden. Folgender Inhalt ist einzufügen:</p><pre class="notranslate"># SQUID erforderliche Minimalkonfiguration
acl all src all
acl manager proto cache_object
acl localhost src 127.0.0.1/32
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32

# Example rule allowing access from your local networks.
acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
acl localnet src 192.168.0.0/24	# RFC1918 possible internal network

acl SSL_ports port 443		# https
acl SSL_ports port 563		# snews
acl SSL_ports port 873		# rsync
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl Safe_ports port 631		# cups
acl Safe_ports port 873		# rsync
acl Safe_ports port 901		# SWAT
acl purge method PURGE
acl CONNECT method CONNECT

# Authetifikation
auth_param basic program /usr/lib/squid/ncsa_auth  /etc/squid/passwd
auth_param basic realm Benutzerauthentifizierung fuer den Internetzugang
auth_param basic casesensitive off
auth_param basic children 5

acl kennwort proxy_auth REQUIRED
http_access allow kennwort

http_access allow manager localhost
http_access deny manager

# Only allow purge requests from localhost
http_access allow purge localhost
http_access deny purge

# Deny requests to unknown ports
http_access deny !Safe_ports

# Deny CONNECT to other than SSL ports
http_access deny CONNECT !SSL_ports

http_access deny all

#Allow ICP queries from local networks only
icp_access allow localnet
icp_access deny all

# verwendeter Port 3128
http_port 192.168.3.1:3128

# deutsche Fehlermeldungen geblockte Seiten usw.
error_directory /usr/share/squid/errors/de

# Tag: Programmumleitung zu Squid-Guard / hier deaktiviert
# redirect_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf

access_log /var/log/squid/access.log squid

# Speicherverwaltung
cache_dir ufs /var/spool/squid 2000 16 256
cache_replacement_policy heap LFUDA
memory_replacement_policy heap LFUDA
maximum_object_size 5000 KB
maximum_object_size_in_memory 32 KB
cache_mem 32 MB</pre><p>Nun muss noch die erfoderliche Kennwortdatei <strong>/etc/squid/passwd</strong> angelegt werden. Dazu wird das Werkzeug htpasswd aus dem installierten Paket <strong>apache2-utils</strong> verwendet.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo htpasswd -bc /etc/squid/passwd &lt;Benutzer&gt; &lt;Kennwort&gt;          # Option -c erzeugt die Datei, bzw. legt diese neu an
sudo htpasswd -b /etc/squid/passwd &lt;Benutzer1&gt; &lt;Kennwort&gt;          # weitere Benutzer anlegen oder das Kennwort vorhandener Benutzer ändern </pre></div></div><p>
Beispiel:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo htpasswd -bc /etc/squid/passwd stefan stefanskennwort         # Datei erzeugen, ersten Eintrag anlegen
sudo htpasswd -b /etc/squid/passwd peter peterskennwort            # weitere Einträge anlegen oder ändern
sudo htpasswd -b /etc/squid/passwd manuela manuelaskennwort        # weitere Einträge anlegen oder ändern </pre></div></div><p>Diese Konfiguration kann direkt mit dem hier gezeigten Skript <strong>instant_AdHoc.sh</strong> mit der Startoption <code class="notranslate">-P</code> verwendet werden. Bei einer manuellen Konfiguration über die Datei <a class="internal" href="./interfaces.html">/etc/network/interfaces</a> muss eine entsprechende Portweiterleitung und der Startbefehl für Squid nachgetragen werden.</p><pre class="notranslate">...
up service squid stop
 post-up /sbin/iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -j REDIRECT --to-port 3128
  post-up service squid start -n</pre><p>
Die Konfiguration auf dem Host-Rechner ist damit abgeschlossen.</p><p><img alt="./Proxy-EinstellungenFF.png" class="image-right" src="./_/f6985fcc3b25e06833fab8646a2f858aac810a2f.png"/>
<img alt="./Proxy-Einstellungen.png" class="image-right" src="./_/c4d24e67d1afcef1ce92c7e2ec71fa9656cb0d25.png"/></p></div><div class="section_3"><h4 id="Konfiguration-der-Clients-2">Konfiguration der Clients<a class="headerlink" href="#Konfiguration-der-Clients-2">¶</a></h4><p>
Damit auf den angeschlossenen Clients die Kennwortabfrage wirksam werden kann und der WEB-Zugriff ermöglicht wird, müssen die Proxy-Einstellungen Systemweit angewandt werden. Dazu wird über das Menü in <em>System &gt; Einstellungen &gt; Netzwerk-Proxy</em> die IP-Adresse des Host, in unserem Fall <em>192.168.3.1</em> und der verwendete Port <em>3128</em> eingetragen. Die Einstellungen müssen dann "<em>Systemweit übernommen</em>" werden.</p><p>Der Browser <a class="internal" href="./firefox.html">Firefox</a> und auch der Mail-Client <a class="internal" href="./thunderbird.html">Thunderbird</a> muss separat konfiguriert werden. Bei den erweiterten Einstellungen, Registerkarte "Netzwerk" ist "<em>Proxyeinstellungen des Systems verwenden</em>" auszuwählen. Bei Anwahl einer beliebigen Webseite wird nun zunächst nach dem Benutzernamen und dem Kennwort gefragt.</p></div></div></div><div class="section_1"><h2 id="Zusatzinformationen">Zusatzinformationen<a class="headerlink" href="#Zusatzinformationen">¶</a></h2><p>
</p><ul><li><p><a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Private_IP-Adresse">IP-Adressen</a> in lokalen Netzwerken</p></li><li><p><a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Wireless_Local_Area_Network#Frequenzen_und_Kan.C3.A4le">Frequenzeinstellungen</a> </p></li><li><p><a class="external" href="http://linuxwiki.de/dnsmasq" rel="nofollow">dnsmasq</a> - Tipps und Tricks auf linuxwiki.de <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/></p></li><li><p><a class="external" href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html" rel="nofollow">dnsmasq Manpages</a> auf thekelleys.org.uk <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/></p></li></ul><p>
</p><div class="section_2"><h3 id="freie-DNS">freie DNS<a class="headerlink" href="#freie-DNS">¶</a></h3><p>
</p><ul><li><p><a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Domain_Name_System">DNS</a></p></li><li><p><a class="external" href="http://www.friendly-board.de/forum/freie-dns-server-t552.html" rel="nofollow">Liste freier DNS www.friendly-board.de</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/></p></li><li><p><a class="external" href="http://wiki.ak-zensur.de/index.php/Unzensierte_DNS_Server" rel="nofollow">Liste freier DNS auf wiki.ak-zensur.de</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/></p></li></ul><p>
</p></div></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="internal" href="./internet_und_netzwerk.html">Internet und Netzwerk</a> und <a class="internal" href="./netzwerk.html">Netzwerk</a> <img alt="{Übersicht}" src="./_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> - Übersichten zu verschiedenen Netzwerkthemen</p></li><li><p><a class="internal" href="./router.html">Router</a></p></li><li><p><a class="internal" href="./wlan.html">WLAN</a> <img alt="{Übersicht}" src="./_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> - alles rund um Wireless LAN</p></li><li><p><a class="internal" href="./wlan_router.html">WLAN Router</a></p></li><li><p><a class="internal" href="./heimnetzwerk.html">Heimnetzwerk</a> - Daten in einem LAN austauschen</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="./internetverbindungsfreigabe/a/revision/835213.html">Diese Revision</a> wurde am 6. September 2015 12:54 von <a href="https://ubuntuusers.de/user/aasche/">aasche</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="./startseite.html">Wiki</a></li>
<li><a href="./internetverbindungsfreigabe.html">Internetverbindungsfreigabe</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="./_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="./_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="./_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="./_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>