<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Skripte/inkrementelles_Backup › ubuntuusers statisches Wiki</title>
<link href="../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../skripte/inkrementelles_backup.html">inkrementelles Backup</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Skripte/inkrementelles_Backup">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../wiki/index.html">Index</a></li>
<li><a href="../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../wiki.html">Übersicht</a></li>
<li><a href="../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../kategorien.html">Kategorie</a></li>
<li><a href="../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../howto.html">Howto anlegen</a></li>
<li><a href="../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../baustelle.html">Baustellen</a></li>
<li><a href="../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../skripte/inkrementelles_backup/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../skripte/inkrementelles_backup/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../skripte/inkrementelles_backup/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../skripte/inkrementelles_backup/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../skripte/inkrementelles_backup/a/backlinks.html">inkrementelles Backup</a></h1>
<div id="page"><div class="box improvable"><h3 class="box improvable">Ausbaufähige Anleitung</h3><div class="contents"><p>
Dieser Anleitung fehlen noch einige Informationen. Wenn Du etwas
verbessern kannst, dann editiere den Beitrag, um die Qualität
des Wikis noch weiter zu verbessern.
</p><hr/><p><strong>Anmerkung:</strong> Das im Artikel enthaltene Skript könnte überarbeitet werden (siehe <a class="crosslink post" href="https://forum.ubuntuusers.de/post/7343153/">Diskussion</a>).
</p></div></div><p>
</p><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p>
</p><ul><li><p><a class="internal" href="../xenial_xerus.html">Ubuntu 16.04</a> Xenial Xerus</p></li></ul></div></div><p>
</p><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="../terminal.html">Ein Terminal öffnen</a> </p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="../editor.html">Einen Editor öffnen</a> </p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="../rechte.html">Rechte für Dateien und Ordner ändern</a> </p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="../paketinstallation_deb.html">Ein Paket installieren</a> </p></li></ol></div></div><p>
</p><div class="toc toc-depth-1"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Funktion">Funktion
</a></li><li><a class="crosslink" href="#Installation">Installation
</a></li><li><a class="crosslink" href="#Das-Skript">Das Skript
</a></li><li><a class="crosslink" href="#Erklaerungen">Erklärungen
</a></li><li><a class="crosslink" href="#Bereit-zum-Ausfuehren">Bereit zum Ausführen
</a></li><li><a class="crosslink" href="#Daten-zuruecksichern">Daten zurücksichern
</a></li><li><a class="crosslink" href="#Probleme-bei-Backup-Quellen-die-ueber-Samba-CIFS-oder-NFS-eingebunden-werden">Probleme bei Backup Quellen, die über Samb...</a></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p><img alt="Wiki/Icons/terminal.png" class="image-left" src="../_/e81889fd6e485dd32e1cde611eabc18abced7993.png"/>
Wie wertvoll ein Backup der persönlichen Daten sein kann, erkennt man meist erst, wenn der Ernstfall eingetreten ist. Einige lehnen sich dann entspannt zurück und schreiben die "verlorenen Daten" mit einer kurzen Befehlszeile zurück, andere beißen vor Wut in die Tischkante, weil sie vergessen haben, ein Backup zu machen. Mittels des hier vorgestellten kleinen Skriptes sollte jeder in der Lage sein, sich im Ernstfall entspannt zurückzulehnen.</p><div class="section_1"><h2 id="Funktion">Funktion<a class="headerlink" href="#Funktion">¶</a></h2><p>
Dieses Backupskript erstellt ein Grundbackup und eine tägliche Sicherung der geänderten Daten. Dazu bedient es sich des Programmes <a class="internal" href="../tar.html">tar</a> und des Dienstes <a class="internal" href="../cron.html">anacron</a>. Der Dienst anacron sorgt dafür, dass immer ein Backup nach dem ersten Rechnereinschalten des Tages gemacht wird. Somit ist sichergestellt, dass nicht vergessen wird, ein Backup anzulegen bzw. dass ein Backup nicht angelegt wird, weil die Ausführungszeit vor Einschalten des Rechners liegt, was z.B. der Fall bei <a class="internal" href="../cron.html">cron</a> wäre. Nach jedem Backupvorgang wird eine Mail an <code class="notranslate">root</code> gesendet, in der mitgeteilt wird ob das Backup von Erfolg gekrönt war oder ob ein Fehler aufgetreten ist.</p></div><div class="section_1"><h2 id="Installation">Installation<a class="headerlink" href="#Installation">¶</a></h2><p>
Folgendes Paket sollte bei Bedarf installiert werden <sup><a href="#source-4">[4]</a></sup>:</p><ul><li><p><strong>mailutils</strong></p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install mailutils </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install mailutils </pre></div></div><p>
</p></div></div><p>(nur notwendig wenn man keinen anderen <a class="internal" href="../mailserver_einführung.html">MTA</a> installiert hat und sich Mails über den Backup-Erfolg senden lassen möchte)</p></div><div class="section_1"><h2 id="Das-Skript">Das Skript<a class="headerlink" href="#Das-Skript">¶</a></h2><p>
Zuerst öffnet man einen Texteditor <sup><a href="#source-2">[2]</a></sup> und kopiert den folgenden Text hinein:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Script fuer inkrementelles Backup mit 30 taegigem Vollbackup</span>

<span class="c1">### Einstellungen ##</span>
<span class="nv">BACKUPDIR</span><span class="o">=</span><span class="s2">"media/backup"</span>           <span class="c1">## Pfad zum Backupverzeichnis</span>
<span class="nv">ROTATEDIR</span><span class="o">=</span><span class="s2">"media/backup/rotate"</span>    <span class="c1">## Pfad wo die Backups nach 30 Tagen konserviert werden</span>
<span class="nv">TIMESTAMP</span><span class="o">=</span><span class="s2">"timestamp.dat"</span>          <span class="c1">## Zeitstempel</span>
<span class="nv">SOURCE</span><span class="o">=</span><span class="s2">"home/user"</span>                 <span class="c1">## Verzeichnis(se) welche(s) gesichert werden soll(en)</span>
<span class="nv">DATUM</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>date +%d-%m-%Y<span class="k">)</span><span class="s2">"</span>          <span class="c1">## Datumsformat einstellen</span>
<span class="nv">ZEIT</span><span class="o">=</span><span class="s2">"</span><span class="k">$(</span>date +%H:%M<span class="k">)</span><span class="s2">"</span>              <span class="c1">## Zeitformat einstellen &gt;&gt;Edit bei NTFS und Verwendung auch unter Windows : durch . ersetzen</span>

<span class="c1">### Verzeichnisse/Dateien welche nicht gesichert werden sollen ! Achtung keinen Zeilenumbruch ! ##</span>
<span class="nv">EXCLUDE</span><span class="o">=</span><span class="s2">"--exclude=home/user/Filme --exclude=home/user/Musik --exclude=home/user/Spiele --exclude=home/user/.VirtualBox  --exclude=home/user/.local/share/Trash"</span>

<span class="c1">### Wechsel in root damit die Pfade stimmen ##</span>
<span class="nb">cd</span> /

<span class="c1">### Backupverzeichnis anlegen ##</span>
mkdir -p <span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span>

<span class="c1">### Test ob Backupverzeichnis existiert und Mail an Admin bei fehlschlagen ##</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">"</span><span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

mail -s <span class="s2">"Backupverzeichnis nicht vorhanden!"</span> root <span class="s">&lt;&lt;EOM</span>
<span class="s">Hallo Admin,</span>
<span class="s">das Backup am ${DATUM} konnte nicht erstellt werden. Das Verzeichnis ${BACKUPDIR} wurde nicht gefunden und konnte auch nicht angelegt werden.</span>
<span class="s">Mit freundlichem Gruss Backupscript</span>
<span class="s">EOM</span>

 . <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1">### Alle Variablen einlesen und letzte Backupdateinummer herausfinden ##</span>
<span class="nb">set</span> -- <span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span>/backup-???.tgz
<span class="nv">lastname</span><span class="o">=</span><span class="si">${</span><span class="p">!#</span><span class="si">}</span>
<span class="nv">backupnr</span><span class="o">=</span><span class="si">${</span><span class="nv">lastname</span><span class="p">##*backup-</span><span class="si">}</span>
<span class="nv">backupnr</span><span class="o">=</span><span class="si">${</span><span class="nv">backupnr</span><span class="p">%%.*</span><span class="si">}</span>
<span class="nv">backupnr</span><span class="o">=</span><span class="si">${</span><span class="nv">backupnr</span><span class="p">//</span><span class="se">\?</span><span class="p">/0</span><span class="si">}</span>
<span class="nv">backupnr</span><span class="o">=</span>$<span class="o">[</span><span class="m">10</span><span class="c1">#${backupnr}]</span>

<span class="c1">### Backupdateinummer automatisch um +1 bis maximal 30 erhoehen ##</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span>$<span class="s2">[backupnr++]"</span> -ge <span class="m">30</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
mkdir -p <span class="si">${</span><span class="nv">ROTATEDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATUM</span><span class="si">}</span>-<span class="si">${</span><span class="nv">ZEIT</span><span class="si">}</span>

<span class="c1">### Test ob Rotateverzeichnis existiert und Mail an Admin bei fehlschlagen ##</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">"</span><span class="si">${</span><span class="nv">ROTATEDIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">DATUM</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">ZEIT</span><span class="si">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

mail -s <span class="s2">"Rotateverzeichnis nicht vorhanden!"</span> root <span class="s">&lt;&lt;EOM</span>
<span class="s">Hallo Admin,</span>
<span class="s">die alten Backups konnten am ${DATUM} nicht verschoben werden. Das Verzeichnis ${ROTATEDIR} wurde nicht gefunden und konnte auch nicht angelegt werden.</span>
<span class="s">Mit freundlichem Gruss Backupscript</span>
<span class="s">EOM</span>

 . <span class="nb">exit</span> <span class="m">1</span>
<span class="k">else</span>
<span class="c1">### alter Code: mv ${BACKUPDIR}/* ${ROTATEDIR}/${DATUM}-${ZEIT}  Damit verschiebt er die Dateien in sich selbst weil rotate ein Unterverzeichnis von backup ist. Es kommt zur Fehlermeldung ##</span>
<span class="c1">### /b* und /t* weil die Dateien nur mit b und t beginnen ##</span>
mv <span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span>/b* <span class="si">${</span><span class="nv">ROTATEDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATUM</span><span class="si">}</span>-<span class="si">${</span><span class="nv">ZEIT</span><span class="si">}</span> 
mv <span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span>/t* <span class="si">${</span><span class="nv">ROTATEDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">DATUM</span><span class="si">}</span>-<span class="si">${</span><span class="nv">ZEIT</span><span class="si">}</span> 
<span class="k">fi</span>

<span class="c1">### Abfragen ob das Backupverschieben erfolgreich war ##</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

mail -s <span class="s2">"Backupverschieben fehlerhaft!"</span> root <span class="s">&lt;&lt;EOM</span>
<span class="s">Hallo Admin,</span>
<span class="s">die alten Backups konnte am ${DATUM} nicht verschoben werden.</span>
<span class="s">Mit freundlichem Gruss Backupscript</span>
<span class="s">EOM</span>

<span class="nb">exit</span> <span class="m">1</span>
<span class="k">else</span>

mail -s <span class="s2">"Backupverschieben erfolgreich"</span> root <span class="s">&lt;&lt;EOM</span>
<span class="s">Hallo Admin,</span>
<span class="s">die alten Backups wurde am ${DATUM} erfolgreich nach ${ROTATEDIR}/${DATUM}-${ZEIT} verschoben.</span>
<span class="s">Mit freundlichem Gruss Backupscript</span>
<span class="s">EOM</span>

<span class="c1">### die Backupnummer wieder auf 1 stellen ##</span>
<span class="nv">backupnr</span><span class="o">=</span><span class="m">1</span> 
<span class="k">fi</span> 
<span class="k">fi</span>

<span class="nv">backupnr</span><span class="o">=</span><span class="m">000</span><span class="si">${</span><span class="nv">backupnr</span><span class="si">}</span>
<span class="nv">backupnr</span><span class="o">=</span><span class="si">${</span><span class="nv">backupnr</span><span class="p">: -3</span><span class="si">}</span>
<span class="nv">filename</span><span class="o">=</span>backup-<span class="si">${</span><span class="nv">backupnr</span><span class="si">}</span>.tgz

<span class="c1">### Nun wird das eigentliche Backup ausgefuehrt ##</span>
tar -cpzf <span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">filename</span><span class="si">}</span> -g <span class="si">${</span><span class="nv">BACKUPDIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">TIMESTAMP</span><span class="si">}</span> <span class="si">${</span><span class="nv">SOURCE</span><span class="si">}</span> <span class="si">${</span><span class="nv">EXCLUDE</span><span class="si">}</span>

<span class="c1">### Abfragen ob das Backup erfolgreich war ##</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

mail -s <span class="s2">"Backup (</span><span class="si">${</span><span class="nv">SOURCE</span><span class="si">}</span><span class="s2">) war fehlerhaft!"</span> root <span class="s">&lt;&lt;EOM</span>
<span class="s">Hallo Admin,</span>
<span class="s">das Backup ${filename} am ${DATUM} wurde mit Fehler(n) beendet.</span>
<span class="s">Mit freundlichem Gruss Backupscript</span>
<span class="s">EOM</span>

<span class="k">else</span>

mail -s <span class="s2">"Backup (</span><span class="si">${</span><span class="nv">SOURCE</span><span class="si">}</span><span class="s2">) war erfolgreich"</span> root <span class="s">&lt;&lt;EOM</span>
<span class="s">Hallo Admin,</span>
<span class="s">das Backup ${filename} am ${DATUM} wurde erfolgreich beendet.</span>
<span class="s">Mit freundlichem Gruss Backupscript</span>
<span class="s">EOM</span>

<span class="k">fi</span>
</pre></div>
</td></tr></table></div></div><div class="section_1"><h2 id="Erklaerungen">Erklärungen<a class="headerlink" href="#Erklaerungen">¶</a></h2><p>
Die wenigen Einstellungen, welche man im Skript vornehmen muss, sind eigentlich hinreichend beschrieben. Wichtig sind:</p><ul><li><p><code class="notranslate">BACKUPDIR="media/backup"</code> - Pfad zum Backupverzeichnis </p></li><li><p><code class="notranslate">ROTATEDIR="media/backup/rotate"</code> - Pfad, wo die Backups nach 30 Tagen konserviert werden </p></li><li><p><code class="notranslate">SOURCE="home/user" </code> - Verzeichnis(se), welche(s) gesichert werden soll(en) </p></li></ul><p>
Weiterhin sollte man die Unterverzeichnisse des Source-Verzeichnisses, welche nicht gesichert werden sollen anpassen.</p><ul><li><p><code class="notranslate">EXCLUDE="--exclude=home/user/Filme  ........ "</code> </p></li></ul><p>
Das Skript speichert man im Homeverzeichnis unter dem Namen <strong>backup</strong>. Der Dateiname darf keine Punkte enthalten, sonst wird das Script von Anacron nicht regelmäßig automatisch ausgeführt!</p><p>Wie das <a class="external" href="http://www.gnu.org/software/tar/manual/html_chapter/Backups.html#SEC94" rel="nofollow">tar-Handbuch</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> empfiehlt, sollte man beim Backup eines <a class="internal" href="../logical_volume_manager.html#Snapshot-eines-Logical-Volumes-anlegen">LVM-Snapshots</a> mit <a class="internal" href="../tar.html">tar</a> die Option <code class="notranslate">--no-check-device</code> übergeben. Möchte man den Inhalt von <a class="internal" href="../mount.html">Mountpoints</a>, die auf andere Dateisysteme zeigen, nicht sichern, so fügt man die Option <code class="notranslate">--one-file-system</code> hinzu; diese Option kann z.B. für Backups des gesamten Dateisystems, also von <code class="notranslate">/</code> benutzt werden, um temporäre Dateisysteme wie <code class="notranslate">/proc</code> auszuschließen. All diese Optionen sollten vor <code class="notranslate">-czf</code> stehen, da nach <code class="notranslate">f</code> der Dateiname des Backups folgen muss.</p></div><div class="section_1"><h2 id="Bereit-zum-Ausfuehren">Bereit zum Ausführen<a class="headerlink" href="#Bereit-zum-Ausfuehren">¶</a></h2><p>
Nun wird ein Terminal geöffnet <sup><a href="#source-1">[1]</a></sup> und das Skript ausführbar gemacht <sup><a href="#source-3">[3]</a></sup></p><div class="bash"><div class="contents"><pre class="notranslate">sudo chmod +x ~/backup </pre></div></div><p>
Anschließend wird das Skript dann mit Root-Rechten verschoben, um es täglich automatisch ausführen zu lassen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mv backup /etc/cron.daily </pre></div></div><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Das Skript überprüft nicht, ob im Backupverzeichnis genügend freier Speicher vorhanden ist. Sollte der Platz zu gering sein, bricht das Skript mit einer Fehlermeldung ab. Wer sich keine automatische Statusmail schicken lässt, sollte daher immer mal das Backupverzeichnis kontrollieren. 
</p></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Alle 30 Tage wird der Inhalt des Backupordners verschoben und ein neues Komplettbackup angelegt. Die "alten Backups" werden nicht automatisch gelöscht, sondern müssen bei Bedarf manuell gelöscht werden. Zu finden sind diese im <code class="notranslate">{ROTATEDIR}/{DATUM}</code>.
</p></div></div></div><div class="section_1"><h2 id="Daten-zuruecksichern">Daten zurücksichern<a class="headerlink" href="#Daten-zuruecksichern">¶</a></h2><p>
Das Backup wird erstellt, um im Ernstfall die Daten wiederherstellen zu können. Dies funktioniert dann ganz einfach per Terminal <sup><a href="#source-1">[1]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">BACKUPDIR=/media/backup   # Pfad zum Backupverzeichnis
cd / # Dies sollte trotz des Parameters -C ausgeführt werden, da ansonsten u. U. mittlerweile gelöschte Dateien eines inkrementellen Backups dennoch wiederhergestellt werden.
for archiv in ${BACKUPDIR}/backup-*.tgz; do
tar --listed-incremental=/dev/null -xpzf $archiv -C /
done </pre></div></div><p>Erfolgt die Wiederherstellung nicht vom ursprünglichen System aus, sondern z.B. von einer Live-CD, sollte man den Parameter <code class="notranslate">--numeric-owner</code> in Betracht ziehen.</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>tar löscht alle Dateien, die zum Zeitpunkt der Sicherung nicht existiert haben!
</p></div></div><p>Wenn man dies als eine ausführbare Datei <sup><a href="#source-3">[3]</a></sup> speichert (z.B. <strong>ruecksicher.sh</strong>), so kann man später einfach per Terminal <sup><a href="#source-1">[1]</a></sup> die Daten wiederherstellen:</p><div class="bash"><div class="contents"><pre class="notranslate">chmod +x ./ruecksicher.sh # vor dem ersten Ausführen
./ruecksicher.sh </pre></div></div><p>Will man nur einzelne Dateien zurücksichern, so bedient man sich des folgenden Tricks. Dies ist notwendig, da mit inkrementellen Backups gearbeitet wird und die letzte Sicherung der verlorenen Datei benötigt wird.</p><ol class="arabic"><li><p>Zuerst sucht man die Datei: </p><div class="bash"><div class="contents"><pre class="notranslate">BACKUPDIR=media/backup
ls -l ${BACKUPDIR}
for archiv in ${BACKUPDIR}/backup-*.tgz; do
tar -tzf $archiv -C / | grep Name_der_Datei;
done </pre></div></div></li><li><p>Nun merkt man sich den Pfad und stellt die Datei wieder her: </p><div class="bash"><div class="contents"><pre class="notranslate">for archiv in ${BACKUPDIR}/backup-*.tgz; do
tar -xpzf $archiv -C /   home/user/pfad/zur/datei/Name_der_Datei
done </pre></div></div><p> Die Datei wird nun im ursprünglichem Pfad wiederhergestellt.</p></li></ol><p>
</p></div><div class="section_1"><h2 id="Probleme-bei-Backup-Quellen-die-ueber-Samba-CIFS-oder-NFS-eingebunden-werden">Probleme bei Backup Quellen, die über Samba/CIFS oder NFS eingebunden werden<a class="headerlink" href="#Probleme-bei-Backup-Quellen-die-ueber-Samba-CIFS-oder-NFS-eingebunden-werden">¶</a></h2><p>
Nach einem Neustart des Systems kann es vorkommen, dass tar wieder ein komplettes Backup macht, anstatt nur die Änderungen zu speichern, wenn die Backupquelle über Samba/CIFS oder NFS eingebunden ist. Dies liegt daran, dass tar Metadaten in den Snapshot Dateien speichert, die die Device Nummern enthalten. Diese können sich nach einem Kernel Update oder gerade bei Netzwerkquellen nach einem Neustart ändern. tar kann gezwungen werden, diese Information zu ignorieren. Dies geschieht über die Angabe der Option <code class="notranslate">--no-check-device</code> beim Programmaufruf.</p></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="external" href="http://www.gnu.org/software/tar/manual/html_chapter/Backups.html#SEC94" rel="nofollow">Using tar to Perform Incremental Dumps</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> im tar-Handbuch</p></li><li><p><a class="interwiki interwiki-ubuntu_doc" href="https://help.ubuntu.com/community/BackupYourSystem/TAR#Backing_Up">Backup Your System - tar</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> - nützliche tar-Parameter im englischen Ubuntu-Wiki</p></li></ul><p></p></div></div>
<p class="meta">
<a href="../skripte/inkrementelles_backup/a/revision/944618.html">Diese Revision</a> wurde am 31. Oktober 2017 21:30 von <a href="https://ubuntuusers.de/user/noisefloor/">noisefloor</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../startseite.html">Wiki</a></li>
<li><a href="../skripte.html">Skripte</a></li>
<li><a href="../skripte/inkrementelles_backup.html">inkrementelles Backup</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>