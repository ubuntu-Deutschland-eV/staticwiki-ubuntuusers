<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Skripte/AutoSuspend › ubuntuusers statisches Wiki</title>
<link href="../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../skripte/autosuspend.html">AutoSuspend</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Skripte/AutoSuspend">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../wiki/index.html">Index</a></li>
<li><a href="../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../wiki.html">Übersicht</a></li>
<li><a href="../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../kategorien.html">Kategorie</a></li>
<li><a href="../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../howto.html">Howto anlegen</a></li>
<li><a href="../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../baustelle.html">Baustellen</a></li>
<li><a href="../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../skripte/autosuspend/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../skripte/autosuspend/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../skripte/autosuspend/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../skripte/autosuspend/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../skripte/autosuspend/a/backlinks.html">AutoSuspend</a></h1>
<div id="page"><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="../pakete_installieren.html">Installation von Programmen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="../editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="../sudo.html">Root-Rechte</a></p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="../terminal.html">Ein Terminal öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-5" id="source-5"></a> <a class="internal" href="../rechte.html">Rechte für Dateien und Ordner ändern</a> </p></li></ol></div></div><div class="toc toc-depth-3"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Vorbereitungen">Vorbereitungen
</a><ol class="arabic"><li><a class="crosslink" href="#Konfigurationsdateien">Konfigurationsdateien
</a></li><li><a class="crosslink" href="#Das-Skript">Das Skript
</a></li><li><a class="crosslink" href="#Per-Cronjob-ausfuehren">Per Cronjob ausführen
</a></li></ol></li><li><a class="crosslink" href="#Funktionen">Funktionen
</a></li><li><a class="crosslink" href="#Konfiguration">Konfiguration
</a><ol class="arabic"><li><a class="crosslink" href="#Dauerlauf-erzwingen">Dauerlauf erzwingen
</a></li><li><a class="crosslink" href="#Den-Computer-regelmaessig-neustarten">Den Computer regelmäßig neustarten
</a></li><li><a class="crosslink" href="#Tagsueber-nicht-abschalten">Tagsüber nicht abschalten
</a></li><li><a class="crosslink" href="#Weitere-Parameter">Weitere Parameter
</a></li><li><a class="crosslink" href="#Den-Rechner-zu-bestimmten-Zeiten-reaktivieren">Den Rechner zu bestimmten Zeiten reaktiv...</a></li></ol></li><li><a class="crosslink" href="#Log-Datei-ueber-Suspends-und-Resumes">Log-Datei über Suspends und Resumes
</a></li><li><a class="crosslink" href="#Server-durch-andere-Computer-reaktivieren">Server durch andere Computer reaktivieren
</a><ol class="arabic"><li><a class="crosslink" href="#Ubuntu-Clients">Ubuntu-Clients
</a><ol class="arabic"><li><a class="crosslink" href="#Schritt-1">Schritt 1
</a></li><li><a class="crosslink" href="#Schritt-2">Schritt 2
</a></li><li><a class="crosslink" href="#Schritt-3">Schritt 3
</a></li><li><a class="crosslink" href="#Schritt-4">Schritt 4
</a></li></ol></li><li><a class="crosslink" href="#Windows-Clients">Windows-Clients
</a></li></ol></li></ol></div><p>Dieses AutoSuspend-Skript versetzt den Computer bei Nichtbenutzung automatisch in den Standby-Modus (je nach Verfügbarkeit: Hybrid-Standby, Suspend-To-RAM oder Suspend-To-Disk). Es kann so helfen, Strom zu sparen, da beispielsweise ein Heimserver meist nur zu bestimmten Zeiten genutzt, aber aufgrund des hohen Aufwandes auch ungern heruntergefahren wird.
Das Skript ist darüber hinaus in der Lage ‒ sofern das System dies unterstützt ‒ den Computer automatisch per <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/ACPI">ACPI</a> zu bestimmten Zeiten wieder aufzuwecken. Soll der Computer in regelmäßigen Abständen neu gestartet werden, so kann dieses Skript auch einen wöchentlichen Reboot durchführen. (Weitere Informationen zum ACPI-Wakeup finden sich im <a class="external" href="http://www.vdr-wiki.de/wiki/index.php/ACPI_Wakeup" rel="nofollow">vdr-Wiki</a> <img alt="{de}" src="../_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/>.)
Nutzt man zusätzlich <a class="internal" href="../wake_on_lan.html">Wake-on-LAN</a>, kann das Aufwecken auch bei Bedarf erfolgen.</p><p>Bei diesem Skript handelt es sich um eine modifzierte bzw. erweiterte Version des <a class="internal" href="../skripte/auto_off.html">Auto OFF</a>-Skriptes.</p><div class="section_1"><h2 id="Vorbereitungen">Vorbereitungen<a class="headerlink" href="#Vorbereitungen">¶</a></h2><p>
Damit das Skript genutzt werden kann, wird das vorinstallierte Paket</p><ul><li><p><strong>pm-utils</strong></p></li></ul><p>benötigt (siehe auch <a class="internal" href="../pm-utils.html">pm-utils</a>).</p><div class="section_2"><h3 id="Konfigurationsdateien">Konfigurationsdateien<a class="headerlink" href="#Konfigurationsdateien">¶</a></h3><p>
Das Skript benötigt zwei Konfigurationsdateien in <strong>/etc</strong>.</p><p>Zunächst wird <strong>/etc/autosuspend</strong> in einem Editor<sup><a href="#source-2">[2]</a></sup> mit Rootrechten<sup><a href="#source-3">[3]</a></sup> angelegt. Diese Datei dient der benutzerspezifischen Konfiguration des Skriptes.</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="c1"># Turn on auto suspend</span>
<span class="nv">AUTO_SUSPEND</span><span class="o">=</span><span class="s1">'yes'</span>

<span class="c1"># Turning suspend by day (8 a.m. to 3 a.m.) off</span>
<span class="nv">DONT_SUSPEND_BY_DAY</span><span class="o">=</span><span class="s1">'no'</span>

<span class="c1"># Automatically reboot once a week when the system isn't in use</span>
<span class="nv">REBOOT_ONCE_PER_WEEK</span><span class="o">=</span><span class="s1">'yes'</span>

<span class="c1"># Daemons that always have one process running, only if more that one process is active we prevent the suspend</span>
<span class="c1"># The values are used with grep, so just a unique portion is sufficient</span>
<span class="nv">DAEMONS</span><span class="o">=</span><span class="s1">''</span>

<span class="c1"># Important applications that shall prevent the suspend</span>
<span class="c1"># The values are used with grep, so just a unique portion is sufficient</span>
<span class="nv">APPLICATIONS</span><span class="o">=</span><span class="s1">'"^nxagent$" "^rsnapshot$" "^wsus$" "^wget$" "^screen$" "^mlnetp$" "^apt-get$" "^aptitude$" "^dpkg$" "^cp$"'</span>

<span class="c1"># Network IP range for checking any open samba connections</span>
<span class="c1"># The value is used with grep, so just a unique portion is sufficient</span>
<span class="nv">SAMBANETWORK</span><span class="o">=</span><span class="s1">'192.168.1.'</span>

<span class="c1"># Names or IP for computers that shall prevent the suspend</span>
<span class="c1"># We ping these computers in the list to check whether they are active.</span>
<span class="nv">CLIENTS</span><span class="o">=</span><span class="s1">'COMPUTER1 COMPUTER2'</span>
</pre></div>
</td></tr></table></div><p>Dann muss noch <strong>/etc/autosuspend_resumeplan</strong> erzeugt werden, diese Datei kann leer sein und daher mithilfe von <a class="internal" href="../touch.html">touch</a> erstellt werden<sup><a href="#source-4">[4]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo touch /etc/autosuspend_resumeplan </pre></div></div></div><div class="section_2"><h3 id="Das-Skript">Das Skript<a class="headerlink" href="#Das-Skript">¶</a></h3><p>
Das Skript wird als <strong>/usr/local/sbin/autosuspend.sh</strong> abgelegt:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>

. /etc/autosuspend

logit<span class="o">()</span>
<span class="o">{</span>
	logger -p local0.notice -s -- AutoSuspend: <span class="nv">$*</span>
	<span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

IsOnline<span class="o">()</span>
<span class="o">{</span>
	<span class="k">for</span> i in <span class="nv">$*</span><span class="p">;</span> <span class="k">do</span>
		ping <span class="nv">$i</span> -c1
		<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		  logit <span class="s2">"PC </span><span class="nv">$i</span><span class="s2"> is still active, auto suspend terminated"</span>
		  <span class="k">return</span> <span class="m">1</span>
		<span class="k">fi</span>
	<span class="k">done</span>
	<span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

IsRunning<span class="o">()</span>
<span class="o">{</span>
	<span class="k">for</span> i in <span class="nv">$*</span><span class="p">;</span> <span class="k">do</span>
		<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>pgrep -c <span class="nv">$i</span><span class="sb">`</span> -gt <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
			logit <span class="s2">"</span><span class="nv">$i</span><span class="s2"> still active, auto suspend terminated"</span>
			<span class="k">return</span> <span class="m">1</span>
		<span class="k">fi</span>
	<span class="k">done</span>
	<span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

IsDaemonActive<span class="o">()</span>
<span class="o">{</span>
	<span class="k">for</span> i in <span class="nv">$*</span><span class="p">;</span> <span class="k">do</span>
		<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>pgrep -c <span class="nv">$i</span><span class="sb">`</span> -gt <span class="m">1</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
			logit <span class="s2">"</span><span class="nv">$i</span><span class="s2"> still active, auto suspend terminated"</span>
			<span class="k">return</span> <span class="m">1</span>
		<span class="k">fi</span>
	<span class="k">done</span>
	<span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

IsBusy<span class="o">()</span>
<span class="o">{</span>
	<span class="c1"># Samba</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">"x</span><span class="nv">$SAMBANETWORK</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"x"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		<span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>/usr/bin/smbstatus -b <span class="p">|</span> grep <span class="nv">$SAMBANETWORK</span> <span class="p">|</span> wc -l <span class="sb">`</span> !<span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		  logit <span class="s2">"samba connected, auto suspend terminated"</span>
		  <span class="k">return</span> <span class="m">1</span>
		<span class="k">fi</span>
	<span class="k">fi</span>

	<span class="c1">#daemons that always have one process running</span>
	IsDaemonActive <span class="nv">$DAEMONS</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		<span class="k">return</span> <span class="m">1</span>
	<span class="k">fi</span>

	<span class="c1">#backuppc, wget, wsus, ....</span>
	IsRunning <span class="nv">$APPLICATIONS</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
			<span class="k">return</span> <span class="m">1</span>
	<span class="k">fi</span>

	<span class="c1"># Read logged users</span>
	<span class="nv">USERCOUNT</span><span class="o">=</span><span class="sb">`</span>who <span class="p">|</span> wc -l<span class="sb">`</span><span class="p">;</span>
	<span class="c1"># No Suspend if there are any users logged in</span>
	<span class="nb">test</span> <span class="nv">$USERCOUNT</span> -gt <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="o">{</span> logit <span class="s2">"some users still connected, auto suspend terminated"</span><span class="p">;</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span> <span class="o">}</span>

	IsOnline <span class="nv">$CLIENTS</span>
	<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		<span class="k">return</span> <span class="m">1</span>
	<span class="k">fi</span>

	<span class="k">return</span> <span class="m">0</span>
<span class="o">}</span>

<span class="nv">COUNTFILE</span><span class="o">=</span><span class="s2">"/var/spool/suspend_counter"</span>
<span class="nv">OFFFILE</span><span class="o">=</span><span class="s2">"/var/spool/suspend_off"</span>

<span class="c1"># turns off the auto suspend</span>
<span class="k">if</span> <span class="o">[</span> -e <span class="nv">$OFFFILE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
	logit <span class="s2">"auto suspend is turned off by existents of </span><span class="nv">$OFFFILE</span><span class="s2">"</span>
	<span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$AUTO_SUSPEND</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"true"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$AUTO_SUSPEND</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"yes"</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
	IsBusy
	<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		<span class="c1"># was it not busy already last time? Then suspend.</span>
		<span class="k">if</span> <span class="o">[</span> -e <span class="nv">$COUNTFILE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
			<span class="c1"># only auto-suspend at night</span>
			<span class="k">if</span> <span class="o">[</span> <span class="se">\(</span> <span class="s2">"</span><span class="nv">$DONT_SUSPEND_BY_DAY</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"true"</span> -a <span class="s2">"</span><span class="nv">$DONT_SUSPEND_BY_DAY</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"yes"</span> <span class="se">\)</span> -o <span class="se">\(</span> <span class="s2">"`date +%H`"</span> -ge <span class="s2">"3"</span> -a <span class="s2">"`date +%H`"</span> -lt <span class="s2">"8"</span> <span class="se">\)</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
				<span class="c1"># notice resume-plan</span>
				<span class="nv">NEXTWAKE</span><span class="o">=</span><span class="s2">"0"</span>
				<span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
					<span class="k">if</span> <span class="o">[</span> <span class="s2">"`date +%s -d \"</span><span class="nv">$line</span><span class="s2">\"`"</span> -gt <span class="s2">"`date +%s`"</span> -a  <span class="se">\(</span> <span class="s2">"`date +%s -d \"</span><span class="nv">$line</span><span class="s2">\"`"</span> -lt <span class="s2">"</span><span class="nv">$NEXTWAKE</span><span class="s2">"</span> -o <span class="s2">"</span><span class="nv">$NEXTWAKE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="se">\)</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
						<span class="nv">NEXTWAKE</span><span class="o">=</span><span class="s2">"`date +%s -d \"</span><span class="nv">$line</span><span class="s2">\"`"</span>
					<span class="k">fi</span>
				<span class="k">done</span> &lt; /etc/autosuspend_resumeplan
				<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$NEXTWAKE</span><span class="s2">"</span> -gt <span class="s2">"`date +%s`"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
					<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$NEXTWAKE</span><span class="s2">"</span> -gt <span class="s2">"`expr \"\`date +%s\`\" + 1800`"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
						<span class="nb">echo</span> <span class="s2">"0"</span> &gt; /sys/class/rtc/rtc0/wakealarm
						<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$NEXTWAKE</span><span class="s2">"</span> &gt; /sys/class/rtc/rtc0/wakealarm
						logit <span class="s2">"will resume at </span><span class="nv">$NEXTWAKE</span><span class="s2">"</span>
					<span class="k">else</span>
						logit <span class="s2">"do not suspend because would have been awaken within next 30 minutes"</span>
						<span class="nb">exit</span> <span class="m">0</span>
					<span class="k">fi</span>
				<span class="k">fi</span>
				<span class="c1"># and suspend or reboot:</span>
				rm -f <span class="nv">$COUNTFILE</span>
				<span class="k">if</span> <span class="o">[</span> <span class="se">\(</span> <span class="s2">"</span><span class="nv">$REBOOT_ONCE_PER_WEEK</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"true"</span> -o <span class="s2">"</span><span class="nv">$REBOOT_ONCE_PER_WEEK</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"yes"</span> <span class="se">\)</span> -a <span class="s2">"`echo \"scale=2; ( \`cat /proc/uptime | cut -d' ' -f1-1\` / 3600 / 24 ) &gt;= 7\" | bc`"</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
					logit <span class="s2">"REBOOTING THE MACHINE BECAUSE IT HAS BEEN RUNNING FOR MORE THAN A WEEK"</span>
					shutdown -r now
				<span class="k">else</span>
					logit <span class="s2">"AUTO SUSPEND CAUSED"</span>
					<span class="o">(</span> <span class="nb">test</span> ! -x <span class="s2">"/usr/bin/pm-is-supported"</span> <span class="o">&amp;&amp;</span> <span class="o">(</span> logit <span class="s2">"cannot check the system's suspend ability. aborting"</span> <span class="o">||</span> /bin/true <span class="o">)</span> <span class="o">)</span> <span class="o">||</span> <span class="se">\</span>
					<span class="o">(</span> /usr/bin/pm-is-supported --suspend-hybrid <span class="o">&amp;&amp;</span> /usr/sbin/pm-suspend-hybrid <span class="o">)</span> <span class="o">||</span> <span class="se">\</span>
					<span class="o">(</span> /usr/bin/pm-is-supported --suspend <span class="o">&amp;&amp;</span> /usr/sbin/pm-suspend <span class="o">)</span> <span class="o">||</span> <span class="se">\</span>
					<span class="o">(</span> /usr/bin/pm-is-supported --hibernate <span class="o">&amp;&amp;</span> /usr/sbin/pm-hibernate <span class="o">)</span> <span class="o">||</span> <span class="se">\</span>
					logit <span class="s2">"NEITHER SUSPEND NOR RESUME ARE NOT SUPPORTED BY THIS SYSTEM!!! aborting"</span>
				<span class="k">fi</span>
			<span class="k">else</span>
				logit <span class="s2">"did not auto suspend because it is broad day"</span>
			<span class="k">fi</span>
			<span class="nb">exit</span> <span class="m">0</span>
		<span class="k">else</span>
			<span class="c1"># shut down next time</span>
			touch <span class="nv">$COUNTFILE</span>
			logit <span class="s2">"marked for suspend in next try"</span>
			<span class="nb">exit</span> <span class="m">0</span>
		<span class="k">fi</span>
	<span class="k">else</span>
		rm -f <span class="nv">$COUNTFILE</span>
		logit <span class="s2">"aborted"</span>
		<span class="nb">exit</span> <span class="m">0</span>
	<span class="k">fi</span>
<span class="k">fi</span>

logit <span class="s2">"malfunction"</span>
<span class="nb">exit</span> <span class="m">1</span>
</pre></div>
</td></tr></table></div><p>Es muss ausführbar<sup><a href="#source-5">[5]</a></sup> gemacht werden, z.B. mit:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo chown root:root /usr/local/sbin/autosuspend.sh
sudo chmod u+x /usr/local/sbin/autosuspend.sh </pre></div></div></div><div class="section_2"><h3 id="Per-Cronjob-ausfuehren">Per Cronjob ausführen<a class="headerlink" href="#Per-Cronjob-ausfuehren">¶</a></h3><p>
Nun muss noch ein <a class="internal" href="../cron.html">Cronjob</a> angelegt werden, damit das Skript überhaupt aufgerufen wird. Hier im Beispiel wird das Skript viertelstündig gestartet, der Computer würde also nach einer halben Stunde Inaktivität in den Standby versetzt (respektive neugestartet).</p><p>Zum Erstellen des Cronjobs kann folgender Befehl genutzt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">echo "*/15 * * * * root /usr/local/sbin/autosuspend.sh" | sudo tee -a /etc/crontab </pre></div></div></div></div><div class="section_1"><h2 id="Funktionen">Funktionen<a class="headerlink" href="#Funktionen">¶</a></h2><p>
Das Skript kann prüfen, ob
</p><ul><li><p>bestimmte Programme laufen</p></li><li><p>bestimmte Dämonen aktiv sind</p></li><li><p>noch Samba Verbindungen aktiv sind</p></li><li><p>User eingeloggt sind</p></li><li><p>andere PCs noch eingeschaltet sind</p></li></ul><p><a class="internal" href="../nfs.html">NFS</a> wird nicht auf aktive Verbindungen überwacht. Man kann sich behelfen, indem stattdessen geprüft wird, ob der Client-PC eingeschaltet ist.</p></div><div class="section_1"><h2 id="Konfiguration">Konfiguration<a class="headerlink" href="#Konfiguration">¶</a></h2><p>
</p><div class="section_2"><h3 id="Dauerlauf-erzwingen">Dauerlauf erzwingen<a class="headerlink" href="#Dauerlauf-erzwingen">¶</a></h3><p>
Die automatische Versetzung des Computers in den Standbymodus (das automatische Neustarten) kann auf folgende Weisen verhindert werden:
</p><ul><li><p>Indem die Datei <strong>/var/spool/suspend_off</strong> erzeugt wird. (siehe <code class="notranslate">man touch</code>)</p></li><li><p>In der Konfigurationsdatei <strong>/etc/autosuspend</strong> den Schalter <code class="notranslate">AUTO_SUSPEND=no</code> aufnehmen.</p></li></ul><p>
</p></div><div class="section_2"><h3 id="Den-Computer-regelmaessig-neustarten">Den Computer regelmäßig neustarten<a class="headerlink" href="#Den-Computer-regelmaessig-neustarten">¶</a></h3><p>
Setzt man in der Konfigurationsdatei <strong>/etc/autosuspend</strong> den Schalter <code class="notranslate">REBOOT_ONCE_PER_WEEK</code> auf <code class="notranslate">yes</code>, wird der Computer nicht in den Standby versetzt, sondern stattdessen neugestartet, wenn er bereits länger als eine Woche läuft.</p></div><div class="section_2"><h3 id="Tagsueber-nicht-abschalten">Tagsüber nicht abschalten<a class="headerlink" href="#Tagsueber-nicht-abschalten">¶</a></h3><p>
Ist in der o.g. Konfigurationsdatei der Schalter <code class="notranslate">DONT_SUSPEND_BY_DAY=yes</code> gesetzt, wird der Computer nur zwischen 3 Uhr und 8 Uhr in den Standby versetzt, damit er tagsüber schnell zur Verfügung steht (und ggf. Komponenten wie Festplatten nicht ständig ein- und ausgeschaltet werden).</p></div><div class="section_2"><h3 id="Weitere-Parameter">Weitere Parameter<a class="headerlink" href="#Weitere-Parameter">¶</a></h3><p>
Erklärung der weiteren Schalter in der Datei <strong>/etc/autosuspend</strong>:</p><p>
</p><table><tr class="kopf"><td> Schalter </td><td> Erklärung </td></tr><tr><td> <code class="notranslate">DAEMONS</code> </td><td> Hier kann eine Liste von Dämonen eingetragen werden, die den Standby-Modus (das Herunterfahren) verhindern sollen. Damit dies geschieht, müssen jedoch mindestens zwei Instanzen dieser Programme aktiv sein. Die Prüfung erfolgt mit <code class="notranslate">grep</code>, sodass auch reguläre Ausdrücke möglich sind. </td></tr><tr><td> <code class="notranslate">APPLICATIONS</code> </td><td> Hier kann eine Liste von Programmen eingetragen werden, die den Standby-Modus (das Herunterfahren) verhindern sollen. Die Prüfung erfolgt mit <code class="notranslate">grep</code>, sodass auch reguläre Ausdrücke möglich sind. </td></tr><tr><td> <code class="notranslate">SAMBANETWORK</code> </td><td> Hier kann ein Netzwerk eingetragen werden, das auf Samba-Verbindungen geprüft wird. Die Prüfung erfolgt mithilfe von <code class="notranslate">grep</code>, sodass ein Teil der Netzwerk-Adresse (z.B. <code class="notranslate">192.168.1.</code>) oder ein von unterstützter regulärer Ausdruck eingetragen werden muss. Eine geöffnete Samba-Verbindung verhindert, dass der Rechner in den Standby-Modus versetzt (heruntergefahren) wird. </td></tr><tr><td> <code class="notranslate">CLIENTS</code> </td><td> Enthält eine Liste von Rechnern, deren Zustand automatisch per Ping geprüft wird. Ist noch einer von ihnen aktiv, wird der Rechner nicht in den Standby-Modus versetzt (heruntergefahren). </td></tr></table></div><div class="section_2"><h3 id="Den-Rechner-zu-bestimmten-Zeiten-reaktivieren">Den Rechner zu bestimmten Zeiten reaktivieren<a class="headerlink" href="#Den-Rechner-zu-bestimmten-Zeiten-reaktivieren">¶</a></h3><p>
In der Datei <strong>/etc/autosuspend_resumeplan</strong> können Termine eingetragen werden, an denen der Computer aufwachen soll. Sie werden mithilfe von <code class="notranslate">date</code> geparst, müssen also im richtigen Format eingetragen werden. Beispiel:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>16:00
16:00 tomorrow
</pre></div>
</td></tr></table></div><p>Das Skript verwendet immer den frühsten in der Zukunft liegenden Termin. (Achtung: <code class="notranslate">16:00</code> wird von date, auch wenn es schon 17 Uhr ist, noch als "16 Uhr heute" interpretiert!)</p></div></div><div class="section_1"><h2 id="Log-Datei-ueber-Suspends-und-Resumes">Log-Datei über Suspends und Resumes<a class="headerlink" href="#Log-Datei-ueber-Suspends-und-Resumes">¶</a></h2><p>
Zwar erzeugt das Script bereits Einträge in <strong>/var/log/syslog</strong>, einige werden jedoch die Resume- und Suspend-Vorgänge separat loggen wollen. Mit den <code class="notranslate">pm-utils</code> geht das sehr einfach. Ein Beispiel-Skript ist auf <a class="external" href="http://askubuntu.com/questions/8112/how-do-i-detect-when-the-system-suspends/8124#8124" rel="nofollow">askubuntu.com</a> <img alt="{en}" src="../_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> verfügbar.</p></div><div class="section_1"><h2 id="Server-durch-andere-Computer-reaktivieren">Server durch andere Computer reaktivieren<a class="headerlink" href="#Server-durch-andere-Computer-reaktivieren">¶</a></h2><p>
Nun, da der Rechner durch das Skript automatisch in den Standby gesetzt wird, ist es sinnvoll, ihn automatisch zu reaktivieren, wenn andere Rechner auf ihn zugreifen sollen (sofern es sich um einen Server handelt).</p><div class="section_2"><h3 id="Ubuntu-Clients">Ubuntu-Clients<a class="headerlink" href="#Ubuntu-Clients">¶</a></h3><p>
Unter Ubuntu lässt sich das relativ einfach lösen.</p><div class="section_3"><h4 id="Schritt-1">Schritt 1<a class="headerlink" href="#Schritt-1">¶</a></h4><p>
Benötigtes Paket installieren:
</p><ul><li><p><strong>etherwake</strong> (<em>universe</em>)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="../_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="../apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install etherwake </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install etherwake </pre></div></div><p>
</p></div></div></div><div class="section_3"><h4 id="Schritt-2">Schritt 2<a class="headerlink" href="#Schritt-2">¶</a></h4><p>
Skript zum Aufwecken einrichten:</p><p>Hierzu muss die MAC-Adresse des Servers bekannt sein und für die Variable MAC eingetragen werden. Sie kann auf dem Server mithilfe von <code class="notranslate">ifconfig</code> ermittelt werden.
Gegebenfalls muss auch das Interface angepasst werden.</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">INTERFACE</span><span class="o">=</span><span class="s2">"eth0"</span>
<span class="nv">MAC</span><span class="o">=</span><span class="s2">"00:AA:BB:CC:DD:EE"</span>
etherwake -i <span class="s2">"</span><span class="nv">$INTERFACE</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$MAC</span><span class="s2">"</span>
</pre></div>
</td></tr></table></div><p>Dieses wird als <strong>/usr/local/sbin/wakeserver.sh</strong> gespeichert und für <code class="notranslate">root</code> ausführbar gemacht <sup><a href="#source-5">[5]</a></sup>.</p></div><div class="section_3"><h4 id="Schritt-3">Schritt 3<a class="headerlink" href="#Schritt-3">¶</a></h4><p>
Skript beim Systemstart aufrufen:</p><p>Hier zu muss in <strong>/etc/rc.local</strong> vor <code class="notranslate">exit 0</code> folgendes ergänzt werden:</p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span>/usr/local/sbin/wakeserver.sh
</pre></div>
</td></tr></table></div></div><div class="section_3"><h4 id="Schritt-4">Schritt 4<a class="headerlink" href="#Schritt-4">¶</a></h4><p>
Den Server nicht nur aufwecken, wenn der Client bootet, sondern auch wenn er selbst aus einem Standby erwacht:</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Hierfür wird die Verwendung von <a class="internal" href="../pm-utils.html"><code class="notranslate">pm-utils</code></a> vorausgesetzt.
</p></div></div><p>Der folgende Befehl erstellt automatisch eine Konfigurationsdatei für <code class="notranslate">pm-utils</code>, die das Skript auch beim Resume aufruft.</p><div class="bash"><div class="contents"><pre class="notranslate">echo -ne '#!/bin/sh\ncase "$1" in\n\tresume|thaw)\n\t\t/usr/local/sbin/wakeserver.sh\n\t\t;;\nesac\n' | sudo tee /etc/pm/sleep.d/90_wakeserver </pre></div></div><p>Sollte der Befehl mit Wlan nicht zufriedenstellend funktionieren, sei hiermit auf die Diskussion zum Artikel verwiesen.</p></div></div><div class="section_2"><h3 id="Windows-Clients">Windows-Clients<a class="headerlink" href="#Windows-Clients">¶</a></h3><p>
Für Windows Vista und Windows 7 existiert auf <a class="external" href="http://synthesis.tobiasquetschke.de/andere-rechner-aufwecken-wenn-ein-windows-7-c" rel="nofollow">tobiasqeutschke.de</a> <img alt="{de}" src="../_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> eine Anleitung, für Windows XP wird noch eine erstellt werden.</p><p></p></div></div></div>
<p class="meta">
<a href="../skripte/autosuspend/a/revision/567262.html">Diese Revision</a> wurde am 11. März 2013 01:49 von <a href="https://ubuntuusers.de/user/Lasall/">Lasall</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../startseite.html">Wiki</a></li>
<li><a href="../skripte.html">Skripte</a></li>
<li><a href="../skripte/autosuspend.html">AutoSuspend</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>