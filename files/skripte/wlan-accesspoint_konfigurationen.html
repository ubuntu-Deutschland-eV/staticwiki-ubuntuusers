<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Skripte/WLAN-Accesspoint_Konfigurationen › ubuntuusers statisches Wiki</title>
<link href="../_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="../_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="../_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="../_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="../_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="../_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="../startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="../skripte/wlan-accesspoint_konfigurationen.html">WLAN-Accesspoint Konfigurationen</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/Skripte/WLAN-Accesspoint_Konfigurationen">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="../wiki/index.html">Index</a></li>
<li><a href="../wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="../wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="../wiki.html">Übersicht</a></li>
<li><a href="../wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="../wiki/benutzung.html">Benutzung</a></li>
<li><a href="../kategorien.html">Kategorie</a></li>
<li><a href="../wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="../wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="../howto.html">Howto anlegen</a></li>
<li><a href="../wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="../wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="../baustelle.html">Baustellen</a></li>
<li><a href="../wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="../wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="../wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="../wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="../skripte/wlan-accesspoint_konfigurationen/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="../skripte/wlan-accesspoint_konfigurationen/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="../skripte/wlan-accesspoint_konfigurationen/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="../skripte/wlan-accesspoint_konfigurationen/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="../skripte/wlan-accesspoint_konfigurationen/a/backlinks.html">WLAN-Accesspoint Konfigurationen</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p> 
Dieser Artikel ist größtenteils für alle Ubuntu-Versionen gültig.
</p></div></div><p>
</p><p>
</p><div class="box advanced"><h3 class="box advanced">Artikel für fortgeschrittene Anwender</h3><div class="contents"><p>
Dieser Artikel erfordert mehr Erfahrung im Umgang mit
Linux und ist daher nur für fortgeschrittene Benutzer
gedacht.
</p></div></div><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="../pakete_installieren.html">Installation von Programmen</a></p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="../terminal.html">Ein Terminal öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="../editor.html">Einen Editor öffnen</a></p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="../programme_starten.html">Starten von Programmen</a></p></li><li><p><a class="crosslink anchor" href="#source-5" id="source-5"></a> <a class="internal" href="../sudo.html">Root-Rechte</a></p></li></ol></div></div><p><img alt="Wiki/Icons/terminal.png" class="image-left" src="../_/7c12231bc1c5c7f8a4664329a48760f274ec0394.png"/></p><div class="toc toc-depth-2"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Vorbereitungen">Vorbereitungen
</a><ol class="arabic"><li><a class="crosslink" href="#Programme-installieren">Programme installieren
</a></li><li><a class="crosslink" href="#Skript-anlegen">Skript anlegen
</a></li><li><a class="crosslink" href="#Skript-starten-und-beenden">Skript starten und beenden
</a></li><li><a class="crosslink" href="#Skript-konfigurieren">Skript konfigurieren
</a></li><li><a class="crosslink" href="#Dienste-konfigurieren">Dienste konfigurieren
</a></li><li><a class="crosslink" href="#Network-Manager-deaktivieren">Network-Manager deaktivieren
</a></li></ol></li><li><a class="crosslink" href="#Skripte">Skripte
</a><ol class="arabic"><li><a class="crosslink" href="#WLAN-Router-mit-Gast-Netzwerk">WLAN-Router mit Gast-Netzwerk
</a></li><li><a class="crosslink" href="#WLAN-Repeater">WLAN-Repeater
</a></li><li><a class="crosslink" href="#WLAN-Router-und-Proxyserver">WLAN-Router und Proxyserver
</a></li><li><a class="crosslink" href="#Tor-WLAN-Router-Onion-Router">Tor WLAN-Router (Onion-Router)
</a></li></ol></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p>In diesem Artikel werden verschiedene Skripte beschrieben, mit denen unter Ubuntu und auch anderen Linux-Distributionen bei Bedarf verschiedene WLAN-Router für diverse Einsatzszenarien konfiguriert werden können. Die jeweiligen Skripte wurden ebenfalls auf dem Raspberry Pi™ (Version <em>B</em>) ausgiebig getestet. Basisartikel dazu ist <a class="internal" href="../wlan_router.html">WLAN Router</a>.</p><p>Als Software werden beispielsweise <a class="internal" href="../squid.html">Squid</a>, <a class="internal" href="../privoxy.html">Privoxy</a>, <a class="internal" href="../wlan_router.html">hostapd:</a>, <a class="internal" href="../iptables2.html">iptables</a>, <a class="internal" href="../iw.html">iw</a>, <a class="internal" href="../isc-dhcpd.html">isc-dhcpd</a> und <a class="internal" href="../netzwerkbrücke.html">bridge-utils:</a> verwendet. Diese Wiki-Artikel dienen als Grundlage und sollten bekannt sein.</p><div class="section_1"><h2 id="Vorbereitungen">Vorbereitungen<a class="headerlink" href="#Vorbereitungen">¶</a></h2><p>
</p><div class="section_2"><h3 id="Programme-installieren">Programme installieren<a class="headerlink" href="#Programme-installieren">¶</a></h3><p>
Die für die genannten Skriptvarianten gezeigten Programme müssen natürlich zuvor installiert <sup><a href="#source-1">[1]</a></sup> und ggf. konfiguriert werden. Entsprechende Vorlagen sind hier angegeben. <em>skriptname.sh</em> ist durch den tatsächlich gewünschten Namen zu ersetzen.</p></div><div class="section_2"><h3 id="Skript-anlegen">Skript anlegen<a class="headerlink" href="#Skript-anlegen">¶</a></h3><p>
Anlegen und ausführbar machen eines Skripts über Terminal <sup><a href="#source-2">[2]</a></sup>:
</p><div class="bash"><div class="contents"><pre class="notranslate">touch skriptname.sh
chmod +x skriptname.sh  </pre></div></div><p>
Anschließend kann man das erzeugte Skript mit einem Editor <sup><a href="#source-3">[3]</a></sup> bearbeiten und den gewünschten Code hier kopieren und einfügen. Teilweise enthalten die Skripte Kennwörter im Klartext. Daher den Zugang zum verwendeten System und/oder die Zugriffsrechte entsprechend anpassen. Siehe auch <a class="internal" href="../chmod.html">chmod</a>.</p></div><div class="section_2"><h3 id="Skript-starten-und-beenden">Skript starten und beenden<a class="headerlink" href="#Skript-starten-und-beenden">¶</a></h3><p>
Die Skripte sind vom Grundgerüst her identisch aufgebaut. Verschiedene Startparameter sind möglich. Auch hier ist <em>skriptname.sh</em> durch den tatsächlich verwendeten Namen zu ersetzen.</p><p>Skript mit den gewünschten Startoptionen aufrufen <sup><a href="#source-4">[4]</a></sup><sup><a href="#source-5">[5]</a></sup>:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ./skriptname.sh -start          # startet das Skript und die Konfiguration
sudo ./skriptname.sh -stop           # startet das Skript, beendet die Konfiguration und die verwendeten Dienste
sudo ./skriptname.sh                 # ohne Option identisch wie -stop
sudo ./skriptname.sh -h              # gibt eine kurze Hilfe zur Syntax aus </pre></div></div></div><div class="section_2"><h3 id="Skript-konfigurieren">Skript konfigurieren<a class="headerlink" href="#Skript-konfigurieren">¶</a></h3><p>
Bei jedem Skript können verschiedene Optionen verändert und Variablen gesetzt werden. Diese sind durch Kommentarzeilen entsprechend beschrieben. Im Normalfall müssen nur bestimmte IP-Adressen des eigenen Routers, Gateways usw. angepasst werden.</p><p>Variablen und Optionen können im Skript im Bereich zwischen ...
</p><pre class="notranslate">## freie Variablen
...
...
## Ende freie Variablen</pre><p>
... bearbeitet und angepasst werden.</p></div><div class="section_2"><h3 id="Dienste-konfigurieren">Dienste konfigurieren<a class="headerlink" href="#Dienste-konfigurieren">¶</a></h3><p>
Alle hier verwendeten <a class="internal" href="../dienste.html">Dienste</a> wie z.B. Squid oder der isc-dhcpd-Server werden durch das jeweilige Skript gestartet und auch wieder beendet. Werden diese Dienste nicht direkt bei Systemstart benötigt, so sollte man diese grundsätzlich deaktivieren, um Speicher und Rechenleistung nicht unnötig zu verschwenden oder ungewollte Systemfunktionen zu vermeiden. Dies erfolgt über <a class="internal" href="../dienste.html">Runlevel</a>.</p><p>Dienste bei Systemstart deaktivieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-rc.d DIENST disable </pre></div></div><p>
Das entsprechende Beispiel, um Squid Version 3.x nicht automatisch bei Systemstart auszuführen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo update-rc.d squid3 disable </pre></div></div><p>
Für die jeweils benötigten und installierten Dienste geht man entsprechend vor.</p></div><div class="section_2"><h3 id="Network-Manager-deaktivieren">Network-Manager deaktivieren<a class="headerlink" href="#Network-Manager-deaktivieren">¶</a></h3><p>
Wer ein Skript auf einem Desktop-System mit grafischer Oberfläche und dem <a class="internal" href="../network-manager.html">Network-Manager</a> testen oder verwenden möchte, muss diesen vorab deaktivieren, ansonsten wird die Netzwerkkonfiguration des Systems blockiert. Bestehende Verbindungen werden dabei getrennt.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo service network-manager stop </pre></div></div><p>
Der Network-Manager kann anschließend wieder aktiviert werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo service network-manager start </pre></div></div></div></div><div class="section_1"><h2 id="Skripte">Skripte<a class="headerlink" href="#Skripte">¶</a></h2><p>
</p><div class="section_2"><h3 id="WLAN-Router-mit-Gast-Netzwerk">WLAN-Router mit Gast-Netzwerk<a class="headerlink" href="#WLAN-Router-mit-Gast-Netzwerk">¶</a></h3><p>
Erforderliche Programme:
</p><ul><li><p><a class="internal" href="../wlan_router.html">hostapd</a></p></li><li><p><a class="internal" href="../netzwerkbrücke.html">bridge-utils</a></p></li><li><p><a class="internal" href="../iw.html">iw</a></p></li></ul><p>
Funktionsbeschreibung:
</p><ul><li><p>LAN/WLAN-Router im Bridged-Mode</p><ul><li><p>Ethernetschnittstelle 1 verbindet zum vorhandenen Router (Internetanbindung)</p></li><li><p>WLAN-Accesspoint</p></li></ul></li></ul><p>
</p><ul><li><p>zweiter unabhängiger WLAN-Accesspoint mit eigenem Kennwort und eigenem IP-Adressbereich für einen Gast-Zugang</p><ul><li><p>Konfiguration mit einem (nicht alle Adapter bzw. Treiber unterstützen diese Funktion) oder zwei unabhängigen WLAN-Adaptern möglich</p></li><li><p>separater DHCP-Server für WLAN 2, also den Gast-Zugang (dnsmasq_base)</p></li><li><p>kein Zugriff auf WLAN-Netzwerk 1 und Ethernet 2 möglich (NAT/iptables)</p></li></ul></li></ul><p>
</p><ul><li><p>Ethernetschnittstelle 2 für das lokale Netzwerk (optional)</p></li><li><p>DHCP-Server für das WLAN-Netz 1 und Ethernet 2 bleibt der vorhandenen Router</p></li><li><p>alle Clients (WLAN 1 und Ethernet 1/2) befinden sich im selben Netzwerk (Bridge)</p></li></ul><p>
Erfolgreich getestet mit einem TP-Link TL-WN822N v1.1 USB WLAN-Adapter mit Atheros-Otus Chipsatz als einziger WLAN-Adapter. Geräte-ID: <code class="notranslate">0CF3:1002</code>, Treibermodul <code class="notranslate">carl9170</code>.</p><ul><li><p><strong>instant_AP-bridge_vWLAN.sh</strong>: </p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant WLAN Access-Point an Ethernet Router with transparent bridged interfaces and VLAN</span>
<span class="c1">## (WLAN-Guest Accesspoint)</span>
<span class="c1">## for Raspberry Pi™ with Raspian and other Linux based Systems</span>
<span class="c1">##</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2013</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 1.7.1.5bvw / 17. Oktober 2013</span>
<span class="c1">##</span>
<span class="c1">## have fun :-)</span>

<span class="c1">## freie Variablen</span>

<span class="c1">## Source-Interface / WAN-Schnittstelle</span>
<span class="c1">## durch die interfaces gesteuerte Schnittstelle für die Internetverbindung</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="c1">## Standard eth0 / Ethernet</span>
<span class="nv">sourceiface</span><span class="o">=</span>eth0

<span class="c1">## Bridge-Konfiguration</span>
<span class="nv">bridgeiface</span><span class="o">=</span>br0
<span class="nv">forward_delay</span><span class="o">=</span><span class="m">2</span>
<span class="nv">stp</span><span class="o">=</span><span class="m">1</span>
<span class="nv">brageing</span><span class="o">=</span><span class="m">10000</span>
<span class="nv">brage</span><span class="o">=</span><span class="m">40</span>

<span class="nv">braddress</span><span class="o">=</span><span class="m">192</span>.168.178.6
<span class="nv">brbroadcast</span><span class="o">=</span><span class="m">192</span>.168.178.255
<span class="nv">brnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">briptablemasq</span><span class="o">=</span><span class="m">192</span>.168.178.0/24

<span class="c1">## IP-Adresse des Routers/Gateway</span>
<span class="nv">wangateway</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">## manuelle DNS-Konfiguration aktiviert (1) oder deaktiviert (0) (Standard)</span>
<span class="nv">manDNS</span><span class="o">=</span><span class="m">0</span>

<span class="c1"># manuelle DNS-Konfiguration</span>
<span class="nv">sys_domain</span><span class="o">=</span><span class="s2">"domain fritz.box"</span>
<span class="nv">sys_search</span><span class="o">=</span><span class="s2">"search fritz.box"</span>
<span class="nv">sys_dns0</span><span class="o">=</span><span class="s2">"nameserver 192.168.178.1"</span>

<span class="c1">## optional DNS 2 &amp; 3 aktivieren</span>
<span class="c1">## Beispiel</span>
<span class="c1"># sys_dns1="nameserver 8.8.4.4"</span>
<span class="c1"># sys_dns2="nameserver 8.8.8.8"</span>
<span class="nv">sys_dns1</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">sys_dns2</span><span class="o">=</span><span class="s2">""</span>

<span class="c1">## Konfiguration der WLAN-Schnittstelle, die den Accesspoint erzeugt</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">wlaniface</span><span class="o">=</span>wlan0

<span class="c1">## Konfiguration der virtuellen WLAN-Schnittstelle </span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">vlaniface</span><span class="o">=</span>wlan1
<span class="nv">vaddress</span><span class="o">=</span><span class="m">192</span>.168.3.1
<span class="nv">vbroadcast</span><span class="o">=</span><span class="m">192</span>.168.3.255
<span class="nv">vnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">viptablemask</span><span class="o">=</span><span class="m">192</span>.168.3.0/24

<span class="c1">## dnsmasq-base Konfiguration</span>
<span class="c1">## Start- Endadresse / lease</span>
<span class="nv">vlan_startaddress</span><span class="o">=</span><span class="m">192</span>.168.3.10
<span class="nv">vlan_endaddress</span><span class="o">=</span><span class="m">192</span>.168.3.15
<span class="nv">vlan_leasetime</span><span class="o">=</span>infinite

<span class="c1">## Konfiguration der zweiten lokalen LAN-Schnittstelle</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">locallan</span><span class="o">=</span>eth1

<span class="c1">## lokales LAN aktivieren (1), oder nicht (0)</span>
<span class="c1">## abschalten, sollte keine zweite Ethernetschnittstelle vorhanden sein</span>
<span class="nv">locallan_on</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## erste WLAN-Schnittstelle wlan0</span>
<span class="nv">wlan_modul</span><span class="o">=</span><span class="s2">"carl9170"</span>

<span class="c1"># WLAN tx power in dBm wlan0</span>
<span class="nv">txpower</span><span class="o">=</span><span class="m">15</span>

<span class="c1">## WLAN-Interface 2 virtuell (0) oder physikalisch (zweiter WLAN-Adapter) (1)</span>
<span class="nv">second_phy</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## zweite  WLAN-Schnittstelle wlan1 (0ptional)</span>
<span class="c1">## nur wirksam bei second_phy=1</span>
<span class="nv">wlan_modul2</span><span class="o">=</span><span class="s2">"rt2800usb"</span>

<span class="c1"># Sendeleistung für WLAN-Adapter 2 (wlan1) einstellen </span>
<span class="c1"># nur bei zweitem WLAN-Adapter wirksam</span>
<span class="c1"># tx power in dBm</span>
<span class="nv">txpower2</span><span class="o">=</span><span class="m">15</span>

<span class="c1">## Regionseinstellung</span>
<span class="nv">regcode</span><span class="o">=</span><span class="s2">"DE"</span>
<span class="nv">regdelay</span><span class="o">=</span><span class="m">3</span>

<span class="c1"># Lease-Time DHCP-Server dnsmasq_base für das Gastnetzwerk (wlan1)</span>
<span class="nv">leasetime</span><span class="o">=</span>infinite

<span class="c1">## Steuerung hostapd Schnittstelle wlan0</span>
<span class="nv">hostapdservice</span><span class="o">=</span><span class="s2">"hostapd -B"</span>
<span class="nv">hostapdconf</span><span class="o">=</span><span class="s2">"/etc/hostapd_vlan.conf"</span>

<span class="c1">## Konfigurationsdatei hostapd Schnittstelle wlan1 (optional)</span>
<span class="c1">## nur wirksam bei second_phy=1</span>
<span class="nv">hostapdconf1</span><span class="o">=</span><span class="s2">"/etc/hostapd_vlan1.conf"</span>

<span class="c1">## Iptables-Filter bei Programmende löschen</span>
<span class="c1"># Standard=1</span>
<span class="c1"># bei pppoe-Verbindungen oder Bridge-Konfiguration auf 0 setzen</span>
<span class="nv">delfilter</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## zeige Konfiguration nach Ablauf des Skripts (1/0)</span>
<span class="nv">showconfig</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## Ende freie Variablen</span>

<span class="c1"># Skript</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-h"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_AP-bridge.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_vWLAN.sh -start startet den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_vWLAN.sh -stop beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_vWLAN.sh beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration ausführen ...\n"</span>

<span class="c1"># Konfiguration löschen, Dienste stoppen</span>
sleep <span class="m">1</span>
 service hostapd stop
  /usr/bin/killall hostapd
   /usr/bin/killall dnsmasq squid
    /bin/rm -f /var/run/hostapd/<span class="nv">$wlaniface</span>
     /bin/rm -f /var/run/hostapd/<span class="nv">$wlaniface1</span>
      /usr/bin/killall dnsmasq wpa_supplicant wpa_cli wpa_action
       /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>
      
<span class="c1">## Bridge löschen</span>
<span class="nb">echo</span> <span class="s2">"lösche Bridge und Konfiguration ..."</span>
/sbin/ifconfig br0 down
 /sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$sourceiface</span>
  /sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
   /sbin/ifconfig <span class="nv">$bridgeiface</span> down
    /sbin/brctl delbr <span class="nv">$bridgeiface</span>
   
<span class="nb">echo</span> <span class="s2">"entferne WAN-Konfiguration ..."</span> 
 /sbin/ifconfig <span class="nv">$sourceiface</span> <span class="m">0</span>.0.0.0   
  sleep <span class="m">1</span>
   /sbin/ifconfig <span class="nv">$sourceiface</span> down  
   
<span class="nb">echo</span> <span class="s2">"entferne WLAN-Konfiguration ..."</span>
  /sbin/iwconfig <span class="nv">$wlaniface</span> mode managed
   sleep <span class="m">1</span>
    /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="m">0</span>.0.0.0
     sleep <span class="m">1</span>
      /sbin/ifconfig <span class="nv">$wlaniface</span> down
       sleep <span class="m">1</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$delfilter</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"lösche iptables-Filter ..."</span>
 /sbin/iptables -F
  /sbin/iptables -X
   /sbin/iptables -t nat -F
    /sbin/modprobe -rfv iptable_nat ipt_MASQUERADE xt_conntrack iptable_filter   
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"Router &amp; WLAN Access-Point Konfiguration beendet."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"stoppe alle Dienste, und Verbindungen ..."</span>
  <span class="nb">exit</span>
 <span class="k">fi</span>

<span class="c1">## start Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Starte alle Dienste, und Verbindungen ...\n"</span>


<span class="c1">## reintialisiere WLAN-Adapter</span>
 <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul Adapter 1: </span><span class="nv">$wlan_modul</span><span class="s2">"</span>
   /sbin/modprobe -rf <span class="nv">$wlan_modul</span> <span class="nv">$wlan_modul2</span>
 sleep <span class="m">1</span>
 
<span class="nb">echo</span> -e <span class="s2">"WLAN-Adapter 1  reinitialisieren ...\n"</span>
  /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
   sleep <span class="m">1</span>
    /sbin/modprobe <span class="nv">$wlan_modul</span> 
   sleep <span class="m">1</span>
    
<span class="c1">## reintialisiere WLAN-Adapter 2 (optional) </span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul Adapter 2: </span><span class="nv">$wlan_modul2</span><span class="s2">"</span>
  <span class="nb">echo</span> -e <span class="s2">"WLAN-Adapter 2 reinitialisieren ...\n"</span>
   /sbin/modprobe <span class="nv">$wlan_modul2</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>
    
<span class="c1">## MAC-Adress Konfiguration wlan-Adapter 1  für hostapd</span>
<span class="nv">currentmacset</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$hostapdconf</span> <span class="p">|</span> grep bssid<span class="k">)</span> 
 <span class="nv">currentmac</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> grep -i link <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $6'</span><span class="o">}</span><span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">"erkannte MAC-Adresse des WLAN-Adapters 1:"</span> <span class="nv">$currentmac</span>
   sleep <span class="m">1</span>
   
<span class="nb">echo</span> -e <span class="s2">"ändere hostapd-Konfiguration für WLAN-Adapter 1 (</span><span class="nv">$wlaniface</span><span class="s2">)\n"</span>
   /bin/sed -i <span class="s2">"s/</span><span class="nv">$currentmacset</span><span class="s2">/bssid=</span><span class="nv">$currentmac</span><span class="s2">/g"</span> <span class="nv">$hostapdconf</span>
  
<span class="c1">## initialize WAN-Port</span>
 /sbin/ifconfig <span class="nv">$sourceiface</span> up
    sleep <span class="m">1</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>    
<span class="c1">## MAC-Adress Konfiguration wlan-Adapter 2 für hostapd</span>
<span class="nv">currentmacset2</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$hostapdconf1</span> <span class="p">|</span> grep bssid<span class="k">)</span> 
 <span class="nv">currentmac2</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$vlaniface</span> <span class="p">|</span> grep -i link <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $6'</span><span class="o">}</span><span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">"erkannte MAC-Adresse des WLAN-Adapters 1:"</span> <span class="nv">$currentmac2</span>
   sleep <span class="m">1</span>
   
<span class="nb">echo</span> -e <span class="s2">"ändere hostapd-Konfiguration für WLAN-Adapter 2 (</span><span class="nv">$vlaniface</span><span class="s2">)\n"</span>
   /bin/sed -i <span class="s2">"s/</span><span class="nv">$currentmacset2</span><span class="s2">/bssid=</span><span class="nv">$currentmac2</span><span class="s2">/g"</span> <span class="nv">$hostapdconf1</span>
<span class="k">fi</span>
  
<span class="c1">## initialize WAN-Port</span>
 /sbin/ifconfig <span class="nv">$sourceiface</span> up
    sleep <span class="m">1</span>

<span class="c1">## Sendeleistung / deaktivate WLAN-Powermanagement / set Tx-Power    </span>
<span class="nb">echo</span> <span class="s2">"deaktiviere Stromsparmechanismen für </span><span class="nv">$wlaniface</span><span class="s2">"</span>
 /sbin/iw dev <span class="nv">$wlaniface</span> <span class="nb">set</span> power_save off
  sleep <span class="m">1</span> 

<span class="nb">echo</span> -e <span class="s2">"setze Sendeleistung des WLAN-Adapters </span><span class="nv">$wlaniface</span><span class="s2"> (</span><span class="nv">$txpower</span><span class="s2">"</span>dBm<span class="s2">")\n"</span>
 /sbin/iwconfig <span class="nv">$wlaniface</span> txpower <span class="nv">$txpower</span>
  sleep <span class="m">1</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"deaktiviere Stromsparmechanismen für </span><span class="nv">$vlaniface</span><span class="s2">"</span>
 /sbin/iw dev <span class="nv">$vlaniface</span> <span class="nb">set</span> power_save off
  sleep <span class="m">2</span> 
  
<span class="nb">echo</span> -e <span class="s2">"setze Sendeleistung des WLAN-Adapters </span><span class="nv">$vlaniface</span><span class="s2"> (</span><span class="nv">$txpower2</span><span class="s2">"</span>dBm<span class="s2">")\n"</span>
 /sbin/iwconfig <span class="nv">$vlaniface</span> txpower <span class="nv">$txpower2</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>
  
<span class="c1">## Regionseinstellung</span>
<span class="nb">echo</span> -e <span class="s2">"setze Regionseinstellung des Systems: </span><span class="nv">$regcode</span><span class="s2">\n"</span>
/sbin/iw reg <span class="nb">set</span> <span class="nv">$regcode</span>
 sleep <span class="nv">$regdelay</span>

<span class="c1"># aut. Dienste nach Reinitialisierung des WLAN-Adapters beenden </span>
/usr/bin/killall wpa_supplicant wpa_cli wpa_action ifplugd
  
<span class="c1">## start hostapd</span>
<span class="nb">echo</span> -e <span class="s2">"Starte hostapd-Service\n"</span>
 <span class="nv">$hostapdservice</span> <span class="nv">$hostapdconf</span>
  sleep <span class="m">1</span>
   <span class="nb">echo</span>
   
<span class="c1">## start hostapd für WLAN-Adapter 2 (optional) </span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> -e <span class="s2">"Starte hostapd-Service\n"</span>
 <span class="nv">$hostapdservice</span> <span class="nv">$hostapdconf1</span>
  sleep <span class="m">1</span>
   <span class="nb">echo</span>
<span class="k">fi</span>
  
<span class="c1">## Bridge konfigurieren</span>
/sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$sourceiface</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$locallan_on</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
  <span class="nb">echo</span> -e <span class="s2">"Ethernerschnittstelle 2 aktiviert.\n"</span>
 <span class="k">fi</span>
  /sbin/brctl setfd <span class="nv">$bridgeiface</span> <span class="nv">$forward_delay</span>
   /sbin/brctl stp <span class="nv">$bridgeiface</span> <span class="nv">$stp</span>
   
<span class="c1">## Optional aktivieren   </span>
<span class="c1">#    /sbin/brctl setageing $bridgeiface $brageing</span>
<span class="c1">#     /sbin/brctl setmaxage $bridgeiface $brage</span>
   
<span class="c1">## initialize Bridge-Port</span>
<span class="nb">echo</span> <span class="s2">"Bridge-Schnittstelle initialisieren (statisch)"</span>
 <span class="nb">echo</span> -e <span class="s2">"Interface: </span><span class="nv">$bridgeiface</span><span class="s2"> IP-Adresse: </span><span class="nv">$braddress</span><span class="s2"> Broadcast: </span><span class="nv">$brbroadcast</span><span class="s2"> Netzmaske: </span><span class="nv">$brnetmask</span><span class="s2">\n"</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="nv">$braddress</span> broadcast <span class="nv">$brbroadcast</span> netmask <span class="nv">$brnetmask</span>
   /sbin/route add default gw <span class="nv">$wangateway</span> metric <span class="m">0</span> dev <span class="nv">$bridgeiface</span>
    sleep <span class="m">1</span>
     /sbin/ifconfig <span class="nv">$sourceiface</span> up
    
<span class="c1">## vLAN-Schnittstelle statisch konfigurieren</span>
<span class="nb">echo</span> <span class="s2">"VLAN-Schnittstelle initialisieren (statisch)"</span>
 <span class="nb">echo</span> -e <span class="s2">"Interface: </span><span class="nv">$vlaniface</span><span class="s2"> IP-Adresse: </span><span class="nv">$vaddress</span><span class="s2"> Broadcast: </span><span class="nv">$vbroadcast</span><span class="s2"> Netzmaske: </span><span class="nv">$vnetmask</span><span class="s2">\n"</span>
  /sbin/ifconfig <span class="nv">$vlaniface</span> <span class="nv">$vaddress</span> broadcast <span class="nv">$vbroadcast</span> netmask <span class="nv">$vnetmask</span>
   sleep <span class="m">1</span>

<span class="c1">## Netze trennen / NAT / Ping unterbinden</span>
/sbin/iptables -A INPUT -p icmp --icmp-type <span class="m">8</span> -i <span class="nv">$vlaniface</span> -j DROP
 /sbin/iptables -t nat -A POSTROUTING -o <span class="nv">$bridgeiface</span> -j MASQUERADE
  /sbin/iptables -A FORWARD -i <span class="nv">$vlaniface</span> --dst <span class="nv">$briptablemasq</span> -j DROP

<span class="c1">## Port forwarding</span>
/sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>    
    
<span class="c1">## starting DHCP-Service VLAN</span>
<span class="nb">echo</span> -e <span class="s2">"starte dnsmasq-base\n"</span>
 <span class="nb">echo</span> <span class="s2">"DHCP-Range dnsmasq-base ..."</span>
  <span class="nb">echo</span> -e <span class="s2">"</span><span class="nv">$vlaniface</span><span class="s2"> Startadresse: </span><span class="nv">$vlan_startaddress</span><span class="s2"> Endadresse: </span><span class="nv">$vlan_endaddress</span><span class="s2"> Lease: </span><span class="nv">$vlan_leasetime</span><span class="s2">\n"</span>
  
/usr/sbin/dnsmasq -h -I <span class="nv">$bridgeiface</span> -i <span class="nv">$vlaniface</span> -F <span class="nv">$vlan_startaddress</span>,<span class="nv">$vlan_endaddress</span>,<span class="nv">$vlan_leasetime</span> 
 sleep <span class="m">1</span>  
 
<span class="nb">echo</span> <span class="s2">"dnsmasq - Dienstekonfiguration:"</span>
 ps aux <span class="p">|</span> grep <span class="o">[</span>d<span class="o">]</span>ns
  <span class="nb">echo</span>

<span class="c1">## DNS setzen</span>
<span class="c1">## verwende erkanntes Gateway</span>
<span class="nb">echo</span> <span class="s2">"DNS-Konfiguration ..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$manDNS</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> -e <span class="s2">"nameserver"</span> <span class="k">$(</span>route -n <span class="p">|</span> grep UG <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $2'</span><span class="o">}</span><span class="k">)</span> <span class="p">|</span> tee /etc/resolv.conf
  <span class="nb">echo</span>
<span class="k">else</span>
  <span class="nb">echo</span> -e <span class="s2">"</span><span class="nv">$sys_domain</span><span class="s2">\n</span><span class="nv">$sys_search</span><span class="s2">\n</span><span class="nv">$sys_dns0</span><span class="s2">\n</span><span class="nv">$sys_dns1</span><span class="s2">\n</span><span class="nv">$sys_dns2</span><span class="s2">"</span> <span class="p">|</span> tee /etc/resolv.conf
 sleep <span class="m">1</span>
   <span class="nb">echo</span>
<span class="k">fi</span>

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$showconfig</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   
 <span class="nb">echo</span> -e <span class="s2">"System DNS-Check und Routing:"</span>
  cat /etc/resolv.conf
   <span class="nb">echo</span>
    /sbin/route -n
     <span class="nb">echo</span>
    
<span class="nb">echo</span> -e <span class="s2">"Konfiguration Bridge:\n"</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    /sbin/brctl show
     <span class="nb">echo</span>
      /sbin/brctl showmacs <span class="nv">$bridgeiface</span>
       <span class="nb">echo</span>
      /sbin/brctl showstp <span class="nv">$bridgeiface</span>
    <span class="nb">echo</span>
    
<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales WAN:\n"</span>
  /sbin/ifconfig <span class="nv">$sourceiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
  
<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales LAN:\n"</span>
  /sbin/ifconfig <span class="nv">$locallan</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>

 <span class="nb">echo</span> <span class="s2">"Konfiguration WLAN:"</span>
  /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    /sbin/iwconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Power|Mode'</span>
     <span class="nb">echo</span>      
      /sbin/iwconfig mon.<span class="nv">$wlaniface</span>
	 
  /sbin/ifconfig <span class="nv">$vlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    /sbin/iwconfig <span class="nv">$vlaniface</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Power|Mode'</span>
     <span class="nb">echo</span>      

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Regionseinstellung des/der WLAN-Adapters:\n"</span>
 /sbin/iw reg get
  <span class="nb">echo</span>
	 
<span class="nb">echo</span> <span class="s2">"Dienstestatus:"</span>
service hostapd status

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 ps aux <span class="p">|</span> grep <span class="o">[</span>h<span class="o">]</span>ostapd
<span class="k">fi</span>

<span class="k">else</span>
 <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table></div></li></ul><p>
</p><ul><li><p>Dienstekonfiguration via <strong>/etc/hostapd_vlan.conf</strong> bei Verwendung eines einzigen WLAN-Adapters. Der Eintrag <code class="notranslate">bssid=xx:xx:xx:xx:xx:xx</code> wird durch das Skript mit der tatsächlichen MAC-Adresse des WLAN-Adapters überschrieben:</p><pre class="notranslate"># WLAN0-Konfiguration
interface=wlan0
bssid=b2:af:41:3a:eb:b5
driver=nl80211
bridge=br0

# WLAN-Konfiguration
ssid=WLAN_AP
channel=4

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890abcdefghijklmn

# WLAN1-Konfiguration / VLAN
bss=wlan1
driver=nl80211

ssid=Guest_Net

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890


# ESSID sichtbar
ignore_broadcast_ssid=0

# Ländereinstellungen
country_code=DE
ieee80211d=1

# Übertragungsmodus
hw_mode=g

# Optionale Einstellungen
# supported_rates=10 20 55 110 60 90 120 180 240 360 480 540

# Draft-N Modus aktivieren / optional nur für entsprechende Karten
# ieee80211n=1

# Übertragungsmodus / Bandbreite 40MHz
# ht_capab=[HT40+][SHORT-GI-40][DSSS_CCK-40]

# Beacons
beacon_int=100
dtim_period=2

# MAC-Authentifizierung
macaddr_acl=0

# max. Anzahl der Clients
max_num_sta=20

# Größe der Datenpakete/Begrenzung
rts_threshold=2347
fragm_threshold=2346

# hostapd Log Einstellungen
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2

# temporäre Konfigurationsdateien
dump_file=/tmp/hostapd.dump
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# Authentifizierungsoptionen 
auth_algs=3

# wmm-Funktionalität
wmm_enabled=0

# Schlüsselintervalle / Standardkonfiguration
wpa_group_rekey=600
wpa_ptk_rekey=600
wpa_gmk_rekey=86400</pre></li></ul><p>
Werden zwei WLAN-Adapter verwendet, so muss eine zweite Konfigurationsdatei für <strong>hostapd</strong> angelegt werden. Das Skript startet dann entsprechend eine weitere Instanz.</p><ul><li><p><strong>/etc/hostapd_vlan.conf</strong> für den ersten WLAN-Adapter. Der Eintrag <code class="notranslate">bssid=xx:xx:xx:xx:xx:xx</code> wird durch das Skript mit der tatsächlichen MAC-Adresse des ersten WLAN-Adapters überschrieben: </p><pre class="notranslate"># WLAN0-Konfiguration
interface=wlan0
bssid=b2:af:41:3a:eb:b5
driver=nl80211
bridge=br0

# WLAN-Konfiguration
ssid=WLAN_AP
channel=1

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890abcdefghijklmn

# ESSID sichtbar
ignore_broadcast_ssid=0

# Ländereinstellungen
country_code=DE
ieee80211d=1

# Übertragungsmodus
hw_mode=g

# Optionale Einstellungen
# supported_rates=10 20 55 110 60 90 120 180 240 360 480 540

# Draft-N Modus aktivieren / optional nur für entsprechende Karten
# ieee80211n=1

# Übertragungsmodus / Bandbreite 40MHz
# ht_capab=[HT40+][SHORT-GI-40][DSSS_CCK-40]

# Beacons
beacon_int=100
dtim_period=2

# MAC-Authentifizierung
macaddr_acl=0

# max. Anzahl der Clients
max_num_sta=20

# Größe der Datenpakete/Begrenzung
rts_threshold=2347
fragm_threshold=2346

# hostapd Log Einstellungen
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2

# temporäre Konfigurationsdateien
dump_file=/tmp/hostapd.dump
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# Authentifizierungsoptionen 
auth_algs=3

# wmm-Funktionalität
wmm_enabled=0

# Schlüsselintervalle / Standardkonfiguration
wpa_group_rekey=600
wpa_ptk_rekey=600
wpa_gmk_rekey=86400</pre></li></ul><p>
</p><ul><li><p><strong>/etc/hostapd_vlan1.conf</strong> für den zweiten WLAN-Adapter. Der Eintrag <code class="notranslate">bssid=xx:xx:xx:xx:xx:xx</code> wird durch das Skript mit der tatsächlichen MAC-Adresse des zweiten WLAN-Adapters überschrieben: </p><pre class="notranslate"># WLAN0-Konfiguration
interface=wlan1
bssid=b2:af:41:3a:eb:b5
driver=nl80211

# WLAN-Konfiguration
ssid=Guest_Net
channel=11

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890

# ESSID sichtbar
ignore_broadcast_ssid=0

# Ländereinstellungen
country_code=DE
ieee80211d=1

# Übertragungsmodus
hw_mode=g

# Optionale Einstellungen
# supported_rates=10 20 55 110 60 90 120 180 240 360 480 540

# Draft-N Modus aktivieren / optional nur für entsprechende Karten
# ieee80211n=1

# Übertragungsmodus / Bandbreite 40MHz
# ht_capab=[HT40+][SHORT-GI-40][DSSS_CCK-40]

# Beacons
beacon_int=100
dtim_period=2

# MAC-Authentifizierung
macaddr_acl=0

# max. Anzahl der Clients
max_num_sta=20

# Größe der Datenpakete/Begrenzung
rts_threshold=2347
fragm_threshold=2346

# hostapd Log Einstellungen
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2

# temporäre Konfigurationsdateien
dump_file=/tmp/hostapd.dump
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# Authentifizierungsoptionen 
auth_algs=3

# wmm-Funktionalität
wmm_enabled=0

# Schlüsselintervalle / Standardkonfiguration
wpa_group_rekey=600
wpa_ptk_rekey=600
wpa_gmk_rekey=86400</pre></li></ul><p>
</p></div><div class="section_2"><h3 id="WLAN-Repeater">WLAN-Repeater<a class="headerlink" href="#WLAN-Repeater">¶</a></h3><p>
Erforderliche Programme:
</p><ul><li><p><a class="internal" href="../wlan_router.html">hostapd</a></p></li><li><p><a class="internal" href="../isc-dhcpd.html">isc-dhcpd</a> (Server)</p></li><li><p><a class="internal" href="../netzwerkbrücke.html">bridge-utils</a></p></li><li><p><a class="internal" href="../iw.html">iw</a></p></li></ul><p>
Funktionsbeschreibung:
</p><ul><li><p>LAN/WLAN-Router mit einem einzigen oder alternativ zwei WLAN-Adaptern</p><ul><li><p>nur wenige Adapter unterstützen ein virtuelles Interface im Infrastrukturmodus neben der AP-Funktion</p></li><li><p>erfolgreich getestet mit einem TP-Link TL-WN822N v1.1 USB WLAN-Adapter mit Atheros-Otus Chipsatz als einzigen WLAN-Adapter. Geräte-ID: <code class="notranslate">0CF3:1002</code>, Treibermodul <code class="notranslate">carl9170</code>.</p></li></ul></li></ul><p>
</p><ul><li><p>Konstrukt arbeitet quasi als Bridge, ist somit mit jedem WLAN-Accesspoint kompatibel</p><ul><li><p>WLAN-Accesspoint über WLAN-Interface 1</p></li><li><p>separater DHCP-Server (isc-dhcpd-server)</p></li><li><p>WLAN-Interface 2 verbindet zum vorhandenen Router (Internetanbindung im Infrastruktur-Modus)</p></li><li><p>Ethernetschnittstelle 1 für das lokale Netzwerk</p></li><li><p>alle Clients (WLAN 1 und Ethernet 1) befinden sich im selben Netzwerk</p></li></ul></li></ul><p>
</p><ul><li><p><strong>instant_AP-WLAN_Bridge.sh</strong>: </p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant WLAN Access-Point and Ethernet Router with transparent bridged interfaces </span>
<span class="c1">## (Wireless-Bridge)</span>
<span class="c1">## for RaspberryPi™ with Raspbian and other Linux based Systems</span>
<span class="c1">##</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2013</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 1.7.1.3wb / 16. Oktober 2013</span>
<span class="c1">## have fun :-)</span>

<span class="c1">## freie Variablen</span>

<span class="c1">## Accesspoint Konfiguration für den Verbindungsaufbau zum vorhandenen WLAN</span>
<span class="c1"># SSID (Name) des WLAN Accesspoints eintragen</span>
<span class="nv">ssid</span><span class="o">=</span><span class="s2">"Deine_WLAN_SSID"</span>

<span class="c1"># MAC-Adresse des WLAN Accesspoints eintragen</span>
<span class="c1"># Beispiel:</span>
<span class="c1"># mac="00:15:0E:31:7A:1A"</span>
<span class="nv">mac</span><span class="o">=</span><span class="s2">"00:15:0E:31:7A:1A"</span>

<span class="c1"># Einstellungen zur Verschlüsselung (WPA1 und/oder WPA2)</span>
<span class="c1"># die Vorgabe deckt im Normalfall alle Konfigurationsmöglichkeiten ab</span>
<span class="c1"># Konfiguration wpa-supplicant</span>
<span class="nv">proto</span><span class="o">=</span><span class="s2">"WPA RSN"</span>
<span class="nv">key_mgmt</span><span class="o">=</span><span class="s2">"WPA-PSK"</span>
<span class="nv">pairwise</span><span class="o">=</span><span class="s2">"TKIP CCMP"</span>
<span class="nv">group</span><span class="o">=</span><span class="s2">"TKIP CCMP"</span>

<span class="c1"># WPA1 - WPA2 - WPA1/2 Verschlüsselung</span>
<span class="c1"># Zugangskennwort in Klartext (WPA1/2-Zugangsschlüssel / PSK)</span>
<span class="nv">psk</span><span class="o">=</span><span class="s2">"Dein_WLAN_Kennwort"</span>

<span class="c1">## Konfiguration wpa_supplicant</span>
<span class="c1"># Einstellungen müssen in der Regel nicht angepasst werden</span>
<span class="nv">configfile</span><span class="o">=</span><span class="s2">"wpa_supplicant.tmp"</span>
<span class="nv">ctrliface</span><span class="o">=</span><span class="s2">"ctrl_interface=/var/run/wpa_supplicant"</span>
<span class="nv">eapolv</span><span class="o">=</span><span class="s2">"eapol_version=1"</span>
<span class="nv">apscan</span><span class="o">=</span><span class="s2">"ap_scan=1"</span>

<span class="c1"># Pause vor dem Start der Konfiguration / Wert ggf. erhöhen</span>
<span class="nv">wpa_delay</span><span class="o">=</span><span class="m">4</span>

<span class="c1">## Treiber für wpa_supplicant</span>
<span class="c1">## wext oder nl80211</span>
<span class="nv">wpadriver</span><span class="o">=</span><span class="s2">"wext"</span>

<span class="c1">## Bridge-Konfiguration</span>
<span class="nv">bridgeiface</span><span class="o">=</span>br0
<span class="nv">forward_delay</span><span class="o">=</span><span class="m">2</span>
<span class="nv">stp</span><span class="o">=</span><span class="m">1</span>
<span class="nv">brageing</span><span class="o">=</span><span class="m">10000</span>
<span class="nv">brage</span><span class="o">=</span><span class="m">40</span>

<span class="nv">braddress</span><span class="o">=</span><span class="m">192</span>.168.3.1
<span class="nv">brbroadcast</span><span class="o">=</span><span class="m">192</span>.168.3.255
<span class="nv">brnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0

<span class="nv">wangateway</span><span class="o">=</span><span class="m">192</span>.168.3.1
<span class="nv">iptablemask</span><span class="o">=</span><span class="m">192</span>.168.3.0/24

<span class="c1">## DHCP-Server Einstellungen</span>
<span class="c1">## isc-dhcpd Konfiguration</span>
<span class="nv">isc_serverconf</span><span class="o">=</span><span class="s2">"/etc/default/isc-dhcp-server"</span>

<span class="c1">## isc-dhcpd Start- Endadresse / Options</span>
<span class="nv">isc_configfile</span><span class="o">=</span><span class="s2">"/etc/dhcp/dhcpd.conf"</span>
<span class="nv">isc_subnet</span><span class="o">=</span><span class="m">192</span>.168.3.0
<span class="nv">isc_netmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">isc_startaddress</span><span class="o">=</span><span class="m">192</span>.168.3.10
<span class="nv">isc_endaddress</span><span class="o">=</span><span class="m">192</span>.168.3.20
<span class="nv">isc_leasetime</span><span class="o">=</span>infinite

<span class="c1"># isc-dhcpd Optionen / Vorgabe nicht ändern</span>
<span class="nv">isc_option0</span><span class="o">=</span><span class="s2">"option routers"</span>
<span class="nv">isc_option1</span><span class="o">=</span><span class="s2">"option domain-name-servers"</span>

<span class="c1">## DNS-Server</span>
<span class="c1">## mehrere, durch Komma getrennte Einträge sind möglich</span>
<span class="nv">dns_ip</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">## Konfiguration der WLAN-Schnittstelle, welche die Verbindung zum Router aufbaut</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">wlaniface</span><span class="o">=</span>wlan0

<span class="c1"># Stromsparmechanismen WLAN (off/on)</span>
<span class="nv">powersave</span><span class="o">=</span>off

<span class="c1">## WLAN-Interface 2</span>
<span class="c1">## virtuelles Interface - wird vom Skript erzeugt</span>
<span class="nv">wlaniface2</span><span class="o">=</span>wlan1

<span class="c1"># WLAN statisch oder dynamisch (1/0) (1 DHCP/Standard) konfigurieren </span>
<span class="nv">wlan2_dhcp</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># statische Konfiguration (Optional)</span>
<span class="nv">wlan2_address</span><span class="o">=</span><span class="m">192</span>.168.178.5
<span class="nv">wlan2_broadcast</span><span class="o">=</span><span class="m">192</span>.168.5.255
<span class="nv">wlan2_netmask</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">wlan2_gateway</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">## manuelle DNS-Konfiguration aktiviert (1) oder deaktiviert (0) (Standard)</span>
<span class="nv">manDNS</span><span class="o">=</span><span class="m">0</span>

<span class="c1"># manuelle DNS-Konfiguration</span>
<span class="nv">sys_domain</span><span class="o">=</span><span class="s2">"domain fritz.box"</span>
<span class="nv">sys_search</span><span class="o">=</span><span class="s2">"search fritz.box"</span>
<span class="nv">sys_dns0</span><span class="o">=</span><span class="s2">"nameserver 192.168.178.1"</span>

<span class="c1">## optional DNS 2 &amp; 3 aktivieren</span>
<span class="c1">## Beispiel</span>
<span class="c1"># sys_dns1="nameserver 8.8.4.4"</span>
<span class="c1"># sys_dns2="nameserver 8.8.8.8"</span>
<span class="nv">sys_dns1</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">sys_dns2</span><span class="o">=</span><span class="s2">""</span>

<span class="c1">## WLAN-Interface 2 virtuell (0) oder physikalisch (zweiter WLAN-Adapter) (1)</span>
<span class="nv">second_phy</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## zweite  WLAN-Schnittstelle wlan1 (0ptional)</span>
<span class="c1">## nur wirksam bei second_phy=1</span>
<span class="nv">wlan_modul2</span><span class="o">=</span><span class="s2">"rt2800usb"</span>

<span class="c1">#  Anpassung der MAC-Adresse WLAN-Interface 2</span>
<span class="c1"># nur bei virtuellem Interface wirksam</span>
<span class="nv">lastoctet</span><span class="o">=</span>ff

<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">locallan</span><span class="o">=</span>eth0

<span class="c1"># Sendeleistung für WLAN-Adapter 1 (wlan0) einstellen</span>
<span class="c1"># tx power in dBm</span>
<span class="nv">txpower</span><span class="o">=</span><span class="m">15</span>

<span class="c1"># Sendeleistung für WLAN-Adapter 2 (wlan1) einstellen </span>
<span class="c1"># nur bei zweitem WLAN-Adapter wirksam</span>
<span class="c1"># tx power in dBm</span>
<span class="nv">txpower2</span><span class="o">=</span><span class="m">15</span>

<span class="c1">## Regionseinstellung</span>
<span class="nv">regcode</span><span class="o">=</span><span class="s2">"DE"</span>
<span class="c1"># Pause zur Konfigurationsübernahme / Wert ggf. erhöhen</span>
<span class="nv">regdelay</span><span class="o">=</span><span class="m">3</span>

<span class="c1">## Steuerung hostapd</span>
<span class="nv">hostapdservice</span><span class="o">=</span><span class="s2">"hostapd -B"</span>
<span class="nv">hostapdconf</span><span class="o">=</span><span class="s2">"/etc/hostapd_wlanbridge.conf"</span>

<span class="c1">## Iptables-Filter bei Programmende löschen (1/0)</span>
<span class="c1"># Standard=1</span>
<span class="nv">delfilter</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## zeige Konfiguration nach Ablauf des Skripts (1/0)</span>
<span class="nv">showconfig</span><span class="o">=</span><span class="m">1</span>

<span class="c1">##Konfigurationsdatei Info zuletzt erkannter WLAN-Adapter/Treibermodul</span>
<span class="nv">wlan_adapterfile</span><span class="o">=</span><span class="s2">"wlan_adapter.txt"</span>

<span class="c1">## Ende freie Variablen</span>

<span class="c1"># Skript</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-h"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_AP-bridge.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-start -D<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-Bridge.sh -start startet den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-Bridge.sh -stop beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-Bridge.sh beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="c1">## manuelle DNS-Konfiguration abfragen</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-D"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nv">manDNS</span><span class="o">=</span><span class="m">1</span>
  <span class="nb">echo</span> -e <span class="s2">"manuelle DNS_Konfiguration aktiviert.\n"</span>
<span class="k">else</span> 
 <span class="nv">manDNS</span><span class="o">=</span><span class="m">0</span>
<span class="k">fi</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration ausführen ...\n"</span>

<span class="c1"># Konfiguration löschen, Dienste stoppen</span>
sleep <span class="m">1</span>
 service hostapd stop
  service isc-dhcp-server stop
   /bin/rm -f /var/run/hostapd/<span class="nv">$wlaniface</span>
    /usr/bin/killall dnsmasq dhclient 
     /usr/bin/killall wpa_supplicant wpa_cli wpa_action isc-dhcp-server hostapd
      /bin/rm /var/run/wpa_supplicant/*
     /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>   
       
<span class="c1">## Bridge löschen</span>
<span class="nb">echo</span> <span class="s2">"lösche Bridge und Konfiguration ..."</span>
/sbin/ifconfig br0 down
 /sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$wlaniface</span>
  /sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
   /sbin/ifconfig <span class="nv">$bridgeiface</span> down
    /sbin/brctl delbr <span class="nv">$bridgeiface</span>
   
<span class="nb">echo</span> <span class="s2">"entferne WLAN-Konfiguration ..."</span>
 /sbin/iwconfig <span class="nv">$wlaniface</span> mode managed
  sleep <span class="m">1</span>
  
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   iw dev <span class="nv">$wlaniface2</span> del
 <span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$delfilter</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"lösche iptables-Filter ..."</span>
 /sbin/iptables -F
  /sbin/iptables -X
   /sbin/iptables -t nat -F
    /sbin/modprobe -rfv iptable_nat ipt_MASQUERADE xt_conntrack iptable_filter   
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"Bridge &amp; WLAN Access-Point Konfiguration beendet."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"stoppe alle Dienste, und Verbindungen ..."</span>
  <span class="nb">exit</span>
 <span class="k">fi</span>

<span class="c1">## start Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Starte alle Dienste, und Verbindungen ...\n"</span>

<span class="c1">## WLAN-Verbindung vorbereiten</span>
<span class="nb">echo</span> -e <span class="s2">"\nlege Konfigurationsdatei </span><span class="nv">$configfile</span><span class="s2"> an.\n"</span>
 <span class="nb">echo</span> <span class="nv">$ctrliface</span> &gt; <span class="nv">$configfile</span>
  <span class="nb">echo</span> <span class="nv">$eapolv</span> &gt;&gt; <span class="nv">$configfile</span>
   <span class="nb">echo</span> <span class="nv">$apscan</span> &gt;&gt; <span class="nv">$configfile</span>
    <span class="nb">echo</span> <span class="s1">'network={'</span> &gt;&gt; <span class="nv">$configfile</span>
     <span class="nb">echo</span> <span class="nv">ssid</span><span class="o">=</span><span class="s1">'"'</span><span class="nv">$ssid</span><span class="s1">'"'</span> &gt;&gt; <span class="nv">$configfile</span>
      <span class="nb">echo</span> <span class="nv">bssid</span><span class="o">=</span><span class="nv">$mac</span> &gt;&gt; <span class="nv">$configfile</span>
     <span class="nb">echo</span> <span class="nv">proto</span><span class="o">=</span><span class="nv">$proto</span> &gt;&gt; <span class="nv">$configfile</span>
    <span class="nb">echo</span> <span class="nv">key_mgmt</span><span class="o">=</span><span class="nv">$key_mgmt</span> &gt;&gt; <span class="nv">$configfile</span>
   <span class="nb">echo</span> <span class="nv">pairwise</span><span class="o">=</span><span class="nv">$pairwise</span>&gt;&gt; <span class="nv">$configfile</span>
  <span class="nb">echo</span> <span class="nv">group</span><span class="o">=</span><span class="nv">$group</span> &gt;&gt; <span class="nv">$configfile</span>
 <span class="nb">echo</span> <span class="nv">psk</span><span class="o">=</span><span class="s1">'"'</span><span class="nv">$psk</span><span class="s1">'"'</span> &gt;&gt; <span class="nv">$configfile</span>
<span class="nb">echo</span> <span class="s1">'}'</span> &gt;&gt; <span class="nv">$configfile</span>
	    
<span class="c1">## isc-dhcpd Konfiguration vorbereiten	</span>
<span class="nb">echo</span> -e <span class="s2">"\nlege Konfigurationsdatei </span><span class="nv">$isc_serverconf</span><span class="s2"> an:\n"</span>
 <span class="nb">echo</span> -e <span class="s2">"DHCPD_CONF=</span><span class="nv">$isc_configfile</span><span class="s2">\nINTERFACES="</span><span class="nv">$bridgeiface</span><span class="s2">""</span> <span class="p">|</span> tee <span class="nv">$isc_serverconf</span>
  <span class="nb">echo</span> -e <span class="s2">"\nlege Konfigurationsdatei </span><span class="nv">$isc_configfile</span><span class="s2"> an:\n"</span>
   <span class="nb">echo</span> -e <span class="s2">"subnet </span><span class="nv">$isc_subnet</span><span class="s2"> netmask </span><span class="nv">$isc_netmask</span><span class="s2"> { range </span><span class="nv">$isc_startaddress</span><span class="s2"> </span><span class="nv">$isc_endaddress</span><span class="s2">; }\n</span><span class="nv">$isc_option0</span><span class="s2"> </span><span class="nv">$braddress</span><span class="s2">;\n</span><span class="nv">$isc_option1</span><span class="s2"> </span><span class="nv">$dns_ip</span><span class="s2">;"</span> <span class="p">|</span> tee  <span class="nv">$isc_configfile</span>   
  <span class="nb">echo</span>

<span class="c1">## Modulerkennung WLAN</span>
<span class="nv">wlan_modul</span><span class="o">=</span><span class="k">$(</span>find /sys/class/net/<span class="nv">$wlaniface</span>/device/driver/module/drivers/ <span class="p">|</span> grep usb <span class="p">|</span> cut -c <span class="m">55</span>-70<span class="k">)</span>
 <span class="nv">lastknownmodule</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$wlan_adapterfile</span><span class="k">)</span>
    
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nv">wlan_modul2</span><span class="o">=</span><span class="k">$(</span>find /sys/class/net/<span class="nv">$wlaniface2</span>/device/driver/module/drivers/ <span class="p">|</span> grep usb <span class="p">|</span> cut -c <span class="m">55</span>-70<span class="k">)</span>
 <span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$lastknownmodule</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
 <span class="nv">lastknownmodule</span><span class="o">=</span><span class="s2">"none"</span>
  <span class="k">fi</span>

<span class="c1">## reinitialisiere WLAN-Adapter</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul </span><span class="nv">$wlan_modul</span><span class="s2"> erkannt, vorheriges Modul: </span><span class="nv">$lastknownmodule</span><span class="s2">"</span>

 <span class="nb">echo</span> -e <span class="s2">"WLAN-Adapter reinitialisieren ...\n"</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$wlan_modul</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lastknownmodule</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
   /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
    sleep <span class="m">1</span>
     /sbin/modprobe <span class="nv">$wlan_modul</span> 
   sleep <span class="m">1</span>
    
<span class="k">else</span>
 /sbin/modprobe -rf <span class="nv">$lastknownmodule</span>  
  sleep <span class="m">1</span>
   /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
    sleep <span class="m">1</span>
     /sbin/modprobe <span class="nv">$wlan_modul</span> 
    sleep <span class="m">1</span>
   <span class="nb">echo</span> <span class="nv">$wlan_modul</span> &gt; <span class="nv">$wlan_adapterfile</span>
  sleep <span class="m">1</span>
 <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul 1 </span><span class="nv">$wlan_modul</span><span class="s2"> erkannt"</span>
  <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul 2 </span><span class="nv">$wlan_modul2</span><span class="s2"> erkannt"</span>
  
/sbin/modprobe -rf <span class="nv">$wlan_modul</span> <span class="nv">$wlan_modul2</span>
 sleep <span class="m">1</span>

<span class="nb">echo</span> <span class="s2">"lade Module </span><span class="nv">$wlan_modul</span><span class="s2"> </span><span class="nv">$wlan_modul2</span><span class="s2">"</span>
  /sbin/modprobe <span class="nv">$wlan_modul</span>
   sleep <span class="m">1</span>
   /sbin/modprobe <span class="nv">$wlan_modul2</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>
     
<span class="c1">## MAC-Adress Konfiguration WLAN-Interface</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nv">currentmac</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> grep -i link <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $6'</span><span class="o">}</span><span class="k">)</span>
  <span class="nv">cutmac</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> grep -i link <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $6'</span><span class="o">}</span> <span class="p">|</span> cut -c <span class="m">1</span>-15<span class="k">)</span>
   <span class="nv">newmacaddress</span><span class="o">=</span><span class="nv">$cutmac$lastoctet</span>   

<span class="nb">echo</span> <span class="s2">"erkannte MAC-Adresse des WLAN-Adapters"</span> <span class="nv">$currentmac</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>
    
<span class="c1">## deaktivate WLAN-Powermanagement / set Tx-Power    </span>
<span class="nb">echo</span> <span class="s2">"setze Stromsparmechanismen für </span><span class="nv">$wlaniface</span><span class="s2"> (Powersave = </span><span class="nv">$powersave</span><span class="s2">)"</span>
 /sbin/iw dev <span class="nv">$wlaniface</span> <span class="nb">set</span> power_save <span class="nv">$powersave</span>
  sleep <span class="m">1</span> 
  
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"setze Stromsparmechanismen für </span><span class="nv">$wlaniface2</span><span class="s2"> (Powersave = </span><span class="nv">$powersave</span><span class="s2">)"</span>
 /sbin/iw dev <span class="nv">$wlaniface2</span> <span class="nb">set</span> power_save <span class="nv">$powersave</span>
  sleep <span class="m">1</span> 
  
<span class="nb">echo</span> <span class="s2">"setze Sendeleistung des WLAN-Adapters </span><span class="nv">$wlaniface2</span><span class="s2"> (</span><span class="nv">$txpower2</span><span class="s2">"</span>dBm<span class="s2">")"</span>
 /sbin/iwconfig <span class="nv">$wlaniface2</span> txpower <span class="nv">$txpower2</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"setze Sendeleistung des WLAN-Adapters </span><span class="nv">$wlaniface</span><span class="s2"> (</span><span class="nv">$txpower</span><span class="s2">"</span>dBm<span class="s2">")"</span>
 /sbin/iwconfig <span class="nv">$wlaniface</span> txpower <span class="nv">$txpower</span>
  sleep <span class="m">1</span>
  
<span class="c1">## Regionseinstellung</span>
<span class="nb">echo</span> -e <span class="s2">"setze Regionseinstellungen des Systems (Regionscode </span><span class="nv">$regcode</span><span class="s2">)\n"</span>
/sbin/iw reg <span class="nb">set</span> <span class="nv">$regcode</span>
 sleep <span class="nv">$regdelay</span>
 
<span class="c1">## start hostapd</span>
<span class="nb">echo</span> <span class="s2">"Starte hostapd-Service"</span>
 <span class="nv">$hostapdservice</span> <span class="nv">$hostapdconf</span>
  sleep <span class="m">1</span>
   <span class="nb">echo</span> 
 
<span class="c1">## zweite WLAN-Schnittstelle erzeugen</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$second_phy</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>

<span class="c1">## WLAN-Schnittstellenerkennung</span>
<span class="nv">wiphy</span><span class="o">=</span><span class="k">$(</span>iw list <span class="p">|</span> grep Wiphy <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $2'</span><span class="o">}</span><span class="k">)</span>

 <span class="nb">echo</span> <span class="s2">"suche WLAN-Interface ..."</span> 
  <span class="nb">echo</span> <span class="s2">"physikalisch Schnittstelle </span><span class="nv">$wiphy</span><span class="s2"> gefunden"</span>
   <span class="nb">echo</span> <span class="s2">"erzeuge zweites virtuelles WLAN-Interface </span><span class="nv">$wlaniface2</span><span class="s2">"</span>
    /sbin/iw phy <span class="nv">$wiphy</span> interface add <span class="nv">$wlaniface2</span> <span class="nb">type</span> managed
   sleep <span class="m">1</span>
   
<span class="c1">## MAC-Adresse ändern  </span>
<span class="nb">echo</span> -e <span class="s2">"ändere MAC-Adresse von </span><span class="nv">$wlaniface2</span><span class="s2">. Setze </span><span class="nv">$newmacaddress</span><span class="s2">\n"</span>
 ip link <span class="nb">set</span> dev <span class="nv">$wlaniface2</span> addr <span class="nv">$newmacaddress</span>
  sleep <span class="nv">$wpa_delay</span>
  
<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"verwende zweiten WLAN-Adapter </span><span class="nv">$wlaniface2</span><span class="s2">"</span>
<span class="k">fi</span>
    
<span class="c1">## starte WLAN-Verbindung zum Accesspoint</span>
<span class="nb">echo</span> <span class="s2">"starte Verbindung zu WLAN-Accesspoint </span><span class="nv">$mac</span><span class="s2"> - </span><span class="nv">$ssid</span><span class="s2">"</span>
 <span class="nb">echo</span> <span class="s2">"Using interface </span><span class="nv">$wlaniface</span><span class="s2"> with hwaddr </span><span class="nv">$newmacaddress</span><span class="s2">"</span>
  <span class="nb">echo</span> -e <span class="s2">"einen Moment bitte, starte wpa_supplicant ...\n"</span>
  
/sbin/wpa_supplicant -D<span class="nv">$wpadriver</span> -i<span class="nv">$wlaniface2</span> -c<span class="nv">$configfile</span> -B
 <span class="nb">echo</span>
 
<span class="c1">## WLAN-Schnittstelle 2 konfigurieren</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$wlan2_dhcp</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"WLAN-Schnittstelle 2 initialisieren (statisch)"</span>
  <span class="nb">echo</span> -e <span class="s2">"Interface: </span><span class="nv">$wlaniface2</span><span class="s2"> IP-Adresse: </span><span class="nv">$wlan2_address</span><span class="s2"> Broadcast: </span><span class="nv">$wlan2_broadcast</span><span class="s2"> Netzmaske: </span><span class="nv">$wlan2_netmask</span><span class="s2">\n"</span>
   /sbin/ifconfig <span class="nv">$wlaniface2</span> <span class="nv">$wlan2_address</span> broadcast <span class="nv">$wlan2_broadcast</span> netmask <span class="nv">$wlan2_netmask</span>
    /sbin/route add default gw <span class="nv">$wlan2_gateway</span> metric <span class="m">0</span> dev <span class="nv">$wlaniface2</span>  

<span class="c1">## DNS setzen</span>
<span class="c1">## verwende erkanntes Gateway</span>
<span class="nb">echo</span> <span class="s2">"DNS-Konfiguration ..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$manDNS</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> -e <span class="s2">"nameserver"</span> <span class="k">$(</span>route -n <span class="p">|</span> grep UG <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $2'</span><span class="o">}</span><span class="k">)</span> <span class="p">|</span> tee /etc/resolv.conf
  <span class="nb">echo</span>
<span class="k">else</span>
  <span class="nb">echo</span> -e <span class="s2">"</span><span class="nv">$sys_domain</span><span class="s2">\n</span><span class="nv">$sys_search</span><span class="s2">\n</span><span class="nv">$sys_dns0</span><span class="s2">\n</span><span class="nv">$sys_dns1</span><span class="s2">\n</span><span class="nv">$sys_dns2</span><span class="s2">"</span> <span class="p">|</span> tee /etc/resolv.conf
 sleep <span class="m">1</span>
   <span class="nb">echo</span>
<span class="k">fi</span>

<span class="nb">echo</span> -e <span class="s2">"WLAN-Schnittstelle initialisieren (DHCP). Einen Moment bitte ...\n"</span>
 /sbin/dhclient <span class="nv">$wlaniface2</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>

<span class="c1">## Bridge konfigurieren</span>
/sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
 /sbin/brctl setfd <span class="nv">$bridgeiface</span> <span class="nv">$forward_delay</span>
  /sbin/brctl stp <span class="nv">$bridgeiface</span> <span class="nv">$stp</span>
   
<span class="c1">## Optional aktivieren   </span>
<span class="c1">#    /sbin/brctl setageing $bridgeiface $brageing</span>
<span class="c1">#     /sbin/brctl setmaxage $bridgeiface $brage</span>
   
<span class="c1">## initialize Bridge-Port</span>
<span class="nb">echo</span> <span class="s2">"Bridge-Schnittstelle initialisieren (statisch):"</span>
 <span class="nb">echo</span> -e <span class="s2">"Bridge: </span><span class="nv">$bridgeiface</span><span class="s2"> IP-Adresse: </span><span class="nv">$braddress</span><span class="s2"> Broadcast: </span><span class="nv">$brbroadcast</span><span class="s2"> Netzmaske: </span><span class="nv">$brnetmask</span><span class="s2">\n"</span>
 /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="nv">$braddress</span> broadcast <span class="nv">$brbroadcast</span> netmask <span class="nv">$brnetmask</span>
  /sbin/route add default gw <span class="nv">$wangateway</span> metric <span class="m">1</span> dev <span class="nv">$bridgeiface</span>
   sleep <span class="m">1</span>   
   
<span class="c1">## starting Services</span>
<span class="nb">echo</span> -e <span class="s2">"starte isc-dhcp-server\n"</span>
 <span class="nb">echo</span> <span class="s2">"DHCP-Range isc-dhcp-server:"</span>
  <span class="nb">echo</span> -e <span class="s2">"Schnittstelle: </span><span class="nv">$bridgeiface</span><span class="s2"> Startadresse: </span><span class="nv">$isc_startaddress</span><span class="s2"> Endadresse: </span><span class="nv">$isc_endaddress</span><span class="s2"> Lease: </span><span class="nv">$isc_leasetime</span><span class="s2">\n"</span>
  
service isc-dhcp-server start
 sleep <span class="m">1</span> 
<span class="nb">echo</span>

<span class="c1">## Forwarding &amp; NAT</span>
/sbin/iptables -A FORWARD -o <span class="nv">$wlaniface2</span> -i <span class="nv">$bridgeiface</span> -s <span class="nv">$iptablemask</span> -m conntrack --ctstate NEW -j ACCEPT
 /sbin/iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
  /sbin/iptables -t nat -A POSTROUTING -o <span class="nv">$wlaniface2</span> -j MASQUERADE 
  
<span class="nb">echo</span> <span class="s2">"aktiviere Port-Forwarding ..."</span>
 /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
  <span class="nb">echo</span> -e <span class="s2">"Konfiguration beendet.\n"</span>

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$showconfig</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   
 <span class="nb">echo</span> -e <span class="s2">"System DNS-Check und Routing:"</span>
  cat /etc/resolv.conf
   <span class="nb">echo</span>
    /sbin/route -n
     <span class="nb">echo</span>
    
<span class="nb">echo</span> -e <span class="s2">"Konfiguration Bridge:\n"</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    /sbin/brctl show
     <span class="nb">echo</span>
      /sbin/brctl showmacs <span class="nv">$bridgeiface</span>
       <span class="nb">echo</span>
      /sbin/brctl showstp <span class="nv">$bridgeiface</span>
    <span class="nb">echo</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales LAN (keine IP-Adresse im Bridged-Mode!):\n"</span>
  /sbin/ifconfig <span class="nv">$locallan</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>

    <span class="nb">echo</span> -e <span class="s2">"Konfiguration WLAN (keine IP-Adresse im Bridged-Mode!):\n"</span>
     /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
      <span class="nb">echo</span>
       /sbin/iwconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Power|Mode'</span>
      <span class="nb">echo</span>  
     <span class="nb">echo</span> <span class="s2">"Controll-Interface:"</span>    
    /sbin/iwconfig mon.<span class="nv">$wlaniface</span>
	  
    <span class="nb">echo</span> <span class="s2">"Virtuelles WLAN-Interface im Infrastruktur-Modus:"</span>
     /sbin/ifconfig <span class="nv">$wlaniface2</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
      <span class="nb">echo</span>
     /sbin/iwconfig <span class="nv">$wlaniface2</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Power|Mode'</span>
    <span class="nb">echo</span>      

<span class="nb">echo</span> -e <span class="s2">"Regionseinstellung des WLAN-Adapters:\n"</span>
 /sbin/iw reg get
  <span class="nb">echo</span>
	 
<span class="nb">echo</span> <span class="s2">"Dienstestatus:"</span>
service hostapd status
 service isc-dhcp-server status

  <span class="k">else</span>
 <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table></div></li></ul><p>
Dienstekonfiguration: der isc-dhcp Server wird durch das Skript konfiguriert. Es empfiehlt sich, die ursprünglichen Konfigurationsdateien <code class="notranslate">/etc/default/isc-dhcp-server</code> und <code class="notranslate">/etc/dhcpd/dhcp.conf</code> vorab zu sichern. Die Einstellung für den Funkkanal (<code class="notranslate">channel=4</code>) muss mit dem Funkkanal des WLAN-Accesspoint übereinstimmen, wenn für die Konfiguration nur ein einziger WLAN-Adapter verwendet wird! Werden zwei Adapter verwendet, so sollte der Abstand zum Funkkanal des Accesspoints mindestens 5 Kanäle betragen, um Störungen zu vermeiden.</p><ul><li><p><strong>/etc/hostapd_wlanbridge.conf</strong>: </p><pre class="notranslate"># Schnittstelle und Treiber
interface=wlan0
driver=nl80211
bridge=br0

# WLAN-Konfiguration
ssid=WLAN_AP
channel=4

# ESSID sichtbar
ignore_broadcast_ssid=0

# Ländereinstellungen
country_code=DE
ieee80211d=1

# Übertragungsmodus
hw_mode=g

# Optionale Einstellungen
# supported_rates=10 20 55 110 60 90 120 180 240 360 480 540

# Draft-N Modus aktivieren / optional nur für entsprechende Karten
# ieee80211n=1

# Übertragungsmodus / Bandbreite 40MHz
# ht_capab=[HT40+][SHORT-GI-40][DSSS_CCK-40]

# Beacons
beacon_int=100
dtim_period=2

# MAC-Authentifizierung
macaddr_acl=0

# max. Anzahl der Clients
max_num_sta=20

# Größe der Datenpakete/Begrenzung
rts_threshold=2347
fragm_threshold=2346

# hostapd Log Einstellungen
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2

# temporäre Konfigurationsdateien
dump_file=/tmp/hostapd.dump
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# Authentifizierungsoptionen 
auth_algs=3

# wmm-Funktionalität
wmm_enabled=0

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Schlüsselintervalle / Standardkonfiguration
wpa_group_rekey=600
wpa_ptk_rekey=600
wpa_gmk_rekey=86400

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890abcdefghijklmn</pre></li></ul><p>
<img alt="/squid/squid-logo.png" class="image-right" src="../_/356fc694bdf99b632c29ca10f788bfa935ca008a.png"/>
</p></div><div class="section_2"><h3 id="WLAN-Router-und-Proxyserver">WLAN-Router und Proxyserver<a class="headerlink" href="#WLAN-Router-und-Proxyserver">¶</a></h3><p>
Erforderliche Programme:
</p><ul><li><p><a class="internal" href="../squid.html">Squid</a> (Version 2.x oder 3.x)</p></li><li><p><a class="internal" href="../privoxy.html">Privoxy</a></p></li><li><p><a class="internal" href="../wlan_router.html">hostapd</a></p></li><li><p><a class="internal" href="../netzwerkbrücke.html">bridge-utils</a></p></li><li><p><a class="internal" href="../iw.html">iw</a></p></li></ul><p>
Funktionsbeschreibung:
</p><ul><li><p>LAN/WLAN-Router im Bridged-Mode mit transparente Bridge, transparentem Proxyserver Squid und Werbeblocker Privoxy</p><ul><li><p>Ethernetschnittstelle 1 verbindet zum vorhandenen Router (Internetanbindung)</p></li><li><p>WLAN-Accesspoint</p></li><li><p>Ethernetschnittstelle 2 für das lokale Netzwerk (optional)</p></li><li><p>DHCP-Server bleibt der vorhandenen (FRITZ!Box-)Router</p></li><li><p>alle Clients befinden sich im selben Netzwerk</p></li><li><p>eine Proxy-Konfiguration der Clients ist nicht erforderlich, da transparente Konfiguration des Proxyservers</p></li></ul></li></ul><p>
</p><ul><li><p><strong>instant_AP-bridge_Proxy.sh</strong>: </p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant WLAN Access-Point an Ethernet Router with transparent bridged interfaces</span>
<span class="c1">## for Raspberry Pi™ with Raspian and other Linux based Systems</span>
<span class="c1">##</span>
<span class="c1">## with transparent Proxyserver Squid and  Privoxy Contentfilter</span>
<span class="c1">##</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2013</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 1.7.1.4bp / 08. ONovember 2013</span>
<span class="c1">## have fun :-)</span>

<span class="c1">## freie Variablen</span>

<span class="c1">## Source-Interface / WAN-Schnittstelle</span>
<span class="c1">## durch die interfaces gesteuerte Schnittstelle für die Internetverbindung</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="c1">## Standard eth0 / Ethernet</span>
<span class="nv">sourceiface</span><span class="o">=</span>eth0

<span class="c1">## Bridge-Konfiguration</span>
<span class="nv">bridgeiface</span><span class="o">=</span>br0
<span class="nv">forward_delay</span><span class="o">=</span><span class="m">2</span>
<span class="nv">stp</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># optional</span>
<span class="nv">brageing</span><span class="o">=</span><span class="m">10000</span>
<span class="nv">brage</span><span class="o">=</span><span class="m">40</span>

<span class="c1"># WLBridge statisch (0) oder dynamisch (1) konfigurieren (0 statisch/Standard)</span>
<span class="c1"># bedingt empfehlenswert, da so wechselnde IP-Adresse möglich</span>
<span class="c1"># die IP-Adresseinstellungen in Squid, Privoxy und Tor müssenn dementsprechend angepasst werden.</span>
<span class="nv">bridge_dhcp</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## Adresskonfiguration statisch / IP-Bereich ggf. anpassen</span>
<span class="c1"># die IP-Adresseinstellungen in Squid, Privoxy müssenn dementsprechend angepasst werden.</span>
<span class="nv">braddress</span><span class="o">=</span><span class="m">192</span>.168.178.5
<span class="nv">brbroadcast</span><span class="o">=</span><span class="m">192</span>.168.178.255
<span class="nv">brnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0

<span class="c1">## IP-Adresse des Routers/Gateway</span>
<span class="nv">wangateway</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">## manuelle DNS-Konfiguration aktiviert (1) oder deaktiviert (0) (Standard)</span>
<span class="nv">manDNS</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># manuelle DNS-Konfiguration</span>
<span class="nv">sys_domain</span><span class="o">=</span><span class="s2">"domain fritz.box"</span>
<span class="nv">sys_search</span><span class="o">=</span><span class="s2">"search fritz.box"</span>
<span class="nv">sys_dns0</span><span class="o">=</span><span class="s2">"nameserver 192.168.178.1"</span>

<span class="c1">## optional DNS 2 &amp; 3 aktivieren</span>
<span class="c1">## Beispiel</span>
<span class="c1"># sys_dns1="nameserver 8.8.4.4"</span>
<span class="c1"># sys_dns2="nameserver 8.8.8.8"</span>
<span class="nv">sys_dns1</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">sys_dns2</span><span class="o">=</span><span class="s2">""</span>

<span class="c1">## Konfiguration der WLAN-Schnittstelle die den Accesspoint erzeugt</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">wlaniface</span><span class="o">=</span>wlan0

<span class="c1">## aut. Modulerkennung aktiviert (1) oder abgeschaltet (0)</span>
<span class="c1">## nur für RaspberryPi</span>
<span class="nv">auto_ident</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## verwendetes WLAN-Modul bei auto_ident=0 eintragen</span>
<span class="nv">wlan_modul</span><span class="o">=</span><span class="s2">"carl9170"</span>

<span class="c1">## Konfiguration der lokalen LAN-Schnittstelle</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">locallan</span><span class="o">=</span>eth1

<span class="c1">## lokales LAN aktivieren (1), oder nicht (0)</span>
<span class="c1">## abschalten, sollte keine zweite Ethernetschnittstelle vorhanden sein</span>
<span class="nv">locallan_on</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Sendeleistung einstellen</span>
<span class="c1"># Optionen: auto|fixed|limit</span>
<span class="nv">txpoweroption</span><span class="o">=</span><span class="s2">"limit"</span>

<span class="c1"># tx power in dBm</span>
<span class="nv">txpower</span><span class="o">=</span><span class="m">15</span>

<span class="c1">## Regionseinstellung</span>
<span class="nv">regcode</span><span class="o">=</span><span class="s2">"DE"</span>
<span class="nv">regdelay</span><span class="o">=</span><span class="m">3</span>

<span class="c1"># Lease-Time</span>
<span class="nv">leasetime</span><span class="o">=</span>infinite

<span class="c1">## Steuerung hostapd</span>
<span class="nv">hostapdservice</span><span class="o">=</span><span class="s2">"hostapd -B"</span>
<span class="nv">hostapdconf</span><span class="o">=</span><span class="s2">"/etc/hostapd_wlanbridge.conf"</span>

<span class="c1">## Iptables-Filter bei Programmende löschen</span>
<span class="c1"># Standard=1</span>
<span class="c1"># bei pppoe-Verbindungen oder Bridge-Konfiguration auf 0 setzen</span>
<span class="nv">delfilter</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## zeige Konfiguration nach Ablauf des Skripts (1/0)</span>
<span class="c1">## zur Diadnose bei Fehlfunktionen</span>
<span class="nv">showconfig</span><span class="o">=</span><span class="m">1</span>

<span class="c1">##Konfigurationsdatei Info zuletzt erkannter WLAN-Adapter/Treibermodul</span>
<span class="nv">wlan_adapterfile</span><span class="o">=</span><span class="s2">"wlan_adapter.txt"</span>

<span class="c1">## verwendete Squid-version (v2.x - v3.x)</span>
<span class="c1">## squid v2.x - squid=squid</span>
<span class="c1">## squid v3.x - squid=squid3</span>
<span class="nv">squid</span><span class="o">=</span>squid3

<span class="c1">## Ende freie Variablen</span>

<span class="c1"># Skript</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-h"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_AP-bridge.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_Proxy.sh -start startet den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_Proxy.sh -stop beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_Proxy.sh beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration ausführen\n"</span>

<span class="c1"># Konfiguration löschen, Dienste stoppen</span>
sleep <span class="m">1</span>
 service hostapd stop
  /usr/bin/killall hostapd
   service <span class="nv">$squid</span> stop
    service privoxy stop
     service tor stop
      /usr/bin/killall dnsmasq squid
       /bin/rm -f /var/run/hostapd/<span class="nv">$wlaniface</span>
     /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>   
       
<span class="c1">## Bridge löschen</span>
<span class="nb">echo</span> <span class="s2">"lösche Bridge und Konfiguration"</span>
/sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$sourceiface</span>
 /sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> down
   /sbin/brctl delbr <span class="nv">$bridgeiface</span>
   
<span class="nb">echo</span> <span class="s2">"entferne WAN-Konfiguration"</span> 
 /sbin/ifconfig <span class="nv">$sourceiface</span> <span class="m">0</span>.0.0.0   
  sleep <span class="m">1</span>
   /sbin/ifconfig <span class="nv">$sourceiface</span> down  
   
<span class="nb">echo</span> <span class="s2">"entferne LAN-Konfiguration"</span> 
 /sbin/ifconfig <span class="nv">$locallan</span> <span class="m">0</span>.0.0.0   
  sleep <span class="m">1</span>
   /sbin/ifconfig <span class="nv">$locallan</span> down  
  
<span class="nb">echo</span> <span class="s2">"entferne WLAN-Konfiguration"</span>
  /sbin/iwconfig <span class="nv">$wlaniface</span> mode managed
   sleep <span class="m">1</span>
    /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="m">0</span>.0.0.0
     sleep <span class="m">1</span>
      /sbin/ifconfig <span class="nv">$wlaniface</span> down
       sleep <span class="m">2</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$delfilter</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"lösche iptables-Filter"</span>
 /sbin/iptables -F
  /sbin/iptables -X
   /sbin/iptables -t nat -F
    /sbin/modprobe -rfv iptable_nat ipt_MASQUERADE xt_conntrack iptable_filter   
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"Router &amp; WLAN Access-Point Konfiguration beendet."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"stoppe alle Dienste, und Verbindungen"</span>
  <span class="nb">exit</span>
 <span class="k">fi</span>

<span class="c1">## start Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Starte alle Dienste, und Verbindungen\n"</span>

<span class="c1">## Modulerkennung WLAN</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$auto_ident</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nv">wlan_modul</span><span class="o">=</span><span class="k">$(</span>find /sys/class/net/<span class="nv">$wlaniface</span>/device/driver/module/drivers/ <span class="p">|</span> grep usb <span class="p">|</span> cut -c <span class="m">55</span>-70<span class="k">)</span>
  <span class="nv">lastknownmodule</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$wlan_adapterfile</span><span class="k">)</span>
   <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul </span><span class="nv">$wlan_modul</span><span class="s2"> erkannt, vorheriges Modul: </span><span class="nv">$lastknownmodule</span><span class="s2">"</span>
<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"Autoerkennung des WLAN-Treibermodul deaktiviert."</span>
  <span class="nb">echo</span> -e <span class="s2">"verwendet </span><span class="nv">$wlan_modul</span><span class="s2">\n"</span>
   <span class="nb">echo</span> <span class="nv">$wlan_modul</span> &gt; <span class="nv">$wlan_adapterfile</span>
<span class="k">fi</span>

<span class="nv">lastknownmodule</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$wlan_adapterfile</span><span class="k">)</span>
 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$lastknownmodule</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
  <span class="nv">lastknownmodule</span><span class="o">=</span><span class="s2">"none"</span>
   <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul </span><span class="nv">$wlan_modul</span><span class="s2"> erkannt, vorheriges Modul: </span><span class="nv">$lastknownmodule</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c1">## reinitialisiere WLAN-Adapter</span>
<span class="nb">echo</span> -e <span class="s2">"WLAN-Adapter reinitialisieren ...\n"</span>
 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$wlan_modul</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lastknownmodule</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
   sleep <span class="m">1</span>
    /sbin/modprobe <span class="nv">$wlan_modul</span> 
   sleep <span class="m">1</span>
    
<span class="k">else</span>
 /sbin/modprobe -rf <span class="nv">$lastknownmodule</span>  
  sleep <span class="m">1</span>
   /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
    sleep <span class="m">1</span>
     /sbin/modprobe <span class="nv">$wlan_modul</span> 
    sleep <span class="m">1</span>
   <span class="nb">echo</span> <span class="nv">$wlan_modul</span> &gt; <span class="nv">$wlan_adapterfile</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>
  
<span class="c1">## initialize WAN-Port</span>
 /sbin/ifconfig <span class="nv">$sourceiface</span> up
  sleep <span class="m">1</span>

<span class="c1">## deaktivate WLAN-Powermanagement / set Tx-Power    </span>
<span class="nb">echo</span> -e <span class="s2">"deaktiviere Stromsparmechanismen für </span><span class="nv">$wlaniface</span><span class="s2">"</span>
 /sbin/iw dev <span class="nv">$wlaniface</span> <span class="nb">set</span> power_save off
  sleep <span class="m">1</span>

<span class="nb">echo</span> -e <span class="s2">"setze Sendeleistung des WLAN-Adapters </span><span class="nv">$wlaniface</span><span class="s2">"</span>
<span class="c1"># /sbin/iw dev $wlaniface set txpower $txpoweroption $txpower</span>
/sbin/iwconfig <span class="nv">$wlaniface</span> txpower <span class="nv">$txpower</span>
  sleep <span class="m">1</span>
  
<span class="c1">## Regionseinstellung</span>
<span class="nb">echo</span> -e <span class="s2">"setze Regionseinstellung des WLAN-Adapters </span><span class="nv">$wlaniface</span><span class="s2">"</span>
/sbin/iw reg <span class="nb">set</span> <span class="nv">$regcode</span>
 sleep <span class="nv">$regdelay</span>
  
<span class="c1">## start hostapd</span>
<span class="nb">echo</span> -e <span class="s2">"Starte hostapd-Service:\n"</span>
 <span class="nv">$hostapdservice</span> <span class="nv">$hostapdconf</span>
  sleep <span class="m">1</span>
   <span class="nb">echo</span>
  
<span class="c1">## Bridge konfigurieren</span>
/sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$sourceiface</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$locallan_on</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
  <span class="nb">echo</span> -e <span class="s2">"Ethernerschnittstelle 2 aktiviert.\n"</span>
 <span class="k">fi</span>
  /sbin/brctl setfd <span class="nv">$bridgeiface</span> <span class="nv">$forward_delay</span>
   /sbin/brctl stp <span class="nv">$bridgeiface</span> <span class="nv">$stp</span>
   
<span class="c1">## Optional aktivierbar   </span>
<span class="c1">#    /sbin/brctl setageing $bridgeiface $brageing</span>
<span class="c1">#     /sbin/brctl setmaxage $bridgeiface $brage</span>
   
<span class="c1">## initialize Bridge-Port</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$bridge_dhcp</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"Bridge-Schnittstelle </span><span class="nv">$bridgeiface</span><span class="s2"> initialisieren (statisch):"</span>
  <span class="nb">echo</span> -e <span class="s2">"Interfac: </span><span class="nv">$bridgeiface</span><span class="s2"> IP-Adresse: </span><span class="nv">$braddress</span><span class="s2"> Broadcast: </span><span class="nv">$brbroadcast</span><span class="s2"> Netzmaske: </span><span class="nv">$brnetmask</span><span class="s2">"</span>
   /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="nv">$braddress</span> broadcast <span class="nv">$brbroadcast</span> netmask <span class="nv">$brnetmask</span>
    /sbin/route add default gw <span class="nv">$wangateway</span> metric <span class="m">0</span> dev <span class="nv">$bridgeiface</span>
     sleep <span class="m">1</span>
 <span class="k">else</span>
<span class="nb">echo</span> -e <span class="s2">"Bridge </span><span class="nv">$bridgeiface</span><span class="s2">  automatisch initialisieren (DHCP). Einen Moment bitte ...\n"</span>
  /sbin/dhclient <span class="nv">$bridgeiface</span>
   sleep <span class="m">1</span>
 <span class="k">fi</span>
  /sbin/ifconfig <span class="nv">$sourceiface</span> up
    
<span class="c1">## Forwarding to squid</span>
/sbin/iptables -t nat -A PREROUTING -i <span class="nv">$bridgeiface</span> -p tcp --dport <span class="m">80</span> -j REDIRECT --to-port <span class="m">3128</span>      

<span class="c1">## optional aktivieren</span>
<span class="c1">#/sbin/iptables -t nat -A PREROUTING -i $bridgeiface -p tcp --dport 22 -j REDIRECT --to-ports 3128</span>

<span class="c1">## starting Services    </span>
<span class="nb">echo</span> -e <span class="s2">"starte Proxyserver Squid\n"</span> 
 service <span class="nv">$squid</span> start
  sleep <span class="m">1</span>
   <span class="nb">echo</span> -e <span class="s2">"Starte Privoxy\n"</span>
    service privoxy start
     sleep <span class="m">1</span>
 
<span class="c1">## DNS setzen</span>
<span class="c1">## verwende erkanntes Gateway</span>
<span class="nb">echo</span> <span class="s2">"DNS-Konfiguration ..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$manDNS</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> -e <span class="s2">"nameserver"</span> <span class="k">$(</span>route -n <span class="p">|</span> grep UG <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $2'</span><span class="o">}</span><span class="k">)</span> <span class="p">|</span> tee /etc/resolv.conf
<span class="c1">#echo -e "nameserver 192.168.178.5" | tee /etc/resolv.conf</span>
  <span class="nb">echo</span>
<span class="k">else</span>
  <span class="nb">echo</span> -e <span class="s2">"</span><span class="nv">$sys_domain</span><span class="s2">\n</span><span class="nv">$sys_search</span><span class="s2">\n</span><span class="nv">$sys_dns0</span><span class="s2">\n</span><span class="nv">$sys_dns1</span><span class="s2">\n</span><span class="nv">$sys_dns2</span><span class="s2">"</span> <span class="p">|</span> tee /etc/resolv.conf
 sleep <span class="m">1</span>
   <span class="nb">echo</span>
<span class="k">fi</span>

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$showconfig</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   
 <span class="nb">echo</span> -e <span class="s2">"System DNS-Check und Routing:"</span>
  cat /etc/resolv.conf
   <span class="nb">echo</span>
    /sbin/route -n
     <span class="nb">echo</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration Bridge:\n"</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    /sbin/brctl show
     <span class="nb">echo</span>
      /sbin/brctl showmacs <span class="nv">$bridgeiface</span>
       <span class="nb">echo</span>
      /sbin/brctl showstp <span class="nv">$bridgeiface</span>
    <span class="nb">echo</span>
    
<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales WAN:\n"</span>
  /sbin/ifconfig <span class="nv">$sourceiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
  
<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales LAN:\n"</span>
  /sbin/ifconfig <span class="nv">$locallan</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>

  <span class="nb">echo</span> <span class="s2">"Konfiguration WLAN:"</span>
   /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
    <span class="nb">echo</span>
     /sbin/iwconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Power|Mode'</span>
      <span class="nb">echo</span>      
       /sbin/iwconfig mon.<span class="nv">$wlaniface</span>

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Regionseinstellung des WLAN-Adapters:\n"</span>
 /sbin/iw reg get
  <span class="nb">echo</span>

<span class="nb">echo</span> <span class="s2">"Iptables:"</span>
 iptables -t nat -L
  <span class="nb">echo</span>
	 
<span class="nb">echo</span> <span class="s2">"Dienstestatus:"</span>
service hostapd status
 service <span class="nv">$squid</span> status
  service privoxy status
<span class="k">else</span>
 <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table></div></li></ul><p>
</p><ul><li><p>Dienstekonfiguration via <strong>/etc/hostapd_wlanbridge.conf</strong>: </p><pre class="notranslate"># Schnittstelle und Treiber
interface=wlan0
driver=nl80211
bridge=br0

# WLAN-Konfiguration
ssid=WLAN_AP
channel=4

# ESSID sichtbar
ignore_broadcast_ssid=0

# Ländereinstellungen
country_code=DE
ieee80211d=1

# Übertragungsmodus
hw_mode=g

# Optionale Einstellungen
# supported_rates=10 20 55 110 60 90 120 180 240 360 480 540

# Draft-N Modus aktivieren / optional nur für entsprechende Karten
# ieee80211n=1

# Übertragungsmodus / Bandbreite 40MHz
# ht_capab=[HT40+][SHORT-GI-40][DSSS_CCK-40]

# Beacons
beacon_int=100
dtim_period=2

# MAC-Authentifizierung
macaddr_acl=0

# max. Anzahl der Clients
max_num_sta=20

# Größe der Datenpakete/Begrenzung
rts_threshold=2347
fragm_threshold=2346

# hostapd Log Einstellungen
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2

# temporäre Konfigurationsdateien
dump_file=/tmp/hostapd.dump
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# Authentifizierungsoptionen 
auth_algs=3

# wmm-Funktionalität
wmm_enabled=0

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Schlüsselintervalle / Standardkonfiguration
wpa_group_rekey=600
wpa_ptk_rekey=600
wpa_gmk_rekey=86400

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890abcdefghijklmn</pre></li></ul><p>
</p><ul><li><p><strong>/etc/squid3/squid.conf</strong> (hier für Squid v3.x, unter v2.x sehen die acl-Regeln für <code class="notranslate">localhost</code> etwas anders aus. Beachtet dazu die original <code class="notranslate">squid.conf</code> nach der Installation). Die Einstellungen für den verwendeten IP-Bereich im lokalen Netzwerk muss angepasst werden. Zusätzliche Funktionen und Filterregeln, wie zeitgesteuerte Berechtigungen für einzelne Clients usw. können natürlich nach Belieben hinzugefügt werden: </p><pre class="notranslate">#	WELCOME TO SQUID 3.1.20
acl manager proto cache_object
acl localhost src 127.0.0.1/32 ::1
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1

# Example rule allowing access from your local networks.
acl localnet src 192.168.0.0/24	

# lokale Rechner freigegeben
acl lokale_rechner src 192.168.178.0/24
http_access allow lokale_rechner

acl SSL_ports port 443		# https
acl SSL_ports port 563		# snews
acl SSL_ports port 873		# rsync
acl Safe_ports port 80 		# http
acl Safe_ports port 20 		# ftp
acl Safe_ports port 21 		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl Safe_ports port 631		# cups
acl Safe_ports port 873		# rsync
acl Safe_ports port 901		# SWAT
acl purge method PURGE
acl CONNECT method CONNECT

# Only allow cachemgr access from localhost
http_access allow manager localhost
http_access deny manager

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
#http_access deny to_localhost

# Example rule allowing access from your local networks.
http_access allow localhost

#Allow ICP queries from local networks only
icp_access allow localnet
icp_access deny all

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 3128 transparent

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid3

# Add any of your own refresh_pattern entries above these.
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320

forwarded_for off
via off

# Weiterleitung auf privoxy
cache_peer 127.0.0.1 parent 8118 7 no-query default</pre></li></ul><p>
</p><ul><li><p><strong>/etc/privoxy/config</strong>: </p><pre class="notranslate"># privoxy lauscht auf ...
listen-address 127.0.0.1:8118

user-manual /usr/share/doc/privoxy/user-manual
confdir /etc/privoxy
logdir /var/log/privoxy

forwarded-connect-retries 1
accept-intercepted-requests 0
allow-cgi-request-crunching 0
split-large-forms 0
keep-alive-timeout 5
socket-timeout 300

actionsfile match-all.action 
actionsfile default.action   
actionsfile user.action      

filterfile default.filter
filterfile user.filter      

logfile logfile
toggle  1
enable-remote-toggle  0
enable-remote-http-toggle  0
enable-edit-actions 0
enforce-blocks 0
buffer-limit 4096</pre></li></ul><p>
<img alt="./Tor_logo1.png" class="image-right" src="../_/689aa026bb782a40bbbce4daf9cd8b29295b9c89.png"/>
</p></div><div class="section_2"><h3 id="Tor-WLAN-Router-Onion-Router">Tor WLAN-Router (Onion-Router)<a class="headerlink" href="#Tor-WLAN-Router-Onion-Router">¶</a></h3><p>
Erforderliche Programme:
</p><ul><li><p><a class="internal" href="../tor.html">Tor</a></p></li><li><p><a class="internal" href="../wlan_router.html">hostapd</a></p></li><li><p><a class="internal" href="../netzwerkbrücke.html">bridge-utils</a></p></li><li><p><a class="internal" href="../iw.html">iw</a></p></li></ul><p>
Funktionsbeschreibung:
</p><ul><li><p>LAN/WLAN-Router im Bridged-Mode mit transparenter Bridge und Anbindung an das Tor-Netzwerk</p><ul><li><p>Ethernetschnittstelle 1 verbindet zum vorhandenen Router (Internetanbindung)</p></li><li><p>WLAN-Accesspoint</p></li><li><p>Ethernetschnittstelle 2 für das lokale Netzwerk (optional)</p></li><li><p>DHCP-Server beleibt der vorhandenen Router</p></li><li><p>alle Clients befinden sich im selben Netzwerk</p></li><li><p>eine Proxy-Konfiguration der Clients und verwendeten Internetbrowser ist nicht erforderlich, da transparente Konfiguration</p></li><li><p>Zeitsynchronisation über NTP-Server (optional)</p></li></ul></li></ul><p>
</p><ul><li><p><strong>instant_AP-bridge_Tor.sh</strong>: </p><div class="code"><table class="notranslate syntaxtable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345</pre></div></td><td class="code"><div class="notranslate syntax"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">## Instant WLAN Access-Point an Ethernet Router with transparent bridged interfaces and Tor Network</span>
<span class="c1">## for Raspberry Pi™ with Raspian and other Linux based Systems</span>
<span class="c1">##</span>
<span class="c1">## elektronenblitz63 ubuntuusers.de 2013</span>
<span class="c1">## published under GPL v3</span>
<span class="c1">##</span>
<span class="c1">## Version 1.7.1.4bt / 17. ONovember 2013</span>
<span class="c1">## have fun :-)</span>

<span class="c1">## freie Variablen</span>

<span class="c1">## Source-Interface / WAN-Schnittstelle</span>
<span class="c1">## durch die interfaces gesteuerte Schnittstelle für die Internetverbindung</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="c1">## Standard eth0 / Ethernet</span>
<span class="nv">sourceiface</span><span class="o">=</span>eth0

<span class="c1">## Bridge-Konfiguration</span>
<span class="nv">bridgeiface</span><span class="o">=</span>br0
<span class="nv">forward_delay</span><span class="o">=</span><span class="m">2</span>
<span class="nv">stp</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># optional</span>
<span class="nv">brageing</span><span class="o">=</span><span class="m">10000</span>
<span class="nv">brage</span><span class="o">=</span><span class="m">40</span>

<span class="c1"># Bridge statisch (0) oder dynamisch (1) konfigurieren (0 statisch/Standard)</span>
<span class="c1"># bedingt empfehlenswert, da so wechselnde IP-Adresse möglich</span>
<span class="c1"># die IP-Adresseinstellungen in und Tor müssenn dementsprechend angepasst werden!</span>
<span class="nv">bridge_dhcp</span><span class="o">=</span><span class="m">0</span>

<span class="c1">## Adresskonfiguration statisch / IP-Bereich an das eigene Netzwerk anpassen</span>
<span class="c1"># die IP-Adresseinstellungen in Squid, Privoxy und Tor müssenn dementsprechend angepasst werden.</span>
<span class="nv">braddress</span><span class="o">=</span><span class="m">192</span>.168.178.5
<span class="nv">brbroadcast</span><span class="o">=</span><span class="m">192</span>.168.178.255
<span class="nv">brnetmask</span><span class="o">=</span><span class="m">255</span>.255.255.0

<span class="c1">## IP-Adresse des Routers/Gateway</span>
<span class="nv">wangateway</span><span class="o">=</span><span class="m">192</span>.168.178.1

<span class="c1">## manuelle DNS-Konfiguration aktiviert (1) oder deaktiviert (0) (Standard)</span>
<span class="nv">manDNS</span><span class="o">=</span><span class="m">0</span>

<span class="c1"># manuelle DNS-Konfiguration</span>
<span class="nv">sys_domain</span><span class="o">=</span><span class="s2">"domain fritz.box"</span>
<span class="nv">sys_search</span><span class="o">=</span><span class="s2">"search fritz.box"</span>
<span class="nv">sys_dns0</span><span class="o">=</span><span class="s2">"nameserver 192.168.178.1"</span>

<span class="c1">## optional DNS 2 &amp; 3 aktivieren</span>
<span class="c1">## Beispiel</span>
<span class="c1"># sys_dns1="nameserver 8.8.4.4"</span>
<span class="c1"># sys_dns2="nameserver 8.8.8.8"</span>
<span class="nv">sys_dns1</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">sys_dns2</span><span class="o">=</span><span class="s2">""</span>

<span class="c1">## Konfiguration der WLAN-Schnittstelle die den Accesspoint erzeugt</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">wlaniface</span><span class="o">=</span>wlan0

<span class="c1">## aut. Modulerkennung aktiviert (1) oder abgeschaltet (0)</span>
<span class="c1">## nur für RaspberryPi</span>
<span class="nv">auto_ident</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## verwendetes WLAN-Modul bei auto_ident=0 eintragen</span>
<span class="nv">wlan_modul</span><span class="o">=</span><span class="s2">"carl9170"</span>

<span class="c1">## Konfiguration der lokalen LAN-Schnittstelle</span>
<span class="c1">## Bezeichnung ggf. anpassen</span>
<span class="nv">locallan</span><span class="o">=</span>eth1

<span class="c1">## lokales LAN aktivieren (1), oder nicht (0)</span>
<span class="c1">## abschalten, sollte keine zweite Ethernetschnittstelle vorhanden sein</span>
<span class="nv">locallan_on</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># Sendeleistung einstellen</span>
<span class="c1"># Optionen: auto|fixed|limit</span>
<span class="nv">txpoweroption</span><span class="o">=</span><span class="s2">"limit"</span>

<span class="c1"># tx power in dBm</span>
<span class="nv">txpower</span><span class="o">=</span><span class="m">15</span>

<span class="c1">## Regionseinstellung</span>
<span class="nv">regcode</span><span class="o">=</span><span class="s2">"DE"</span>
<span class="nv">regdelay</span><span class="o">=</span><span class="m">3</span>

<span class="c1"># Lease-Time</span>
<span class="nv">leasetime</span><span class="o">=</span>infinite

<span class="c1">## Steuerung hostapd</span>
<span class="nv">hostapdservice</span><span class="o">=</span><span class="s2">"hostapd -B"</span>
<span class="nv">hostapdconf</span><span class="o">=</span><span class="s2">"/etc/hostapd_tor.conf"</span>

<span class="c1">## Iptables-Filter bei Programmende löschen</span>
<span class="c1"># Standard=1</span>
<span class="c1"># bei pppoe-Verbindungen oder Bridge-Konfiguration auf 0 setzen</span>
<span class="nv">delfilter</span><span class="o">=</span><span class="m">1</span>

<span class="c1">## zeige Konfiguration nach Ablauf des Skripts (1/0)</span>
<span class="c1">## zur Diadnose bei Fehlfunktionen</span>
<span class="nv">showconfig</span><span class="o">=</span><span class="m">1</span>

<span class="c1">##Konfigurationsdatei Info zuletzt erkannter WLAN-Adapter/Treibermodul</span>
<span class="nv">wlan_adapterfile</span><span class="o">=</span><span class="s2">"wlan_adapter.txt"</span>

<span class="c1">## NTP Timeserver aktiv (1) / nicht aktiv (0)</span>
<span class="nv">ntp_timeset</span><span class="o">=</span><span class="m">0</span>
<span class="nv">ntp_command</span><span class="o">=</span><span class="s2">"ntpdate -u"</span>
<span class="nv">ntp_server</span><span class="o">=</span><span class="s2">"ntp.ubuntu.com"</span>

<span class="c1">## Ende freie Variablen</span>

<span class="c1"># Skript</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"-h"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> Verwendung: instant_AP-bridge.sh <span class="o">[</span>-start<span class="o">]</span> <span class="o">[</span>-stop<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span>
<span class="nb">echo</span> Syntax:
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_Tor.sh -start startet den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_Tor.sh -stop beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"sudo ./instant_AP-bridge_Tor.sh beendet die Konfiguration und schließt den AP"</span>
<span class="nb">echo</span> <span class="s2">"Ende"</span>
 <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration ausführen\n"</span>

<span class="c1"># Konfiguration löschen, Dienste stoppen</span>
service hostapd stop
 /usr/bin/killall hostapd
  service tor stop
   /usr/bin/killall dnsmasq
    /bin/rm -f /var/run/hostapd/<span class="nv">$wlaniface</span>
     /sbin/sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">0</span>   
       
<span class="c1">## Bridge löschen</span>
<span class="nb">echo</span> <span class="s2">"lösche Bridge und Konfiguration"</span>
/sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$sourceiface</span>
 /sbin/brctl delif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> down
   /sbin/brctl delbr <span class="nv">$bridgeiface</span>
   
<span class="nb">echo</span> <span class="s2">"entferne WAN-Konfiguration"</span> 
 /sbin/ifconfig <span class="nv">$sourceiface</span> <span class="m">0</span>.0.0.0   
  sleep <span class="m">1</span>
   /sbin/ifconfig <span class="nv">$sourceiface</span> down  

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$locallan_on</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   
 <span class="nb">echo</span> <span class="s2">"entferne LAN-Konfiguration"</span> 
  /sbin/ifconfig <span class="nv">$locallan</span> <span class="m">0</span>.0.0.0   
   sleep <span class="m">1</span>
    /sbin/ifconfig <span class="nv">$locallan</span> down  
<span class="k">fi</span> 

<span class="nb">echo</span> <span class="s2">"entferne WLAN-Konfiguration"</span>
  /sbin/iwconfig <span class="nv">$wlaniface</span> mode managed
   sleep <span class="m">1</span>
    /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="m">0</span>.0.0.0
     sleep <span class="m">1</span>
      /sbin/ifconfig <span class="nv">$wlaniface</span> down
       sleep <span class="m">2</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$delfilter</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"lösche iptables-Filter"</span>
 /sbin/iptables -F
  /sbin/iptables -X
   /sbin/iptables -t nat -F
    /sbin/modprobe -rfv iptable_nat ipt_MASQUERADE xt_conntrack iptable_filter   
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">"Router &amp; WLAN Access-Point Konfiguration beendet."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> !<span class="o">=</span> <span class="s2">"-start"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"stoppe alle Dienste, und Verbindungen"</span>
  <span class="nb">exit</span>
 <span class="k">fi</span>

<span class="c1">## start Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Starte alle Dienste, und Verbindungen\n"</span>

<span class="c1">## Modulerkennung WLAN</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$auto_ident</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nv">wlan_modul</span><span class="o">=</span><span class="k">$(</span>find /sys/class/net/<span class="nv">$wlaniface</span>/device/driver/module/drivers/ <span class="p">|</span> grep usb <span class="p">|</span> cut -c <span class="m">55</span>-70<span class="k">)</span>
  <span class="nv">lastknownmodule</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$wlan_adapterfile</span><span class="k">)</span>
   <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul </span><span class="nv">$wlan_modul</span><span class="s2"> erkannt, vorheriges Modul: </span><span class="nv">$lastknownmodule</span><span class="s2">"</span>
<span class="k">else</span>
 <span class="nb">echo</span> <span class="s2">"Autoerkennung des WLAN-Treibermodul deaktiviert."</span>
  <span class="nb">echo</span> -e <span class="s2">"verwendet </span><span class="nv">$wlan_modul</span><span class="s2">\n"</span>
   <span class="nb">echo</span> <span class="nv">$wlan_modul</span> &gt; <span class="nv">$wlan_adapterfile</span>
<span class="k">fi</span>

<span class="nv">lastknownmodule</span><span class="o">=</span><span class="k">$(</span>cat <span class="nv">$wlan_adapterfile</span><span class="k">)</span>
 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$lastknownmodule</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> 
  <span class="nv">lastknownmodule</span><span class="o">=</span><span class="s2">"none"</span>
   <span class="nb">echo</span> <span class="s2">"WLAN-Treibermodul </span><span class="nv">$wlan_modul</span><span class="s2"> erkannt, vorheriges Modul: </span><span class="nv">$lastknownmodule</span><span class="s2">"</span>
<span class="k">fi</span>

<span class="c1">## reintialisiere WLAN-Adapter</span>
<span class="nb">echo</span> -e <span class="s2">"WLAN-Adapter reinitialisieren ...\n"</span>
 <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$wlan_modul</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$lastknownmodule</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
   sleep <span class="m">1</span>
    /sbin/modprobe <span class="nv">$wlan_modul</span> 
   sleep <span class="m">1</span>
    
<span class="k">else</span>
 /sbin/modprobe -rf <span class="nv">$lastknownmodule</span>  
  sleep <span class="m">1</span>
   /sbin/modprobe -rf <span class="nv">$wlan_modul</span>  
    sleep <span class="m">1</span>
     /sbin/modprobe <span class="nv">$wlan_modul</span> 
    sleep <span class="m">1</span>
   <span class="nb">echo</span> <span class="nv">$wlan_modul</span> &gt; <span class="nv">$wlan_adapterfile</span>
  sleep <span class="m">1</span>
<span class="k">fi</span>
  
<span class="c1">## initialize WAN-Port</span>
 /sbin/ifconfig <span class="nv">$sourceiface</span> up
    sleep <span class="m">1</span>

<span class="c1">## deaktivate WLAN-Powermanagement / set Tx-Power    </span>
<span class="nb">echo</span> -e <span class="s2">"deaktiviere Stromsparmechanismen für </span><span class="nv">$wlaniface</span><span class="s2">"</span>
 /sbin/iw dev <span class="nv">$wlaniface</span> <span class="nb">set</span> power_save off
  sleep <span class="m">1</span>

<span class="nb">echo</span> -e <span class="s2">"setze Sendeleistung des WLAN-Adapters </span><span class="nv">$wlaniface</span><span class="s2">"</span>
<span class="c1"># /sbin/iw dev $wlaniface set txpower $txpoweroption $txpower</span>
/sbin/iwconfig <span class="nv">$wlaniface</span> txpower <span class="nv">$txpower</span>
  sleep <span class="m">1</span>
  
<span class="c1">## Regionseinstellung</span>
<span class="nb">echo</span> -e <span class="s2">"setze Regionseinstellung des WLAN-Adapters </span><span class="nv">$wlaniface</span><span class="s2">"</span>
/sbin/iw reg <span class="nb">set</span> <span class="nv">$regcode</span>
 sleep <span class="nv">$regdelay</span>
  
<span class="c1">## start hostapd</span>
<span class="nb">echo</span> -e <span class="s2">"Starte hostapd-Service:\n"</span>
 <span class="nv">$hostapdservice</span> <span class="nv">$hostapdconf</span>
  sleep <span class="m">1</span>
   <span class="nb">echo</span>
  
<span class="c1">## Bridge konfigurieren</span>
/sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$sourceiface</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$locallan_on</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 /sbin/brctl addif <span class="nv">$bridgeiface</span> <span class="nv">$locallan</span>
  <span class="nb">echo</span> -e <span class="s2">"Ethernerschnittstelle 2 aktiviert.\n"</span>
 <span class="k">fi</span>
  /sbin/brctl setfd <span class="nv">$bridgeiface</span> <span class="nv">$forward_delay</span>
   /sbin/brctl stp <span class="nv">$bridgeiface</span> <span class="nv">$stp</span>
   
<span class="c1">## Optional aktivierbar   </span>
<span class="c1">#    /sbin/brctl setageing $bridgeiface $brageing</span>
<span class="c1">#     /sbin/brctl setmaxage $bridgeiface $brage</span>
   
<span class="c1">## initialize Bridge-Port</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$bridge_dhcp</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">"Bridge-Schnittstelle </span><span class="nv">$bridgeiface</span><span class="s2"> initialisieren (statisch):"</span>
 <span class="nb">echo</span> -e <span class="s2">"Interfac: </span><span class="nv">$bridgeiface</span><span class="s2"> IP-Adresse: </span><span class="nv">$braddress</span><span class="s2"> Broadcast: </span><span class="nv">$brbroadcast</span><span class="s2"> Netzmaske: </span><span class="nv">$brnetmask</span><span class="s2">"</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="nv">$braddress</span> broadcast <span class="nv">$brbroadcast</span> netmask <span class="nv">$brnetmask</span>
   /sbin/route add default gw <span class="nv">$wangateway</span> metric <span class="m">0</span> dev <span class="nv">$bridgeiface</span>
    sleep <span class="m">1</span>
 <span class="k">else</span>
<span class="nb">echo</span> -e <span class="s2">"Bridge </span><span class="nv">$bridgeiface</span><span class="s2">  automatisch initialisieren (DHCP). Einen Moment bitte ...\n"</span>
  /sbin/dhclient <span class="nv">$bridgeiface</span>
   sleep <span class="m">1</span>
 <span class="k">fi</span>
  /sbin/ifconfig <span class="nv">$sourceiface</span> up

<span class="c1">## Forwarding to Tor</span>
/sbin/iptables -t nat -A PREROUTING -i <span class="nv">$bridgeiface</span> -p tcp --dport <span class="m">22</span> -j REDIRECT --to-ports <span class="m">22</span>
 /sbin/iptables -t nat -A PREROUTING -i <span class="nv">$bridgeiface</span> -p udp --dport <span class="m">53</span> -j REDIRECT --to-ports <span class="m">53</span>
  /sbin/iptables -t nat -A PREROUTING -i <span class="nv">$bridgeiface</span> -p tcp --syn -j REDIRECT --to-ports <span class="m">9040</span>

<span class="c1">## starting Tor    </span>
<span class="nb">echo</span> -e <span class="s2">"Starte Tor ...\n"</span>
 service tor start
 
<span class="c1">## DNS setzen</span>
<span class="c1">## verwende erkanntes Gateway</span>
<span class="nb">echo</span> <span class="s2">"DNS-Konfiguration ..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$manDNS</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> -e <span class="s2">"nameserver"</span> <span class="k">$(</span>route -n <span class="p">|</span> grep UG <span class="p">|</span> awk <span class="o">{</span><span class="s1">'print $2'</span><span class="o">}</span><span class="k">)</span> <span class="p">|</span> tee /etc/resolv.conf
  <span class="nb">echo</span>
<span class="k">else</span>
  <span class="nb">echo</span> -e <span class="s2">"</span><span class="nv">$sys_domain</span><span class="s2">\n</span><span class="nv">$sys_search</span><span class="s2">\n</span><span class="nv">$sys_dns0</span><span class="s2">\n</span><span class="nv">$sys_dns1</span><span class="s2">\n</span><span class="nv">$sys_dns2</span><span class="s2">"</span> <span class="p">|</span> tee /etc/resolv.conf
 sleep <span class="m">1</span>
   <span class="nb">echo</span>
<span class="k">fi</span>

<span class="c1">## NTP Zeit-Syncronisation</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ntp_timeset</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 <span class="nb">echo</span> <span class="s2">"Zeitsyncronisation über </span><span class="nv">$ntp_server</span><span class="s2">:"</span>
  <span class="nv">$ntp_command</span> <span class="nv">$ntp_server</span>
 <span class="k">fi</span>

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$showconfig</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>   
 <span class="nb">echo</span> -e <span class="s2">"System DNS-Check und Routing:"</span>
  cat /etc/resolv.conf
   <span class="nb">echo</span>
    /sbin/route -n
     <span class="nb">echo</span>

<span class="nb">echo</span> -e <span class="s2">"Konfiguration Bridge:\n"</span>
  /sbin/ifconfig <span class="nv">$bridgeiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
    /sbin/brctl show
     <span class="nb">echo</span>
      /sbin/brctl showmacs <span class="nv">$bridgeiface</span>
       <span class="nb">echo</span>
      /sbin/brctl showstp <span class="nv">$bridgeiface</span>
    <span class="nb">echo</span>
    
<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales WAN:\n"</span>
  /sbin/ifconfig <span class="nv">$sourceiface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>
  
<span class="nb">echo</span> -e <span class="s2">"Konfiguration lokales LAN:\n"</span>
  /sbin/ifconfig <span class="nv">$locallan</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
   <span class="nb">echo</span>

  <span class="nb">echo</span> <span class="s2">"Konfiguration WLAN:"</span>
   /sbin/ifconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'Link|inet Adresse'</span>
    <span class="nb">echo</span>
     /sbin/iwconfig <span class="nv">$wlaniface</span> <span class="p">|</span> egrep <span class="s1">'IEEE|Power|Mode'</span>
      <span class="nb">echo</span>      
       /sbin/iwconfig mon.<span class="nv">$wlaniface</span>

<span class="c1">## Ausgabe der aktuellen Konfiguration</span>
<span class="nb">echo</span> -e <span class="s2">"Regionseinstellung des WLAN-Adapters:\n"</span>
 /sbin/iw reg get
  <span class="nb">echo</span>

<span class="nb">echo</span> <span class="s2">"Iptables:"</span>
 iptables -t nat -L
  <span class="nb">echo</span>
	 
<span class="nb">echo</span> <span class="s2">"Dienstestatus:"</span>
service hostapd status
 service tor status
<span class="k">else</span>
 <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>
</pre></div>
</td></tr></table></div></li></ul><p>
</p><ul><li><p>Dienstekonfigurationen via <strong>/etc/tor/torrc</strong>. Dies ist nur die erforderliche Basiskonfiguration. Insbesondere die Einstellung für die sog. Entry- und Exit-Nodes sollte verfeinert werden. Genauere Informationen dazu in <a class="internal" href="../tor/konfiguration.html">Tor - Konfiguration</a>. Die IP-Einstellung für <code class="notranslate">TransListenAddress</code> und <code class="notranslate">DNSListenAddress</code> ist an die tatsächliche IP-Konfiguration der Bridge anzugleichen: </p><pre class="notranslate">Log notice file /var/log/tor/notices.log
AutomapHostsSuffixes .onion,.exit
AutomapHostsOnResolve 1
TransPort 9040
TransListenAddress 192.168.178.5
DNSPort 53
DNSListenAddress 192.168.178.5
EntryNodes {de}
ExitNodes {de}</pre></li></ul><p>
</p><ul><li><p><strong>/etc/hostapd_tor.conf</strong>: </p><pre class="notranslate"># Schnittstelle und Treiber
interface=wlan0
driver=nl80211
bridge=br0

# WLAN-Konfiguration
ssid=WLAN_AP_TOR
channel=4

# ESSID sichtbar
ignore_broadcast_ssid=0

# Ländereinstellungen
country_code=DE
ieee80211d=1

# Übertragungsmodus
hw_mode=g

# Optionale Einstellungen
# supported_rates=10 20 55 110 60 90 120 180 240 360 480 540

# Draft-N Modus aktivieren / optional nur für entsprechende Karten
# ieee80211n=1

# Übertragungsmodus / Bandbreite 40MHz
# ht_capab=[HT40+][SHORT-GI-40][DSSS_CCK-40]

# Beacons
beacon_int=100
dtim_period=2

# MAC-Authentifizierung
macaddr_acl=0

# max. Anzahl der Clients
max_num_sta=20

# Größe der Datenpakete/Begrenzung
rts_threshold=2347
fragm_threshold=2346

# hostapd Log Einstellungen
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2

# temporäre Konfigurationsdateien
dump_file=/tmp/hostapd.dump
ctrl_interface=/var/run/hostapd
ctrl_interface_group=0

# Authentifizierungsoptionen 
auth_algs=3

# wmm-Funktionalität
wmm_enabled=0

# Verschlüsselung / hier rein WPA2
wpa=2
rsn_preauth=1
rsn_preauth_interfaces=wlan0
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP

# Schlüsselintervalle / Standardkonfiguration
wpa_group_rekey=600
wpa_ptk_rekey=600
wpa_gmk_rekey=86400

# Zugangsschlüssel (PSK) / hier in Klartext (ASCII)
wpa_passphrase=1234567890abcdefghijklmn</pre></li></ul><p>
</p></div></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="internal" href="../skripte.html">Skripte</a> <img alt="{Übersicht}" src="../_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> Übersichtsartikel</p></li><li><p><a class="internal" href="../wlan.html">WLAN</a> <img alt="{Übersicht}" src="../_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> Übersichtsartikel</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="../skripte/wlan-accesspoint_konfigurationen/a/revision/747417.html">Diese Revision</a> wurde am 23. August 2014 15:40 von <a href="https://ubuntuusers.de/user/elektronenblitz63/">elektronenblitz63</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="../startseite.html">Wiki</a></li>
<li><a href="../skripte.html">Skripte</a></li>
<li><a href="../skripte/wlan-accesspoint_konfigurationen.html">WLAN-Accesspoint Konfigurationen</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="../_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="../_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="../_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="../_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>