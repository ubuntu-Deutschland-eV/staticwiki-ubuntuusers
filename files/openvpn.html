<!DOCTYPE html>
<html lang="">
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>OpenVPN › ubuntuusers statisches Wiki</title>
<link href="./_/34e5d78db234405457773cc26741aada99f7fff2.css" rel="stylesheet" type="text/css"/>
<link href="./_/61af784fc5c93e296fec3be63b8e0bb48443727c.css" rel="stylesheet" type="text/css"/>
<link href="./_/634e8d1015b02df998cdec7cb07c5aff61d068b5.css" rel="stylesheet" type="text/css"/>
<link href="./_/b583ff7e37147497a59224ccf54cfee812a1d21b.css" rel="stylesheet" type="text/css"/>
<link href="./_/a0d5775ed6f36f8cc5b12bcf2f1c1bd98a3eb225.css" rel="stylesheet" type="text/css"/>
<link href="./_/98de73bded109a634cbd1e924abdd8c8964b8df2.css" media="print" rel="stylesheet" type="text/css"/>

<meta content="#a87300" name="theme-color"/>

</head>
<body>
<div class="wrap">
<div class="header">
<h1><a href="http://ubuntuusers.de/"><span>ubuntuusers.de</span></a></h1>
<ul class="tabbar">
<li class="portal">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ubuntuusers.de/">Portal<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="forum">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://forum.ubuntuusers.de/">Forum<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="wiki active">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/">Wiki<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="ikhaya">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://ikhaya.ubuntuusers.de/">Ikhaya<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="planet">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://planet.ubuntuusers.de/">Planet<span></span></a></div>
<div class="tab_right"></div>
</li>
<li class="community">
<div class="tab_left"></div>
<div class="tab_center"><a href="http://wiki.ubuntuusers.de/Mitmachen">Mitmachen<span></span></a></div>
<div class="tab_right"></div>
</li>
</ul>
</div>
<div class="body">
<div class="appheader">

<div class="pagetitle">
<h1 class="breadcrumb_title">
<a class="separator" href="./startseite.html">
              Wiki
            </a>
</h1>
<h2 class="breadcrumb_subtitle"><a href="./openvpn.html">OpenVPN</a></h2>
</div>
</div><div class="message staticwikinote"><strong>Hinweis:</strong> Dies ist ein statischer Snapshot unseres Wikis vom Jan. 17, 2018 und kann daher nicht bearbeitet werden. Der aktuelle Artikel ist unter <a href="http://wiki.ubuntuusers.de/OpenVPN">wiki.ubuntuusers.de</a> zu finden.</div>

<!--[if lt IE 8]>
      <div class="message fail">Bitte installiere den Internet Explorer 8 oder neuer.</div>
      <![endif]-->
<div class="page_content">
<div class="navi_sidebar navigation">
<div class="container">
<h3 class="navi_wiki">Wiki</h3>
<ul>
<li><a href="./wiki/index.html">Index</a></li>
<li><a href="./wiki/recentchanges.html">Letzte Änderungen</a></li>
<li><a href="./wiki/neue_artikel.html">Liste neuer Artikel</a></li>
<li><a href="./wiki.html">Übersicht</a></li>
<li><a href="./wiki/faq_-_häufig_gestellte_fragen.html">FAQ</a></li>
<li><a href="./wiki/benutzung.html">Benutzung</a></li>
<li><a href="./kategorien.html">Kategorie</a></li>
<li><a href="./wiki/tagcloud.html">Wortwolke</a></li>
</ul>
<h3 class="navi_join">Mitmachen</h3>
<ul>
<li><a href="./wikiartikel_anlegen.html">Wikiartikel anlegen</a></li>
<li><a href="./howto.html">Howto anlegen</a></li>
<li><a href="./wiki/referenz.html">Wiki-Referenz</a></li>
<li><a href="./wiki/syntax.html">Wiki-Syntax</a></li>
<li><a href="./baustelle.html">Baustellen</a></li>
<li><a href="./wiki/artikelideen.html">Artikelideen</a></li>
<li><a href="./wiki/ungetestet.html">Ungetestete Artikel</a></li>
<li><a href="./wiki/vorlagen/ausbaufähig/a/backlinks.html">Ausbaufähige Artikel</a></li>
<li><a href="./wiki/vorlagen/fehlerhaft/a/backlinks.html">Fehlerhafte Artikel</a></li>
<li><a href="https://forum.ubuntuusers.de/forum/wiki/">Rund ums Wiki</a></li>
</ul>
<h3 class="navi_config">Konfiguration</h3>
<ul>
<li><a href="./openvpn/a/backlinks.html">Backlinks anzeigen</a></li>
<li>
        Exportieren
        <ul>
<li><a href="./openvpn/a/export/meta.html" rel="nofollow">Metadaten</a></li>
<li><a href="./openvpn/a/export/raw.html" rel="nofollow">Rohformat</a></li>
<li><a href="./openvpn/a/export/html.html" rel="nofollow">HTML</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div class="content content_tabbar content_sidebar">
<h1 class="pagetitle"><a href="./openvpn/a/backlinks.html">OpenVPN</a></h1>
<div id="page"><p>
</p><div class="box tested_for"><h3 class="box tested_for">Dieser Artikel wurde für die folgenden
Ubuntu-Versionen getestet:</h3><div class="contents"><p>
</p><ul><li><p><a class="internal" href="./xenial_xerus.html">Ubuntu 16.04</a> Xenial Xerus</p></li><li><p><a class="internal" href="./trusty_tahr.html">Ubuntu 14.04</a> Trusty Tahr</p></li></ul></div></div><p>
</p><div class="box knowledge"><h3 class="box knowledge">Zum Verständnis dieses Artikels sind folgende Seiten hilfreich:</h3><div class="contents"><p>
</p><ol class="arabic"><li><p><a class="crosslink anchor" href="#source-1" id="source-1"></a> <a class="internal" href="./pakete_installieren.html">Installation von Programmen</a> </p></li><li><p><a class="crosslink anchor" href="#source-2" id="source-2"></a> <a class="internal" href="./paketquellen_freischalten.html">Paketquellen freischalten</a> </p></li><li><p><a class="crosslink anchor" href="#source-3" id="source-3"></a> <a class="internal" href="./terminal.html">Ein Terminal öffnen</a> </p></li><li><p><a class="crosslink anchor" href="#source-4" id="source-4"></a> <a class="internal" href="./editor.html">Einen Editor öffnen</a> </p></li><li><p><a class="crosslink anchor" href="#source-5" id="source-5"></a> <a class="internal" href="./packprogramme.html">Archive entpacken</a> </p></li><li><p><a class="crosslink anchor" href="#source-6" id="source-6"></a> <a class="internal" href="./rechte.html">Rechte für Dateien und Ordner ändern</a></p></li><li><p><a class="crosslink anchor" href="#source-7" id="source-7"></a> <a class="internal" href="./sudo.html">Root-Rechte</a></p></li></ol></div></div><p>
</p><div class="toc toc-depth-2"><div class="head">Inhaltsverzeichnis</div><ol class="arabic"><li><a class="crosslink" href="#Installation">Installation
</a></li><li><a class="crosslink" href="#Server">Server
</a><ol class="arabic"><li><a class="crosslink" href="#Schluessel-und-Zertifikate-generieren">Schlüssel und Zertifikate generieren
</a></li><li><a class="crosslink" href="#Konfiguration">Konfiguration
</a></li><li><a class="crosslink" href="#Mehrere-Server">Mehrere Server
</a></li><li><a class="crosslink" href="#LAN-einbeziehen-und-Weiterleitung-ins-Internet">LAN einbeziehen und Weiterleitung ins In...</a></li><li><a class="crosslink" href="#LAN-eines-Clients-einbeziehen">LAN eines Clients einbeziehen
</a></li></ol></li><li><a class="crosslink" href="#Client-Konfiguration">Client-Konfiguration
</a><ol class="arabic"><li><a class="crosslink" href="#Ubuntu">Ubuntu
</a></li><li><a class="crosslink" href="#Microsoft-Windows">Microsoft Windows
</a></li><li><a class="crosslink" href="#OpenVPN-ueber-HTTP-Proxy">OpenVPN über HTTP-Proxy
</a></li></ol></li><li><a class="crosslink" href="#Sicherheit-erhoehen">Sicherheit erhöhen
</a><ol class="arabic"><li><a class="crosslink" href="#Verschluesselungsalgorithmus-aendern">Verschlüsselungsalgorithmus ändern
</a></li><li><a class="crosslink" href="#Authentifizierungsalgorithmus-aendern">Authentifizierungsalgorithmus ändern
</a></li><li><a class="crosslink" href="#Schluessellaenge-erhoehen">Schlüssellänge erhöhen
</a></li><li><a class="crosslink" href="#MITM-Angriffsmoeglichkeiten-verringern">MITM Angriffsmöglichkeiten verringern
</a></li><li><a class="crosslink" href="#DOS-abschwaechen">DOS abschwächen
</a></li></ol></li><li><a class="crosslink" href="#Probleme">Probleme
</a><ol class="arabic"><li><a class="crosslink" href="#Zertifikate-sperren">Zertifikate sperren
</a></li><li><a class="crosslink" href="#Virtualisierte-Systeme">Virtualisierte Systeme
</a></li><li><a class="crosslink" href="#Mediatomb">Mediatomb
</a></li></ol></li><li><a class="crosslink" href="#Problemloesung">Problemlösung
</a></li><li><a class="crosslink" href="#Links">Links
</a></li></ol></div><p><img alt="openvpn-logo.png" class="image-left" src="./_/e9279d13edc9f35f0cfdc40d5eee28675a6d1ad6.png"/>
<a class="external" href="http://www.openvpn.net" rel="nofollow">OpenVPN</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> ist eine <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Virtual_Private_Network">Virtual-Private-Network-Software</a>, die auf dem bewährten Verschlüsselungsprotokoll <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Transport_Layer_Security">SSL/TLS</a> aufbaut, welches auch für die Verschlüsselung von Webbrowser-Sitzungen im E-Commerce eingesetzt wird.</p><p>Die Vorteile von OpenVPN gegenüber anderen Lösungen liegen in der (relativ) einfachen Konfiguration und der Verfügbarkeit für zahlreiche Plattformen (u.a. Linux, Solaris, versch. BSDs, Android, Mac OS X und Microsoft Windows) bei gleichzeitig sehr guter Sicherheit.</p><div class="section_1"><h2 id="Installation">Installation<a class="headerlink" href="#Installation">¶</a></h2><p>
Folgende Pakete werden benötigt <sup><a href="#source-1">[1]</a></sup>:</p><ul><li><p><strong>openvpn</strong> (<em>universe</em> <sup><a href="#source-2">[2]</a></sup>)</p></li><li><p><strong>easy-rsa</strong> (<em>universe</em>)</p></li></ul><p><img alt="Wiki/Vorlagen/Installbutton/button.png" class="image-default" src="./_/fd60ccb86c4d96df2f4518df2936cc7d038467aa.png"/>
mit <a class="internal" href="./apturl.html">apturl</a>
</p><div class="package-list"><div class="contents"><p>
Paketliste zum Kopieren:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo apt-get install openvpn easy-rsa </pre></div></div><p>
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo aptitude install openvpn easy-rsa </pre></div></div><p>
</p></div></div><p>Als erstes sollte man die Beispielkonfiguration und das Verzeichnis zur Schlüsselerzeugung an einen geeigneten Ort entpacken <sup><a href="#source-3">[3]</a></sup>:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/
sudo gunzip /etc/openvpn/server.conf.gz
sudo cp -r /usr/share/easy-rsa /etc/openvpn/easy-rsa2
# Alternativ:
make-cadir /etc/openvpn/easy-rsa2 </pre></div></div></div><div class="section_1"><h2 id="Server">Server<a class="headerlink" href="#Server">¶</a></h2><p>
Nachdem man die oben beschriebenen Schritte durchgeführt hat, kann man für die Server-Konfiguration hier fortfahren.</p><div class="section_2"><h3 id="Schluessel-und-Zertifikate-generieren">Schlüssel und Zertifikate generieren<a class="headerlink" href="#Schluessel-und-Zertifikate-generieren">¶</a></h3><p>
</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Im folgenden Abschnitt wird beschrieben, wie man die Zertifikate auf dem Server als Root im Verzeichnis <strong>/etc/openvpn/easy-rsa2</strong> erstellt. Man sollte diese <em>Certificate Authority</em> (CA) aber aus Sicherheitsgründen möglichst auf einem anderen (offline) Rechner erstellen. Man benötigt dazu dann auch keine Root-Rechte, wenn man als normaler Benutzer Schreibrechte besitzt. Weiterhin sind die Schlüssel vor unberechtigtem Zugriff besser geschützt - insbesondere der <strong>ca.key</strong> sollte besonders behandelt werden, da ein Angreifer mit diesem Schlüssel beliebige eigene Schlüssel signieren könnte und ungehinderten Zugriff auf den OpenVPN Server erlangen würde.</p><p>Nach dem Erzeugen muss man dann nur noch die jeweiligen Schlüssel und Zertifikate auf die entsprechenden Rechner kopieren, und zwar auf jeden Rechner (Server und Clients) seine eigene <strong>.key</strong>- und <strong>.crt</strong>-Datei sowie die globale <strong>ca.crt</strong>. Der Server benötigt auch noch die <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Diffie-Hellman-Schl%C3%BCsselaustausch">Diffie-Hellman-Datei</a> <strong>dh2048.key</strong>. Der CA-Schlüssel <strong>ca.key</strong> wird dagegen nur innerhalb der CA benötigt und muss nicht transferiert werden.
</p></div></div><p>Die gegenseitige Authentifizierung zwischen Server und Client findet bei OpenVPN über kryptografische Schlüssel und Zertifikate statt, die als erstes erstellt werden müssen. Dazu wechselt man zuerst in das Verzeichnis <strong>/etc/openvpn/easy-rsa2/</strong> und editiert<sup><a href="#source-4">[4]</a></sup> dort die Datei <strong>vars</strong> mit Root-Rechten<sup><a href="#source-7">[7]</a></sup>. In der Datei findet man am Ende folgende Einträge:</p><pre class="notranslate">export KEY_COUNTRY="DE"
export KEY_PROVINCE="Nordrhein-Westfalen"
export KEY_CITY="Duesseldorf"
export KEY_ORG="Internet Ltd."
export KEY_EMAIL="info@webmaster"
export KEY_EMAIL=info@webmaster
export KEY_CN=changeme
export KEY_NAME=changeme
export KEY_OU=changeme
export PKCS11_MODULE_PATH=changeme
export PKCS11_PIN=1234</pre><p>
Diese Einträge müssen ggf. auf die eigenen Verhältnisse angepasst werden.</p><p>Ab 14.04 muss noch der Eintrag:
</p><pre class="notranslate">export KEY_ALTNAMES="Irgendwas"</pre><p>
eingfügt werden. Mit <code class="notranslate">ALTNAMES</code> sind Aliases bzw Pseudonyme gemeint.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Aufgrund eines Fehlers wird manchmal das Unterverzeichnis für die Keys nicht erstellt. Man sollte dies darum von Hand nachholen (weiterhin in <strong>/etc/openvpn/easy-rsa2/</strong>):</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mkdir keys </pre></div></div><p>
</p></div></div><div class="box experts"><h3 class="box experts">Experten-Info:</h3><div class="contents"><p>In älteren Ubuntu Versionen kann durch das Erhöhen von
export KEY_SIZE=1024 auf 2048 oder 4096 in der vars-Datei die Sicherheit erhöht werden! Dann müssen aber <strong>alle</strong> Zertifikate neu erstellt werden!
In neueren Ubuntu Versionen wird als Standard 2048 genutzt.</p><p>Im späteren Verlauf wird von 2048 ausgegangen
</p></div></div><p>Als nächstes muss die neueste <strong>openssl-x.x.x.cnf</strong> umbenannt werden in <strong>openssl.cnf</strong> oder ein symbolischer Link erstellt werden.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp openssl-x.x.x.cnf openssl.cnf
#Alternativ:
sudo ln -s openssl-x-x-x.cnf openssl.cnf </pre></div></div><p>Danach muss die oben angepasste Datei <strong>vars</strong> in die Umgebungsvariablen aufgenommen werden <sup><a href="#source-3">[3]</a></sup> (dabei aufpassen, dass man sich auch wirklich im Verzeichnis <em>/etc/openvpn/easy-rsa2/</em> befindet):</p><div class="bash"><div class="contents"><pre class="notranslate">source ./vars </pre></div></div><p>Es erscheint eine Warnmeldung, worauf mit den folgenden Skript-Aufrufen das Master-Zertifikat und der Master-Schlüssel erstellt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E ./clean-all
sudo -E ./build-ca </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Falls es hierbei zu Fehlern kommt, diesen <a class="crosslink post" href="https://forum.ubuntuusers.de/post/4330397/">Foreneintrag</a> berücksichtigen.
</p></div></div><p>Jetzt muss noch das Zertifikat und der Schlüssel für den Server erstellt werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E ./build-key-server server </pre></div></div><p>Bei "<em>Common Name</em>" sollte der Name eingegeben, mit dem auf den Server später zugegriffen wird (z.B. ein DynDNS-Name).
Das "<em>Challenge Password</em>" sollte leer gelassen werden, sonst wäre es möglich sich mit diesem Passwort anzumelden. Um die Datenbank zu aktualisieren, muss danach zweimal mit 
<span class="key">Y</span>  bestätigt werden.</p><p>Anschließend werden nun die Schlüssel für die Benutzer angelegt:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E ./build-key ersterclient
sudo -E ./build-key zweiterclient
sudo -E ./build-key dritterclient </pre></div></div><p>Bzw. wenn die Schlüssel mit einem Passwort geschützt werden sollen (welches bei jedem Anmelden eingegeben werden muss):</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E ./build-key-pass ersterclient
sudo -E ./build-key-pass zweiterclient
sudo -E ./build-key-pass dritterclient </pre></div></div><p>Das geschieht nach dem gleichen Prinzip wie beim Server, jedoch wird nun bei "<em>Common Name</em>" jeweils der Name des Clients eingetragen.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Benötigt man zu einem späteren Zeitpunkt weitere Zertifikate, muss zuerst die vars erneut gesourcet werden. Danach können wie gewohnt neue Zertifikate mittels ./build-key erstellt werden. 
</p></div></div><p>Um kryptografische Schlüssel sicher über unsichere Kanäle auszuhandeln, werden jetzt die Diffie-Hellmann-Parameter generiert. Geduld, der Vorgang dauert!</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E ./build-dh </pre></div></div><p><img alt="openvpn-key-overview.png" class="image-right" src="./_/f477b6dd91ad6053242f146b17ddedc64d7f06a1.png" title="Keys und deren Speicherorte"/>
Wenn die Erstellung erfolgreich gewesen ist, liegen nun alle benötigten Dateien im Verzeichnis <strong>/etc/openvpn/easy-rsa2/keys/</strong>.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Key Übersicht:
CA Maschine (hier wurden die Zertifikate erstellt): <strong>ca.crt</strong>, <strong>ca.key</strong>; Server: <strong>ca.crt</strong>, <strong>server.crt</strong>, <strong>server.key</strong>; Client: <strong>client.crt</strong>, <strong>client.key</strong>, <strong>ca.crt</strong>
</p></div></div><p>Die Dateien mit der Endung <strong>.key</strong> sind die geheimen Schlüssel. Die <strong>.crt</strong>-Dateien sind nicht geheime Zertifikate.</p><p>Achtung: Schlüssel und Zertifikate dürfen zwischen Server und Client nicht als ASCII Dateien übertragen werden, sie können dadurch unbrauchbar werden. Die Dateien sollen in ein Archiv (z.B. zip / tar) gepackt werden und erst dann verschlüsselt (z.B. über <a class="internal" href="./gnupg.html">GnuPG</a>) übertragen werden.</p><p>Die Client-Schlüssel und -Zertifikate werden nun auf die Clients transferiert, der <strong>server.key</strong> bleibt nur auf dem Server. Die <strong>ca.key</strong> Datei sollte aus Sicherheitsgründen vom Server entfernt werden. Sie wird ausschließlich für die Erstellung weiterer Schlüssel benötigt und ist daher sensibel. Im laufenden Serverbetrieb hat sie keine Bedeutung</p><p>Die Datei <strong>ca.crt</strong> muss sowohl auf dem Server als auch auf dem Client liegen. Sie dient zur Identifikation zwischen Server und Client.</p><div class="bash"><div class="contents"><pre class="notranslate">tar -cf client1.tar client1.key client1.crt ca.crt </pre></div></div></div><div class="section_2"><h3 id="Konfiguration">Konfiguration<a class="headerlink" href="#Konfiguration">¶</a></h3><p>
Nun muss noch in der Server-Konfigurationsdatei <strong>/etc/openvpn/server.conf</strong> der Pfad zu den Schlüsseln angepasst werden. Alle anderen Voreinstellungen sind in Ordnung.</p><pre class="notranslate">ca ./easy-rsa2/keys/ca.crt
cert ./easy-rsa2/keys/server.crt
key ./easy-rsa2/keys/server.key    # Diese Datei geheim halten.
dh ./easy-rsa2/keys/dh2048.pem     # Diffie-Hellman-Parameter</pre><p>Hinweis: sollte bei Serverstart die Fehlermeldung "Cannot open dh2048.pem for DH parameters - No such file or directory" auflaufen, muss der Verweis auf die Quelle für die Diffie-Hellman-Parameter (weiter unten in der Datei) auskommentiert werden.</p><p>Zur Verbesserung der Sicherheit sollte man den Daemon unter einer unprivilegierten Benutzerkennung laufen lassen, indem man folgende Zeilen aktiviert:</p><pre class="notranslate"># Downgrade privileges after initialization (non-Windows only)
user nobody
group nogroup</pre><p>Noch besser ist es, hier nicht auf die Kennung <code class="notranslate">nobody/nogroup</code> zurückzugreifen, sondern eine eigene spezialisierte <code class="notranslate">openvpn/openvpn</code>-Identität zu schaffen, wobei man die Shell auf <code class="notranslate">/bin/false</code> setzen kann.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo addgroup --system --no-create-home --disabled-login --group openvpn
sudo adduser --system --no-create-home --disabled-login --ingroup openvpn openvpn </pre></div></div><p>Wer den Server in einem privaten LAN stehen hat, muss noch "Port-Forwarding" auf seinem Router aktivieren. OpenVPN nutzt standardmäßig den Port 1194 (UDP), der auf die interne IP-Adresse des VPN-Servers weitergeleitet werden muss. Wer einen Linux-<a class="internal" href="./router.html">Router</a> betreibt, kann dafür das <a class="internal" href="./skripte/nathelper.html">nathelper-Skript</a> verwenden. Besitzer eines Hardware-Routers sollten bei Bedarf dessen Betriebsanleitung oder die Webseiten des Router-Herstellers zu Rate ziehen.</p><p>Jetzt kann der Server durch <a class="internal" href="./upstart.html">Upstart</a> gestartet werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo service openvpn restart </pre></div></div><p>Server Status prüfen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo service openvpn status </pre></div></div><p>Server Status stoppen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo service openvpn stop </pre></div></div><p>Hinweis: falls der Start nicht erfolgreich war und folgender Fehler in <strong>/var/log/daemon.log</strong> bzw. <strong>/var/log/syslog</strong> steht (häufig bei virtualisierten Systemen der Fall):</p><pre class="notranslate">openvpn[...]: Note: Cannot open TUN/TAP dev /dev/net/tun: Permission denied (errno=13)
openvpn[...]: Note: Attempting fallback to kernel 2.2 TUN/TAP interface
openvpn[...]: Cannot allocate TUN/TAP dev dynamically</pre><p>hilft eventuell der Abschnitt <a class="crosslink" href="#Probleme">Probleme</a> weiter.</p></div><div class="section_2"><h3 id="Mehrere-Server">Mehrere Server<a class="headerlink" href="#Mehrere-Server">¶</a></h3><p>
Um mehrere OpenVPN-Server laufen zu lassen, muss zunächst in der Datei <strong>/etc/default/openvpn</strong> die richtige Option aktiviert werden, indem man das # entfernt:
</p><pre class="notranslate">#Entweder für alle *.conf Datein:
AUTOSTART="all" #wenn alle *.conf eingelesen werden sollen.
#oder nur für bestimmte:
AUTOSTART="home office" #"home office" durch den Namen der jeweiligen server.conf Datei ersetzen (ohne .conf).</pre><p>Ab 16.04 muss dann die Konfiguration mit:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo systemctl daemon-reload </pre></div></div><p>
neu eingelesen werden.</p><p>Nun sollten alle wichtigen Dateien und Ordner für die neue Konfiguration verdoppelt werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">cd /etc/openvpn
sudo cp server.conf server2.conf #Obligatorisch
sudo cp easy-rsa2 easy-rsa3 #Optional - Wenn neue Schlüssel benutzt werden sollen
sudo cp ipp.txt ipp2.txt #Optional - Verzeichnis der IP Adressen
sudo cp openvpn-status.log openvpn-status2.log #Optional - Status des Servers, wird von jedem Server überschrieben </pre></div></div><p>Die <strong>vars</strong>-Datei in easy-rsa3 sollte nun, wie <a class="crosslink" href="#Schluessel-und-Zertifikate-generieren">im vorigen Kapitel</a> beschrieben, auf die eigenen Bedürfnisse angepasst werden und auch die neue <strong>server2.conf</strong>.
Hierbei ist aber zu beachten, das jede Pfadangabe korrigiert werden muss und das jede <strong>server.conf</strong> einen einzigartigen tun/tap-Adapter besitzen muss. Es müssen also in jeder <strong>server.conf</strong> mindestens die Zeilen:
</p><pre class="notranslate">dev tun0 #Zahl ersetzen
port 1194 #Zahl ersetzen
server 10.8.0.0 255.255.255.0 #Netzwerk-Range ersetzen</pre><p>
ersetzt werden.</p><p>Als letztes muss nur noch der OpenVPN-Service neugestartet werden (ab 16.04 muss systemd noch die geänderte default-config von OpenVPN neu einlesen)
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo systemctl daemon-reload #Ab 16.04
sudo service openvpn restart </pre></div></div></div><div class="section_2"><h3 id="LAN-einbeziehen-und-Weiterleitung-ins-Internet">LAN einbeziehen und Weiterleitung ins Internet<a class="headerlink" href="#LAN-einbeziehen-und-Weiterleitung-ins-Internet">¶</a></h3><p>
</p><div class="box warning"><h3 class="box warning">Achtung!</h3><div class="contents"><p>Das Einbinden von mobilen Geräten in ein VPN, wo das LAN miteinbezogen ist, führt bei den mobilen Geräten zu Verbindungsproblemen, wenn sich diese nun physisch (z. B. per WLAN) in diesem Netzwerk befinden. Um dies zu umgehen, muss der VPN-Client vorher deaktiviert werden.
</p></div></div><p>Um dem Client nicht nur den Server selber, sondern auch das LAN über das VPN zugänglich zu machen, muss nochmal die <strong>server.conf</strong> bearbeitet werden. Dort wird im betreffenden Bereich folgendes eingetragen:</p><pre class="notranslate">push "route 192.168.2.0 255.255.255.0"</pre><p>Der hier genannte IP-Bereich muss natürlich durch den des serverseitigen LANs ersetzt werden. Dabei ist 255.255.255.0 die Subnetzmaske, nicht die höchste noch weiterzuleitende IP. Insgesamt wird also das Netz 192.168.2.0/24 über das VPN zugreifbar.</p><p>Außerdem muss noch das IP-Forwarding am Server aktiviert werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo sysctl -w net/ipv4/ip_forward=1 </pre></div></div><p>Um diese Änderung permanent zu machen, kann man sie in die Datei <strong>/etc/sysctl.conf</strong> eintragen:</p><pre class="notranslate">net.ipv4.ip_forward=1</pre><p>Wenn der OpenVPN-Daemon nicht auf dem "Default-Gateway" des lokalen Netzes läuft, so muss auf letzterem (dem Default-Gateway/Router) noch eine Route erstellt werden, die den OpenVPN-Server als Gateway für das VPN festlegt. Handelt es sich dabei um einen Linux-Rechner, so lautet der Befehl wie folgt und kann bei Bedarf (ohne "<code class="notranslate">sudo</code>") in die Datei <strong>/etc/rc.local</strong> eingetragen werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo route add -net 10.8.0.0 netmask 255.255.255.0 gw vpn.server.i.p </pre></div></div><p>
Bei besseren "Consumer-Routern" wie z.B. einer FritzBox gibt es häufig auch in den Netzwerkeinstellungen die Option "IP-Routen" oder "statische Routen". Besagte FritzBoxen erwarten dort die Eingabe von IP-Adresse, Subnetzmaske und Gateway. 
Dabei ist mit IP-Adresse die Adresse des IP-Netzwerkes (hier 10.8.0.0) gemeint.
Es ergibt sich für typische Privat-Netzwerke also folgende Einstellung, wenn z.B. der lokale Adressbereich 192.168.1.0 ist und der Openvpn-Server auf einem Rechner mit der IP 192.168.1.66 läuft.</p><pre class="notranslate">IP-Adresse 10.8.0.0
Subnetzmaske 255.255.255.0
Gateway 192.168.1.66</pre><p>Hat man keine FritzBox und läuft der Openvpn-Server auf einem Linux-Rechner im Heimnetz, müssen für Internetzugriff der Clients zwingend iptables-Regeln erstellt werden. Die Befehle lauten wie folgt und können bei Bedarf ebenfalls in die Datei <strong>/etc/rc.local</strong> eingetragen werden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo iptables -A FORWARD -o eth0 -i tun0 -s 10.8.0.0/24 -m conntrack --ctstate NEW -j ACCEPT #bei gewünschtem Internet-Zugriff über andere Schnittstelle "-o eth0" entfernen!
sudo iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE </pre></div></div><p>Die hier genannten Befehle beziehen sich auf die Netzwerkschnittstelle eth0 und die serverseitige TUN-IP-Adresse 10.8.0.0. Überprüfbar ist beides (die serverseitige TUN-IP-Adresse erst nach Start des VPN) mit:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo ifconfig </pre></div></div><p>Weiterhin müssen bei einer evtl. vorhandenen Firewall Regeln (bei Iptables in der "Forward-chain") eingerichtet werden, die die Kommunikation erlauben (siehe auch Kommentar im letzten iptables-Codeblock).</p><p>Weitere Informationen zu Iptables finden sich <a class="internal" href="./iptables2.html">hier</a></p><p>Zuletzt muss noch folgende Zeile in der <strong>server.conf</strong> aktiviert werden (Semikolon am Beginn entfernen):</p><pre class="notranslate">push "redirect-gateway def1 bypass-dhcp"</pre><p>Hat man keine oder nur eingeschränkte Möglichkeiten, mit dem Client ins Internet zu kommen, so ist der Abschnitt <a class="crosslink" href="#OpenVPN-ueber-HTTP-Proxy">OpenVPN über HTTP-Proxy</a> lesenswert.</p></div><div class="section_2"><h3 id="LAN-eines-Clients-einbeziehen">LAN eines Clients einbeziehen<a class="headerlink" href="#LAN-eines-Clients-einbeziehen">¶</a></h3><p>
Manchmal ist es notwendig, auch andere Rechner im Netzwerk eines Clients auf das VPN zugreifen lassen zu können, um dies zu schaffen, müssen ein paar zusätzliche Schritte durchgeführt werden.</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Das Netzwerk von Client und Server dürfen nicht den gleichen Adressbereich haben! Wenn der Client im Netzwerk 192.168.2.0 liegt und der Server auch, dann ist die Konfiguration nicht möglich!</p><p>Der Punkt <em>"LAN einbeziehen"</em> muss durchgeführt worden sein und funktionieren!</p><p>Außerdem muss in der Server-Config-Datei der Befehl <code class="notranslate">dublicate-cn</code> auskommentiert sein!</p><p>Das zu benutzende Client Zertifikat muss einen eindeutigen "Common Name" haben.
</p></div></div><p>Zur Vereinfachung wird im folgenden das Netzwerk des Servers als 192.168.1.0 und das des Clients als 192.168.2.0 bezeichnet.</p><p>Als erstes muss im Ordner <strong>/etc/openvpn</strong> ein Ordner <strong>ccd</strong> erstellt werden.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mkdir /etc/openvpn/ccd </pre></div></div><p>Nun legt man in diesem Ordner eine Datei mit dem <strong>Common Name</strong> des Clients an, die Datei kann z.B. <strong>client1</strong> heißen.</p><p>In diese Datei wird dann die Zeile</p><pre class="notranslate">iroute 192.168.2.0 255.255.255.0</pre><p>
hinzugefügt. Dadurch wird dem Server mitgeteilt, dass sich hinter diesem Client ein ganzes Netzwerk verbirgt und der Server leitet diesen Traffic weiter.</p><p>Nun muss die Datei <strong>/etc/openvpn/server.conf</strong> geändert werden<sup><a href="#source-4">[4]</a></sup><sup><a href="#source-7">[7]</a></sup></p><p>Dort werden nun folgende Zeilen auskommentiert oder hinzugefügt:</p><pre class="notranslate">client-config-dir ccd
route 192.168.2.0 255.255.255.0 
#Dies ist wichtig für die Weiterleitung vom Kernel zum VPN-Server

#Optional, wenn auch andere Clients das Client-Netzwerk erreichen können sollen
client-to-client
push "route 192.168.2.0 255.255.255.0"</pre><p>Als letztes und wichtigstes, muss nun, wie bei <em>"LAN einbeziehen"</em> die neuen Routen in die Router vom Server und Client eingetragen werden:</p><p>Beim Server-Router:     192.168.2.0 255.255.255.0</p><p>und beim Client-Router: 192.168.1.0 255.255.255.0</p><p>Als letztes den OpenVPN-Server neustarten und fertig.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo service openvpn restart </pre></div></div></div></div><div class="section_1"><h2 id="Client-Konfiguration">Client-Konfiguration<a class="headerlink" href="#Client-Konfiguration">¶</a></h2><p>
Zuerst muss auch auf den Clients das <strong>openvpn</strong>-Paket installiert werden, wie weiter oben beschrieben. Statt der Datei <strong>server.conf</strong> wird hier aber logischerweise die <strong>/etc/openvpn/client.conf</strong> editiert <sup><a href="#source-4">[4]</a></sup>, die vorher mit</p><div class="bash"><div class="contents"><pre class="notranslate">sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf /etc/openvpn/ </pre></div></div><p>in das entsprechende Verzeichnis kopiert wurde.</p><p>Dort ändert man die IP-Adresse, unter der der Server erreichbar ist. Wer keine statische IP zur Verfügung hat, kann dort auch seine dyndns-Adresse angeben.</p><pre class="notranslate">remote ich.dyndns.org</pre><p>Die Pfade der einzelnen <strong>ca</strong>, <strong>cert</strong>, usw. müssen hier nicht unbedingt angepasst werden, wenn die einzelnen Dateien auf dem Client im selben Ordner liegen wie die <strong>client.conf</strong> und die voreingestellten Dateinamen besitzen. Natürlich müssen sie erstmal vom Server herüberkopiert worden sein.</p><p>Die Authentifizierung des OpenVPN-Servers ist für einen ersten Test nicht notwendig, für die spätere Benutzung aus Sicherheitsgründen aber empfohlen. Dazu wird eine der Methoden, die auf der Seite <a class="external" href="http://openvpn.net/howto.html#mitm" rel="nofollow" title="http://openvpn.net/howto.html#mitm">http://openvpn.net/howto.html#mitm</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> beschrieben ist, verwendet . 
</p><pre class="notranslate">remote-cert-tls server</pre><p>Andernfalls bekommt man bei jeder Verbindung eine Warnung ("WARNING: No server certificate verification method has been enabled.  See <a class="external" href="http://openvpn.net/howto.html#mitm" rel="nofollow" title="http://openvpn.net/howto.html#mitm">http://openvpn.net/howto.html#mitm</a> for more info.")</p><div class="section_2"><h3 id="Ubuntu">Ubuntu<a class="headerlink" href="#Ubuntu">¶</a></h3><p>
</p><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Es bietet sich die komfortable Nutzung der <a class="internal" href="./networkmanager/vpn_plugins.html">NetworkManager/VPN Plugins</a> an. 
</p></div></div><p>Auch hier muss das VPN jetzt neu gestartet werden <sup><a href="#source-3">[3]</a></sup>,nachdem die config-Datei, client.crt, client.key und ca.crt nach etc/openvpn kopiert wurden:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo /etc/init.d/openvpn restart </pre></div></div><p>Wer die Verbindung nicht bei jedem Systemstart automatisch aufbauen lassen will, muss folgende Zeile in der Datei <strong>/etc/default/openvpn</strong> aktivieren:</p><pre class="notranslate">AUTOSTART="none"</pre><p>In diesem Fall empfiehlt es sich, die Konfiguration im eigenen Homeverzeichnis anzulegen. Dann kann man die Verbindung bei Bedarf auch mit einfachen Benutzerrechten über folgenden Befehl starten:</p><div class="bash"><div class="contents"><pre class="notranslate">openvpn ~/pfad/zu/client.conf </pre></div></div><div class="box notice"><h3 class="box notice">Hinweis:</h3><div class="contents"><p>Wenn das Client-Zertifikat mit "./build-key-pass", also mit Passwort erstellt wurde, dann wird die Verbindung auch nicht automatisch erstellt, hierzu muss jedesmal nach einem Neustart mithilfe von <em>"sudo service openvpn restart"</em> das Passwort eingegeben werden.
</p></div></div></div><div class="section_2"><h3 id="Microsoft-Windows">Microsoft Windows<a class="headerlink" href="#Microsoft-Windows">¶</a></h3><p>
OpenVPN-Pakete für Windows sind über die folgende URL erhältlich: <a class="external" href="http://openvpn.net/index.php/download/community-downloads.html" rel="nofollow">http://openvpn.net/</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> . Nach der Installation müssen dann folgende Dateien, die vorhin erstellt wurden, in den Ordner <strong>C:\Programme\OpenVPN\config\ </strong> kopiert werden:</p><pre class="notranslate">client.ovpn
clientX.crt
clientX.key
ca.crt</pre><p>Wie zu erkennen ist, muss die <strong>client.conf</strong>-Datei zur Verwendung mit der Windows-GUI die Endung <strong>.ovpn</strong> haben.</p><p>Nun mit der rechten Maustaste <img alt="rechte Maustaste" class="image-default" src="./_/aa516ca8be74ff7de9b706b8ffc7a88e87e17fb5.png"/> auf das Icon von OpenVPN klicken und <em>"Connect"</em> auswählen. Wenn alles richtig gemacht wurde, sollte die Verbindung nun funktionieren.</p><p>Wer die VPN-Verbindung/en bereits beim Start von Windows aktivieren möchte, kann über <em>"Start -&gt; Ausführen -&gt; services.msc"</em> den Dienst openVPN auf automatisch starten setzen. Damit werden alle konfigurierten Verbindungen aus dem Ordner <em>"C:\Programme\OpenVPN\config\"</em> beim Systemstart automatisch aufgebaut.</p></div><div class="section_2"><h3 id="OpenVPN-ueber-HTTP-Proxy">OpenVPN über HTTP-Proxy<a class="headerlink" href="#OpenVPN-ueber-HTTP-Proxy">¶</a></h3><p>
Sitzt man nicht direkt an einem Internetzugang (z.b. im Büro oder beim Kunden), so hat man oft keine Möglichkeit über Port 1194 ins Internet zu kommen. Üblicherweise ist aber der Port 443 (HTTPS) über einen HTTPS-Proxy im Netz nutzbar. Theoretisch würden auch andere Ports funktionieren, praktisch limitieren aber Proxys in Firewall-Umgebungen die Benutzung von HTTP CONNECT, welche zur Tunnelung von SSL notwendig ist, nahezu immer auf den Port 443.</p><p>Um vom Client über den HTTPS-Proxy ins Internet und zum heimischen OpenVPN-Server zu gelangen, müssen folgende Konfigurationen gemacht werden:</p><div class="section_3"><h4 id="server-conf">server.conf<a class="headerlink" href="#server-conf">¶</a></h4><p>
</p><pre class="notranslate"># Which TCP/UDP port should OpenVPN listen on?
# If you want to run multiple OpenVPN instances
# on the same machine, use a different port
# number for each one.  You will need to
# open up this port on your firewall.
port 443
;port 1194

# TCP or UDP server?
proto tcp
;proto udp</pre><p>Auf dem Server wird in der <strong>server.conf</strong> auf den Port 443 umgeschaltet. Zudem wird hier auf das Protokoll TCP umgeschaltet, was in diesem Fall auch zwingend ist, da HTTP(S)-Verkehr generell über TCP transportiert wird.</p></div><div class="section_3"><h4 id="client-conf">client.conf<a class="headerlink" href="#client-conf">¶</a></h4><p>
</p><pre class="notranslate"># Are we connecting to a TCP or
# UDP server?  Use the same setting as
# on the server.
proto tcp
;proto udp

[...]

# If you are connecting through an
# HTTP proxy to reach the actual OpenVPN
# server, put the proxy server/IP and
# port number here.  See the man page
# if your proxy server requires
# authentication.
http-proxy 192.168.4.1 1080
;http-proxy-retry # retry on connection failures
;http-proxy [proxy server] [proxy port #]</pre><p>Auf dem Client wird in der <strong>client.conf</strong> die Zeile "<code class="notranslate">http-proxy 192.168.4.1 1080</code>" hinzugefügt. Wobei die Addresse des Proxy "<code class="notranslate">192.168.4.1</code>" und der Port "<code class="notranslate">1080</code>" mit den effektiven Angaben ersetzt werden müssen. Weitere Informationen zur Konfiguration von HTTP-Proxys sind unter <a class="external" href="http://openvpn.net/howto.html#http" rel="nofollow">http://openvpn.net/howto.html#http</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> verfügbar.</p><p>Auch auf dem Client muss darauf geachtet werden, TCP als Transportprotokoll auszuwählen.</p><p>Weiteres darüber ist im Artikel <a class="internal" href="./proxyserver.html">Proxyserver</a> zu finden.</p><p>Zu empfehlen ist <a class="internal" href="./tinyproxy.html">Tinyproxy</a> wegen seiner einfachen Konfiguration.</p></div></div></div><div class="section_1"><h2 id="Sicherheit-erhoehen">Sicherheit erhöhen<a class="headerlink" href="#Sicherheit-erhoehen">¶</a></h2><p>
Die Standardeinstellungen von OpenVPN sind zwar leistungsschonend, doch für das 21. Jahrhundert oft nicht mehr sicher genug. Deshalb kann man noch einige Einstellungen verändern, um die Sicherheit der Verbindung zu erhöhen.</p><p>Nach jeder Veränderung der Konfigurationen müssen die Dienste (Client und Server) mit: </p><div class="bash"><div class="contents"><pre class="notranslate">sudo service openvpn restart
#Ab 16.04
sudo systemctl restart openvpn </pre></div></div><p>
neugestartet werden.</p><div class="section_2"><h3 id="Verschluesselungsalgorithmus-aendern">Verschlüsselungsalgorithmus ändern<a class="headerlink" href="#Verschluesselungsalgorithmus-aendern">¶</a></h3><p>
Sowohl in der <strong>server.conf</strong> als auch in der <strong>client.conf</strong> ist der Verschlüsselungsalgorithmus als Standard auf "BF-CBC" gesetzt. Die <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Blowfish">Blowfish-Verschlüsselung</a> gilt zwar noch nicht offiziell als gebrochen, jedoch wurden einige Schwächen entdeckt, welche dazu führen können. Deswegen sollte sowohl in der <strong>server.conf</strong> als auch in der <strong>client.conf</strong> die Zeile:
</p><pre class="notranslate">cipher AES-256-CBC</pre><p>
eingefügt werden. Dadurch wird die Blowfish-Verschlüsselung durch die bekannte <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Advanced_Encryption_Standard">AES-Verschlüsselung</a> mit einer Schlüssellänge von 256 ersetzt.</p></div><div class="section_2"><h3 id="Authentifizierungsalgorithmus-aendern">Authentifizierungsalgorithmus ändern<a class="headerlink" href="#Authentifizierungsalgorithmus-aendern">¶</a></h3><p>
Der Standard hier ist <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Sha1">SHA-1</a>, welcher schon seit 2005 als gebrochen gilt, was sich aber auf eine andere Anwendungsweise bezieht. Trotzdem ist es besser auf den neueren Algorithmus <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/SHA-2">SHA-2</a> zu setzen. Hierfür muss sowohl in der <strong>server.conf</strong> als auch in der <strong>client.conf</strong> die Zeile:
</p><pre class="notranslate">auth SHA512 #SHA128 SHA256 und SHA512 gehören zur SHA-2 Familie</pre><p>
eingefügt werden.</p></div><div class="section_2"><h3 id="Schluessellaenge-erhoehen">Schlüssellänge erhöhen<a class="headerlink" href="#Schluessellaenge-erhoehen">¶</a></h3><p>
Wenn man es nicht schon in der Konfiguration zuvor getan hat, sollte man in der <strong>vars</strong> Datei den Wert </p><pre class="notranslate">export KEY_SIZE=1024 bzw export KEY_SIZE=2048</pre><p>
auf <strong>4096</strong> ändern und auch in der server.conf den Pfad anpassen, danach müssen <strong>alle Zertifikate</strong> neu erstellen.</p></div><div class="section_2"><h3 id="MITM-Angriffsmoeglichkeiten-verringern">MITM Angriffsmöglichkeiten verringern<a class="headerlink" href="#MITM-Angriffsmoeglichkeiten-verringern">¶</a></h3><p>
Damit <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Man-In-The-Middle-Angriff">Man-In-The-Middle-Angriff</a> - MITM abgewehrt werden können, sollte der Client bei der Kommunikation sicherstellen, das das Zertifikat des Servers auch wirklich ein Server-Zertifikat ist. Das kann durch hinzufügen dieser Zeile in der <strong>client.conf</strong> erreicht werden:
</p><pre class="notranslate">remote-cert-tls server</pre><p>Umgekehrt sollte in der <strong>server.conf</strong> ähnliches stehen:
</p><pre class="notranslate">remote-cert-tls client</pre></div><div class="section_2"><h3 id="DOS-abschwaechen">DOS abschwächen<a class="headerlink" href="#DOS-abschwaechen">¶</a></h3><p>
Vor <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Denial_of_Service">DOS-Attacken haben</a> die meisten noch keine Angst, aber durch den Aufstieg des <a class="interwiki interwiki-wikipedia" href="https://de.wikipedia.org/wiki/Internet_of_Things">Internet_of_Things</a> könnte jeder ein Angriffsziel werden. Deshalb sollte auch dafür die Konfiguration angepasst werden.</p><p>Zuallererst muss ein Signierungsschlüssel erstellt werden:
</p><div class="bash"><div class="contents"><pre class="notranslate">sudo openvpn --genkey --secret /etc/openvpn/easy-rsa2/keys/ta.key </pre></div></div><p>Dann wird in der <strong>server.conf</strong> die Zeile:
</p><pre class="notranslate">;tls-auth ta.key 0 #verändern in:
tls-auth ./easy-rsa2/keys/ta.key 0</pre><p>In der <strong>client.conf</strong> muss nun gleichermaßen die Zeile:
</p><pre class="notranslate">tls-auth ta.key 1</pre><p>
einkommentiert werden.</p><p>Als letztes muss noch der <strong>ta.key</strong> zu allen Clients transportiert werden. Dadurch werden nun alle Anfragen zum Server mit diesem Schlüssel signiert und der Server sortiert alle unsignierten Anfragen schon frühzeitig aus, was Serverkapazität spart und so DOS-Attacken vorbeugt.</p><p><a class="crosslink anchor" href="#Konfiguration" id="Konfiguration"></a>
</p></div></div><div class="section_1"><h2 id="Probleme">Probleme<a class="headerlink" href="#Probleme">¶</a></h2><p>
</p><div class="section_2"><h3 id="Zertifikate-sperren">Zertifikate sperren<a class="headerlink" href="#Zertifikate-sperren">¶</a></h3><p>
Sind Client-Zertifikate in die Hände von Fremden gelangt, können diese sich mit dem OpenVPN-Server verbinden. Um kompromittierte Zertifikate für die weitere Nutzung unbrauchbar zu machen, widerruft man diese. Dafür muss man sich ebenfalls im Ordner <strong>/etc/openvpn/easy-rsa2/</strong> befinden und die Datei <strong>vars</strong> gesourcet haben.</p><p>Zuerst wird die Server-Konfigurationsdatei <strong>/etc/openvpn/server.conf</strong> um einen Eintrag zur Widerrufsliste erweitert:</p><pre class="notranslate">crl-verify ./easy-rsa2/keys/crl.pem</pre><p>Danach soll OpenVPN die Konfiguration neu einlesen und guckt dann bei neuen oder laufenden Verbindungen nach, ob das Zertifikat des Clients noch gültig ist.</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E service openvpn reload     </pre></div></div><p>Die Zertifikate werden dann mit derselben Bezeichnung wie bei der Erstellung gesperrt:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo -E ./revoke-full ersterclient </pre></div></div></div><div class="section_2"><h3 id="Virtualisierte-Systeme">Virtualisierte Systeme<a class="headerlink" href="#Virtualisierte-Systeme">¶</a></h3><p>
Viele Provider bieten mittlerweile günstige virtualisierte Server an (auch VPS oder VServer). Bestimmte Funktionen lassen sich auf solchen Servern nur nutzen, wenn die entsprechenden Fähigkeiten auch in den Kernel des Host-Systems kompiliert wurden, auf dem die VPS läuft. Das gilt insbesondere für TUN/TAP und iptables. Bei vielen Providern genügt es, wenn man in einem Support-Ticket kurz erklärt, dass man TUN/TAP oder iptables nutzen möchte und sie wechseln den Kernel aus.</p><p>Funktioniert TUN/TAP dann immer noch nicht, muss man das Gerät noch selbst erstellen:</p><div class="bash"><div class="contents"><pre class="notranslate">sudo mkdir -p /dev/net
sudo mknod /dev/net/tun c 10 200
sudo chmod 600 /dev/net/tun </pre></div></div><p>Wenn man den Vserver als Gateway nutzen möchte muss man in der In der /etc/rc.local noch folgendes eintragen, wobei EXT_IP die öffentliche IP des servers ist
</p><div class="bash"><div class="contents"><pre class="notranslate">iptables -t nat -F POSTROUTING
echo 1 &gt; /proc/sys/net/ipv4/ip_forward

# iptables -t nat -A POSTROUTING -o eth0 -s 10.8.0.0/24 -j MASQUERADE # das geht nur wenn das Interface nicht venet0:0 (also keine Map ist)

iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j SNAT --to-source EXT_IP  </pre></div></div></div><div class="section_2"><h3 id="Mediatomb">Mediatomb<a class="headerlink" href="#Mediatomb">¶</a></h3><p>
Unter Umständen kann es zu Problemen kommen, wenn <a class="internal" href="./mediatomb.html">Mediatomb</a> und OpenVPN gleichzeitig installiert sind. Das Problem äußert sich darin, dass die Weboberfläche von Mediatomb zwar erreichbar ist, der eigentliche UPNP Service aber nicht.</p><p>Die Ursache ist hierfür, dass Mediatomb den UPNP Service scheinbar an die TUN Netzwerkschnittstelle, welches von OpenVPN angelegt wird, bindet. Stattdessen soll Mediatomb sich an die übliche Netzwerkschnittstelle binden, normalerweise also eth0 oder wlan0.</p><p>Ein einfacher Eingriff in die config.xml des Mediatomb löst das Problem:</p><pre class="notranslate">&lt;config ...&gt;
  &lt;server&gt;
  ...
    &lt;interface&gt;eth0&lt;/interface&gt;
  ...
  &lt;/server&gt;
&lt;/config&gt;</pre></div></div><div class="section_1"><h2 id="Problemloesung">Problemlösung<a class="headerlink" href="#Problemloesung">¶</a></h2><p>
Sollte über das VPN Datenverkehr wie z.b. Ping und ssh funktionieren, andere wie HTTP(s) aber nicht, könnte dies an zu großen Paketen (MTU) liegen. Hier kann man versuchen beim Server die Option <code class="notranslate">mssfix</code> zu setzen.
Optionen wie <code class="notranslate">link-mtu</code> müssen auf Server- und CLient-Seite konfiguriert werden.</p></div><div class="section_1"><h2 id="Links">Links<a class="headerlink" href="#Links">¶</a></h2><p>
</p><ul><li><p><a class="external" href="https://www.sempervideo.de/?video=openvpn-server-installieren" rel="nofollow">OpenVPN Installation über Bash Script</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/></p></li><li><p><a class="external" href="https://community.openvpn.net/openvpn/wiki" rel="nofollow">Offizielle OpenVPN Dokumentation</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/></p></li><li><p><a class="external" href="http://www.openvpn.eu" rel="nofollow">OpenVPN e.V</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> - Verein zur Stärkung der Community mit Wiki und Forum</p></li><li><p>offizieller <a class="external" href="https://play.google.com/store/apps/details?id=net.openvpn.openvpn" rel="nofollow">OpenVPN Client</a> für Android</p></li><li><p>Von <a class="external" href="http://www.savecall.de/standortvernetzung/" rel="nofollow">Savecall</a> wird beschrieben, wie VPN im Internet, per Ethernet oder mit einer MPLS-Verbindung genutzt werden kann.</p></li><li><p><a class="internal" href="./serverdienste.html#VPN">VPN</a> <img alt="{Übersicht}" src="./_/021d71c30babf2ce4dd27339ba3c55995610945b.png"/> Artikelübersicht</p></li><li><p><a class="external" href="http://ctaas.de/openvpn_routing.htm" rel="nofollow">ctaas.de/openvpn_routing.htm</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> - ausführliches OpenVPN Tutorial für: tun/NAT, routing OSI-Level 3, Protokollierung, für geroutete Netze - insbes. für Smartphones/Tablets usw.</p></li><li><p><a class="external" href="http://ctaas.de/openvpn_bridging.htm" rel="nofollow">ctaas.de/openvpn_bridging.htm</a> <img alt="{de}" src="./_/ffd333e1d59794eac31aea8b3e984e1b88473c33.png"/> - ausführliches OpenVPN Tutorial für: tap/NAT, bridging, OSI-Level 2, Protokollierung - insbes. geeignet zur Standortvernetzung</p></li><li><p><a class="external" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04" rel="nofollow" title="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-set-up-an-openvpn-server-on-ubuntu-16-04</a> <img alt="{en}" src="./_/d5ecf89114b079f85d02099649c4ee617ffa34c7.png"/> - ausführliches OpenVPN Tutorial für Server und Client</p></li></ul><p>
</p></div></div>
<p class="meta">
<a href="./openvpn/a/revision/944920.html">Diese Revision</a> wurde am 16. November 2017 17:11 von <a href="https://ubuntuusers.de/user/Heinrich_Schwietering/">Heinrich_Schwietering</a> erstellt.
    
  </p>
</div>
</div>
<div style="clear: both;"></div>
<div class="pathbar breadcrumb">
<div class="breadcrumb">
<ol>
<li><a href="./startseite.html">Wiki</a></li>
<li><a href="./openvpn.html">OpenVPN</a></li>
</ol>
</div>
</div>
</div>
<div class="footer" style="clear: both;">
<ul>
<li class="poweredby"><li class="poweredby">Erstellt mit <a href="http://inyokaproject.org/">Inyoka</a></li></li>
<li class="license">

<img alt="Copyleft" src="./_/65dad5b770326dbbe1bd26ee6363e366a76bd8b7.png"/>
          2004 – 2017 ubuntuusers.de • Einige Rechte vorbehalten<br/>
<a href="./_lizenz.html" rel="cc:morePermissions">Lizenz</a> •
          <a href="http://ubuntuusers.de/kontakt/">Kontakt</a> •
          <a href="http://ubuntuusers.de/datenschutz/">Datenschutz</a> •
          <a href="http://ubuntuusers.de/impressum/">Impressum</a> •
          <a href="https://ubuntuusers.statuspage.io">Serverstatus</a>
</li>
<li class="housing">
<span title="Unterbringung und Netzanbindung eines Servers">Serverhousing</span> gespendet von<br/>
<img alt="noris network" src="./_/e7d27e9081eec23a8a5a5fe9434d7b2f1532e1d9.png"/>
<img alt="anexia" src="./_/ad1b63a3fc35749344af0a03e8c3ce05a2a3ee7e.png"/>
</li>
</ul>
</div>
<div style="clear: both;"></div>
</div>






</body>
</html>